# Stripe Integration Testing Guide\n\n## Test Cards\n\nUse these cards in test mode only:\n\n### Successful Payments\n\n```\nCard Number: 4242 4242 4242 4242\nExp Date: Any future date (e.g., 12/25)\nCVC: Any 3 digits (e.g., 123)\nZip: Any valid zip code (e.g., 10001)\n```\n\n### Declined Payments\n\n```\nCard Number: 4000 0000 0000 0002\nExp Date: Any future date\nCVC: Any 3 digits\nResult: Card will be declined\n```\n\n### 3D Secure (SCA) Required\n\n```\nCard Number: 4000 0025 0000 3155\nExp Date: Any future date\nCVC: Any 3 digits\nResult: Requires 3D Secure authentication\n```\n\n### Expired Card\n\n```\nCard Number: 4000 0000 0000 0069\nExp Date: Any past date\nCVC: Any 3 digits\nResult: Card will be declined as expired\n```\n\nFor more test cards, see: https://stripe.com/docs/testing\n\n## Unit Tests\n\n### Test Checkout Validation\n\n```typescript\nimport { POST } from '@/app/api/stripe/checkout/route';\nimport { NextRequest } from 'next/server';\n\ndescribe('POST /api/stripe/checkout', () => {\n  it('should validate required fields', async () => {\n    const request = new NextRequest('http://localhost/api/stripe/checkout', {\n      method: 'POST',\n      body: JSON.stringify({\n        priceId: 'price_test',\n        // Missing userId and email\n      }),\n    });\n\n    const response = await POST(request);\n    expect(response.status).toBe(400);\n    const data = await response.json() as { error: string };\n    expect(data.error).toContain('Missing required fields');\n  });\n\n  it('should reject invalid price IDs', async () => {\n    const request = new NextRequest('http://localhost/api/stripe/checkout', {\n      method: 'POST',\n      body: JSON.stringify({\n        priceId: 'price_invalid',\n        userId: 'user_123',\n        email: 'test@example.com',\n        successUrl: 'https://example.com/success',\n        cancelUrl: 'https://example.com/cancel',\n      }),\n    });\n\n    const response = await POST(request);\n    expect(response.status).toBe(400);\n    const data = await response.json() as { error: string };\n    expect(data.error).toContain('Invalid price ID');\n  });\n\n  it('should create checkout session with valid data', async () => {\n    const request = new NextRequest('http://localhost/api/stripe/checkout', {\n      method: 'POST',\n      body: JSON.stringify({\n        priceId: process.env.NEXT_PUBLIC_STRIPE_FUNDRAISING_PRICE_ID,\n        userId: 'user_123',\n        email: 'test@example.com',\n        successUrl: 'https://example.com/success',\n        cancelUrl: 'https://example.com/cancel',\n      }),\n    });\n\n    const response = await POST(request);\n    expect(response.status).toBe(200);\n    const data = await response.json() as { url: string };\n    expect(data.url).toContain('checkout.stripe.com');\n  });\n});\n```\n\n### Test Webhook Signature Verification\n\n```typescript\nimport { POST } from '@/app/api/stripe/webhook/route';\nimport { NextRequest } from 'next/server';\n\ndescribe('POST /api/stripe/webhook', () => {\n  it('should reject missing signature', async () => {\n    const request = new NextRequest('http://localhost/api/stripe/webhook', {\n      method: 'POST',\n      body: JSON.stringify({\n        type: 'checkout.session.completed',\n        data: { object: { id: 'cs_test' } },\n      }),\n      // No stripe-signature header\n    });\n\n    const response = await POST(request);\n    expect(response.status).toBe(401);\n  });\n\n  it('should reject invalid signature', async () => {\n    const request = new NextRequest('http://localhost/api/stripe/webhook', {\n      method: 'POST',\n      headers: {\n        'stripe-signature': 'invalid_signature',\n      },\n      body: JSON.stringify({\n        type: 'checkout.session.completed',\n        data: { object: { id: 'cs_test' } },\n      }),\n    });\n\n    const response = await POST(request);\n    expect(response.status).toBe(401);\n  });\n\n  it('should process valid webhook event', async () => {\n    // This requires constructing a valid Stripe webhook\n    // Use Stripe test event endpoint or ngrok/Stripe CLI\n    // See \"Integration Tests\" section below\n  });\n});\n```\n\n## Integration Tests\n\n### Full Checkout Flow\n\n```bash\n#!/bin/bash\n\n# 1. Start dev server\nnpm run dev &\nDEV_PID=$!\nsleep 2\n\n# 2. Visit pricing page\necho \"Visit http://localhost:3000/pricing\"\n\n# 3. Click \"Start 14-Day Trial\" on Fundraising plan\necho \"Click checkout button\"\n\n# 4. Use test card\necho \"Enter card: 4242 4242 4242 4242\"\necho \"Enter date: 12/25\"\necho \"Enter CVC: 123\"\n\n# 5. Verify webhook received\necho \"Check webhook logs in Stripe Dashboard\"\n\n# 6. Verify database updated\necho \"Query user_subscriptions table\"\n\n# 7. Cleanup\nkill $DEV_PID\n```\n\n### Webhook Testing with Stripe CLI\n\n```bash\n# 1. Install Stripe CLI\nbrew install stripe/stripe-cli/stripe\n\n# 2. Login to Stripe\nstripe login\n\n# 3. Start local forwarding\nstripe listen --forward-to localhost:3000/api/stripe/webhook\n\n# 4. In another terminal, trigger test event\nstripe trigger checkout.session.completed\n\n# 5. Verify webhook received and processed\necho \"Check your app logs\"\necho \"Verify database was updated\"\n```\n\n### Webhook Testing with ngrok\n\n```bash\n# 1. Install ngrok\nbrew install ngrok\n\n# 2. Start tunnel\nngrok http 3000\n# Output: Forwarding https://abc123.ngrok.io -> http://localhost:3000\n\n# 3. Update webhook in Stripe Dashboard\necho \"Go to Webhooks > Create endpoint\"\necho \"URL: https://abc123.ngrok.io/api/stripe/webhook\"\necho \"Events: checkout.session.completed, etc.\"\n\n# 4. Run checkout flow\necho \"Visit https://abc123.ngrok.io/pricing\"\necho \"Complete checkout with test card\"\n\n# 5. View webhook logs\necho \"Check ngrok console for webhook delivery\"\necho \"Check Stripe Dashboard for event details\"\n```\n\n## Test Scenarios\n\n### Scenario 1: Successful Subscription Purchase\n\n**Steps:**\n1. Navigate to pricing page\n2. Click \"Start 14-Day Trial\" on Fundraising plan\n3. Enter email: test@example.com\n4. Enter card: 4242 4242 4242 4242\n5. Complete checkout\n\n**Expected Results:**\n- Redirected to /billing?success=true\n- Webhook: checkout.session.completed received\n- Database: user_subscriptions row created\n- Database: stripe_events row created\n- User receives confirmation email (if configured)\n\n**Verify:**\n```sql\nSELECT * FROM user_subscriptions WHERE stripe_customer_id = 'cus_...';\nSELECT * FROM stripe_events WHERE type = 'checkout.session.completed';\n```\n\n### Scenario 2: Payment Failure Handling\n\n**Steps:**\n1. Navigate to pricing page\n2. Click \"Start 14-Day Trial\" on Venture Studio plan\n3. Enter email: test@example.com\n4. Enter card: 4000 0000 0000 0002 (declined card)\n5. Attempt checkout\n\n**Expected Results:**\n- Stripe displays error: \"Your card was declined\"\n- User can retry with different card\n- No subscription created\n- No webhook event fired\n\n**Verify:**\n```sql\nSELECT * FROM user_subscriptions WHERE email = 'test@example.com';\n-- Should return empty result\n```\n\n### Scenario 3: Webhook Idempotency\n\n**Steps:**\n1. Use Stripe CLI to trigger event\n2. Trigger the SAME event again\n3. Verify duplicate handling\n\n**Expected Results:**\n- First event: subscription created, event marked processed\n- Second event: detected as duplicate, skipped\n- No duplicate subscription created\n- No double charge\n\n**Verify:**\n```sql\nSELECT COUNT(*) FROM stripe_events \nWHERE stripe_event_id = 'evt_...';\n-- Should return 1 (not duplicated)\n\nSELECT COUNT(*) FROM user_subscriptions \nWHERE stripe_customer_id = 'cus_...';\n-- Should return 1 (not duplicated)\n```\n\n### Scenario 4: Subscription Updates\n\n**Steps:**\n1. Complete successful purchase (Scenario 1)\n2. In Stripe Dashboard, manually trigger: customer.subscription.updated\n3. Update subscription status to past_due\n4. Verify app handles update\n\n**Expected Results:**\n- Webhook: customer.subscription.updated received\n- Database: subscription status updated to past_due\n- stripe_events row created and marked processed\n\n**Verify:**\n```sql\nSELECT status FROM user_subscriptions WHERE stripe_customer_id = 'cus_...';\n-- Should return 'past_due'\n```\n\n### Scenario 5: Subscription Cancellation\n\n**Steps:**\n1. Use Stripe Dashboard to cancel subscription\n2. Verify app updates correctly\n\n**Expected Results:**\n- Webhook: customer.subscription.deleted received\n- Database: subscription marked as canceled\n- canceled_at timestamp set\n- User loses access to features (if implemented)\n\n**Verify:**\n```sql\nSELECT status, canceled_at FROM user_subscriptions WHERE stripe_customer_id = 'cus_...';\n-- status should be 'canceled' with timestamp\n```\n\n### Scenario 6: Invoice Payment Success\n\n**Steps:**\n1. Subscription active for 30+ days\n2. Stripe automatically charges for renewal\n3. Verify success handling\n\n**Expected Results:**\n- Webhook: invoice.payment_succeeded received\n- Subscription remains active\n- Payment logged for audit trail\n- Customer receives receipt (if configured)\n\n**Verify:**\n```sql\nSELECT * FROM stripe_events WHERE type = 'invoice.payment_succeeded';\n```\n\n### Scenario 7: Invoice Payment Failure\n\n**Steps:**\n1. Subscription with payment method that will fail\n2. Manual trigger: invoice.payment_failed\n3. Verify failure handling\n\n**Expected Results:**\n- Webhook: invoice.payment_failed received\n- Subscription status updated to past_due\n- Customer notified (if configured)\n- Retry scheduled\n\n**Verify:**\n```sql\nSELECT status FROM user_subscriptions WHERE stripe_customer_id = 'cus_...';\n-- status should be 'past_due'\n```\n\n### Scenario 8: Price ID Tampering\n\n**Steps:**\n1. In browser devtools, modify price ID to invalid value\n2. Submit checkout form\n3. Verify rejection\n\n**Expected Results:**\n- API rejects invalid price ID\n- 400 Bad Request response\n- No checkout session created\n\n**Verify:**\n```bash\ncurl -X POST http://localhost:3000/api/stripe/checkout \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"priceId\": \"price_fake_99_cents\",\n    \"userId\": \"user_123\",\n    \"email\": \"test@example.com\",\n    \"successUrl\": \"https://localhost:3000/success\",\n    \"cancelUrl\": \"https://localhost:3000/cancel\"\n  }'\n\n# Expected: {\"error\": \"Invalid price ID\"}\n```\n\n### Scenario 9: Replay Attack Prevention\n\n**Steps:**\n1. Capture valid webhook with ngrok/Stripe CLI\n2. Extract signature header\n3. Send request twice with same body/signature\n4. Verify second request doesn't duplicate charges\n\n**Expected Results:**\n- First request: processed normally\n- Second request: idempotently handled, no duplicate effect\n- Both recorded in database with same event ID\n\n**Verify:**\n```sql\nSELECT stripe_event_id, COUNT(*) FROM stripe_events \nGROUP BY stripe_event_id HAVING COUNT(*) > 1;\n-- Should return no results (no duplicate event IDs)\n```\n\n### Scenario 10: Old Webhook Rejection\n\n**Steps:**\n1. Create webhook event\n2. Wait > 5 minutes\n3. Send event to webhook endpoint\n4. Verify rejection based on age\n\n**Expected Results:**\n- Webhook received with 200 OK (quick response)\n- But not processed (too old)\n- No database changes\n\n**Verify:**\n```bash\n# Manually craft old webhook (normally Stripe prevents this)\n# This is more about code review than manual testing\ngrep \"WEBHOOK_MAX_AGE\" /root/github-repos/sierra-fred-carey/app/api/stripe/webhook/route.ts\n# Should show 300 seconds (5 minutes) threshold\n```\n\n## Performance Testing\n\n### Load Test Checkout\n\n```bash\n# Using Apache Bench\nab -n 100 -c 10 -p data.json \\\n  -T application/json \\\n  http://localhost:3000/api/stripe/checkout\n\n# Expected: All requests succeed with < 1s response time\n```\n\n### Webhook Processing Speed\n\n```bash\n# Stripe requires response within 200ms\n# Verify with:\ntime curl -X POST http://localhost:3000/api/stripe/webhook \\\n  -H \"stripe-signature: valid_signature\" \\\n  -d '@webhook.json'\n\n# Expected: response time < 200ms\n```\n\n## Debugging\n\n### View Webhook Logs\n\n```bash\n# In Stripe Dashboard:\n# 1. Go to Webhooks\n# 2. Click on endpoint\n# 3. Scroll to \"Events\"\n# 4. Click event to view payload, response, retries\n```\n\n### Enable Verbose Logging\n\n```typescript\n// In app/api/stripe/webhook/route.ts\nif (process.env.NODE_ENV === 'development') {\n  console.log('Webhook received:', {\n    id: event.id,\n    type: event.type,\n    created: new Date(event.created * 1000),\n    payload: JSON.stringify(event.data, null, 2),\n  });\n}\n```\n\n### Check Event Status\n\n```bash\n# Query your database\nsqlite3 yourdb.db\nSELECT * FROM stripe_events ORDER BY created_at DESC LIMIT 10;\n\n# Check status column:\n# 'pending' = being processed\n# 'processed' = completed successfully\n# 'failed' = error during processing\n```\n\n## Cleanup\n\n### Delete Test Data\n\n```sql\n-- Delete test subscriptions\nDELETE FROM user_subscriptions \nWHERE stripe_customer_id LIKE 'cus_test%';\n\n-- Delete test webhooks\nDELETE FROM stripe_events \nWHERE stripe_customer_id LIKE 'cus_test%';\n```\n\n### Reset Test Mode\n\nIn Stripe Dashboard:\n1. Go to Settings > Test Data\n2. Click \"Clear all test data\"\n3. Confirms deletion of all test customers, invoices, etc.\n\n## Continuous Testing\n\n### Pre-deployment Checklist\n\n- [ ] Run unit tests: `npm test`\n- [ ] Run integration tests against test API keys\n- [ ] Manual test: Complete checkout flow\n- [ ] Manual test: Cancel subscription\n- [ ] Check webhook logs for errors\n- [ ] Verify database updates correct\n- [ ] Test error scenarios (declined card, etc.)\n- [ ] Test security (invalid signatures, tampered prices)\n- [ ] Performance test (< 1s response times)\n- [ ] Verify logs don't contain sensitive data\n\n## Troubleshooting\n\nSee `STRIPE_IMPLEMENTATION_GUIDE.md` for common issues and fixes.\n"