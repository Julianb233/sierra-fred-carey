# Stripe Integration Security Guidelines\n\n## PCI Compliance Strategy\n\n### What is PCI DSS?\n\nPayment Card Industry Data Security Standard (PCI DSS) is a set of security requirements for handling card data. Non-compliance can result in fines up to $100,000+ per month.\n\n### Our Approach: Zero Card Handling\n\nThis implementation achieves **highest PCI compliance level** by:\n\n1. **Never touching card data** - All card handling done by Stripe\n2. **Using hosted checkout** - Customers enter cards on Stripe's secure servers\n3. **No payment forms** - We don't build our own payment UI\n4. **Server-side validation** - All sensitive operations verified server-side\n\n### What We Never Do\n\n```javascript\n// WRONG - Never do this\nconst cardNumber = \"4242424242424242\";\nconst cvv = \"123\";\nconst response = await fetch(\"/api/process-payment\", {\n  body: JSON.stringify({ cardNumber, cvv })\n});\n\n// RIGHT - What we do\nconst response = await fetch(\"/api/stripe/checkout\", {\n  body: JSON.stringify({\n    priceId: \"price_...\",  // Only safe data\n    email: \"user@example.com\"\n  })\n});\n// Stripe Checkout handles the card\n```\n\n## Webhook Security\n\n### Signature Verification (HMAC)\n\nEvery webhook is signed with a secret key. We verify this signature before processing.\n\n**Why this matters:**\n- Prevents malicious requests impersonating Stripe\n- Ensures data integrity\n- Authenticates message source\n\n**Implementation:**\n\n```typescript\n// In app/api/stripe/webhook/route.ts\nconst signature = request.headers.get(\"stripe-signature\");\nconst event = getWebhookEvent(body, signature, process.env.STRIPE_WEBHOOK_SECRET);\n// If signature is invalid, getWebhookEvent throws error\n```\n\n### Idempotency & Replay Protection\n\nStripe may retry failed webhooks. Without idempotency, a retry could:\n- Charge customer twice\n- Create duplicate subscriptions\n- Grant double refunds\n\n**Implementation:**\n\n```typescript\n// Store event ID to prevent duplicate processing\nconst existingEvent = await getStripeEventById(event.id);\nif (existingEvent) {\n  console.log(\"Event already processed, skipping\");\n  return; // Don't process again\n}\n\n// Store event before processing\nawait recordStripeEvent({\n  stripeEventId: event.id,\n  status: \"pending\",\n  payload: event.data\n});\n\n// Process event...\n\n// Mark as processed\nawait markEventAsProcessed(event.id);\n```\n\n### Timestamp Validation\n\nWe reject webhooks older than 5 minutes to prevent replay attacks.\n\n```typescript\nconst WEBHOOK_MAX_AGE = 300; // 5 minutes\nif (Date.now() - event.created * 1000 > WEBHOOK_MAX_AGE * 1000) {\n  console.warn(\"Webhook too old, ignoring\");\n  return NextResponse.json({ received: true }, { status: 200 });\n}\n```\n\n### Quick Response Requirement\n\nWebhooks must return 2xx status within 200ms before expensive operations.\n\n**Why:**\n- Stripe considers slow responses as failed delivery\n- Retries cause duplicate processing\n- Creates race conditions\n\n**Implementation:**\n\n```typescript\n// WRONG - Blocks response on expensive operation\nawait createOrUpdateSubscription(data); // Slow DB call\nreturn NextResponse.json({ received: true });\n\n// RIGHT - Return immediately, process async\nreturn NextResponse.json({ received: true }, { status: 200 });\n\n// Then process asynchronously\nprocessWebhookAsync(event).catch(err => {\n  console.error(\"Async processing failed\", err);\n});\n```\n\n## Server-Side Validation\n\n### Never Trust Client Responses\n\nA user could modify prices in browser devtools:\n\n```javascript\n// User modifies price in console\ndocument.querySelector('[data-price]').textContent = \"$0.01\";\n\n// Then submits checkout\nconst response = await fetch(\"/api/stripe/checkout\", {\n  body: JSON.stringify({\n    priceId: \"price_...modified...\"\n  })\n});\n```\n\n**Our defense:**\n\n```typescript\n// In checkout/route.ts\nconst validPriceIds = [\n  STRIPE_PLANS.FUNDRAISING.priceId,\n  STRIPE_PLANS.VENTURE_STUDIO.priceId,\n].filter(Boolean);\n\nif (!validPriceIds.includes(body.priceId)) {\n  return NextResponse.json(\n    { error: \"Invalid price ID\" },\n    { status: 400 }\n  );\n}\n\n// Create session - Stripe validates amount matches price ID\nconst session = await stripe.checkout.sessions.create({\n  line_items: [{ price: body.priceId, quantity: 1 }],\n  // Stripe ensures this price exists and amount is correct\n});\n```\n\n## Secret Key Management\n\n### Environment Variables\n\n**Private (Backend only):**\n```bash\nSTRIPE_SECRET_KEY=sk_test_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\n```\n\n**Public (Exposed to browser - safe):**\n```bash\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...\nNEXT_PUBLIC_STRIPE_FUNDRAISING_PRICE_ID=price_...\nNEXT_PUBLIC_STRIPE_VENTURE_STUDIO_PRICE_ID=price_...\n```\n\n### Why This Is Safe\n\nThe publishable key (pk_test_) is intentionally public. It can only:\n- Create checkout sessions\n- Display pricing\n- Never charge customer or access payment data\n\nThe secret key (sk_test_) is backend-only. It can:\n- Refund payments\n- Update subscriptions\n- Access customer data\n- Must be protected at all costs\n\n## Data Security\n\n### What We Store in Database\n\nSafe to store:\n```typescript\ninterface UserSubscription {\n  userId: string;              // Your user ID\n  stripeCustomerId: string;    // Public Stripe ID\n  stripeSubscriptionId: string;// Public Stripe ID\n  stripePriceId: string;       // Product price ID\n  status: \"active\" | \"canceled\"; // Subscription status\n  currentPeriodEnd: Date;      // Renewal date\n  // ... other non-sensitive data\n}\n```\n\nNever store:\n```typescript\n// NEVER store these in database\nconst cardNumber = \"4242424242424242\";\nconst expirationDate = \"12/25\";\nconst cvv = \"123\";\nconst fullName = \"John Doe\"; // Payment method name\n```\n\n### What Stripe Stores Securely\n\nStripe stores (encrypted):\n- Card numbers\n- Expiration dates\n- CVV codes\n- Billing addresses\n- All payment data\n\nYou access this via Stripe API only, never directly.\n\n## Rate Limiting\n\nProtect checkout endpoint from abuse:\n\n```typescript\n// TODO: Implement rate limiting\n// Recommended: 10 requests per minute per IP/user\nimport { Ratelimit } from \"@upstash/ratelimit\";\n\nconst ratelimit = new Ratelimit({\n  redis: Redis.fromEnv(),\n  limiter: Ratelimit.slidingWindow(10, \"1 m\"),\n});\n\nconst { success } = await ratelimit.limit(userId);\nif (!success) {\n  return NextResponse.json(\n    { error: \"Too many requests\" },\n    { status: 429 }\n  );\n}\n```\n\n## Input Validation\n\n### Checkout Request\n\n```typescript\ninterface CheckoutRequest {\n  priceId: string;   // Validated against allowed prices\n  userId: string;    // Validated as non-empty\n  email: string;     // Validated as valid email format\n  successUrl: string;// Validated as HTTPS URL\n  cancelUrl: string; // Validated as HTTPS URL\n}\n\n// Validate email format\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(body.email)) {\n  return NextResponse.json({ error: \"Invalid email\" }, { status: 400 });\n}\n\n// Validate URLs are HTTPS\nif (!body.successUrl.startsWith(\"https://\")) {\n  return NextResponse.json(\n    { error: \"URLs must use HTTPS\" },\n    { status: 400 }\n  );\n}\n```\n\n## Monitoring & Alerts\n\n### What to Monitor\n\n1. **Webhook Delivery:**\n   - Failed webhooks (retry them)\n   - Delays (> 5 seconds)\n   - Error rates (> 1%)\n\n2. **Payment Failures:**\n   - invoice.payment_failed events\n   - Subscription cancellations\n   - High churn rate\n\n3. **Suspicious Activity:**\n   - Multiple failed payment attempts\n   - Rapid checkout sessions\n   - Price validation failures\n\n### Stripe Dashboard Monitoring\n\n1. Go to Webhooks section\n2. View endpoint details\n3. Check delivery status and error logs\n4. Set up email alerts for failures\n\n## Testing Security\n\n### Test Invalid Signatures\n\n```bash\ncurl -X POST http://localhost:3000/api/stripe/webhook \\\n  -H \"stripe-signature: invalid_signature\" \\\n  -d '{\"type\": \"checkout.session.completed\"}'\n\n# Expected: 401 Unauthorized\n```\n\n### Test Price Validation\n\n```bash\ncurl -X POST http://localhost:3000/api/stripe/checkout \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"priceId\": \"price_invalid\",\n    \"userId\": \"user_123\",\n    \"email\": \"test@example.com\",\n    \"successUrl\": \"https://example.com/success\",\n    \"cancelUrl\": \"https://example.com/cancel\"\n  }'\n\n# Expected: 400 Bad Request\n```\n\n### Test Replay Attack Prevention\n\n1. Capture a valid webhook with ngrok/Stripe CLI\n2. Extract the signature header\n3. Send the same request twice\n4. Second request should be idempotently handled (no double charge)\n\n## Compliance Checklist\n\n### Before Launch\n\n- [ ] All webhook signatures verified\n- [ ] Idempotency implemented (event deduplication)\n- [ ] No card data in logs\n- [ ] No card data in database\n- [ ] All URLs use HTTPS\n- [ ] Secret keys in environment variables\n- [ ] Rate limiting enabled\n- [ ] Input validation on all endpoints\n- [ ] Webhook endpoint accessible (public URL)\n- [ ] Error messages don't leak sensitive info\n\n### Production Requirements\n\n- [ ] SSL certificate valid and renewed\n- [ ] Regular security audits\n- [ ] Webhook logs retained for audit\n- [ ] Monitoring alerts configured\n- [ ] Incident response plan documented\n- [ ] Team trained on security practices\n- [ ] Regular backups of database\n- [ ] Access controls for admin functions\n\n## Incident Response\n\n### Payment Processing Down\n\n1. Check Stripe status: https://status.stripe.com\n2. Check webhook logs in Stripe Dashboard\n3. Review error logs in your app\n4. Contact Stripe Support if needed\n5. Notify customers of delays\n6. Reprocess failed webhooks when service restored\n\n### Suspected Fraud\n\n1. Identify suspicious transactions\n2. Review in Stripe Dashboard\n3. Contact customer for verification\n4. File dispute if unauthorized\n5. Update fraud detection rules\n6. Consider card decline rules\n\n### Data Breach\n\n1. Check if Stripe systems affected (unlikely, very secure)\n2. Review your logs for unauthorized access\n3. Rotate credentials if needed\n4. Contact customers if their data compromised\n5. File incident report\n\n## Additional Resources\n\n- PCI DSS Compliance: https://stripe.com/docs/security/pci-compliance\n- Stripe Security: https://stripe.com/docs/security\n- OWASP Payment Security: https://owasp.org/\n- Webhook Security: https://stripe.com/docs/webhooks\n"