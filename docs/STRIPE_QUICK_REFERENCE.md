# Stripe Integration - Quick Reference\n\n## File Structure\n\n```\nlib/stripe/\n├── config.ts          - Plans & pricing config\n├── client.ts          - Browser Stripe instance\n└── server.ts          - Server Stripe client + webhooks\n\nlib/db/\n└── subscriptions.ts   - Database types (TODO: implement)\n\napp/api/stripe/\n├── checkout/route.ts  - Create checkout sessions\n├── webhook/route.ts   - Handle Stripe events\n└── portal/route.ts    - Manage subscriptions\n\napp/api/user/\n└── subscription/route.ts - Get user subscription status\n\nhooks/\n└── use-subscription.ts - React hook for subscription\n\ncomponents/\n└── pricing.tsx        - Updated with Stripe integration\n\ndocs/\n├── STRIPE_IMPLEMENTATION_GUIDE.md\n├── STRIPE_SECURITY.md\n├── STRIPE_TESTING.md\n└── STRIPE_QUICK_REFERENCE.md (this file)\n```\n\n## Environment Variables\n\n```bash\n# Backend Only (KEEP SECRET)\nSTRIPE_SECRET_KEY=sk_test_...\nSTRIPE_WEBHOOK_SECRET=whsec_...\n\n# Public (Safe to expose)\nNEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_...\nNEXT_PUBLIC_STRIPE_FUNDRAISING_PRICE_ID=price_...\nNEXT_PUBLIC_STRIPE_VENTURE_STUDIO_PRICE_ID=price_...\n```\n\nSee `.env.example` for template.\n\n## Setup Checklist\n\n1. [ ] Create Stripe account: https://dashboard.stripe.com\n2. [ ] Get API keys (Settings > API Keys)\n3. [ ] Create products and prices (Products section)\n4. [ ] Create webhook endpoint (Webhooks section)\n5. [ ] Set environment variables\n6. [ ] Implement database schema\n7. [ ] Implement database functions in `lib/db/subscriptions.ts`\n8. [ ] Uncomment webhook handlers\n9. [ ] Update auth context in pricing component\n10. [ ] Test with Stripe CLI or ngrok\n11. [ ] Deploy and switch to live keys\n\n## Core Components\n\n### 1. Stripe Configuration\n\n```typescript\nimport { STRIPE_PLANS } from '@/lib/stripe/config';\n\n// Access plan config\nSTRIPE_PLANS.FREE          // Free tier (no priceId)\nSTRIPE_PLANS.FUNDRAISING   // $99/month\nSTRIPE_PLANS.VENTURE_STUDIO // $249/month\n```\n\n### 2. Client-Side Stripe Instance\n\n```typescript\nimport { getStripe } from '@/lib/stripe/client';\n\nconst stripe = await getStripe();\n// Use for Stripe Elements, confirmPayment, etc.\n```\n\n### 3. Server-Side Stripe Client\n\n```typescript\nimport { stripe, getWebhookEvent } from '@/lib/stripe/server';\n\n// Create checkout session\nconst session = await stripe.checkout.sessions.create({ ... });\n\n// Verify webhook signature\nconst event = getWebhookEvent(body, signature, secret);\n```\n\n### 4. Subscription Hook\n\n```typescript\nimport { useSubscription, useHasFeature } from '@/hooks/use-subscription';\n\n// Check subscription status\nconst { plan, status, isLoading } = useSubscription();\n\n// Check feature access\nconst hasVentureStudio = useHasFeature('venture_studio');\n```\n\n## API Endpoints\n\n### POST /api/stripe/checkout\n\nCreate checkout session.\n\n```javascript\nconst response = await fetch('/api/stripe/checkout', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    priceId: 'price_...',\n    userId: 'user_...',\n    email: 'user@example.com',\n    successUrl: window.location.origin + '/billing?success=true',\n    cancelUrl: window.location.origin + '/pricing',\n  }),\n});\n\nconst { url } = await response.json();\nwindow.location.href = url; // Redirect to Stripe Checkout\n```\n\n### POST /api/stripe/webhook\n\nReceive and process webhooks (called by Stripe, not your app).\n\nEvents handled:\n- `checkout.session.completed` - User completed purchase\n- `customer.subscription.updated` - Subscription status changed\n- `customer.subscription.deleted` - Subscription canceled\n- `invoice.payment_succeeded` - Recurring charge succeeded\n- `invoice.payment_failed` - Recurring charge failed\n\n### POST /api/stripe/portal\n\nCreate billing portal for subscription management.\n\n```javascript\nconst response = await fetch('/api/stripe/portal', {\n  method: 'POST',\n  headers: { 'Content-Type': 'application/json' },\n  body: JSON.stringify({\n    customerId: 'cus_...',\n    returnUrl: window.location.origin + '/account',\n  }),\n});\n\nconst { url } = await response.json();\nwindow.location.href = url; // Redirect to portal\n```\n\n### GET /api/user/subscription\n\nGet current user subscription status.\n\n```javascript\nconst response = await fetch('/api/user/subscription');\nconst { plan, status, currentPeriodEnd } = await response.json();\n// plan: 'free' | 'fundraising' | 'venture_studio'\n// status: 'active' | 'canceled' | 'past_due' | null\n```\n\n## Database Schema\n\nRequired tables:\n\n### user_subscriptions\n\n```sql\nCREATE TABLE user_subscriptions (\n  user_id TEXT PRIMARY KEY,\n  stripe_customer_id TEXT NOT NULL UNIQUE,\n  stripe_subscription_id TEXT,\n  stripe_price_id TEXT NOT NULL,\n  status TEXT NOT NULL,\n  current_period_start TIMESTAMP NOT NULL,\n  current_period_end TIMESTAMP NOT NULL,\n  canceled_at TIMESTAMP,\n  cancel_at_period_end BOOLEAN DEFAULT FALSE,\n  trial_start TIMESTAMP,\n  trial_end TIMESTAMP,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n```\n\n### stripe_events\n\n```sql\nCREATE TABLE stripe_events (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  stripe_event_id TEXT NOT NULL UNIQUE,\n  stripe_customer_id TEXT,\n  type TEXT NOT NULL,\n  status TEXT NOT NULL,\n  payload JSONB NOT NULL,\n  error TEXT,\n  created_at TIMESTAMP DEFAULT NOW(),\n  processed_at TIMESTAMP\n);\n```\n\n## Implementation Functions (TODO)\n\nIn `lib/db/subscriptions.ts`, implement:\n\n```typescript\n// Get subscription for user\ngetUserSubscription(userId: string): Promise<UserSubscription | null>\n\n// Create or update subscription\ncreatOrUpdateSubscription(subscription: Partial<UserSubscription>): Promise<UserSubscription>\n\n// Store webhook event (for idempotency)\nrecordStripeEvent(event: Partial<StripeEvent>): Promise<StripeEvent>\n\n// Check if event was already processed\ngetStripeEventById(id: string): Promise<StripeEvent | null>\n\n// Mark event as processed\nmarkEventAsProcessed(id: string): Promise<void>\n```\n\n## Test Cards\n\n```\n// Successful\n4242 4242 4242 4242 - Any future date, any CVC\n\n// Declined\n4000 0000 0000 0002 - Any future date, any CVC\n\n// 3D Secure\n4000 0025 0000 3155 - Any future date, any CVC\n```\n\nMore: https://stripe.com/docs/testing\n\n## Testing Webhooks Locally\n\n### Option 1: Stripe CLI (Recommended)\n\n```bash\nstripe login\nstripe listen --forward-to localhost:3000/api/stripe/webhook\nstripe trigger checkout.session.completed\n```\n\n### Option 2: ngrok\n\n```bash\nngrok http 3000\n# Update webhook URL in Stripe Dashboard\n# Run checkout flow\n```\n\n## Common Issues\n\n### \"Invalid webhook signature\"\n\n- Check `STRIPE_WEBHOOK_SECRET` value\n- Ensure raw request body (no JSON parsing before webhook)\n- Already handled in code\n\n### \"Duplicate charges\"\n\n- Idempotency key prevents checkout duplicates\n- Event deduplication prevents webhook retries\n- Check stripe_events table for duplicates\n\n### \"Test card rejected\"\n\n- Use test mode (pk_test_, sk_test_)\n- Use test card: 4242 4242 4242 4242\n- Any future date, any CVC\n\n### \"Webhook not receiving events\"\n\n- Verify endpoint URL is public\n- Check Stripe Dashboard > Webhooks > Events tab\n- Test with Stripe CLI: `stripe trigger ...`\n\n## Security Checklist\n\n- [x] No raw card data handled\n- [x] Webhook signatures verified\n- [x] Idempotent event processing\n- [x] Server-side validation\n- [x] Secret keys protected\n- [x] Timestamp validation (5 min)\n- [x] Input validation\n- [x] Quick webhook response (< 200ms)\n\n## Production Checklist\n\n- [ ] Switch to live mode\n- [ ] Update to live API keys (sk_live_, pk_live_)\n- [ ] Create live products & prices\n- [ ] Create live webhook endpoint\n- [ ] Test full flow in production mode\n- [ ] Enable monitoring/alerts\n- [ ] Test customer portal\n- [ ] Configure dunning management\n- [ ] Set up fraud detection\n- [ ] Enable email notifications\n\n## Documentation\n\nDetailed guides:\n- `STRIPE_IMPLEMENTATION_GUIDE.md` - Full setup & configuration\n- `STRIPE_SECURITY.md` - PCI compliance & security\n- `STRIPE_TESTING.md` - Test scenarios & debugging\n\nOfficial:\n- Stripe Docs: https://stripe.com/docs\n- API Reference: https://stripe.com/docs/api\n- Webhooks: https://stripe.com/docs/webhooks\n- Testing: https://stripe.com/docs/testing\n\n## Next Steps\n\n1. Read `STRIPE_IMPLEMENTATION_GUIDE.md` for full setup\n2. Set up Stripe account and get API keys\n3. Create database schema\n4. Implement database functions\n5. Configure environment variables\n6. Test with test cards\n7. Deploy and switch to live keys\n\n## Support\n\nFor issues:\n1. Check `STRIPE_TESTING.md` troubleshooting section\n2. Review Stripe Dashboard logs\n3. Check webhook delivery status\n4. Contact Stripe Support: https://support.stripe.com\n"