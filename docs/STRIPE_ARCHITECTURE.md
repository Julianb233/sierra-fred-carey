# Stripe Integration Architecture\n\n## System Overview\n\n```\n┌─────────────────────────────────────────────────────────────────────┐\n│                        Customer Browser                              │\n├─────────────────────────────────────────────────────────────────────┤\n│                                                                      │\n│  ┌────────────────────────────────────────────────────────────┐   │\n│  │            Pricing Component (pricing.tsx)                  │   │\n│  │  - Displays 3 subscription tiers                            │   │\n│  │  - \"Start Trial\" buttons for each tier                    │   │\n│  │  - Free tier redirects to /get-started                     │   │\n│  │  - Paid tiers trigger checkout via useSubscription hook    │   │\n│  └────────────────────────────────────────────────────────────┘   │\n│                              │                                       │\n│                              ▼                                       │\n│  ┌────────────────────────────────────────────────────────────┐   │\n│  │         Stripe.js (Client Library)                          │   │\n│  │  - Loaded once via getStripe()                             │   │\n│  │  - Never handles card numbers                              │   │\n│  │  - Only creates checkout sessions                          │   │\n│  └────────────────────────────────────────────────────────────┘   │\n│                              │                                       │\n└──────────────────────────────┼───────────────────────────────────────┘\n                               │\n                               ▼\n                   ┌───────────────────────┐\n                   │   /api/stripe/       │\n                   │   checkout (POST)    │\n                   └───────────────────────┘\n                               │\n┌──────────────────────────────┼───────────────────────────────────────┐\n│                    Next.js Server                                    │\n├──────────────────────────────┼───────────────────────────────────────┤\n│                              │                                        │\n│                    ┌─────────▼──────────┐                            │\n│                    │ Checkout Handler   │                            │\n│                    │ ─────────────────  │                            │\n│                    │ 1. Validate input  │                            │\n│                    │ 2. Verify price ID │                            │\n│                    │ 3. Create session  │                            │\n│                    └────────┬───────────┘                            │\n│                             │                                        │\n│                             ▼                                        │\n│            ┌─────────────────────────────────┐                      │\n│            │   Stripe SDK (Node.js)          │                      │\n│            │  ─────────────────────────────  │                      │\n│            │  - Secret key: sk_test_...      │                      │\n│            │  - Creates checkout session     │                      │\n│            │  - Returns session.url          │                      │\n│            └─────────────┬───────────────────┘                      │\n│                          │                                           │\n└──────────────────────────┼───────────────────────────────────────────┘\n                           │\n                           ▼\n                ┌──────────────────────┐\n                │  Stripe Checkout     │\n                │  (Hosted by Stripe)  │\n                ├──────────────────────┤\n                │ PCI Compliant        │\n                │ - Card field iframe  │\n                │ - Secure payment     │\n                │ - No data touches    │\n                │   our servers        │\n                └──────────┬───────────┘\n                           │\n                           ▼\n                ┌──────────────────────┐\n                │ Customer Returns     │\n                │ (success or cancel)  │\n                └──────────┬───────────┘\n                           │\n                           ▼\n          /billing?success=true  or  /pricing\n\n```\n\n## Webhook Flow\n\n```\n┌──────────────────────────────────────────────────────────────┐\n│                      Stripe Systems                          │\n├──────────────────────────────────────────────────────────────┤\n│                                                              │\n│  Customer completes checkout → Subscription created         │\n│           │                                                  │\n│           ▼                                                  │\n│  Stripe generates event: checkout.session.completed        │\n│           │                                                  │\n│           └─► Event Queue (with retries)                   │\n│                │                                             │\n│                ├─ Sign with webhook secret                  │\n│                ├─ Add timestamp                             │\n│                └─ Add event ID                              │\n│                       │                                      │\n└───────────────────────┼──────────────────────────────────────┘\n                        │\n                        │ HTTPS POST\n                        │ stripe-signature: hmac_sha256\n                        │\n                        ▼\n        ┌───────────────────────────────────┐\n        │ /api/stripe/webhook (POST)        │\n        └───────────────────────────────────┘\n                        │\n┌───────────────────────┼──────────────────────────────────────┐\n│       Next.js Server: Webhook Handler                       │\n├───────────────────────┼──────────────────────────────────────┤\n│                       │                                       │\n│        Step 1: VERIFY SIGNATURE                             │\n│        ┌──────────────┴────────────────┐                     │\n│        │ Get signature from header     │                     │\n│        │ Use secret: STRIPE_WEBHOOK_   │                     │\n│        │             SECRET            │                     │\n│        │ Verify HMAC SHA256            │                     │\n│        └──────────────┬────────────────┘                     │\n│                       │                                       │\n│      ✓ Valid │ ✗ Invalid                                    │\n│       │      │     │                                         │\n│       │      └─────┴─► Return 401 Unauthorized              │\n│       │                                                      │\n│        Step 2: CHECK TIMESTAMP                              │\n│        ┌──────────────┴────────────────┐                     │\n│        │ If event > 5 minutes old      │                     │\n│        │ Return 200 (ignore)           │                     │\n│        │ (prevents replay attacks)     │                     │\n│        └──────────────┬────────────────┘                     │\n│                       │                                       │\n│        Step 3: CHECK IDEMPOTENCY                            │\n│        ┌──────────────┴────────────────┐                     │\n│        │ Query: SELECT * FROM          │                     │\n│        │ stripe_events WHERE           │                     │\n│        │ stripe_event_id = event.id    │                     │\n│        │                               │                     │\n│        │ If found: Already processed   │                     │\n│        │ Return 200 (skip)             │                     │\n│        │                               │                     │\n│        │ If not found: Continue        │                     │\n│        └──────────────┬────────────────┘                     │\n│                       │                                       │\n│        Step 4: RECORD EVENT                                 │\n│        ┌──────────────┴────────────────┐                     │\n│        │ INSERT into stripe_events     │                     │\n│        │ status = 'pending'            │                     │\n│        │ (Preserve for audit trail)    │                     │\n│        └──────────────┬────────────────┘                     │\n│                       │                                       │\n│        Step 5: RETURN 200 OK IMMEDIATELY                    │\n│        ┌──────────────┴────────────────┐                     │\n│        │ Response: {\"received\": true}  │                     │\n│        │ Time: < 200ms                 │                     │\n│        │ (Prevents timeout retries)    │                     │\n│        └──────────────┬────────────────┘                     │\n│                       │                                       │\n└───────────────────────┼──────────────────────────────────────┘\n                        │\n                        │ (Async processing continues in background)\n                        │\n                        ▼\n        ┌─────────────────────────────┐\n        │ Handle Event Asynchronously │\n        ├─────────────────────────────┤\n        │ Based on event type:        │\n        │                             │\n        │ checkout.session.completed: │\n        │  → CREATE subscription      │\n        │  → Store customer ID        │\n        │                             │\n        │ subscription.updated:       │\n        │  → UPDATE subscription      │\n        │  → Update status            │\n        │                             │\n        │ subscription.deleted:       │\n        │  → MARK as canceled         │\n        │                             │\n        │ invoice.payment_succeeded:  │\n        │  → LOG payment              │\n        │                             │\n        │ invoice.payment_failed:     │\n        │  → UPDATE to past_due       │\n        │  → SEND notification        │\n        └──────────────┬──────────────┘\n                       │\n                       ▼\n        ┌─────────────────────────────┐\n        │ UPDATE stripe_events        │\n        │ status = 'processed'        │\n        │ processed_at = NOW()        │\n        └─────────────────────────────┘\n\n```\n\n## Database Schema\n\n```\n┌─────────────────────────────────────────────────────┐\n│                 user_subscriptions                  │\n├─────────────────────────────────────────────────────┤\n│ user_id (PK)          │ Your app's user ID          │\n│ stripe_customer_id    │ cus_... from Stripe         │\n│ stripe_subscription_id│ sub_... from Stripe         │\n│ stripe_price_id       │ price_... from Stripe       │\n│ status                │ active/canceled/past_due    │\n│ current_period_start  │ TIMESTAMP                   │\n│ current_period_end    │ TIMESTAMP (renewal date)    │\n│ canceled_at           │ TIMESTAMP or NULL           │\n│ cancel_at_period_end  │ Boolean                     │\n│ trial_start           │ TIMESTAMP or NULL           │\n│ trial_end             │ TIMESTAMP or NULL           │\n│ created_at            │ TIMESTAMP                   │\n│ updated_at            │ TIMESTAMP                   │\n└─────────────────────────────────────────────────────┘\n\n┌─────────────────────────────────────────────────────┐\n│               stripe_events                         │\n├─────────────────────────────────────────────────────┤\n│ id (PK)               │ UUID (unique)               │\n│ stripe_event_id       │ evt_... (Stripe event ID)   │\n│ stripe_customer_id    │ cus_... (for lookup)        │\n│ type                  │ Event type string           │\n│ status                │ pending/processed/failed     │\n│ payload               │ JSONB (full event data)     │\n│ error                 │ Error message or NULL       │\n│ created_at            │ TIMESTAMP                   │\n│ processed_at          │ TIMESTAMP or NULL           │\n└─────────────────────────────────────────────────────┘\n\nIndexes:\n- user_subscriptions: (stripe_customer_id) UNIQUE\n- stripe_events: (stripe_event_id) UNIQUE\n- stripe_events: (stripe_customer_id)\n- stripe_events: (status)\n\nFlow: event.id → stripe_events lookup → check if processed\n\n```\n\n## Pricing Configuration\n\n```\nSTRIPE_PLANS (in lib/stripe/config.ts)\n│\n├─► STRIPE_PLANS.FREE\n│   ├─ id: \"free\"\n│   ├─ name: \"Founder Decision OS\"\n│   ├─ priceId: null (no payment)\n│   ├─ price: 0\n│   └─ features: [...]\n│\n├─► STRIPE_PLANS.FUNDRAISING\n│   ├─ id: \"fundraising\"\n│   ├─ name: \"Fundraising & Strategy\"\n│   ├─ priceId: process.env.NEXT_PUBLIC_STRIPE_FUNDRAISING_PRICE_ID\n│   ├─ price: 99 (monthly)\n│   └─ features: [...]\n│\n└─► STRIPE_PLANS.VENTURE_STUDIO\n    ├─ id: \"venture_studio\"\n    ├─ name: \"Venture Studio\"\n    ├─ priceId: process.env.NEXT_PUBLIC_STRIPE_VENTURE_STUDIO_PRICE_ID\n    ├─ price: 249 (monthly)\n    └─ features: [...]\n\nUsage:\n1. Pricing page displays plans from STRIPE_PLANS\n2. Checkout validates priceId against allowed plans\n3. useSubscription hook determines user's current plan\n4. Feature gates check against plan hierarchy\n\n```\n\n## Security Layers\n\n```\n┌──────────────────────────────────────────────────────────┐\n│              Input Validation Layer                      │\n├──────────────────────────────────────────────────────────┤\n│ • Email format check (regex)                            │\n│ • Price ID whitelist (allowed values only)              │\n│ • URL HTTPS validation (no http://)                     │\n│ • Required field checks (priceId, userId, email)        │\n└────────────┬─────────────────────────────────────────────┘\n             │\n┌────────────▼─────────────────────────────────────────────┐\n│            Signature Verification Layer                  │\n├──────────────────────────────────────────────────────────┤\n│ • Stripe-signature header present?                      │\n│ • HMAC SHA256 with STRIPE_WEBHOOK_SECRET                │\n│ • Signature verification fails → 401                    │\n│ • Never process unverified webhooks                     │\n└────────────┬─────────────────────────────────────────────┘\n             │\n┌────────────▼─────────────────────────────────────────────┐\n│           Timestamp Validation Layer                     │\n├──────────────────────────────────────────────────────────┤\n│ • Event created timestamp extracted                     │\n│ • Check: current_time - event_created < 300 seconds    │\n│ • Old events: return 200 but don't process              │\n│ • Prevents replay attacks                              │\n└────────────┬─────────────────────────────────────────────┘\n             │\n┌────────────▼─────────────────────────────────────────────┐\n│          Idempotency Check Layer                         │\n├──────────────────────────────────────────────────────────┤\n│ • Query: SELECT * FROM stripe_events                   │\n│          WHERE stripe_event_id = ?                     │\n│ • Found → Already processed, skip                       │\n│ • Not found → Continue processing                      │\n│ • Prevents duplicate charges from retries              │\n└────────────┬─────────────────────────────────────────────┘\n             │\n┌────────────▼─────────────────────────────────────────────┐\n│         Server-Side Verification Layer                   │\n├──────────────────────────────────────────────────────────┤\n│ • Stripe SDK verifies price matches priceId            │\n│ • Cannot modify amount in browser (Stripe checks)      │\n│ • Cannot use fake priceIds (validated whitelist)       │\n│ • Database confirms subscription after creation        │\n└────────────┬─────────────────────────────────────────────┘\n             │\n┌────────────▼─────────────────────────────────────────────┐\n│              Response Management Layer                   │\n├──────────────────────────────────────────────────────────┤\n│ • Return 2xx immediately (< 200ms)                     │\n│ • No error details in responses (prevent info leaks)    │\n│ • No card data in logs or responses                    │\n│ • Async processing avoids timeouts                     │\n└──────────────────────────────────────────────────────────┘\n\n```\n\n## Feature Gating\n\n```\nUser Plan Hierarchy:\n\n  free (0)\n    |\n    ├─ Core Decision OS features\n    ├─ Red Flag Detection\n    └─ No access to premium features\n\n  fundraising (1)\n    |\n    ├─ Everything in free tier\n    ├─ Investor Lens\n    ├─ Pitch Deck Review\n    └─ Strategy Documents\n\n  venture_studio (2)\n    |\n    ├─ Everything in fundraising tier\n    ├─ Boardy integration\n    ├─ Investor targeting\n    └─ Virtual Team agents\n\nUsage in components:\n  const hasVentureStudio = useHasFeature('venture_studio');\n  if (!hasVentureStudio) {\n    return <UpgradePrompt />;\n  }\n\n```\n\n## Deployment Flow\n\n```\n┌─────────────────────────────────────────────────────────┐\n│                Local Development                        │\n├─────────────────────────────────────────────────────────┤\n│ • Use sk_test_, pk_test_ keys                          │\n│ • Webhook via ngrok or Stripe CLI                      │\n│ • Test with 4242 4242 4242 4242                       │\n│ • Database: local PostgreSQL/SQLite                    │\n│ • npm run dev                                          │\n└────────────────┬──────────────────────────────────────┘\n                 │\n                 ▼\n┌─────────────────────────────────────────────────────────┐\n│              Staging Environment                        │\n├─────────────────────────────────────────────────────────┤\n│ • Still use sk_test_, pk_test_ keys                    │\n│ • Production database replica                          │\n│ • Webhook via public URL                               │\n│ • Test full flow with test cards                       │\n│ • Deploy via staging branch                            │\n└────────────────┬──────────────────────────────────────┘\n                 │\n                 ▼\n┌─────────────────────────────────────────────────────────┐\n│              Production Environment                     │\n├─────────────────────────────────────────────────────────┤\n│ • Switch to sk_live_, pk_live_ keys                    │\n│ • Production database                                  │\n│ • Live Stripe webhook endpoint                         │\n│ • Real credit cards accepted                           │\n│ • Deploy via main branch                               │\n│ • Monitor webhook logs                                 │\n│ • Set up alerts for failures                           │\n└─────────────────────────────────────────────────────────┘\n\n```\n\nKey takeaway: Same code, different credentials!\n\n## Error Handling Flow\n\n```\nCheckout Error:\n  ✗ Missing field → 400 Bad Request\n  ✗ Invalid price → 400 Bad Request\n  ✗ Stripe API down → 500 Internal Server Error\n  → User sees error message and can retry\n\nWebhook Error:\n  ✗ Invalid signature → 401 Unauthorized\n  ✗ Old event → 200 OK (ignore)\n  ✗ Duplicate event → 200 OK (idempotent)\n  ✗ Processing error → 500 (Stripe retries)\n  → Always return quickly to Stripe\n\nPayment Error:\n  ✗ Card declined → Stripe shows error, checkout fails\n  ✗ Expired card → Stripe shows error, checkout fails\n  ✗ 3D Secure required → Stripe shows challenge\n  → User prompted to fix payment method\n\n```\n\nThis architecture ensures:\n- Security first (verification at every step)\n- PCI compliance (no card handling)\n- Reliability (idempotent, retry-safe)\n- User experience (quick responses, clear errors)\n"