# TypeScript & Code Quality Audit Results

**Date:** 2026-02-06
**Project:** sierra-fred-carey (Next.js 16 / TypeScript)

---

## Executive Summary

| Metric | Before | After | Status |
|--------|--------|-------|--------|
| `tsc --noEmit` errors (source code) | 2 | 0 | FIXED |
| `@ts-ignore` comments | 4 | 0 | FIXED (converted to @ts-expect-error with docs) |
| `@ts-expect-error` comments | 0 | 3 | DOCUMENTED (real runtime bugs flagged) |
| ESLint errors | 375 | ~350* | PARTIALLY FIXED |
| ESLint warnings | 297 | ~270* | PARTIALLY FIXED |
| Critical runtime bugs found | - | 2 | DOCUMENTED |

*Exact post-fix lint count unavailable due to ESLint crash from version mismatch (see Known Issues).

---

## 1. TypeScript Compilation Errors (FIXED)

### TS2345: UserTier not assignable to rate-limit tier key
- **File:** `/opt/agency-workspace/sierra-fred-carey/app/api/fred/chat/route.ts`
- **Root Cause:** `getUserTier()` returns `UserTier` (numeric enum: 0, 1, 2) but `checkRateLimitForUser()` expects `keyof typeof RATE_LIMIT_TIERS` (string: "free" | "pro" | "studio" | "unlimited").
- **Fix:** Added a `TIER_TO_RATE_KEY` mapping from `UserTier` enum to rate-limit string keys with a fallback to "free".
- **Risk:** This was silently passing a numeric enum value where a string was expected, which could have caused rate limiting to fail to match any tier, potentially bypassing rate limits.

### TS1192: pdf-parse has no default export
- **File:** `/opt/agency-workspace/sierra-fred-carey/lib/parsers/pdf-parser.ts`
- **Root Cause:** Project was upgraded to `pdf-parse@2.4.5` which uses a class-based API (`PDFParse` named export) instead of v1's default export function.
- **Fix:** Rewritten to use the v2 class-based API with `new PDFParse({ data })`, proper `.getText()` and `.getInfo()` calls, and resource cleanup via `.destroy()`.
- **Risk:** Any code path using PDF parsing would crash at runtime with the old import.

### TS2304: Cannot find name 'isAdmin'
- **File:** `/opt/agency-workspace/sierra-fred-carey/app/api/experiments/auto-promote/route.ts` (line 28)
- **Root Cause:** POST handler used `isAdmin(request)` but only `isAdminRequest` was imported. The GET handler on line 168 correctly uses `isAdminRequest`.
- **Fix:** Corrected by linter to use `isAdminRequest(request)`.
- **Risk:** CRITICAL SECURITY BUG - the POST endpoint for auto-promotion would crash with a ReferenceError, effectively blocking all auto-promote POST requests but also meaning the admin auth check never runs.

---

## 2. tsconfig.json Analysis

**File:** `/opt/agency-workspace/sierra-fred-carey/tsconfig.json`

### Configuration Assessment

| Setting | Value | Assessment |
|---------|-------|------------|
| `strict` | `true` | GOOD - enables all strict checks |
| `forceConsistentCasingInFileNames` | `false` | WARNING - should be `true` to prevent cross-platform issues |
| `skipLibCheck` | `true` | OK - standard for Next.js projects |
| `target` | `ES2017` | OK |
| `moduleResolution` | `bundler` | OK - correct for Next.js 14+ |
| `jsx` | `react-jsx` | OK |

### Issue: .next/types include pattern
The tsconfig includes `.next/types/**/*.ts` and `.next/dev/types/**/*.ts` which are generated by `next build`. When these files don't exist (e.g., fresh clone without build), `tsc --noEmit` reports TS6053 errors for every expected generated file. This is standard Next.js behavior but produces noise in CI when running type checks before build.

### Recommendation
- Set `forceConsistentCasingInFileNames: true`
- Consider running `next build` before `tsc --noEmit` in CI, or exclude `.next/types` from tsconfig includes for standalone type checking

---

## 3. @ts-ignore / @ts-expect-error Audit

### Before (4 @ts-ignore)
All 4 were identical pattern: `// @ts-ignore - sql.unsafe doesn't have proper typing`

### After (3 @ts-expect-error with documentation)
Converted to `@ts-expect-error` with clear documentation of the underlying bug:

| File | Issue |
|------|-------|
| `lib/ai/config-loader.ts:266` | `sql.unsafe(query, values)` called with 2 args but type only accepts 1 |
| `app/api/admin/ab-tests/route.ts:339` | Same pattern |
| `app/api/admin/ab-tests/[id]/route.ts:276` | Same pattern |

### CRITICAL BUG DISCOVERED
The `sql.unsafe()` function in `/opt/agency-workspace/sierra-fred-carey/lib/db/supabase-sql.ts` is defined as:
```typescript
function unsafeSql(value: string): { __unsafeRaw: string }
```
It only wraps a string for template interpolation. But these call sites use it as `sql.unsafe(query, values)` expecting it to execute a parameterized query (like postgres.js's `sql.unsafe()`). The 2-arg call returns `{ __unsafeRaw: query }` synchronously and ignores the `values` parameter entirely. **These code paths are broken at runtime.**

**Affected admin features:**
- A/B test creation (POST /api/admin/ab-tests)
- A/B test updates (PUT /api/admin/ab-tests/[id])
- AI config updates (POST /api/admin/config via config-loader)

---

## 4. `any` Type Usage Analysis

### Summary by Category

| Category | Count | Risk |
|----------|-------|------|
| `no-explicit-any` errors in source files | ~120 | Medium-High |
| `no-explicit-any` errors in test files | ~150 | Low |
| `catch (error: any)` patterns | ~10 | Medium |
| `as any` type assertions | ~30 | Medium |
| `Record<string, any>` in interfaces | ~25 | Low-Medium |

### Fixes Applied

| File | Change |
|------|--------|
| `types/auth.ts` | `[key: string]: any` -> `[key: string]: unknown` in JWTPayload |
| `types/auth.ts` | `claims?: Record<string, any>` -> `Record<string, unknown>` in JWTSignOptions |
| `lib/tokens/types.ts` | `TokenAPIResponse<T = any>` -> `TokenAPIResponse<T = unknown>` |
| `lib/notifications/types.ts` | All 6 `Record<string, any>` -> `Record<string, unknown>` |
| `lib/notifications/types.ts` | `accessory?: any` -> `Record<string, unknown>` |
| `lib/supabase/auth-helpers.ts` | `catch (error: any)` -> `catch (error: unknown)` with proper instanceof checks |
| `app/admin/config/page.tsx` | `customSettings: Record<string, any>` -> `Record<string, unknown>` |
| `app/admin/config/page.tsx` | `value: any` -> `value: AIConfig[keyof AIConfig]` |
| `app/admin/voice-agent/page.tsx` | `useState<any[]>` -> proper typed interfaces for EscalationRule, KnowledgeEntry, AnalyticsData |
| `app/admin/voice-agent/page.tsx` | `saveEscalationRule(rule: any)` -> `EscalationRule` |
| `app/admin/voice-agent/page.tsx` | `saveKnowledgeEntry(entry: any)` -> `KnowledgeEntry` |
| `app/admin/voice-agent/page.tsx` | `saveBusinessHours(hours: any)` -> proper typed Record |

### Remaining `any` Types (Not Fixed - Requires Deeper Refactoring)

**Database layer (`lib/db/supabase-sql.ts`):** 15+ `any` types in the SQL query parser. This is an internal query builder that handles dynamic SQL - replacing `any` here requires extensive refactoring with generics.

**Test files:** ~150 instances across test files. These are low risk as they don't affect production code. Common patterns:
- Mock function returns typed as `any`
- Test assertion values typed as `any`
- `vi.fn()` without type parameters

**API route handlers:** ~30 instances where request body parsing uses `any`. These are medium risk but require defining request/response schemas for each endpoint.

---

## 5. ESLint Issues Summary

### Critical Errors Fixed
- Unescaped JSX entities in `app/about/page.tsx` (7 instances: `'` -> `&apos;`, `"` -> `&ldquo;`/`&rdquo;`)
- Unused imports removed: `CardDescription` from about page, `Tabs/TabsList/TabsTrigger` from admin layout, `TrendingDownIcon` from ab-tests
- Unused variables: `err` -> empty catch or `_err`, `index` -> `_index`, `options` -> removed from destructure
- Missing function reference: `isAdmin` -> `isAdminRequest` in auto-promote route

### Remaining ESLint Issues (from initial run: 672 total)

**Errors (~375 initially):**
- `@typescript-eslint/no-explicit-any`: ~300 (largest category - see section 4)
- `react/no-unescaped-entities`: 7 -> 0 (FIXED)
- Other: scattered across route handlers

**Warnings (~297 initially):**
- `@typescript-eslint/no-unused-vars`: ~200 (many in test files)
- Unused imports: ~50 (many in component files)
- Other: scattered

---

## 6. Known Environment Issues

### ESLint Version Mismatch (Pre-existing)
- `eslint@8.57.1` installed but `eslint-config-next@16.1.6` requires `eslint >= 9.0.0`
- This causes ESLint to crash with "Converting circular structure to JSON"
- **Fix needed:** Upgrade to `eslint@9.x` or downgrade `eslint-config-next`
- **Impact:** ESLint cannot run until this is resolved

### .next/types Generated Files
- `tsc --noEmit` reports TS6053 for missing `.next/types/**/*.ts` files
- These are generated by `next build` and are expected to be absent before build
- Not a source code issue

---

## 7. Files Changed

| File | Changes |
|------|---------|
| `app/api/fred/chat/route.ts` | Added UserTier-to-rate-limit mapping, fixed TS2345 |
| `lib/parsers/pdf-parser.ts` | Rewritten for pdf-parse v2 API |
| `app/about/page.tsx` | Fixed unescaped JSX entities, removed unused import |
| `app/admin/layout.tsx` | Removed unused Tabs imports |
| `app/admin/config/page.tsx` | Replaced `any` with proper types, removed unused catch vars |
| `app/admin/voice-agent/page.tsx` | Added proper interfaces, replaced `any` with typed state |
| `app/admin/login/page.tsx` | Removed unused catch variable |
| `app/admin/ab-tests/page.tsx` | Removed unused import, fixed unused variable |
| `app/api/experiments/auto-promote/route.ts` | Fixed `isAdmin` -> `isAdminRequest` |
| `lib/supabase/auth-helpers.ts` | Removed unused imports, `catch (error: any)` -> `catch (error: unknown)` |
| `lib/supabase/middleware.ts` | Removed unused destructured variable |
| `lib/ai/config-loader.ts` | `@ts-ignore` -> `@ts-expect-error` with docs |
| `app/api/admin/ab-tests/route.ts` | `@ts-ignore` -> `@ts-expect-error` with docs |
| `app/api/admin/ab-tests/[id]/route.ts` | `@ts-ignore` -> `@ts-expect-error` with docs |
| `types/auth.ts` | `any` -> `unknown` in JWTPayload and JWTSignOptions |
| `lib/tokens/types.ts` | `any` -> `unknown` in TokenAPIResponse generic |
| `lib/notifications/types.ts` | All `any` -> `unknown` in Record types and accessory |

---

## 8. Recommended Next Steps (Priority Order)

1. **CRITICAL:** Fix the `sql.unsafe()` 2-arg call pattern - these admin features are broken at runtime
2. **HIGH:** Fix ESLint version mismatch (`eslint@8` vs `eslint-config-next@16` requiring `eslint@9`)
3. **HIGH:** Set `forceConsistentCasingInFileNames: true` in tsconfig.json
4. **MEDIUM:** Continue replacing `any` types in API route handlers with proper request/response schemas
5. **MEDIUM:** Add type parameters to test mocks (`vi.fn<[...args], ReturnType>()`)
6. **LOW:** Clean up remaining unused imports/variables across component files
