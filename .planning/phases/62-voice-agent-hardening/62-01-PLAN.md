---
phase: 62-voice-agent-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - components/dashboard/call-fred-modal.tsx
  - app/api/livekit/webhook/route.ts
  - app/api/fred/call/summary/route.ts
  - workers/voice-agent/agent.ts
autonomous: true

must_haves:
  truths:
    - "User sees 'Reconnecting...' banner during network interruption, banner disappears when reconnected"
    - "Webhook metadata is preserved across room lifecycle (room_started fields not overwritten by room_finished)"
    - "Summary endpoint rejects transcript arrays larger than 500 entries"
    - "Agent identity detection correctly identifies AI agent vs human user named Fred"
    - "Voice agent worker handles connect() and waitForParticipant() failures gracefully"
  artifacts:
    - path: "components/dashboard/call-fred-modal.tsx"
      provides: "Reconnection UI with Reconnecting/Reconnected event handlers"
      contains: "RoomEvent.Reconnecting"
    - path: "app/api/livekit/webhook/route.ts"
      provides: "Fixed metadata merge and agent identity detection"
      contains: "fred-cary-voice"
    - path: "app/api/fred/call/summary/route.ts"
      provides: "Transcript size limit"
      contains: ".max(500)"
    - path: "workers/voice-agent/agent.ts"
      provides: "Error handling around connect/waitForParticipant"
      contains: "try"
  key_links:
    - from: "components/dashboard/call-fred-modal.tsx"
      to: "livekit-client RoomEvent"
      via: "Reconnecting/Reconnected event listeners"
      pattern: "RoomEvent\\.Reconnect"
    - from: "app/api/livekit/webhook/route.ts"
      to: "supabase video_rooms"
      via: "metadata merge on room_finished"
      pattern: "existingRoom.*metadata"
---

<objective>
Harden the voice call client UI and fix remaining MEDIUM-severity bugs across webhook, summary, and worker.

Purpose: Address reconnection UX gap (users see no feedback during network hiccups) and fix 4 bugs identified in voice audit reports (metadata overwrite, no transcript limit, fragile agent identity, unhandled worker errors).

Output: Updated call-fred-modal.tsx with reconnection UI, fixed webhook handler, hardened summary endpoint, and robust worker error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/62-voice-agent-hardening/62-RESEARCH.md
@components/dashboard/call-fred-modal.tsx
@app/api/livekit/webhook/route.ts
@app/api/fred/call/summary/route.ts
@workers/voice-agent/agent.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnection UI and connection quality indicator to CallFredModal</name>
  <files>components/dashboard/call-fred-modal.tsx</files>
  <action>
Add reconnection handling to the CallFredModal component:

1. Add a `connectionStatus` state: `useState<'connected' | 'reconnecting'>('connected')`

2. In `handleStartCall`, after `room.on(RoomEvent.Disconnected, ...)`, add two new event listeners:
   - `room.on(RoomEvent.Reconnecting, () => setConnectionStatus('reconnecting'))`
   - `room.on(RoomEvent.Reconnected, () => setConnectionStatus('connected'))`

3. Reset `connectionStatus` to `'connected'` in the modal open reset effect (alongside other state resets).

4. In the in-call UI section (where `callState === "in-call"`), add a reconnecting banner ABOVE the transcript area:
   ```tsx
   {connectionStatus === 'reconnecting' && (
     <div className="bg-yellow-100 dark:bg-yellow-900/30 text-yellow-800 dark:text-yellow-200 text-xs text-center py-1.5 rounded-md flex items-center justify-center gap-2">
       <Loader2 className="h-3 w-3 animate-spin" />
       Reconnecting...
     </div>
   )}
   ```

5. Optionally log reconnection events to console for debugging:
   `console.log('[CallFred] Reconnecting...')` and `console.log('[CallFred] Reconnected')`

Do NOT refactor to @livekit/components-react -- the manual Room API is already working with correct event handlers. Only ADD the reconnection events.
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify RoomEvent.Reconnecting and RoomEvent.Reconnected are valid enum members (they are in livekit-client v2.16.1).
  </verify>
  <done>
CallFredModal shows a yellow "Reconnecting..." banner during network interruption and hides it when connection recovers. No type errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix webhook metadata merge, agent identity detection, transcript limit, and worker error handling</name>
  <files>
    app/api/livekit/webhook/route.ts
    app/api/fred/call/summary/route.ts
    workers/voice-agent/agent.ts
  </files>
  <action>
Fix 4 MEDIUM-severity audit findings:

**A. Webhook metadata merge (app/api/livekit/webhook/route.ts)**

In the `room_finished` handler (around line 107-128), change the metadata update to MERGE with existing metadata instead of overwriting:

1. Update the existing `select` query to also fetch `metadata`:
   `.select('id, started_at, metadata')`

2. Replace the hardcoded metadata object with a merged one:
   ```typescript
   const mergedMetadata = {
     ...(room?.metadata as Record<string, unknown> || {}),
     livekit_sid: event.room?.sid,
     duration_seconds: durationSeconds,
   };
   ```

3. Use `mergedMetadata` in the update call instead of the inline object.

**B. Agent identity detection (app/api/livekit/webhook/route.ts)**

In `extractUserIdFromIdentity()` (around line 297-304), replace the fragile prefix check:

```typescript
function extractUserIdFromIdentity(identity: string): string | null {
  if (!identity) return null;
  // AI agents use exact identity 'fred-cary-voice' or prefix 'ai-agent'
  if (identity === 'fred-cary-voice' || identity.startsWith('ai-agent')) return null;
  // If it looks like a UUID, return it
  if (identity.length >= 32) return identity;
  return null;
}
```

This checks for the EXACT agent name `fred-cary-voice` (matching the FRED_AGENT_NAME constant in the call route) instead of any string starting with "fred".

**C. Transcript size limit (app/api/fred/call/summary/route.ts)**

In the `summaryRequestSchema` (around line 27), add `.max(500)` to the transcript array:

```typescript
transcript: z.array(
  z.object({
    speaker: z.enum(["user", "fred"]),
    text: z.string(),
    timestamp: z.string().optional(),
  })
).max(500),
```

This prevents malicious/buggy clients from sending huge transcript arrays causing expensive LLM calls.

**D. Worker error handling (workers/voice-agent/agent.ts)**

Wrap `ctx.connect()` and `ctx.waitForParticipant()` in try/catch blocks:

```typescript
entry: async (ctx: JobContext) => {
  try {
    await ctx.connect();
  } catch (err) {
    console.error('[Fred Voice Agent] Failed to connect:', err);
    return;
  }

  let participant;
  try {
    participant = await ctx.waitForParticipant();
  } catch (err) {
    console.error('[Fred Voice Agent] Participant wait failed:', err);
    return;
  }

  console.log(`[Fred Voice Agent] Participant joined: ${participant.identity}`);
  // ... rest of the function unchanged ...
}
```

Keep everything after waitForParticipant unchanged (encoder, publishTranscript, STT/LLM/TTS creation, session setup, shutdown callback, session.start, delay, greeting).
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors across all 3 files. Verify the webhook metadata field now includes spread of existing metadata. Verify extractUserIdFromIdentity checks for exact 'fred-cary-voice' string. Verify transcript schema has .max(500). Verify agent.ts has try/catch around connect and waitForParticipant.
  </verify>
  <done>
Four MEDIUM-severity audit findings fixed: metadata merge preserves room_started fields, agent identity detection is exact-match, transcript array is capped at 500, and worker handles connection failures gracefully. All files pass type checking.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no new errors
2. `call-fred-modal.tsx` contains `RoomEvent.Reconnecting` and `RoomEvent.Reconnected` handlers
3. `webhook/route.ts` merges metadata in room_finished handler (spread operator on existing metadata)
4. `webhook/route.ts` extractUserIdFromIdentity checks for exact `'fred-cary-voice'` string
5. `summary/route.ts` transcript array has `.max(500)` constraint
6. `agent.ts` has try/catch around `ctx.connect()` and `ctx.waitForParticipant()`
</verification>

<success_criteria>
- Reconnection UI shows yellow banner during network interruption
- Webhook metadata is merged, not overwritten
- Agent identity detection uses exact match, not prefix
- Transcript size is limited to 500 entries
- Worker handles connection failures without crashing
- All files pass TypeScript type checking
</success_criteria>

<output>
After completion, create `.planning/phases/62-voice-agent-hardening/62-01-SUMMARY.md`
</output>
