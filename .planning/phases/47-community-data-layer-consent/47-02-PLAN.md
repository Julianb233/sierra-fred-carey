---
phase: 47-community-data-layer-consent
plan: 02
type: execute
wave: 2
depends_on: ["47-01"]
files_modified:
  - lib/db/consent.ts
  - app/api/community/consent/route.ts
  - components/settings/ConsentSettings.tsx
  - app/dashboard/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can view their current consent preferences in Settings"
    - "User can toggle each consent category (benchmarks, social_feed, directory, messaging) independently"
    - "Toggling consent persists to database and survives page refresh"
    - "All consent categories default to OFF (opt-in model)"
    - "Every consent change is recorded in the audit log automatically (via DB trigger)"
  artifacts:
    - path: "lib/db/consent.ts"
      provides: "Consent CRUD with merge-with-defaults pattern"
      exports: ["getConsentPreferences", "updateConsentPreference", "isConsentEnabled", "CONSENT_DEFAULTS", "CONSENT_CATEGORIES"]
      min_lines: 80
    - path: "app/api/community/consent/route.ts"
      provides: "GET and PUT endpoints for consent preferences"
      exports: ["GET", "PUT"]
    - path: "components/settings/ConsentSettings.tsx"
      provides: "Consent management UI component with toggle switches"
      min_lines: 60
  key_links:
    - from: "components/settings/ConsentSettings.tsx"
      to: "/api/community/consent"
      via: "fetch GET on mount, fetch PUT on toggle"
      pattern: "fetch.*api/community/consent"
    - from: "app/api/community/consent/route.ts"
      to: "lib/db/consent.ts"
      via: "import getConsentPreferences, updateConsentPreference"
      pattern: "import.*from.*lib/db/consent"
    - from: "app/dashboard/settings/page.tsx"
      to: "components/settings/ConsentSettings.tsx"
      via: "import and render ConsentSettings component"
      pattern: "ConsentSettings"
---

<objective>
Build the consent management system: a CRUD module following the push preferences pattern, API routes for reading/updating consent, and a Settings UI section where founders control granular data sharing.

Purpose: Consent is the gatekeeper for ALL community data sharing. The anonymized data pipeline (Plan 05), social feed (Phase 49), directory (Phase 52), and messaging (Phase 52) all depend on consent being queryable at the database level. This plan delivers the opt-in infrastructure and user-facing controls.

Output: Consent CRUD module, API routes, and Settings UI component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/47-community-data-layer-consent/47-RESEARCH.md

# Pattern to follow exactly (category-based defaults with merge logic)
@lib/push/preferences.ts

# Settings page to modify (add ConsentSettings section)
@app/dashboard/settings/page.tsx

# Auth helper for API routes
@lib/supabase/auth-helpers.ts

# Service client pattern
@lib/supabase/server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create consent CRUD module and API route</name>
  <files>lib/db/consent.ts, app/api/community/consent/route.ts</files>
  <action>
**lib/db/consent.ts** -- Follow the EXACT structural pattern from `lib/push/preferences.ts`:

1. Define types:
```typescript
export type ConsentCategory = "benchmarks" | "social_feed" | "directory" | "messaging";
// Note: "investor_intros" exists in DB schema but is NOT exposed in UI until Phase 53

export interface ConsentCategoryConfig {
  enabled: boolean;
  label: string;
  description: string;
}

export type ConsentPreferences = Record<ConsentCategory, ConsentCategoryConfig>;
```

2. Define defaults (ALL default to false -- opt-IN model, opposite of push prefs which default to true):
```typescript
export const CONSENT_DEFAULTS: ConsentPreferences = {
  benchmarks: {
    enabled: false,
    label: "Benchmark Data",
    description: "Include your anonymized data in community benchmarks so founders can compare progress",
  },
  social_feed: {
    enabled: false,
    label: "Social Feed",
    description: "Allow your milestones and achievements to appear in the community feed",
  },
  directory: {
    enabled: false,
    label: "Founder Directory",
    description: "Make your community profile searchable in the founder directory",
  },
  messaging: {
    enabled: false,
    label: "Direct Messaging",
    description: "Allow other founders to send you direct messages",
  },
};

export const CONSENT_CATEGORIES = Object.keys(CONSENT_DEFAULTS) as ConsentCategory[];
```

3. Implement `getConsentPreferences(userId: string): Promise<ConsentPreferences>`:
   - Use `createServiceClient()` (import dynamically like push/preferences.ts does)
   - Query `consent_preferences` table WHERE user_id = userId
   - Merge stored rows with CONSENT_DEFAULTS (any missing category gets default false)
   - Return full ConsentPreferences object

4. Implement `updateConsentPreference(userId: string, category: ConsentCategory, enabled: boolean): Promise<ConsentPreferences>`:
   - Validate category against CONSENT_CATEGORIES
   - Use UPSERT (`.upsert({ user_id: userId, category, enabled, updated_at: new Date().toISOString() })`) on consent_preferences
   - The consent_audit_log is populated automatically by the DB trigger (do NOT manually insert audit rows)
   - Return updated preferences via getConsentPreferences()

5. Implement `isConsentEnabled(userId: string, category: ConsentCategory): Promise<boolean>`:
   - Shorthand for downstream phases to check consent

**app/api/community/consent/route.ts**:

GET handler:
- Authenticate user via `requireAuth()` from `lib/supabase/auth-helpers.ts`
- Call `getConsentPreferences(userId)`
- Return `{ success: true, data: preferences }`

PUT handler:
- Authenticate user
- Parse body: `{ category: string, enabled: boolean }`
- Validate category is in CONSENT_CATEGORIES
- Call `updateConsentPreference(userId, category, enabled)`
- Return `{ success: true, data: updatedPreferences }`

Both handlers must follow the existing API response pattern: `{ success: true/false, data/error }`.
  </action>
  <verify>
1. `grep 'CONSENT_DEFAULTS' lib/db/consent.ts` shows all 4 categories with enabled: false
2. `grep 'createServiceClient' lib/db/consent.ts` confirms service client pattern
3. `grep 'upsert' lib/db/consent.ts` confirms UPSERT for idempotent writes
4. `grep 'requireAuth' app/api/community/consent/route.ts` confirms auth check
5. File compiles: `npx tsc --noEmit lib/db/consent.ts 2>&1 | head -20` (may have import resolution issues in isolation, that's OK)
  </verify>
  <done>
Consent CRUD module exports getConsentPreferences, updateConsentPreference, isConsentEnabled, CONSENT_DEFAULTS, and CONSENT_CATEGORIES. API route at /api/community/consent handles GET (read) and PUT (toggle). All defaults are opt-in (false). Audit logging happens via DB trigger, not application code.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ConsentSettings component and add to Settings page</name>
  <files>components/settings/ConsentSettings.tsx, app/dashboard/settings/page.tsx</files>
  <action>
**components/settings/ConsentSettings.tsx** -- Create a new "use client" component:

Structure it like the existing notification settings section in the settings page. Use the same Card/Switch/Label/Separator pattern.

1. State: `Record<ConsentCategory, boolean>` initialized from API response
2. On mount: `fetch('/api/community/consent')` to load current preferences
3. On toggle: `fetch('/api/community/consent', { method: 'PUT', body: { category, enabled } })` immediately (no separate "Save" button -- each toggle saves instantly like a real settings page)
4. Show loading skeleton while fetching
5. Show toast on success/error using `sonner` (already used in settings page)

Layout:
```
<Card>
  <CardHeader>
    <CardTitle>Community Data Sharing</CardTitle>
    <CardDescription>
      Control how your data is shared with the community. All options are opt-in.
    </CardDescription>
  </CardHeader>
  <CardContent>
    {for each category in CONSENT_DEFAULTS:}
      <div className="flex items-center justify-between">
        <div>
          <Label>{category.label}</Label>
          <p className="text-sm text-muted-foreground">{category.description}</p>
        </div>
        <Switch checked={...} onCheckedChange={...} disabled={loading} />
      </div>
      <Separator />
  </CardContent>
</Card>
```

Import the CONSENT_DEFAULTS constant from `lib/db/consent` for labels/descriptions (the type definitions and defaults are safe to import in client components since they contain no server-only code).

Actually -- to avoid importing server module in client component, DUPLICATE the category labels/descriptions as a client-safe constant inside ConsentSettings.tsx (or create a shared constants file). Do NOT import from lib/db/consent.ts in client code since it uses createServiceClient.

**app/dashboard/settings/page.tsx** -- Add the ConsentSettings component:

1. Import `ConsentSettings` from `@/components/settings/ConsentSettings`
2. Add it AFTER the "General Notifications" card and BEFORE the "Voice & TTS" section
3. No tier gating needed -- all tiers can set consent preferences (but features themselves are tier-gated)
  </action>
  <verify>
1. `grep 'ConsentSettings' app/dashboard/settings/page.tsx` confirms component is imported and rendered
2. `grep 'Community Data Sharing' components/settings/ConsentSettings.tsx` confirms card title
3. `grep 'api/community/consent' components/settings/ConsentSettings.tsx` confirms API integration
4. `grep 'Switch' components/settings/ConsentSettings.tsx` confirms toggle UI
5. `grep 'toast' components/settings/ConsentSettings.tsx` confirms feedback on toggle
6. Dev server check: `curl -s http://localhost:3000/dashboard/settings 2>/dev/null | head -1` or build check: `npx next build 2>&1 | tail -5`
  </verify>
  <done>
Settings page shows "Community Data Sharing" card with 4 toggle switches (Benchmark Data, Social Feed, Founder Directory, Direct Messaging). Each toggle saves immediately via API. All default to OFF. Toast notifications confirm save success/failure.
  </done>
</task>

</tasks>

<verification>
1. Consent module follows push preferences pattern (merge-with-defaults)
2. All 4 categories default to false (opt-in)
3. API route requires authentication
4. PUT uses UPSERT (not separate insert/update logic)
5. Settings page renders ConsentSettings component
6. Each toggle saves immediately (no separate Save button)
7. No server-only imports in client component
</verification>

<success_criteria>
- `lib/db/consent.ts` exports all required functions and constants
- `/api/community/consent` GET returns all 4 categories with enabled status
- `/api/community/consent` PUT toggles a specific category and persists
- Settings page shows "Community Data Sharing" section with 4 toggle switches
- Toggling a switch calls the API and shows toast feedback
- Page refresh preserves toggle state
- Consent audit log populated automatically by DB trigger (verified by checking consent_audit_log after toggle)
</success_criteria>

<output>
After completion, create `.planning/phases/47-community-data-layer-consent/47-02-SUMMARY.md`
</output>
