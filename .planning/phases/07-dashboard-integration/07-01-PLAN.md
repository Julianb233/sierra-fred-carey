---
phase: 07-dashboard-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/dashboard/reality-lens/page.tsx
  - app/api/reality-lens/route.ts
  - app/api/__tests__/auth-integration.test.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Reality Lens page sends POST to /api/fred/reality-lens (not /api/reality-lens)"
    - "Reality Lens page renders the richer FRED response (verdict, confidence, executive summary, strengths per factor)"
    - "Legacy /api/reality-lens route redirects or is removed"
    - "Reality Lens page still shows overall score, dimension breakdown, strengths, weaknesses, and recommendations"
  artifacts:
    - path: "app/dashboard/reality-lens/page.tsx"
      provides: "Reality Lens page wired to FRED API"
      contains: "/api/fred/reality-lens"
    - path: "app/api/reality-lens/route.ts"
      provides: "Legacy route removed or redirecting"
  key_links:
    - from: "app/dashboard/reality-lens/page.tsx"
      to: "/api/fred/reality-lens"
      via: "fetch POST call"
      pattern: "fetch.*api/fred/reality-lens"
---

<objective>
Rewire the Reality Lens dashboard page to use the Phase 02 FRED-powered API endpoint instead of the legacy endpoint, and remove the legacy route.

Purpose: The FRED Reality Lens engine at `lib/fred/reality-lens.ts` provides a much richer 5-factor assessment (confidence levels, per-factor strengths/weaknesses/questions/recommendations, verdict, executive summary) but the dashboard page still calls the legacy `/api/reality-lens` which uses raw JSON parsing of unstructured AI output. This gap means the entire Phase 02 Reality Lens engine goes unused.

Output: Dashboard Reality Lens page calling `/api/fred/reality-lens` with updated UI to show the richer data, legacy route removed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

Key files to understand the response shape difference:

Legacy API response shape (from `app/api/reality-lens/route.ts`):
```
{
  success: true,
  data: {
    id, overallScore,
    dimensions: { feasibility: { score, analysis }, ... },
    strengths: string[], weaknesses: string[], recommendations: string[]
  }
}
```

FRED API response shape (from `app/api/fred/reality-lens/route.ts`):
```
{
  success: true,
  data: {
    overallScore, verdict, verdictDescription,
    factors: {
      feasibility: { score, confidence, summary, strengths: [], weaknesses: [], questions: [], recommendations: [] },
      ...
    },
    topStrengths: [], criticalRisks: [], nextSteps: [],
    executiveSummary,
    metadata: { assessmentId, timestamp, version, processingTimeMs }
  }
}
```

The FRED API input expects `{ idea: string, context?: { stage?, funding?, teamSize?, industry?, targetMarket?, mrr?, customerCount?, runwayMonths? } }` (validated by `RealityLensInputSchema`). The current page sends `{ idea, stage, market }` — the `stage` and `market` fields need to be mapped into the nested `context` object.

@app/dashboard/reality-lens/page.tsx
@app/api/fred/reality-lens/route.ts
@app/api/reality-lens/route.ts
@lib/fred/schemas/reality-lens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewire Reality Lens page to FRED API</name>
  <files>app/dashboard/reality-lens/page.tsx</files>
  <action>
  Rewrite the Reality Lens dashboard page to call `/api/fred/reality-lens` instead of `/api/reality-lens`.

  Specific changes:

  1. **Update the ApiResponse interface** to match the FRED response shape:
     - `data.factors` (not `data.dimensions`) containing `FactorAssessment` objects with: `score`, `confidence` ("high"|"medium"|"low"), `summary`, `strengths[]`, `weaknesses[]`, `questions[]`, `recommendations[]`
     - `data.verdict` and `data.verdictDescription` (new)
     - `data.topStrengths[]`, `data.criticalRisks[]`, `data.nextSteps[]` (new)
     - `data.executiveSummary` (new)
     - `data.metadata` with `assessmentId`, `timestamp`, `version`, `processingTimeMs` (new)
     - Remove `data.id`, `data.strengths`, `data.weaknesses`, `data.recommendations` (old flat shape)

  2. **Update the fetch call in handleAnalyze** (around line 72):
     - Change URL from `/api/reality-lens` to `/api/fred/reality-lens`
     - Map the form fields into the FRED input shape: `{ idea, context: { stage: stage || undefined, targetMarket: market || undefined } }`
       Note: the FRED schema uses `targetMarket` (not `market`) and stage values differ — the form has "ideation"|"pre-seed"|"seed"|"series-a" but FRED expects "idea"|"mvp"|"launched"|"scaling". Map "ideation" -> "idea", leave "pre-seed"/"seed"/"series-a" unmapped (pass as undefined or omit, since they don't match the enum). Alternatively, change the Select options to match the FRED enum values: "idea", "mvp", "launched", "scaling".

  3. **Update stage Select options** to match FRED schema enum:
     - Replace: "ideation" -> "idea", add "mvp", add "launched", add "scaling"
     - Remove: "pre-seed", "seed", "series-a" (these don't match the FRED stage enum)
     - Update labels accordingly: "Idea Stage", "MVP", "Launched", "Scaling"

  4. **Update the results rendering** to use the richer FRED data:
     - Change `results.dimensions` references to `results.factors`
     - Each factor now has `summary` (not `analysis`), plus `confidence`, `strengths[]`, `weaknesses[]`, `questions[]`, `recommendations[]`
     - In the dimension cards, show `dimension.summary` instead of `dimension.analysis`
     - Add a confidence badge next to each factor score (e.g., "High confidence", "Medium", "Low")
     - Show per-factor strengths and weaknesses in each factor card (small bullet list below the summary)
     - Replace the flat strengths/weaknesses cards at the bottom with `results.topStrengths` and `results.criticalRisks`
     - Replace the recommendations section with `results.nextSteps`
     - Add the `results.executiveSummary` as a new card between the overall score and the dimension breakdown
     - Show `results.verdict` and `results.verdictDescription` in the overall score card (e.g., badge showing "Promising" next to the score number)

  5. **Remove the unused `RatingPrompt` import** (`@/components/ai/rating-prompt`) and `responseId` state variable since the FRED API does not use that pattern.

  6. **Update error handling** for the FRED API error shape. The FRED API returns errors as `{ success: false, error: { code, message } }` (nested object) while the legacy API returned `{ success: false, error: "string" }`. Update the error extraction to handle both shapes: use `data.error?.message || data.error || "Failed to analyze idea"`.

  Keep the same overall page structure and Tailwind styling (orange brand color `#ff6a1a`, card layout, progress bars). The page should still work the same way: user enters idea -> clicks analyze -> sees results. Just with richer data from the FRED engine.
  </action>
  <verify>
  Run `npx tsc --noEmit 2>&1 | grep -i "reality-lens/page"` to check for TypeScript errors in the page.
  Run `npx next build 2>&1 | tail -20` to verify the build succeeds (or at minimum the page compiles).
  Grep the file to confirm: `grep -n "api/fred/reality-lens" app/dashboard/reality-lens/page.tsx` returns a match, and `grep -n "api/reality-lens\"" app/dashboard/reality-lens/page.tsx` returns NO match (no reference to legacy route without the /fred/ prefix).
  </verify>
  <done>
  Reality Lens page fetches from `/api/fred/reality-lens`, sends input in FRED schema shape (`{idea, context: {stage, targetMarket}}`), renders the richer response including verdict, confidence levels, executive summary, per-factor detail, topStrengths, criticalRisks, and nextSteps. No reference to legacy `/api/reality-lens` remains in the page.
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove legacy Reality Lens route</name>
  <files>app/api/reality-lens/route.ts</files>
  <action>
  Replace the entire legacy `app/api/reality-lens/route.ts` with a thin redirect/deprecation stub.

  The legacy route has both POST and GET handlers. Replace both with handlers that return a 308 Permanent Redirect to the corresponding FRED endpoint, OR return a JSON error indicating the endpoint has moved.

  Preferred approach (simpler, cleaner): **Delete the route entirely.** Since no other code in the codebase should reference it after Task 1 rewires the dashboard page, the cleanest solution is to delete `app/api/reality-lens/route.ts`. Also delete `app/api/reality-lens/README.md` if it exists.

  Before deleting, verify no other files reference `/api/reality-lens` (without `/fred/`):
  - Search the codebase for `api/reality-lens` references excluding the `app/api/reality-lens/` directory itself and excluding `app/api/fred/reality-lens/`. If any references found, update them to point to `/api/fred/reality-lens` first.
  - **Important**: `app/api/__tests__/auth-integration.test.ts` has ~8 references importing from `@/app/api/reality-lens/route`. Update these test cases to import from `@/app/api/fred/reality-lens/route` instead, or remove the legacy Reality Lens test section entirely if the FRED endpoint already has its own tests.

  Then remove:
  - `app/api/reality-lens/route.ts`
  - `app/api/reality-lens/README.md` (if exists)
  - `app/api/reality-lens/` directory (should be empty after above)
  </action>
  <verify>
  Verify the directory is gone: `ls app/api/reality-lens/ 2>&1` should return "No such file or directory".
  Verify no stale references: `grep -r "api/reality-lens" --include="*.ts" --include="*.tsx" app/ lib/ components/ | grep -v "api/fred/reality-lens"` should return empty (no references to the legacy route remain anywhere).
  </verify>
  <done>
  Legacy `/api/reality-lens` route and directory completely removed. No code references the old endpoint. All Reality Lens traffic goes through `/api/fred/reality-lens`.
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "api/reality-lens" app/ lib/ components/ --include="*.ts" --include="*.tsx" | grep -v "api/fred/reality-lens"` returns nothing (no legacy references)
2. `grep -n "api/fred/reality-lens" app/dashboard/reality-lens/page.tsx` shows the fetch call to FRED endpoint
3. `ls app/api/reality-lens/ 2>&1` shows directory does not exist
4. TypeScript compilation succeeds for the reality-lens page
</verification>

<success_criteria>
- Reality Lens dashboard page calls /api/fred/reality-lens (not legacy route)
- Page renders FRED response shape (verdict, confidence, executive summary, per-factor detail)
- Legacy /api/reality-lens route is deleted
- No code references legacy route
- Build compiles without errors related to these files
</success_criteria>

<output>
After completion, create `.planning/phases/07-dashboard-integration/07-01-SUMMARY.md`
</output>
