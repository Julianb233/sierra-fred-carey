---
phase: 60-cicd-testing-expansion
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/deploy.yml
  - playwright.config.ts
  - package.json
  - tests/e2e/accessibility.spec.ts
  - tests/e2e/accessibility-authenticated.spec.ts
autonomous: true

must_haves:
  truths:
    - "Playwright E2E tests run in CI on every PR and push to main/staging"
    - "CI fails if any E2E test fails (not silenced with || true)"
    - "Accessibility tests catch WCAG violations using axe-core in CI"
    - "A11y violations on public pages cause CI failure"
  artifacts:
    - path: ".github/workflows/deploy.yml"
      provides: "Playwright E2E job in CI workflow"
      contains: "playwright"
    - path: "tests/e2e/accessibility.spec.ts"
      provides: "axe-core accessibility tests for public pages"
      contains: "AxeBuilder"
    - path: "tests/e2e/accessibility-authenticated.spec.ts"
      provides: "axe-core accessibility tests for authenticated pages"
      contains: "AxeBuilder"
    - path: "playwright.config.ts"
      provides: "Updated Playwright config with CI reporter and screenshot settings"
      contains: "github"
  key_links:
    - from: ".github/workflows/deploy.yml"
      to: "tests/e2e/*.spec.ts"
      via: "npx playwright test in e2e job"
      pattern: "npx playwright test"
    - from: "tests/e2e/accessibility.spec.ts"
      to: "@axe-core/playwright"
      via: "AxeBuilder import"
      pattern: "import.*AxeBuilder.*@axe-core/playwright"
    - from: ".github/workflows/deploy.yml"
      to: "playwright.config.ts"
      via: "Playwright reads config for CI projects"
      pattern: "playwright install"
---

<objective>
Add Playwright E2E test execution and axe-core accessibility testing to the CI pipeline so every PR runs full end-to-end tests and catches WCAG violations automatically.

Purpose: Currently Playwright tests exist (7 spec files) but are never run in CI. axe-core is not installed. This plan makes E2E and accessibility tests part of every PR gate.

Output: New `e2e` job in GitHub Actions workflow + axe-core accessibility test files + updated Playwright config for CI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md

Existing files:
@.github/workflows/deploy.yml
@playwright.config.ts
@package.json
@tests/e2e/signup.spec.ts (pattern reference for E2E tests)
@tests/e2e/fixtures/auth.ts (auth fixture pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install axe-core and add Playwright E2E job to CI</name>
  <files>
    package.json
    .github/workflows/deploy.yml
    playwright.config.ts
  </files>
  <action>
  Three changes to wire Playwright into CI:

  **A. Install @axe-core/playwright as a dev dependency:**

  Run: `npm install --save-dev @axe-core/playwright --legacy-peer-deps`

  This is the official Playwright integration for axe-core accessibility testing. It provides `AxeBuilder` which runs WCAG 2.1 AA audits against any page.

  **B. Update playwright.config.ts for CI optimization:**

  Modify `playwright.config.ts` with these changes:

  1. Add a CI-specific reporter that outputs GitHub Actions annotations. Change the `reporter` line to:
     ```typescript
     reporter: process.env.CI
       ? [["github"], ["html", { open: "never" }]]
       : "html",
     ```
     This gives inline PR annotations for failures while still generating HTML reports.

  2. Add screenshot-on-failure for debugging CI failures. In the `use` block, add:
     ```typescript
     screenshot: "only-on-failure",
     ```

  3. For CI, restrict to Chromium only (Firefox/WebKit are slow and flaky in CI headless). Wrap the `projects` array:
     ```typescript
     projects: process.env.CI
       ? [{ name: "chromium", use: { ...devices["Desktop Chrome"] } }]
       : [
           { name: "chromium", use: { ...devices["Desktop Chrome"] } },
           { name: "firefox", use: { ...devices["Desktop Firefox"] } },
           { name: "webkit", use: { ...devices["Desktop Safari"] } },
         ],
     ```

  4. Increase the webServer timeout for CI (build takes longer):
     ```typescript
     webServer: {
       command: "npm run build && npm start",
       url: "http://localhost:3000",
       reuseExistingServer: !process.env.CI,
       timeout: 180000, // 3 min for CI builds
     },
     ```

  **C. Add an `e2e` job to `.github/workflows/deploy.yml`:**

  Add a new job after the existing `build` job. The `e2e` job runs Playwright tests including accessibility checks. It runs in parallel with `security` (both depend on `build` succeeding).

  Add this job definition:

  ```yaml
  e2e:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      - name: Run Playwright E2E tests
        run: npx playwright test
        env:
          CI: true
          E2E_TEST_EMAIL: ${{ secrets.E2E_TEST_EMAIL }}
          E2E_TEST_PASSWORD: ${{ secrets.E2E_TEST_PASSWORD }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: |
            playwright-report/
            test-results/
          retention-days: 14
  ```

  Also update the `deploy` job's `needs` array to include the new e2e job:
  ```yaml
  deploy:
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/main'
    needs: [build, security, e2e]
  ```

  This ensures deployments are blocked if E2E tests fail.

  IMPORTANT: The `e2e` job needs the Supabase env vars because the app won't build without them (Next.js build requires NEXT_PUBLIC_* vars). The E2E_TEST_EMAIL/PASSWORD are needed for authenticated test flows. These must be set as GitHub Actions secrets by the user.

  Add these entries to .gitignore if not already present:
  - `playwright-report/`
  - `test-results/`
  - `blob-report/`
  </action>
  <verify>
  - `grep "e2e:" .github/workflows/deploy.yml` confirms the new job exists
  - `grep "playwright install" .github/workflows/deploy.yml` confirms browser install step
  - `grep "needs:.*e2e" .github/workflows/deploy.yml` confirms deploy depends on e2e
  - `grep "@axe-core/playwright" package.json` confirms axe-core installed
  - `grep "github" playwright.config.ts` confirms CI reporter configured
  - `npx tsc --noEmit` passes
  </verify>
  <done>
  CI pipeline has a dedicated `e2e` job that installs Playwright browsers, runs all E2E tests (including a11y tests created in Task 2), uploads reports as artifacts, and blocks deployment if tests fail. Playwright config optimized for CI with Chromium-only, GitHub reporter, and screenshot-on-failure.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create axe-core accessibility test suites</name>
  <files>
    tests/e2e/accessibility.spec.ts
    tests/e2e/accessibility-authenticated.spec.ts
  </files>
  <action>
  Create two accessibility test files using @axe-core/playwright:

  **A. Public pages accessibility tests (`tests/e2e/accessibility.spec.ts`):**

  This file tests pages that don't require authentication. Import from `@playwright/test` (not the auth fixture).

  ```typescript
  import { test, expect } from "@playwright/test";
  import AxeBuilder from "@axe-core/playwright";

  const publicPages = [
    { name: "Homepage", path: "/" },
    { name: "About", path: "/about" },
    { name: "Login", path: "/login" },
    { name: "Get Started", path: "/get-started" },
    { name: "Pricing", path: "/pricing" },
    { name: "Contact", path: "/contact" },
    { name: "Blog", path: "/blog" },
  ];

  test.describe("Accessibility: Public Pages", () => {
    for (const { name, path } of publicPages) {
      test(`${name} (${path}) should have no critical WCAG violations`, async ({ page }) => {
        await page.goto(path);
        // Wait for page to be fully loaded
        await page.waitForLoadState("networkidle");

        const results = await new AxeBuilder({ page })
          .withTags(["wcag2a", "wcag2aa", "wcag21a", "wcag21aa"])
          .analyze();

        // Filter to critical and serious violations only
        const criticalViolations = results.violations.filter(
          (v) => v.impact === "critical" || v.impact === "serious"
        );

        // Log violations for debugging
        if (criticalViolations.length > 0) {
          console.log(`\n${name} a11y violations:`);
          for (const v of criticalViolations) {
            console.log(`  [${v.impact}] ${v.id}: ${v.description}`);
            for (const node of v.nodes.slice(0, 3)) {
              console.log(`    - ${node.html.substring(0, 100)}`);
            }
          }
        }

        expect(
          criticalViolations,
          `${name} has ${criticalViolations.length} critical/serious a11y violations`
        ).toHaveLength(0);
      });
    }
  });
  ```

  **B. Authenticated pages accessibility tests (`tests/e2e/accessibility-authenticated.spec.ts`):**

  This file tests pages that require login. Import from the auth fixture (`./fixtures/auth`).

  ```typescript
  import { test, expect } from "./fixtures/auth";
  import AxeBuilder from "@axe-core/playwright";

  const authenticatedPages = [
    { name: "Dashboard", path: "/dashboard" },
    { name: "Chat", path: "/chat" },
    { name: "Check-ins", path: "/check-ins" },
    { name: "Dashboard Settings", path: "/dashboard/settings" },
    { name: "Dashboard Next Steps", path: "/dashboard/next-steps" },
  ];

  test.describe("Accessibility: Authenticated Pages", () => {
    for (const { name, path } of authenticatedPages) {
      test(`${name} (${path}) should have no critical WCAG violations`, async ({ authenticatedPage: page }) => {
        await page.goto(path);
        await page.waitForLoadState("networkidle");

        const results = await new AxeBuilder({ page })
          .withTags(["wcag2a", "wcag2aa", "wcag21a", "wcag21aa"])
          .analyze();

        const criticalViolations = results.violations.filter(
          (v) => v.impact === "critical" || v.impact === "serious"
        );

        if (criticalViolations.length > 0) {
          console.log(`\n${name} a11y violations:`);
          for (const v of criticalViolations) {
            console.log(`  [${v.impact}] ${v.id}: ${v.description}`);
            for (const node of v.nodes.slice(0, 3)) {
              console.log(`    - ${node.html.substring(0, 100)}`);
            }
          }
        }

        expect(
          criticalViolations,
          `${name} has ${criticalViolations.length} critical/serious a11y violations`
        ).toHaveLength(0);
      });
    }
  });
  ```

  **Key design decisions:**
  - Test WCAG 2.1 AA tags (wcag2a, wcag2aa, wcag21a, wcag21aa) -- matches Phase 65 accessibility target
  - Filter to critical+serious only -- minor/moderate violations are warnings, not blockers. This prevents flaky CI from color contrast edge cases.
  - Log violations with HTML excerpts for easy debugging in CI output
  - `waitForLoadState("networkidle")` ensures dynamic content is loaded before scanning
  - Separate files for public vs authenticated avoids login overhead for public pages
  - Authenticated test skips gracefully if E2E credentials not set (inherited from auth fixture)

  IMPORTANT: Do NOT use `disableRules` to suppress violations. If a page has real a11y issues, they should fail. The critical/serious filter is sufficient to avoid noise.
  </action>
  <verify>
  - `ls tests/e2e/accessibility.spec.ts tests/e2e/accessibility-authenticated.spec.ts` both exist
  - `grep "AxeBuilder" tests/e2e/accessibility.spec.ts` confirms axe-core usage
  - `grep "wcag2aa" tests/e2e/accessibility.spec.ts` confirms WCAG 2.1 AA testing
  - `grep "authenticatedPage" tests/e2e/accessibility-authenticated.spec.ts` confirms auth fixture usage
  - `npx tsc --noEmit` passes (TypeScript is valid)
  </verify>
  <done>
  Two accessibility test suites created: one for 7 public pages (no auth needed) and one for 5 authenticated pages (uses auth fixture). Both use axe-core to scan for WCAG 2.1 AA violations and fail on critical/serious issues. These tests run as part of the Playwright E2E job added in Task 1.
  </done>
</task>

</tasks>

<verification>
- `.github/workflows/deploy.yml` has an `e2e` job with Playwright install + test steps
- `deploy` job depends on `[build, security, e2e]`
- `@axe-core/playwright` is in devDependencies
- `playwright.config.ts` uses GitHub reporter in CI, Chromium-only in CI, screenshot on failure
- `tests/e2e/accessibility.spec.ts` tests 7 public pages with axe-core
- `tests/e2e/accessibility-authenticated.spec.ts` tests 5 authenticated pages with axe-core
- `npx tsc --noEmit` passes
- `npm run build` passes
</verification>

<success_criteria>
1. Playwright E2E tests run in CI on every PR (new `e2e` job in deploy.yml)
2. E2E test failures block deployment (deploy needs e2e)
3. axe-core catches WCAG 2.1 AA violations on 12 pages (7 public + 5 authenticated)
4. CI reports show inline GitHub annotations for test failures
5. Playwright report artifacts uploaded for debugging failed runs
</success_criteria>

<output>
After completion, create `.planning/phases/60-cicd-testing-expansion/60-01-SUMMARY.md`
</output>
