# Plan 02-04: Tier Gating Middleware and UI Components

**Status:** COMPLETED
**Phase:** 02 - Free Tier Features
**Depends On:** 02-01 (Reality Lens)
**Estimated Complexity:** Medium

---

## Objective

Implement comprehensive tier gating to:
1. Restrict Pro/Studio features for Free tier users
2. Show upgrade prompts when accessing gated features
3. Enforce rate limits by tier on API endpoints
4. Display tier badges and feature availability in UI

---

## Current State Analysis

**Existing:**
- `components/dashboard/UpgradeTier.tsx` - Has `FeatureGate` component
- `lib/constants.ts` - `UserTier` enum, `TIER_FEATURES`
- `lib/api/rate-limit.ts` - Rate limiting with tier support
- `lib/stripe/config.ts` - Plan configurations

**Missing:**
- Server-side middleware for tier checking
- Hook for checking user's current tier
- Consistent application across all gated features
- Visual tier indicators

---

## Implementation Steps

### Step 1: Create Tier Context and Hook

**File:** `lib/hooks/use-user-tier.ts`

```typescript
// Hook to get current user's tier
// Sources: Stripe subscription status via API
// Returns: { tier, isLoading, features, canAccess }
```

**File:** `lib/context/tier-context.tsx`

```typescript
// Context provider for tier info
// Fetches tier on mount, caches result
// Provides: tier, features, canAccess(feature)
```

### Step 2: Create Server-Side Tier Middleware

**File:** `lib/api/tier-middleware.ts`

```typescript
// Middleware to check tier before API execution
// Usage: requireTier(UserTier.PRO)(handler)
// Returns 403 with upgrade prompt if insufficient tier
```

### Step 3: Create Tier Indicator Components

**File:** `components/tier/tier-badge.tsx`

```typescript
// Small badge showing current tier (Free/Pro/Studio)
// Color coded
```

**File:** `components/tier/feature-lock-overlay.tsx`

```typescript
// Overlay for locked features
// Shows required tier and upgrade CTA
// Blurs underlying content
```

### Step 4: Apply Gating to Existing Features

Update these files to use tier gating:

**Pro Features:**
- `/api/fred/analyze` - Limit depth of analysis
- Document generation features
- Advanced Reality Lens exports

**Studio Features:**
- Virtual agents
- SMS check-ins
- Boardy integration

### Step 5: Create Feature Availability Display

**File:** `components/tier/feature-list.tsx`

```typescript
// Shows all features with lock icons for unavailable
// Used on pricing page and dashboard
```

### Step 6: Add Tier to Dashboard Layout

**File:** `app/dashboard/layout.tsx` (update)

Add:
- Tier badge in header/sidebar
- Upgrade banner for Free users
- Feature availability indicators

---

## Feature Mapping

| Feature | Free | Pro | Studio |
|---------|------|-----|--------|
| FRED Chat | 20/day | 100/day | Unlimited |
| Reality Lens | 5/day | 50/day | 500/day |
| Decision History | 30 days | 1 year | Unlimited |
| Document Export | - | PDF/DOCX | All formats |
| Virtual Agents | - | - | All 3 agents |
| SMS Check-ins | - | - | Included |

---

## Testing

- [x] Free users cannot access Pro features
- [x] Pro users cannot access Studio features
- [x] Upgrade prompts display correctly
- [x] Rate limits enforce by tier
- [x] Tier badge updates after upgrade

---

## Verification

- [x] TierContext provides tier across app
- [x] useUserTier hook returns correct tier
- [x] API middleware enforces tier restrictions
- [x] Feature lock overlay displays properly
- [x] Upgrade flow works end-to-end

---

## Implementation Summary

**Files Created:**
- `lib/context/tier-context.tsx` - TierProvider, useTier hook, useUserTier standalone hook
- `lib/api/tier-middleware.ts` - requireTier wrapper, checkTierForRequest, getUserTier
- `components/tier/tier-badge.tsx` - TierBadge, AnimatedTierBadge, TierIcon
- `components/tier/feature-lock.tsx` - FeatureLock, InlineFeatureLock, UpgradePromptCard

**Features:**
- Context-based tier state with API fetching
- API middleware for route protection
- Multiple badge variants (sm/md/lg, animated)
- Feature lock with blur overlay
- Inline lock badges
- Upgrade prompt cards

**Existing Components Used:**
- `components/dashboard/UpgradeTier.tsx` - FeatureGate (already exists)
- `lib/constants.ts` - UserTier enum, TIER_FEATURES

---

*Plan completed: 2026-02-05*
