---
phase: 14-voice-agents-channels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/sms/templates.ts
  - lib/voice-agent.ts
  - app/api/admin/voice-agent/config/route.ts
  - lib/db/migrations/036_voice_agent_fred_persona.sql
autonomous: true

must_haves:
  truths:
    - "SMS check-in messages are written in Fred Cary's motivational, direct voice -- not generic SaaS language"
    - "SMS welcome message identifies the sender as Fred Cary, not 'Sahara check-ins'"
    - "Voice agent getDefaultSystemPrompt() identifies as Fred Cary with no reference to 'A Startup Biz'"
    - "Voice agent AccessToken name is 'Fred Cary', not 'AI Support Assistant'"
    - "Admin API default config uses Fred Cary persona, not generic support assistant"
    - "Database migration updates the default voice_agent_config row to Fred Cary persona"
    - "All SMS messages fit within 160-character single SMS segment limit"
  artifacts:
    - path: "lib/sms/templates.ts"
      provides: "SMS templates in Fred Cary's voice"
      exports: ["getCheckinTemplate", "getWelcomeTemplate", "getStopConfirmation"]
    - path: "lib/voice-agent.ts"
      provides: "Voice agent with Fred Cary identity and system prompt"
      exports: ["generateAgentToken", "spawnAgent", "buildEnhancedSystemPrompt", "buildSystemPrompt"]
    - path: "app/api/admin/voice-agent/config/route.ts"
      provides: "Admin API with Fred Cary default config"
      exports: ["GET", "PUT", "POST"]
    - path: "lib/db/migrations/036_voice_agent_fred_persona.sql"
      provides: "Database migration to update default voice agent config to Fred persona"
  key_links:
    - from: "lib/voice-agent.ts"
      to: "lib/fred-brain.ts"
      via: "import FRED_BIO, FRED_COMMUNICATION_STYLE, FRED_COMPANIES, SAHARA_MESSAGING"
      pattern: "import.*from.*fred-brain"
    - from: "lib/voice-agent.ts"
      to: "voice_agent_config table"
      via: "buildEnhancedSystemPrompt fetches from DB, falls back to getDefaultSystemPrompt"
      pattern: "getDefaultSystemPrompt"
    - from: "lib/db/migrations/036_voice_agent_fred_persona.sql"
      to: "lib/db/migrations/009_voice_agent_tables.sql"
      via: "UPDATE the default row that 009 INSERTed"
      pattern: "UPDATE voice_agent_config"
---

<objective>
Rewrite SMS check-in templates and voice agent configuration to use Fred Cary's voice, replacing generic SaaS language and the incorrect "A Startup Biz" identity.

Purpose: SMS templates use bland corporate language ("Hey {name}! Weekly check-in from Sahara.") with zero personality. The voice agent identifies as "A Startup Biz" support assistant in the code fallback, database seed, and admin API defaults -- a completely wrong brand identity. Three separate sources of voice agent config must all be updated for consistency.

Output: SMS templates rewritten in Fred's motivational, direct voice. Voice agent system prompt replaced across all three sources (code fallback, database migration, admin API defaults). AccessToken name changed from "AI Support Assistant" to "Fred Cary".
</objective>

<execution_context>
@/opt/agency-workspace/sierra-fred-carey/.planning/get-shit-done/workflows/execute-plan.md
@/opt/agency-workspace/sierra-fred-carey/.planning/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-voice-agents-channels/14-RESEARCH.md

Key source files:
@lib/fred-brain.ts
@lib/sms/templates.ts
@lib/voice-agent.ts
@app/api/admin/voice-agent/config/route.ts
@lib/db/migrations/009_voice_agent_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SMS templates in Fred Cary's voice</name>
  <files>
    lib/sms/templates.ts
  </files>
  <action>
Rewrite the three SMS template functions in `lib/sms/templates.ts` to use Fred Cary's voice. SMS messages must be under 160 characters (single segment). Fred's voice in SMS = motivational, direct, personal -- NOT storytelling (no room for stories in 160 chars).

IMPORTANT constraints:
- All messages must fit within `MAX_SMS_LENGTH` (160 chars)
- Fred's SMS voice is concise and motivational, not verbose
- Every template must be measured for character count before writing
- Do NOT import from fred-brain.ts for SMS -- the templates are static strings, not dynamic prompts. Importing would add runtime overhead for no benefit since the values are hardcoded in the template text anyway.

**Rewrite getCheckinTemplate (currently line 18-47):**

Replace the bland `"Hey ${founderName}! Weekly check-in from Sahara."` pattern with rotating Fred-voice messages:

```typescript
export function getCheckinTemplate(
  founderName: string,
  highlights?: string[]
): string {
  // Fred's voice: motivational, direct, personal
  // Rotate messages for variety (deterministic based on name length)
  const messages = [
    `${founderName} -- it's Fred. What's your biggest win this week? Reply with your top 3 priorities.`,
    `Hey ${founderName}, Fred here. Quick check-in: what moved the needle this week? Top 3 priorities -- go.`,
    `${founderName}, how's the grind? Tell me your #1 win and your biggest blocker. --Fred`,
  ];

  if (!highlights || highlights.length === 0) {
    const index = founderName.length % messages.length;
    return messages[index].slice(0, MAX_SMS_LENGTH);
  }

  // With highlights, use a shorter base to leave room
  const base = `${founderName}, Fred here. Your agents finished: `;
  const cta = ' What are your priorities?';
  const availableSpace = MAX_SMS_LENGTH - base.length - cta.length;

  let highlightText = highlights.join(', ');
  if (highlightText.length > availableSpace) {
    highlightText = highlightText.slice(0, availableSpace - 3) + '...';
  }

  const message = `${base}${highlightText}.${cta}`;

  // Final safety truncation -- fall back to base message if highlights make it too long
  if (message.length > MAX_SMS_LENGTH) {
    const index = founderName.length % messages.length;
    return messages[index].slice(0, MAX_SMS_LENGTH);
  }

  return message;
}
```

**Rewrite getWelcomeTemplate (currently line 55-60):**

Replace `"Welcome to Sahara check-ins, ${founderName}!"` with Fred's personal introduction:

```typescript
export function getWelcomeTemplate(founderName: string): string {
  return `${founderName}, it's Fred Cary. I'll text you weekly for a quick accountability check. Think of me as your co-founder in your pocket. Reply STOP to opt out.`.slice(
    0,
    MAX_SMS_LENGTH
  );
}
```

**Rewrite getStopConfirmation (currently line 67-69):**

Replace generic unsubscribe with Fred's voice:

```typescript
export function getStopConfirmation(): string {
  return "Got it -- you're unsubscribed from check-ins. Text START anytime to jump back in. --Fred";
}
```

**Character count verification:**
- Check-in message 0 (name="Sarah"): "Sarah -- it's Fred. What's your biggest win this week? Reply with your top 3 priorities." = 89 chars. PASS.
- Check-in message 1 (name="Sarah"): "Hey Sarah, Fred here. Quick check-in: what moved the needle this week? Top 3 priorities -- go." = 95 chars. PASS.
- Check-in message 2 (name="Sarah"): "Sarah, how's the grind? Tell me your #1 win and your biggest blocker. --Fred" = 76 chars. PASS.
- Welcome (name="Sarah"): "Sarah, it's Fred Cary. I'll text you weekly for a quick accountability check. Think of me as your co-founder in your pocket. Reply STOP to opt out." = 149 chars. PASS (tight but fits).
- Stop: "Got it -- you're unsubscribed from check-ins. Text START anytime to jump back in. --Fred" = 89 chars. PASS.

Preserve the file header comment and `MAX_SMS_LENGTH` constant. Keep JSDoc comments on functions (update content to match new behavior). Keep function signatures identical.
  </action>
  <verify>
1. Verify Fred's name appears in templates: `grep "Fred" lib/sms/templates.ts`
2. Verify no generic language remains: `grep -i "Weekly check-in from Sahara\|Welcome to Sahara check-ins" lib/sms/templates.ts` should return nothing
3. Verify MAX_SMS_LENGTH enforcement: `grep "MAX_SMS_LENGTH" lib/sms/templates.ts`
4. Verify all 3 functions exported: `grep "export function" lib/sms/templates.ts`
5. Run `npx tsc --noEmit` -- no errors
  </verify>
  <done>
VOICE-09: SMS templates rewritten in Fred Cary's voice. getCheckinTemplate uses 3 rotating Fred-voice messages with deterministic selection. getWelcomeTemplate identifies sender as "Fred Cary" with accountability framing. getStopConfirmation signed "--Fred". All messages verified under 160 chars.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite voice agent identity and all three config sources</name>
  <files>
    lib/voice-agent.ts
    app/api/admin/voice-agent/config/route.ts
    lib/db/migrations/036_voice_agent_fred_persona.sql
  </files>
  <action>
The voice agent has THREE separate sources of configuration that all need Fred Cary's identity:
1. Code fallback: `getDefaultSystemPrompt()` in `lib/voice-agent.ts`
2. Admin API defaults: hardcoded default config in GET handler of `app/api/admin/voice-agent/config/route.ts`
3. Database seed: migration `009_voice_agent_tables.sql` (do NOT modify -- create a new UPDATE migration instead)

Plus the AccessToken `name` field in `generateAgentToken()`.

**Step 1: Update `lib/voice-agent.ts`**

Add imports from fred-brain.ts after the existing imports (after line 3):
```typescript
import {
  FRED_BIO,
  FRED_COMMUNICATION_STYLE,
  FRED_COMPANIES,
  SAHARA_MESSAGING,
} from '@/lib/fred-brain';
```

Change AccessToken name (line 88):
```typescript
// BEFORE: name: 'AI Support Assistant',
// AFTER:
name: 'Fred Cary',
```

Replace `getDefaultSystemPrompt()` entirely (lines 400-424). The new function composes from fred-brain.ts imports:

```typescript
function getDefaultSystemPrompt(): string {
  return `You are Fred Cary, serial entrepreneur, CEO, attorney, and business coach with over ${FRED_BIO.yearsExperience} years of experience.

Your role on this call:
- Help founders with questions about Sahara and entrepreneurship
- Provide direct, actionable guidance based on your experience
- Be conversational but purposeful -- this is a voice call, not an essay

About you:
- Founded ${FRED_BIO.companiesFounded}+ companies, taken ${FRED_BIO.ipos} public, had ${FRED_BIO.acquisitions} acquired
- Created technology used in ${FRED_COMPANIES.summaryStats.tvHouseholdsReach} of the world's TV households
- Coached 10,000+ founders through IdeaPros and now Sahara
- Your motto: ${FRED_COMMUNICATION_STYLE.voice.primary}

About Sahara (your current venture):
${SAHARA_MESSAGING.differentiators.map(d => '- ' + d).join('\n')}
- Three tiers: Free (FRED chat), Pro (Reality Lens, frameworks), Studio (virtual agent team)

Voice style:
- ${FRED_COMMUNICATION_STYLE.voice.primary}, but warm
- Use personal stories when relevant
- Emphasize action over theory
- Never sugarcoat -- founders need the truth
- Keep responses concise for voice -- 2-3 sentences max per turn

Never refer to yourself as an "AI assistant" or "A Startup Biz." You are Fred Cary, co-founder of Sahara.`;
}
```

Do NOT change: `buildEnhancedSystemPrompt()`, `fetchAgentConfig()`, `fetchKnowledgeBase()`, `fetchEscalationRules()`, `isWithinBusinessHours()`, session management functions, or cache logic. The `buildSystemPrompt()` function (line 429-441) automatically inherits the new prompt since it calls `getDefaultSystemPrompt()` internally.

**Step 2: Update `app/api/admin/voice-agent/config/route.ts`**

In the GET handler, update the hardcoded default config object (returned when no DB row exists, lines 27-61):

Replace these fields:
- `name`: `'Default Agent'` -> `'Fred Cary'`
- `system_prompt`: Replace the entire generic support assistant prompt with Fred Cary persona (same content as the database migration below, but using JS string escaping)
- `greeting_message`: `'Hello! Thank you for calling. How can I help you today?'` -> `'Hey, this is Fred. Thanks for calling Sahara. What can I help you with today?'`
- `response_style`: `'professional'` -> `'friendly'`
- `after_hours_message`: Replace with `'Hey, it\'s Fred. We\'re closed right now, but leave a message and I\'ll get back to you. Keep grinding.'`
- `fallback_message`: Replace with `'That\'s outside my wheelhouse right now. Want me to connect you with someone on the team who can help?'`

Do NOT change: the PUT or POST handlers, voice/max_response_length/language/business_hours/timezone/after_hours_behavior fields, Supabase client logic, or auth checks.

**Step 3: Create new migration `lib/db/migrations/036_voice_agent_fred_persona.sql`**

IMPORTANT: Do NOT modify migration 009. It has `ON CONFLICT DO NOTHING` and may already be run in production. Create a NEW migration that UPDATEs the existing default row.

The highest existing migration number is 035 (035_phone_verifications.sql). The next available is 036.

```sql
-- Migration 036: Update voice agent default config to Fred Cary persona
-- Phase 14: Voice -- Agents & Channels (VOICE-10)
-- Updates the default row inserted by migration 009_voice_agent_tables.sql.
-- If no default row exists, this is a no-op (safe to run idempotently).

UPDATE voice_agent_config
SET
  name = 'Fred Cary',
  system_prompt = 'You are Fred Cary, serial entrepreneur with 50+ years of experience, 40+ companies founded, 3 IPOs. You are the co-founder of Sahara, an AI-driven mentorship platform for founders.

Your role on this call:
- Help founders with questions about Sahara and entrepreneurship
- Provide direct, actionable guidance from your experience
- Be conversational but purposeful

Voice style:
- Direct, no-BS approach, but warm
- Use personal stories when relevant
- Keep responses concise for voice -- 2-3 sentences max per turn
- Never refer to yourself as an AI assistant',
  greeting_message = 'Hey, this is Fred. Thanks for calling Sahara. What can I help you with today?',
  response_style = 'friendly',
  after_hours_message = 'Hey, it''s Fred. We''re closed right now, but leave a message and I''ll get back to you. Keep grinding.',
  fallback_message = 'That''s outside my wheelhouse right now. Want me to connect you with someone on the team who can help?',
  updated_at = NOW()
WHERE name = 'Default Agent'
  AND is_active = true;
```

This migration:
- Uses UPDATE, not INSERT (the row was created by migration 009)
- Targets the specific default row by `name = 'Default Agent' AND is_active = true`
- Is idempotent (safe to run multiple times)
- Uses SQL single-quote escaping (`''` for apostrophes)
- Sets `updated_at` to reflect the change
  </action>
  <verify>
1. Voice agent identity: `grep "name: 'Fred Cary'" lib/voice-agent.ts` and `grep -i "AI Support Assistant\|A Startup Biz" lib/voice-agent.ts` (second should return nothing)
2. Voice agent imports: `grep "fred-brain" lib/voice-agent.ts`
3. Admin API defaults: `grep "Fred Cary" app/api/admin/voice-agent/config/route.ts` and `grep "Hey, this is Fred" app/api/admin/voice-agent/config/route.ts`
4. Migration exists: `test -f lib/db/migrations/036_voice_agent_fred_persona.sql && echo "EXISTS"`
5. Migration uses UPDATE: `grep "UPDATE voice_agent_config" lib/db/migrations/036_voice_agent_fred_persona.sql`
6. Migration 009 NOT modified: `git diff lib/db/migrations/009_voice_agent_tables.sql` shows no changes
7. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
VOICE-10: All three voice agent config sources updated to Fred Cary persona. Code fallback (getDefaultSystemPrompt) now imports from fred-brain.ts and identifies as Fred. AccessToken name changed to "Fred Cary". Admin API GET default uses Fred's greeting, system prompt, and messages. New migration 036 UPDATEs the DB default row. Original migration 009 untouched. Zero references to "A Startup Biz" or "AI Support Assistant" remain.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **SMS templates in Fred's voice:**
   ```bash
   grep "Fred" lib/sms/templates.ts
   grep -i 'Weekly check-in from Sahara\|Welcome to Sahara check-ins' lib/sms/templates.ts
   # First should find matches, second should find nothing
   ```

2. **Voice agent code fallback uses Fred:**
   ```bash
   grep "Fred Cary" lib/voice-agent.ts
   grep -i 'A Startup Biz\|AI Support Assistant' lib/voice-agent.ts
   # First should find matches, second should find nothing
   ```

3. **Admin API defaults use Fred:**
   ```bash
   grep "Fred Cary" app/api/admin/voice-agent/config/route.ts
   grep "Hey, this is Fred" app/api/admin/voice-agent/config/route.ts
   ```

4. **Database migration exists and is correct:**
   ```bash
   test -f lib/db/migrations/036_voice_agent_fred_persona.sql && echo "EXISTS"
   grep 'UPDATE voice_agent_config' lib/db/migrations/036_voice_agent_fred_persona.sql
   ```

5. **fred-brain.ts imports in voice-agent.ts:**
   ```bash
   grep 'fred-brain' lib/voice-agent.ts
   ```

6. **Original migration 009 untouched:**
   ```bash
   git diff lib/db/migrations/009_voice_agent_tables.sql
   # Should show no changes
   ```

7. **Full TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
- SMS getCheckinTemplate uses 3 rotating Fred-voice messages, all under 160 chars
- SMS getWelcomeTemplate identifies sender as "Fred Cary" with accountability framing
- SMS getStopConfirmation signed "--Fred"
- Voice agent getDefaultSystemPrompt() identifies as Fred Cary, imports from fred-brain.ts
- Voice agent AccessToken name is "Fred Cary" (not "AI Support Assistant")
- Voice agent prompt explicitly states never refer to yourself as "AI assistant" or "A Startup Biz"
- Admin API GET default config has name "Fred Cary", Fred persona system_prompt, Fred greeting
- Admin API default after_hours_message and fallback_message in Fred's voice
- New migration 036_voice_agent_fred_persona.sql UPDATEs (not INSERTs) the default row
- Original migration 009 is NOT modified
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/14-voice-agents-channels/14-02-SUMMARY.md`
</output>
