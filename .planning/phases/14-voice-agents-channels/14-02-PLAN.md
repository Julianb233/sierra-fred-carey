---
phase: 14-voice-agents-channels
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/sms/templates.ts
  - lib/voice-agent.ts
  - app/api/admin/voice-agent/config/route.ts
  - lib/db/migrations/014_voice_agent_fred_persona.sql
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SMS check-in messages are written in Fred Cary's motivational, direct voice -- not generic SaaS language"
    - "SMS welcome message identifies the sender as Fred Cary, not 'Sahara check-ins'"
    - "Voice agent getDefaultSystemPrompt() identifies as Fred Cary with no reference to 'A Startup Biz'"
    - "Voice agent AccessToken name is 'Fred Cary', not 'AI Support Assistant'"
    - "Admin API default config uses Fred Cary persona, not generic support assistant"
    - "Database migration updates the default voice_agent_config row to Fred Cary persona"
    - "All SMS messages fit within 160-character single SMS segment limit"
  artifacts:
    - path: "lib/sms/templates.ts"
      provides: "SMS templates in Fred Cary's voice"
      exports: ["getCheckinTemplate", "getWelcomeTemplate", "getStopConfirmation"]
    - path: "lib/voice-agent.ts"
      provides: "Voice agent with Fred Cary identity and system prompt"
      exports: ["generateAgentToken", "spawnAgent", "buildEnhancedSystemPrompt", "buildSystemPrompt"]
    - path: "app/api/admin/voice-agent/config/route.ts"
      provides: "Admin API with Fred Cary default config"
      exports: ["GET", "PUT", "POST"]
    - path: "lib/db/migrations/014_voice_agent_fred_persona.sql"
      provides: "Database migration to update default voice agent config to Fred persona"
  key_links:
    - from: "lib/voice-agent.ts"
      to: "lib/fred-brain.ts"
      via: "import FRED_BIO, FRED_COMMUNICATION_STYLE, FRED_COMPANIES, SAHARA_MESSAGING"
      pattern: "FRED_BIO"
    - from: "lib/voice-agent.ts"
      to: "livekit-server-sdk"
      via: "import AccessToken"
      pattern: "AccessToken"
    - from: "app/api/admin/voice-agent/config/route.ts"
      to: "lib/supabase/server"
      via: "import createServiceClient"
      pattern: "createServiceClient"
---

<objective>
Rewrite SMS check-in templates and voice agent configuration to use Fred Cary's voice, replacing generic SaaS language and the incorrect "A Startup Biz" identity.

Purpose: SMS templates use bland corporate language ("Hey {name}! Weekly check-in from Sahara.") with zero personality. The voice agent identifies as "A Startup Biz" support assistant in the code fallback, database seed, and admin API defaults -- a completely wrong brand identity. Three separate sources of voice agent config must all be updated.

Output: SMS templates rewritten in Fred's motivational, direct voice. Voice agent system prompt replaced across all three sources (code fallback, database migration, admin API defaults). AccessToken name changed from "AI Support Assistant" to "Fred Cary".
</objective>

<execution_context>
@/opt/agency-workspace/sierra-fred-carey/.planning/workflows/execute-plan.md
@/opt/agency-workspace/sierra-fred-carey/.planning/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-voice-agents-channels/14-RESEARCH.md

Key source files:
@lib/fred-brain.ts
@lib/sms/templates.ts
@lib/voice-agent.ts
@app/api/admin/voice-agent/config/route.ts
@lib/db/migrations/009_voice_agent_tables.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite SMS templates in Fred Cary's voice</name>
  <files>
    lib/sms/templates.ts
  </files>
  <action>
Rewrite the three SMS template functions in `lib/sms/templates.ts` to use Fred Cary's voice. SMS messages must be under 160 characters (single segment). Fred's voice in SMS = motivational, direct, personal -- NOT storytelling (no room for stories in 160 chars).

**IMPORTANT constraints:**
- All messages must fit within `MAX_SMS_LENGTH` (160 chars)
- Fred's SMS voice is concise and motivational, not verbose
- Every template must be measured for character count before writing
- Do NOT import from fred-brain.ts for SMS -- the templates are static strings, not dynamic prompts. Importing would add runtime overhead for no benefit since the values are hardcoded in the template text anyway.

**Rewrite getCheckinTemplate (line 18-47):**

Replace the bland `"Hey ${founderName}! Weekly check-in from Sahara."` pattern with rotating Fred-voice messages:

```typescript
export function getCheckinTemplate(
  founderName: string,
  highlights?: string[]
): string {
  // Fred's voice: motivational, direct, personal
  // Rotate messages for variety (deterministic based on name length)
  const messages = [
    `${founderName} -- it's Fred. What's your biggest win this week? Reply with your top 3 priorities.`,
    `Hey ${founderName}, Fred here. Quick check-in: what moved the needle this week? Top 3 priorities -- go.`,
    `${founderName}, how's the grind? Tell me your #1 win and your biggest blocker. --Fred`,
  ];

  if (!highlights || highlights.length === 0) {
    const index = founderName.length % messages.length;
    return messages[index].slice(0, MAX_SMS_LENGTH);
  }

  // With highlights, use a shorter base to leave room
  const base = `${founderName}, Fred here. Your agents finished: `;
  const cta = ' What are your priorities?';
  const availableSpace = MAX_SMS_LENGTH - base.length - cta.length;

  let highlightText = highlights.join(', ');
  if (highlightText.length > availableSpace) {
    highlightText = highlightText.slice(0, availableSpace - 3) + '...';
  }

  const message = `${base}${highlightText}.${cta}`;

  // Final safety truncation
  if (message.length > MAX_SMS_LENGTH) {
    const index = founderName.length % messages.length;
    return messages[index].slice(0, MAX_SMS_LENGTH);
  }

  return message;
}
```

**Rewrite getWelcomeTemplate (line 55-60):**

Replace `"Welcome to Sahara check-ins, ${founderName}!"` with Fred's personal introduction:

```typescript
export function getWelcomeTemplate(founderName: string): string {
  return `${founderName}, it's Fred Cary. I'll text you weekly for a quick accountability check. Think of me as your co-founder in your pocket. Reply STOP to opt out.`.slice(
    0,
    MAX_SMS_LENGTH
  );
}
```

**Rewrite getStopConfirmation (line 67-69):**

Replace generic unsubscribe with Fred's voice:

```typescript
export function getStopConfirmation(): string {
  return "Got it -- you're unsubscribed from check-ins. Text START anytime to jump back in. --Fred";
}
```

**Character count verification (measure each template):**
- Check-in message 0: `"{name} -- it's Fred. What's your biggest win this week? Reply with your top 3 priorities."` -- ~90 chars with 5-char name
- Check-in message 1: `"Hey {name}, Fred here. Quick check-in: what moved the needle this week? Top 3 priorities -- go."` -- ~98 chars with 5-char name
- Check-in message 2: `"{name}, how's the grind? Tell me your #1 win and your biggest blocker. --Fred"` -- ~80 chars with 5-char name
- Welcome: ~155 chars with 5-char name (tight but fits)
- Stop: 89 chars (fits easily)
  </action>
  <verify>
1. **Templates rewritten with Fred's voice:**
   ```bash
   grep "Fred" lib/sms/templates.ts
   # Should find Fred in check-in, welcome, and stop templates
   ```

2. **No generic SaaS language remains:**
   ```bash
   grep -i 'Weekly check-in from Sahara\|Welcome to Sahara check-ins' lib/sms/templates.ts
   # Should return nothing
   ```

3. **MAX_SMS_LENGTH still enforced:**
   ```bash
   grep 'MAX_SMS_LENGTH' lib/sms/templates.ts
   grep 'slice(0, MAX_SMS_LENGTH)' lib/sms/templates.ts
   ```

4. **All 3 functions still exported:**
   ```bash
   grep 'export function' lib/sms/templates.ts
   # Should show getCheckinTemplate, getWelcomeTemplate, getStopConfirmation
   ```

5. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit 2>&1 | grep 'templates' || echo "No errors"
   ```
  </verify>
  <done>
VOICE-09: SMS templates rewritten in Fred Cary's voice. getCheckinTemplate uses 3 rotating Fred-voice messages. getWelcomeTemplate identifies sender as "Fred Cary" with co-founder framing. getStopConfirmation signed "--Fred". All messages verified under 160 chars. No fred-brain.ts import needed (static strings).
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite voice agent code fallback and token identity</name>
  <files>
    lib/voice-agent.ts
  </files>
  <action>
Update `lib/voice-agent.ts` in three places:

**Step 1: Change AccessToken name (line 88)**

Replace `name: 'AI Support Assistant'` with `name: 'Fred Cary'`:

```typescript
const at = new AccessToken(apiKey, apiSecret, {
  identity: agentIdentity,
  name: 'Fred Cary',
  ttl: 7200,
  metadata: JSON.stringify({
    type: 'ai_agent',
    voice: config.voice || 'alloy',
    systemPrompt: config.systemPrompt || getDefaultSystemPrompt(),
  }),
});
```

**Step 2: Replace getDefaultSystemPrompt() entirely (line 400-424)**

Replace the entire `getDefaultSystemPrompt()` function. This is the code fallback used when no database config exists. Import from fred-brain.ts to compose the prompt dynamically:

First, add imports at the top of the file (after existing imports):
```typescript
import {
  FRED_BIO,
  FRED_COMMUNICATION_STYLE,
  FRED_COMPANIES,
  SAHARA_MESSAGING,
} from '@/lib/fred-brain';
```

Then replace the function:

```typescript
function getDefaultSystemPrompt(): string {
  return `You are Fred Cary, serial entrepreneur, CEO, attorney, and business coach with over ${FRED_BIO.yearsExperience} years of experience.

Your role on this call:
- Help founders with questions about Sahara and entrepreneurship
- Provide direct, actionable guidance based on your experience
- Be conversational but purposeful -- this is a voice call, not an essay

About you:
- Founded ${FRED_BIO.companiesFounded}+ companies, taken ${FRED_BIO.ipos} public, had ${FRED_BIO.acquisitions} acquired
- Created technology used in ${FRED_COMPANIES.summaryStats.tvHouseholdsReach} of the world's TV households
- Coached 10,000+ founders through IdeaPros and now Sahara
- Your motto: ${FRED_COMMUNICATION_STYLE.voice.primary}

About Sahara (your current venture):
${SAHARA_MESSAGING.differentiators.map(d => `- ${d}`).join('\n')}
- Three tiers: Free (FRED chat), Pro (Reality Lens, frameworks), Studio (virtual agent team)

Voice style:
- ${FRED_COMMUNICATION_STYLE.voice.primary}, but warm
- Use personal stories when relevant
- Emphasize action over theory
- Never sugarcoat -- founders need the truth
- Keep responses concise for voice -- 2-3 sentences max per turn

Never refer to yourself as an "AI assistant" or "A Startup Biz." You are Fred Cary, co-founder of Sahara.`;
}
```

**Step 3: Update buildSystemPrompt() (line 429-441)**

The `buildSystemPrompt()` function currently calls `getDefaultSystemPrompt()` for its base. Since `getDefaultSystemPrompt()` is now rewritten, `buildSystemPrompt()` will automatically use the new Fred Cary prompt as its base. No code changes needed to the function itself, but verify it still works correctly.

Do NOT change:
- The `buildEnhancedSystemPrompt()` async function (it fetches from DB first, falls back to `getDefaultSystemPrompt()`)
- The `fetchAgentConfig()`, `fetchKnowledgeBase()`, `fetchEscalationRules()` functions
- The `isWithinBusinessHours()` function
- Any session management functions (spawnAgent, removeAgent, etc.)
- The cache logic (CACHE_TTL, etc.)
  </action>
  <verify>
1. **AccessToken name changed:**
   ```bash
   grep "name: 'Fred Cary'" lib/voice-agent.ts
   # Should find exactly 1 match
   grep "AI Support Assistant" lib/voice-agent.ts
   # Should return nothing
   ```

2. **No "A Startup Biz" reference:**
   ```bash
   grep -i 'A Startup Biz\|astartupbiz' lib/voice-agent.ts
   # Should return nothing
   ```

3. **Fred Cary identity in default prompt:**
   ```bash
   grep 'Fred Cary' lib/voice-agent.ts
   # Should find multiple matches (AccessToken name + system prompt)
   ```

4. **Imports from fred-brain.ts:**
   ```bash
   grep 'fred-brain' lib/voice-agent.ts
   ```

5. **buildEnhancedSystemPrompt still works (calls getDefaultSystemPrompt):**
   ```bash
   grep 'getDefaultSystemPrompt' lib/voice-agent.ts
   # Should find calls in buildEnhancedSystemPrompt, generateAgentToken, spawnAgent
   ```

6. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit 2>&1 | grep 'voice-agent' || echo "No errors"
   ```
  </verify>
  <done>
VOICE-10 (partial): Voice agent code fallback rewritten. getDefaultSystemPrompt() now identifies as Fred Cary with bio data from fred-brain.ts. AccessToken name changed from "AI Support Assistant" to "Fred Cary". All "A Startup Biz" references removed. buildEnhancedSystemPrompt() unchanged -- it fetches from DB first, falls back to the now-rewritten getDefaultSystemPrompt().
  </done>
</task>

<task type="auto">
  <name>Task 3: Update admin API defaults and create database migration</name>
  <files>
    app/api/admin/voice-agent/config/route.ts
    lib/db/migrations/014_voice_agent_fred_persona.sql
  </files>
  <action>
**Step 1: Update admin API default config (VOICE-10)**

In `app/api/admin/voice-agent/config/route.ts`, the GET handler returns a hardcoded default config when no database row exists (line 27-61). Update the following fields in the default config object:

Replace the `name` field (line 29):
```
'Default Agent' -> 'Fred Cary'
```

Replace the `system_prompt` field (line 31-40):
```typescript
system_prompt: `You are Fred Cary, serial entrepreneur with 50+ years of experience, 40+ companies founded, 3 IPOs. You are the co-founder of Sahara, an AI-driven mentorship platform for founders.

Your role on this call:
- Help founders with questions about Sahara and entrepreneurship
- Provide direct, actionable guidance from your experience
- Be conversational but purposeful

Voice style:
- Direct, no-BS approach, but warm
- Use personal stories when relevant
- Keep responses concise for voice -- 2-3 sentences max per turn
- Never refer to yourself as an AI assistant`,
```

Replace the `greeting_message` field (line 41):
```
'Hello! Thank you for calling. How can I help you today?' ->
'Hey, this is Fred. Thanks for calling Sahara. What can I help you with today?'
```

Replace the `response_style` field (line 44):
```
'professional' -> 'friendly'
```

Replace the `after_hours_message` field (line 57):
```
'Our office is currently closed. Please leave a message and we\'ll get back to you.' ->
'Hey, it\'s Fred. We\'re closed right now, but leave a message and I\'ll get back to you. Keep grinding.'
```

Replace the `fallback_message` field (line 58):
```
'I apologize, but I\'m unable to help with that. Would you like me to connect you with a team member?' ->
'That\'s outside my wheelhouse right now. Want me to connect you with someone on the team who can help?'
```

Do NOT change:
- The PUT or POST handlers (they accept user input, not defaults)
- The voice, max_response_length, language, business_hours, timezone, or after_hours_behavior fields
- The Supabase client or auth logic

**Step 2: Create new database migration (VOICE-10)**

Create `lib/db/migrations/014_voice_agent_fred_persona.sql` as a NEW migration that UPDATEs the existing default row. Do NOT modify migration 009 -- it may already be run in production, and its `ON CONFLICT DO NOTHING` means changes to the INSERT would have no effect.

```sql
-- Migration 014: Update voice agent default config to Fred Cary persona
-- This updates the default row inserted by migration 009.
-- If no default row exists, this is a no-op (safe to run idempotently).

UPDATE voice_agent_config
SET
  name = 'Fred Cary',
  system_prompt = 'You are Fred Cary, serial entrepreneur with 50+ years of experience, 40+ companies founded, 3 IPOs. You are the co-founder of Sahara, an AI-driven mentorship platform for founders.

Your role on this call:
- Help founders with questions about Sahara and entrepreneurship
- Provide direct, actionable guidance from your experience
- Be conversational but purposeful

Voice style:
- Direct, no-BS approach, but warm
- Use personal stories when relevant
- Keep responses concise for voice -- 2-3 sentences max per turn
- Never refer to yourself as an AI assistant',
  greeting_message = 'Hey, this is Fred. Thanks for calling Sahara. What can I help you with today?',
  response_style = 'friendly',
  after_hours_message = 'Hey, it''s Fred. We''re closed right now, but leave a message and I''ll get back to you. Keep grinding.',
  fallback_message = 'That''s outside my wheelhouse right now. Want me to connect you with someone on the team who can help?',
  updated_at = NOW()
WHERE name = 'Default Agent'
  AND is_active = true;
```

This migration:
- Uses UPDATE, not INSERT (the row was created by migration 009)
- Targets the specific default row by `name = 'Default Agent' AND is_active = true`
- Is idempotent (can run multiple times safely)
- Uses single-quote escaping for SQL (`''` for apostrophes)
- Sets `updated_at` to reflect the change
  </action>
  <verify>
1. **Admin API default uses Fred Cary:**
   ```bash
   grep 'Fred Cary' app/api/admin/voice-agent/config/route.ts
   # Should find in name and system_prompt
   ```

2. **No generic support assistant in admin defaults:**
   ```bash
   grep -i 'helpful AI support assistant\|Default Agent' app/api/admin/voice-agent/config/route.ts
   # Should return nothing (in the default config section)
   ```

3. **Greeting message updated:**
   ```bash
   grep "Hey, this is Fred" app/api/admin/voice-agent/config/route.ts
   ```

4. **Database migration exists:**
   ```bash
   test -f lib/db/migrations/014_voice_agent_fred_persona.sql && echo "EXISTS" || echo "MISSING"
   ```

5. **Migration uses UPDATE (not INSERT):**
   ```bash
   grep 'UPDATE voice_agent_config' lib/db/migrations/014_voice_agent_fred_persona.sql
   ```

6. **Migration targets correct row:**
   ```bash
   grep "WHERE name = 'Default Agent'" lib/db/migrations/014_voice_agent_fred_persona.sql
   ```

7. **Original migration 009 NOT modified:**
   ```bash
   grep 'A Startup Biz\|Default Agent' lib/db/migrations/009_voice_agent_tables.sql
   # Should still show 'Default Agent' (unchanged)
   ```

8. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit 2>&1 | grep 'voice-agent\|config' || echo "No errors"
   ```
  </verify>
  <done>
VOICE-10 (complete): Admin API default config updated -- name "Fred Cary", system_prompt with Fred persona, greeting "Hey, this is Fred", after_hours and fallback messages in Fred's voice. New migration 014_voice_agent_fred_persona.sql UPDATEs the default row from migration 009. Original migration 009 unchanged. All three voice agent config sources (code fallback, DB migration, admin API defaults) now use Fred Cary persona.
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify the full SMS and voice agent voice rewrite:

1. **SMS templates in Fred's voice:**
   ```bash
   grep "Fred" lib/sms/templates.ts
   grep -i 'Weekly check-in from Sahara\|Welcome to Sahara check-ins' lib/sms/templates.ts
   # First should find matches, second should find nothing
   ```

2. **Voice agent code fallback:**
   ```bash
   grep "Fred Cary" lib/voice-agent.ts
   grep -i 'A Startup Biz\|AI Support Assistant' lib/voice-agent.ts
   # First should find matches, second should find nothing
   ```

3. **Admin API defaults:**
   ```bash
   grep "Fred Cary" app/api/admin/voice-agent/config/route.ts
   grep "Hey, this is Fred" app/api/admin/voice-agent/config/route.ts
   ```

4. **Database migration:**
   ```bash
   test -f lib/db/migrations/014_voice_agent_fred_persona.sql && echo "EXISTS" || echo "MISSING"
   grep 'UPDATE' lib/db/migrations/014_voice_agent_fred_persona.sql
   ```

5. **fred-brain.ts imports in voice-agent.ts:**
   ```bash
   grep 'fred-brain' lib/voice-agent.ts
   ```

6. **Original migration 009 untouched:**
   ```bash
   git diff lib/db/migrations/009_voice_agent_tables.sql
   # Should show no changes
   ```

7. **Full TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```

8. **Vitest passes:**
   ```bash
   npx vitest run 2>&1 | tail -5
   ```
</verification>

<success_criteria>
- SMS getCheckinTemplate uses 3 rotating Fred-voice messages, all under 160 chars
- SMS getWelcomeTemplate identifies sender as "Fred Cary" with accountability framing
- SMS getStopConfirmation signed "--Fred"
- Voice agent getDefaultSystemPrompt() identifies as Fred Cary, imports from fred-brain.ts
- Voice agent AccessToken name is "Fred Cary" (not "AI Support Assistant")
- Voice agent prompt includes Fred's bio stats, Sahara info, and voice style rules
- Voice agent prompt explicitly states "Never refer to yourself as an AI assistant or A Startup Biz"
- Admin API GET default config has name "Fred Cary", Fred persona system_prompt, Fred greeting
- Admin API default after_hours_message and fallback_message in Fred's voice
- New migration 014 UPDATEs (not INSERTs) the default voice_agent_config row
- Original migration 009 is NOT modified
- TypeScript compilation passes with no errors
- All existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/14-voice-agents-channels/14-02-SUMMARY.md`
</output>
