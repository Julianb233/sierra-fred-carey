---
phase: 64-dashboard-analytics
plan: 03
type: execute
wave: 2
depends_on: ["64-01"]
files_modified:
  - components/dashboard/dashboard-export-menu.tsx
  - components/dashboard/funnel-chart.tsx
  - app/api/dashboard/export/route.ts
  - app/dashboard/analytics/page.tsx
autonomous: true

must_haves:
  truths:
    - "Founder can export analytics trends as CSV from the analytics page"
    - "Founder can export a summary report as PDF from the analytics page"
    - "Founder can see a user journey funnel visualization on the analytics page"
    - "Export works even when some data sections are empty"
  artifacts:
    - path: "components/dashboard/dashboard-export-menu.tsx"
      provides: "Export dropdown menu with CSV and PDF options"
      min_lines: 30
    - path: "components/dashboard/funnel-chart.tsx"
      provides: "Funnel visualization from Supabase activity data"
      min_lines: 40
    - path: "app/api/dashboard/export/route.ts"
      provides: "Server-side PDF export endpoint"
      exports: ["GET"]
  key_links:
    - from: "components/dashboard/dashboard-export-menu.tsx"
      to: "lib/export/csv-generator.ts"
      via: "import CSVGenerator, downloadCSV"
      pattern: "CSVGenerator|downloadCSV"
    - from: "app/api/dashboard/export/route.ts"
      to: "@react-pdf/renderer"
      via: "import renderToBuffer"
      pattern: "renderToBuffer"
    - from: "components/dashboard/funnel-chart.tsx"
      to: "recharts"
      via: "import BarChart"
      pattern: "BarChart.*recharts"
---

<objective>
Add data export (CSV + PDF) and user journey funnel visualization to the analytics page. CSV export runs client-side using existing CSVGenerator. PDF export runs server-side using existing @react-pdf/renderer. Funnel is built from Supabase activity data (not PostHog) per research recommendation.

Purpose: Founders can share their progress with advisors/investors via export, and see where they are in the user journey funnel.
Output: Export dropdown (CSV/PDF), server-side PDF endpoint, funnel chart component, all wired into the analytics page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-dashboard-analytics/64-RESEARCH.md
@.planning/phases/64-dashboard-analytics/64-CONTEXT.md
@.planning/phases/64-dashboard-analytics/64-01-SUMMARY.md

Key existing files to reference:
@lib/export/csv-generator.ts — CSVGenerator class, downloadCSV, getTimestampedFilename
@lib/export/types.ts — ExportConfig, ColumnMapping types
@lib/documents/export.ts — @react-pdf/renderer pattern with React.createElement (no JSX in .ts files)
@lib/dashboard/trends.ts — TrendPeriod type (from Plan 01)
@lib/dashboard/engagement-score.ts — MomentumIndicator type (from Plan 01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create export menu component and PDF export endpoint</name>
  <files>components/dashboard/dashboard-export-menu.tsx, app/api/dashboard/export/route.ts</files>
  <action>
Create `components/dashboard/dashboard-export-menu.tsx`:
- "use client" component
- Props: `{ trends: TrendPeriod[]; momentum: MomentumIndicator | null }`
- Render a shadcn `DropdownMenu` with trigger Button showing Download icon (lucide `Download`) and text "Export"
- Two menu items:
  1. "Export Trends (CSV)" — calls `exportTrendsCSV(trends)` function defined in the same file
  2. "Export Report (PDF)" — calls `exportReportPDF()` that fetches from `/api/dashboard/export`
- CSV export (client-side):
  - Import `CSVGenerator`, `downloadCSV`, `getTimestampedFilename` from `@/lib/export/csv-generator`
  - Define ExportConfig<TrendPeriod> with columns: Period, Conversations, Check-Ins, Next Steps Completed, Decisions Scored, Documents Created
  - Generate CSV and trigger download with filename `founder-analytics-{timestamp}.csv`
- PDF export (server-side):
  - Fetch `GET /api/dashboard/export` which returns a PDF blob
  - Create a download link, click it, revoke URL
  - Show `toast.success("Report exported")` or `toast.error("Export failed")` using sonner
- Disable buttons and show spinner while exporting
- If trends is empty, disable CSV button with tooltip "No data to export"

Create `app/api/dashboard/export/route.ts`:
- Follow pattern from `lib/documents/export.ts` for @react-pdf/renderer usage
- Use `React.createElement` (NOT JSX — this is a .ts file, not .tsx)
- Use `requireAuth()` for user ID
- Fetch trends and momentum data by calling `getFounderTrends()` and `computeMomentumIndicator()` directly (server-side, no HTTP round-trip)
- Build PDF document with:
  - Title page: "Founder Analytics Report" + date
  - Momentum section: trend direction + summary text
  - Trends table: all TrendPeriod data in a formatted table
  - Limit to last 90 days to avoid timeout (per research pitfall 4)
- Use `renderToBuffer()` to generate PDF
- Return `new Response(buffer, { headers: { 'Content-Type': 'application/pdf', 'Content-Disposition': 'attachment; filename="founder-analytics-report.pdf"' } })`
- On error, return 500 with JSON error message
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the export menu component renders a DropdownMenu. Verify the PDF endpoint imports @react-pdf/renderer correctly and uses React.createElement (not JSX).
  </verify>
  <done>
Export dropdown component exists with CSV (client-side) and PDF (server-side) options. CSV uses existing CSVGenerator. PDF uses existing @react-pdf/renderer. Both handle empty data gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create funnel chart and wire export + funnel into analytics page</name>
  <files>components/dashboard/funnel-chart.tsx, app/dashboard/analytics/page.tsx</files>
  <action>
Create `components/dashboard/funnel-chart.tsx`:
- "use client" component
- Props: `{ userId?: string }` (optional, component fetches its own data)
- Defines funnel steps as a horizontal BarChart (recharts) showing conversion at each stage:
  - Step 1: "Signed Up" — always 1 (the user exists)
  - Step 2: "First Chat" — 1 if conversations > 0, else 0
  - Step 3: "First Check-In" — 1 if checkIns > 0, else 0
  - Step 4: "Next Step Completed" — 1 if nextStepsCompleted > 0, else 0
  - Step 5: "Readiness Review" — 1 if decisionsScored > 0, else 0
- Fetch data from `/api/dashboard/trends?range=all` on mount to determine which steps are complete
- Render as a horizontal BarChart with steps on Y-axis, completion (0/1 mapped to percentage-like display) on X-axis
- Color: completed steps in #ff6a1a (orange), incomplete in #e5e7eb (gray-200 light) / #374151 (gray-700 dark)
- Each bar shows a label: "Complete" or "Not yet"
- Wrapped in shadcn Card with title "Your Journey" and description "Steps completed on your founder path"
- Empty state: Show all steps as incomplete with encouraging "Start your journey by chatting with Fred" message
- Use `useMemo` to prevent unnecessary recalculations

Modify `app/dashboard/analytics/page.tsx` (created in Plan 02):
- Import and add `DashboardExportMenu` component in the page header area, next to the time range selector
- Pass `trends` and `momentum` props to the export menu
- Import and add `FunnelChart` component below the sparkline grid / expanded chart area
- The funnel chart sits at the bottom of the analytics page as a "Your Journey" section
- Ensure the export menu and funnel chart have proper loading states (skeleton while data loads)
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the analytics page imports both new components. Verify the funnel chart renders a recharts BarChart. Verify the export menu is positioned in the page header.
  </verify>
  <done>
Analytics page has: (1) Export dropdown in header with CSV + PDF options, (2) Funnel chart showing user journey progress at bottom of page. Both handle empty states. Full analytics page is complete with all 4 sections: momentum, sparklines, charts, funnel, and export.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in all new and modified files
2. CSV export downloads a well-formatted CSV file with trend data
3. PDF export endpoint returns a valid PDF document
4. Funnel chart shows 5 journey steps with completion status
5. Export menu disables gracefully when no data available
6. No new npm packages installed (CSVGenerator, @react-pdf/renderer, recharts all existing)
7. Analytics page has all sections: momentum, sparklines, expanded charts, funnel, export
</verification>

<success_criteria>
- Export dropdown on analytics page with "Export Trends (CSV)" and "Export Report (PDF)"
- CSV export uses existing CSVGenerator, downloads immediately
- PDF export generates server-side via @react-pdf/renderer, downloads as file
- Funnel chart shows 5-step user journey with completion status
- Empty states handled for all components
- Analytics page is feature-complete with all IMPROVE-03 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/64-dashboard-analytics/64-03-SUMMARY.md`
</output>
