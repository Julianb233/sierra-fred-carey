---
phase: 64-dashboard-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/dashboard/trends.ts
  - lib/dashboard/engagement-score.ts
  - app/api/dashboard/trends/route.ts
  - app/api/dashboard/engagement/route.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/dashboard/trends returns weekly time-series activity data for the authenticated user"
    - "GET /api/dashboard/engagement returns a momentum indicator with trend direction and activity breakdown"
    - "Both endpoints return graceful empty data for users with no activity"
  artifacts:
    - path: "lib/dashboard/trends.ts"
      provides: "Time-series aggregation from existing Supabase tables"
      exports: ["getFounderTrends", "TrendPeriod"]
    - path: "lib/dashboard/engagement-score.ts"
      provides: "Momentum/engagement computation from activity counts"
      exports: ["computeMomentumIndicator", "MomentumIndicator"]
    - path: "app/api/dashboard/trends/route.ts"
      provides: "GET endpoint for trend data"
      exports: ["GET"]
    - path: "app/api/dashboard/engagement/route.ts"
      provides: "GET endpoint for engagement/momentum data"
      exports: ["GET"]
  key_links:
    - from: "app/api/dashboard/trends/route.ts"
      to: "lib/dashboard/trends.ts"
      via: "import getFounderTrends"
      pattern: "getFounderTrends"
    - from: "app/api/dashboard/engagement/route.ts"
      to: "lib/dashboard/engagement-score.ts"
      via: "import computeMomentumIndicator"
      pattern: "computeMomentumIndicator"
    - from: "lib/dashboard/trends.ts"
      to: "lib/supabase/server"
      via: "createServiceClient for DB queries"
      pattern: "createServiceClient"
---

<objective>
Build the backend data layer for dashboard analytics: a trends API that aggregates weekly/monthly time-series data from existing Supabase tables, and a momentum indicator that computes trend direction from founder activity counts.

Purpose: The existing dashboard is point-in-time only. This plan creates the data foundation that charts and export features will consume.
Output: Two new API endpoints (`/api/dashboard/trends`, `/api/dashboard/engagement`) with supporting lib modules.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/64-dashboard-analytics/64-RESEARCH.md
@.planning/phases/64-dashboard-analytics/64-CONTEXT.md

Key existing files to reference:
@lib/dashboard/command-center.ts — Follow this exact pattern for service client, parallel queries, type exports
@app/api/dashboard/command-center/route.ts — Follow this pattern for auth + error handling
@lib/supabase/server.ts — createServiceClient import
@lib/auth.ts — requireAuth import
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trends aggregation module and API endpoint</name>
  <files>lib/dashboard/trends.ts, app/api/dashboard/trends/route.ts</files>
  <action>
Create `lib/dashboard/trends.ts` with:

1. Export `TrendPeriod` interface:
   ```typescript
   export interface TrendPeriod {
     period: string;           // "2026-W07" or "2026-02"
     conversations: number;    // fred_episodic_memory where event_type='conversation'
     checkIns: number;         // sms_checkins where direction='inbound'
     nextStepsCompleted: number; // next_steps where status='completed'
     decisionsScored: number;  // pitch_reviews (decisions scored)
     documentsCreated: number; // document_repository + strategy_documents
   }
   ```

2. Export `getFounderTrends(userId: string, granularity: "weekly" | "monthly", periods: number)` function:
   - Use `createServiceClient()` from `@/lib/supabase/server`
   - Compute date range: `periods` weeks/months back from now using `date-fns` `subWeeks`/`subMonths`
   - Run 5 parallel Supabase queries with `Promise.all`, each fetching rows with `created_at` >= startDate for the user
   - Group results in JavaScript using `date-fns` `startOfWeek`/`startOfMonth` and `format` (NOT raw SQL `date_trunc` -- Supabase JS client doesn't support it directly)
   - For `nextStepsCompleted`, use `completed_at` field (not `created_at`), filtering `status='completed'`
   - Merge all counts into TrendPeriod[] ordered by period ascending
   - Return empty array if no data
   - Default: granularity="weekly", periods=12

3. Support query params: `?range=7d|30d|90d|all&granularity=weekly|monthly`
   - 7d = weekly, 1 period
   - 30d = weekly, 4 periods (default)
   - 90d = weekly, 12 periods
   - all = monthly, 24 periods

Create `app/api/dashboard/trends/route.ts`:
   - Follow exact pattern from `app/api/dashboard/command-center/route.ts`
   - Use `requireAuth()` for user ID
   - Parse `range` and `granularity` from URL searchParams
   - Call `getFounderTrends()` with computed params
   - Return `{ success: true, data: { trends: TrendPeriod[], granularity, range } }`
   - On error, return `{ success: true, data: { trends: [], granularity: "weekly", range: "30d" } }` (graceful degradation)
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors in new files. Verify the API route file exports a GET function. Verify `lib/dashboard/trends.ts` exports both `TrendPeriod` type and `getFounderTrends` function.
  </verify>
  <done>
`/api/dashboard/trends` endpoint exists, accepts range/granularity query params, returns TrendPeriod[] from existing Supabase tables. Empty data returns empty array (no errors).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create momentum indicator module and API endpoint</name>
  <files>lib/dashboard/engagement-score.ts, app/api/dashboard/engagement/route.ts</files>
  <action>
Create `lib/dashboard/engagement-score.ts` with:

1. Export `MomentumIndicator` interface:
   ```typescript
   export interface MomentumIndicator {
     trend: "rising" | "stable" | "declining";
     summary: string;          // e.g., "3 check-ins, 5 steps completed this week"
     breakdown: {
       conversations: { current: number; previous: number };
       checkIns: { current: number; previous: number };
       nextStepsCompleted: { current: number; previous: number };
       readinessProgress: { current: number; previous: number };
     };
     lastActiveDate: string | null;
   }
   ```

   IMPORTANT: This is a momentum INDICATOR, not a numeric score. No 0-100 scale. No gamification. Per CONTEXT.md: "Momentum indicator, NOT a numeric score -- trend-focused, not gamified."

2. Export `computeMomentumIndicator(userId: string)` function:
   - Use `createServiceClient()` from `@/lib/supabase/server`
   - Query 4 activity types for CURRENT 14-day window and PREVIOUS 14-day window (use `date-fns` `subDays`):
     a. `fred_episodic_memory` where `event_type='conversation'` — conversations
     b. `sms_checkins` where `direction='inbound'` — check-ins
     c. `next_steps` where `status='completed'` — completed steps (use `completed_at`)
     d. `investor_readiness_scores` — readiness assessments
   - All 8 queries (4 current + 4 previous) run in parallel with `Promise.all`
   - Compare total activity: current > previous * 1.2 = "rising", current < previous * 0.8 = "declining", else "stable"
   - Build summary string: factual, encouraging, no judgmental language. Examples:
     - Rising: "Trending up -- 3 check-ins, 5 steps completed this period"
     - Stable: "Steady momentum -- 2 check-ins, 3 steps completed this period"
     - Declining: "Activity has slowed -- 1 check-in this period"
   - Get lastActiveDate from most recent activity across all tables
   - Return indicator with empty breakdown and "No activity yet" summary if no data

Create `app/api/dashboard/engagement/route.ts`:
   - Follow exact pattern from command-center route.ts
   - Use `requireAuth()` for user ID
   - Call `computeMomentumIndicator(userId)`
   - Return `{ success: true, data: indicator }`
   - On error, return graceful fallback with trend="stable", summary="Unable to compute momentum"
  </action>
  <verify>
Run `npx tsc --noEmit` to confirm no type errors. Verify the API route file exports a GET function. Verify `lib/dashboard/engagement-score.ts` exports both `MomentumIndicator` type and `computeMomentumIndicator` function.
  </verify>
  <done>
`/api/dashboard/engagement` endpoint exists, returns MomentumIndicator with trend direction ("rising"/"stable"/"declining"), factual summary string, and per-activity breakdown. No numeric scores. Empty data returns "stable" with "No activity yet" summary.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors in the 4 new files
2. Both API routes use `requireAuth()` for authentication
3. Both endpoints handle errors gracefully (return empty/default data, never 500)
4. No new npm packages installed (all dependencies already in project)
5. Time-series queries use `Promise.all` for parallel execution (not sequential)
6. Momentum is a trend indicator, not a numeric score
</verification>

<success_criteria>
- Two new API endpoints functional: `/api/dashboard/trends` and `/api/dashboard/engagement`
- Trends endpoint returns TrendPeriod[] with weekly/monthly granularity from existing Supabase tables
- Engagement endpoint returns MomentumIndicator with trend direction and factual summary
- Both endpoints degrade gracefully for users with no activity data
- All types are exported for consumption by frontend components (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/64-dashboard-analytics/64-01-SUMMARY.md`
</output>
