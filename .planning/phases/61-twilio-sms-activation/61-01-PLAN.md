---
phase: 61-twilio-sms-activation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/sms/status/route.ts
  - lib/sms/client.ts
  - lib/sms/types.ts
  - lib/db/sms.ts
  - lib/db/migrations/075_sms_delivery_status.sql
autonomous: true

must_haves:
  truths:
    - "SMS delivery status updates from Twilio are captured and stored in the database"
    - "Outbound check-in records transition from 'sent' to 'delivered' or 'failed' based on Twilio callbacks"
    - "SMS delivery success/failure rates are queryable for reporting"
  artifacts:
    - path: "app/api/sms/status/route.ts"
      provides: "Twilio delivery status webhook endpoint"
      exports: ["POST"]
    - path: "lib/sms/client.ts"
      provides: "Updated sendSMS with statusCallback URL"
      exports: ["sendSMS", "validateWebhook"]
    - path: "lib/db/sms.ts"
      provides: "Updated updateCheckinStatus with delivery event tracking"
      exports: ["updateCheckinStatus", "getDeliveryStats"]
  key_links:
    - from: "lib/sms/client.ts"
      to: "app/api/sms/status/route.ts"
      via: "statusCallback URL in sendSMS"
      pattern: "statusCallback.*api/sms/status"
    - from: "app/api/sms/status/route.ts"
      to: "lib/db/sms.ts"
      via: "updateCheckinStatus on webhook receipt"
      pattern: "updateCheckinStatus"
---

<objective>
Add SMS delivery status tracking so Twilio delivery callbacks update check-in records from "sent" to "delivered" or "failed", and add a delivery stats query for reporting.

Purpose: Currently, sendSMS fires and the record stays at "sent" forever. There is no way to know if messages were actually delivered. This is required for INFRA-03 success criteria #4: "SMS delivery status tracked and reported."

Output: A new /api/sms/status webhook endpoint, updated sendSMS to include statusCallback, delivery stats query function, and a migration adding delivery event columns.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key existing files to understand:
@lib/sms/client.ts
@lib/sms/types.ts
@lib/db/sms.ts
@app/api/sms/webhook/route.ts (pattern reference for signature validation)
@lib/db/migrations/029_sms_checkins.sql (existing schema)
</context>

<tasks>

<task type="auto">
  <name>Task 1: SMS Delivery Status Webhook + Client Update</name>
  <files>
    app/api/sms/status/route.ts
    lib/sms/client.ts
    lib/sms/types.ts
    lib/db/sms.ts
    lib/db/migrations/075_sms_delivery_status.sql
  </files>
  <action>
1. Create migration `lib/db/migrations/075_sms_delivery_status.sql`:
   - Add columns to sms_checkins: `delivery_status TEXT`, `delivery_error_code TEXT`, `delivery_error_message TEXT`, `delivered_at TIMESTAMPTZ`, `status_updated_at TIMESTAMPTZ`
   - Add index on `idx_sms_checkins_status` for status column
   - Add index on `idx_sms_checkins_delivery` for delivery_status column

2. Update `lib/sms/types.ts`:
   - Add `TwilioMessageStatus` type: `'accepted' | 'queued' | 'sending' | 'sent' | 'delivered' | 'undelivered' | 'failed'`
   - Add `DeliveryStats` interface: `{ total: number; delivered: number; failed: number; pending: number; deliveryRate: number }`
   - Add delivery fields to `CheckinRecord`: `deliveryStatus?: string`, `deliveryErrorCode?: string`, `deliveryErrorMessage?: string`, `deliveredAt?: Date`, `statusUpdatedAt?: Date`

3. Update `lib/sms/client.ts`:
   - Modify the `sendSMS` function to accept an optional `statusCallback` URL parameter
   - When `process.env.NEXT_PUBLIC_APP_URL` is set, pass `statusCallback: \`${process.env.NEXT_PUBLIC_APP_URL}/api/sms/status\`` to `client.messages.create()`
   - This tells Twilio to POST delivery status updates to our endpoint
   - Keep the existing function signature backward-compatible by making statusCallback optional

4. Update `lib/db/sms.ts`:
   - Add `updateDeliveryStatus(supabase, messageSid, status, errorCode?, errorMessage?)` function that updates the check-in record matching the message_sid with the delivery status fields
   - Add `getDeliveryStats(supabase, opts?: { userId?: string, startDate?: Date, endDate?: Date })` function that queries sms_checkins for outbound messages and returns aggregated DeliveryStats (total, delivered, failed, pending, deliveryRate as percentage)
   - Update `mapCheckin()` to include new delivery fields

5. Create `app/api/sms/status/route.ts`:
   - POST endpoint that receives Twilio delivery status callbacks
   - Twilio sends form-encoded POST with fields: MessageSid, MessageStatus, ErrorCode (optional), ErrorMessage (optional)
   - Validate Twilio signature using the same `validateWebhook` pattern from `app/api/sms/webhook/route.ts` (x-twilio-signature header, URL, params)
   - Extract MessageSid and MessageStatus from form data
   - Map Twilio status to our internal status: 'delivered' stays 'delivered', 'undelivered'/'failed' become 'failed', others are informational
   - Call `updateDeliveryStatus()` with the extracted data
   - When status is 'delivered', also call `updateCheckinStatus()` to set the main status to 'delivered'
   - When status is 'failed' or 'undelivered', call `updateCheckinStatus()` to set main status to 'failed'
   - Return 200 with empty body (Twilio expects 200 acknowledgment)
   - Use `createServiceClient()` since this is a server-to-server callback with no user session
   - Add `export const dynamic = 'force-dynamic'`
   - Log delivery events at info level with message SID and status

IMPORTANT: Do NOT use the inbound webhook URL for this. The status callback is a separate endpoint specifically for delivery receipts. The existing /api/sms/webhook handles inbound messages FROM users.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` completes successfully
    - Verify the new route file exists: `app/api/sms/status/route.ts`
    - Grep confirms statusCallback is referenced in client.ts: `grep -n 'statusCallback' lib/sms/client.ts`
    - Grep confirms getDeliveryStats export exists: `grep -n 'getDeliveryStats' lib/db/sms.ts`
  </verify>
  <done>
    - Twilio delivery status webhook at /api/sms/status accepts POST with signature validation
    - sendSMS automatically includes statusCallback URL when NEXT_PUBLIC_APP_URL is set
    - Check-in records update to delivered/failed based on Twilio callbacks
    - getDeliveryStats returns aggregated delivery metrics
    - Migration file ready for deployment
  </done>
</task>

<task type="auto">
  <name>Task 2: Opt-in Compliance Hardening</name>
  <files>
    lib/sms/templates.ts
    components/sms/checkin-settings.tsx
    lib/db/sms.ts
  </files>
  <action>
1. Update `components/sms/checkin-settings.tsx`:
   - Add a required consent checkbox before the Save button that reads: "I agree to receive weekly SMS check-in messages from Sahara at the phone number provided. Message frequency: 1x/week. Msg & data rates may apply. Reply STOP to cancel."
   - The Save button must be disabled unless the consent checkbox is checked (in addition to existing isSaving check)
   - Add a "Privacy" link text that points to `/privacy` (or `#` if no privacy page exists) within the consent text
   - Record the consent timestamp by adding `consentedAt` to the preferences update payload when `checkinEnabled` is toggled to `true` and the checkbox is checked

2. Update `lib/db/sms.ts`:
   - Add `consent_at` field handling in `updateSMSPreferences()` - when `consentedAt` is provided, store it as `consent_at` in the database
   - Update the `mapPreferences()` function to include `consentedAt` field

3. Update `lib/sms/types.ts`:
   - Add `consentedAt?: Date` to `UserSMSPreferences` interface

4. Update `lib/sms/templates.ts`:
   - Update `getWelcomeTemplate()` to include: "Msg frequency: 1x/week. Msg&data rates may apply." at the end (TCPA requirement)
   - Ensure the message still fits within 160 characters by trimming the greeting if needed

5. Update the A2P compliance notice in `components/sms/checkin-settings.tsx`:
   - Change the existing notice text to: "Standard message and data rates may apply. Message frequency: 1 per week. Reply STOP to unsubscribe at any time. Reply HELP for help. View our Privacy Policy for more information."

Note: The consent_at column does not need a separate migration -- it can be stored in the existing `user_sms_preferences` table's JSONB metadata or added as a column. Since the table already exists, add it to the migration file created in Task 1 (075_sms_delivery_status.sql) as an ALTER TABLE statement: `ALTER TABLE user_sms_preferences ADD COLUMN IF NOT EXISTS consent_at TIMESTAMPTZ;`
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` completes successfully
    - Grep confirms consent checkbox in settings: `grep -n 'consent' components/sms/checkin-settings.tsx`
    - Grep confirms consentedAt in types: `grep -n 'consentedAt' lib/sms/types.ts`
    - Grep confirms updated welcome template: `grep -n 'frequency' lib/sms/templates.ts`
  </verify>
  <done>
    - Consent checkbox required before enabling SMS check-ins
    - Consent timestamp recorded in database
    - Welcome SMS includes TCPA-required frequency and rate disclosures
    - Compliance notice updated with standard carrier messaging language
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` completes without errors
- New API endpoint exists: `app/api/sms/status/route.ts`
- Migration file exists: `lib/db/migrations/075_sms_delivery_status.sql`
- Delivery status tracking wired end-to-end (client -> webhook -> DB)
- Consent checkbox prevents enabling SMS without explicit opt-in
- All existing SMS tests still pass (if any): `npm test -- --grep sms`
</verification>

<success_criteria>
1. Twilio delivery callbacks are received and processed at /api/sms/status
2. Check-in records accurately reflect delivered/failed status
3. Delivery statistics are queryable via getDeliveryStats()
4. Users must explicitly consent before enabling SMS check-ins
5. Welcome message includes TCPA-compliant disclosures
6. No regressions in existing SMS functionality
</success_criteria>

<output>
After completion, create `.planning/phases/61-twilio-sms-activation/61-01-SUMMARY.md`
</output>
