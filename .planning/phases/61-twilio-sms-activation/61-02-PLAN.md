---
phase: 61-twilio-sms-activation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - app/api/sms/delivery-report/route.ts
  - app/dashboard/sms/page.tsx
autonomous: false
user_setup:
  - service: twilio
    why: "Real SMS delivery requires Twilio account with A2P 10DLC registration"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_MESSAGING_SERVICE_SID
        source: "Twilio Console -> Messaging -> Services -> Create new service -> Copy SID"
    dashboard_config:
      - task: "Register A2P 10DLC Brand"
        location: "Twilio Console -> Messaging -> Compliance -> US A2P 10DLC -> Brand Registrations -> Create Brand"
        notes: "Uses Sole Proprietor or Low Volume Standard brand. Takes up to 4 weeks for approval."
      - task: "Register A2P 10DLC Campaign"
        location: "Twilio Console -> Messaging -> Compliance -> US A2P 10DLC -> Campaigns -> Create Campaign"
        notes: "Campaign use case: 'Mixed'. Sample messages required. Brand must be approved first."
      - task: "Associate Campaign with Messaging Service"
        location: "Twilio Console -> Messaging -> Services -> [Your Service] -> Compliance Info -> Associate campaign"
        notes: "After campaign is approved, link it to the Messaging Service so messages use the registered campaign."
      - task: "Configure SMS webhook URL"
        location: "Twilio Console -> Messaging -> Services -> [Your Service] -> Integration -> Incoming Messages"
        notes: "Set webhook URL to: https://[your-domain]/api/sms/webhook (POST method)"
      - task: "Configure status callback URL"
        location: "Twilio Console -> Messaging -> Services -> [Your Service] -> Integration -> Status Callback URL"
        notes: "Set to: https://[your-domain]/api/sms/status (POST method) for delivery tracking"

must_haves:
  truths:
    - "Admin can view SMS delivery success/failure rates on the dashboard"
    - "SMS delivery report shows total sent, delivered, failed, and delivery rate percentage"
    - "A2P 10DLC registration steps are documented and user knows what to do"
  artifacts:
    - path: "app/api/sms/delivery-report/route.ts"
      provides: "API endpoint returning delivery statistics"
      exports: ["GET"]
    - path: "app/dashboard/sms/page.tsx"
      provides: "Delivery stats section showing rates"
      min_lines: 50
  key_links:
    - from: "app/dashboard/sms/page.tsx"
      to: "/api/sms/delivery-report"
      via: "fetch in useEffect"
      pattern: "fetch.*api/sms/delivery-report"
    - from: "app/api/sms/delivery-report/route.ts"
      to: "lib/db/sms.ts"
      via: "getDeliveryStats call"
      pattern: "getDeliveryStats"
---

<objective>
Add SMS delivery reporting UI and a checkpoint for Twilio credential setup + A2P 10DLC registration guidance.

Purpose: Users need visibility into whether their SMS messages are actually being delivered (INFRA-03 criteria #4). The 10DLC registration is a 4-week timeline blocker that must be started now.

Output: Delivery report API, updated SMS dashboard with delivery stats, and checkpoint documenting 10DLC setup steps.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key existing files:
@app/dashboard/sms/page.tsx
@app/api/sms/preferences/route.ts (pattern for auth + tier gating)
@lib/db/sms.ts (will have getDeliveryStats from Plan 01)
@.planning/phases/61-twilio-sms-activation/61-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delivery Report API + Dashboard Stats</name>
  <files>
    app/api/sms/delivery-report/route.ts
    app/dashboard/sms/page.tsx
  </files>
  <action>
1. Create `app/api/sms/delivery-report/route.ts`:
   - GET endpoint returning delivery statistics for the authenticated user
   - Require auth via `requireAuth()` and Studio tier via `getUserTier()`/`createTierErrorResponse()` (follow exact pattern from `app/api/sms/preferences/route.ts`)
   - Accept optional query params: `startDate` and `endDate` (ISO date strings) for filtering
   - Call `getDeliveryStats(supabase, { userId, startDate, endDate })` from `lib/db/sms.ts` (created in Plan 01)
   - Return JSON: `{ stats: DeliveryStats }` where DeliveryStats has `total`, `delivered`, `failed`, `pending`, `deliveryRate`
   - Add `export const dynamic = 'force-dynamic'`
   - Handle errors gracefully, returning `{ stats: { total: 0, delivered: 0, failed: 0, pending: 0, deliveryRate: 0 } }` on failure rather than error status

2. Update `app/dashboard/sms/page.tsx`:
   - Add a "Delivery Stats" card between the Settings card and History card
   - Add state: `deliveryStats` (type DeliveryStats from lib/sms/types), `isLoadingStats` boolean
   - Add `fetchDeliveryStats()` callback that fetches from `/api/sms/delivery-report` and sets state
   - Call `fetchDeliveryStats()` in the existing useEffect alongside fetchPreferences and fetchHistory
   - The Delivery Stats card should show:
     a. Four stat boxes in a 2x2 grid (or 4-col on desktop): Total Sent, Delivered, Failed, Delivery Rate
     b. Total Sent: number with a Send icon (use `ArrowUpRight` from lucide)
     c. Delivered: number with green text/badge
     d. Failed: number with red text/badge (show 0 in gray when none)
     e. Delivery Rate: percentage (e.g., "98.5%") with a progress-bar-style visual using a colored div with width set to the percentage
   - Show skeleton loaders while `isLoadingStats` is true
   - Import `DeliveryStats` type from `lib/sms/types`
   - Only show delivery stats when the user has a verified phone and check-ins enabled (otherwise show a subtle note: "Enable check-ins to see delivery statistics")
   - Use the same Card/CardHeader/CardTitle/CardContent pattern as existing cards
   - Use Sahara brand color (#ff6a1a) for the delivery rate progress bar when rate > 90%, yellow for 70-90%, red for below 70%

IMPORTANT: Follow the exact UI patterns already used in the page. Do not add any new UI library dependencies. Use existing Card, Badge, Skeleton components from @/components/ui.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no type errors
    - `npm run build` completes successfully
    - New route exists: `app/api/sms/delivery-report/route.ts`
    - Dashboard page renders (check for no build errors in the sms page)
    - Grep confirms fetch call: `grep -n 'delivery-report' app/dashboard/sms/page.tsx`
  </verify>
  <done>
    - GET /api/sms/delivery-report returns delivery stats for authenticated Studio user
    - SMS dashboard shows delivery stats card with total/delivered/failed/rate
    - Loading states, error handling, and empty states work correctly
    - Delivery rate shown as visual progress indicator with color coding
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <what-built>Complete SMS infrastructure is code-complete: delivery status tracking, compliance consent, delivery reporting UI. The code is ready but requires real Twilio credentials and A2P 10DLC registration to function.</what-built>
  <decision>Twilio Account Setup + A2P 10DLC Registration</decision>
  <context>
A2P 10DLC (Application-to-Person 10-Digit Long Code) is required by US carriers for business SMS. Without it, messages will be filtered or blocked. Registration takes 1-4 weeks for approval.

The SMS code is fully built but uses placeholder/missing credentials. You need to:
1. Set up Twilio credentials in your environment
2. Start the 10DLC registration process (this is the 4-week blocker identified in research)
  </context>
  <instructions>
**Step 1: Get Twilio Credentials** (5 minutes)

1. Go to https://console.twilio.com
2. On the dashboard home page, copy:
   - **Account SID** -> set as `TWILIO_ACCOUNT_SID` in Vercel env vars
   - **Auth Token** -> set as `TWILIO_AUTH_TOKEN` in Vercel env vars

3. Go to Messaging -> Services -> Create a new Messaging Service:
   - Name: "Sahara Weekly Check-ins"
   - Use case: "Notify my users"
   - Copy the **Messaging Service SID** -> set as `TWILIO_MESSAGING_SERVICE_SID` in Vercel env vars

4. In the Messaging Service settings:
   - Integration -> Incoming Messages: Set webhook URL to `https://[your-domain]/api/sms/webhook` (POST)
   - Integration -> Status Callback URL: Set to `https://[your-domain]/api/sms/status` (POST)

**Step 2: A2P 10DLC Registration** (15 minutes to submit, 1-4 weeks for approval)

1. Go to Twilio Console -> Messaging -> Compliance -> US A2P 10DLC
2. **Register Brand:**
   - Click "Brand Registrations" -> "Create Brand"
   - Brand type: "Sole Proprietor" (for small business) or "Low Volume Standard" (for registered business)
   - Fill in business details (name, EIN/tax ID, address, website)
   - Submit for review

3. **Create Campaign** (after brand approval, or can be submitted simultaneously):
   - Click "Campaigns" -> "Create Campaign"
   - Use case: "Mixed" (covers check-ins + conversational)
   - Description: "Weekly accountability check-in messages for startup founders using the Sahara platform. Users opt-in via account settings and can reply STOP to unsubscribe."
   - Sample messages:
     - "Hey [Name]! Weekly check-in from Sahara. Reply with your top 3 priorities."
     - "Welcome aboard, [Name]! Fred here. We'll check in weekly to keep you on track. Reply STOP to opt out. Msg frequency: 1x/week. Msg&data rates may apply."
   - Opt-in flow: "Users opt-in through their account settings page after verifying their phone number with a 6-digit code"
   - Opt-out: "Reply STOP"
   - Help: "Reply HELP"

4. **Associate Campaign with Messaging Service** (after campaign approval):
   - Go to Messaging -> Services -> [Your Service] -> Compliance Info
   - Associate the approved campaign

**Step 3: Verify in Vercel** (2 minutes)

1. Go to Vercel dashboard -> your project -> Settings -> Environment Variables
2. Confirm all three vars are set:
   - `TWILIO_ACCOUNT_SID`
   - `TWILIO_AUTH_TOKEN`
   - `TWILIO_MESSAGING_SERVICE_SID`
3. Redeploy to pick up new env vars

**Note on 10DLC Timeline:**
- Brand registration: 1-7 days (Sole Proprietor is faster)
- Campaign registration: 1-3 weeks
- Total: 1-4 weeks
- SMS will work without 10DLC registration but carrier filtering may block some messages
- Once approved, throughput limits increase and delivery rates improve significantly
  </instructions>
  <resume-signal>Type "credentials configured" when Twilio env vars are set in Vercel, or "10dlc submitted" when registration is submitted, or "skip" to continue without real SMS (code will work with mock/test credentials)</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` completes without errors
- Delivery report API returns valid stats structure
- SMS dashboard displays delivery statistics card
- User has been guided through 10DLC registration process
</verification>

<success_criteria>
1. GET /api/sms/delivery-report returns delivery statistics
2. SMS dashboard shows delivery rate, total sent, delivered, failed counts
3. User has Twilio credentials configured (or has a plan to do so)
4. A2P 10DLC registration submitted or scheduled
5. No regressions in existing SMS functionality
</success_criteria>

<output>
After completion, create `.planning/phases/61-twilio-sms-activation/61-02-SUMMARY.md`
</output>
