---
phase: 66-content-library-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260225000010_content_library.sql
  - package.json
  - package-lock.json
autonomous: true

must_haves:
  truths:
    - "5 content tables exist in the database schema: courses, modules, lessons, enrollments, content_progress"
    - "RLS is enabled on all 5 tables with authenticated read and service_role manage policies"
    - "@mux/mux-node v12.8.1 is installed as a project dependency"
    - "Migration file is numbered correctly and follows existing migration conventions"
  artifacts:
    - path: "supabase/migrations/20260225000010_content_library.sql"
      provides: "All 5 content tables with CHECK constraints, RLS policies, and indexes"
      contains: "CREATE TABLE courses"
    - path: "package.json"
      provides: "@mux/mux-node dependency"
      contains: "@mux/mux-node"
  key_links:
    - from: "lessons.module_id"
      to: "modules.id"
      via: "REFERENCES modules(id) ON DELETE CASCADE"
      pattern: "REFERENCES modules"
    - from: "modules.course_id"
      to: "courses.id"
      via: "REFERENCES courses(id) ON DELETE CASCADE"
      pattern: "REFERENCES courses"
    - from: "enrollments.user_id"
      to: "auth.users(id)"
      via: "REFERENCES auth.users(id) ON DELETE CASCADE"
      pattern: "REFERENCES auth.users"
---

<objective>
Install @mux/mux-node and create the 5-table content library database schema with RLS policies.

Purpose: Phase 66 requires a database foundation before any API routes or library code can be written. This plan creates all tables, constraints, and security policies that the rest of the phase depends on.
Output: Migration file with 5 tables + RLS + indexes, plus the Mux server SDK installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/66-content-library-backend/66-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @mux/mux-node</name>
  <files>package.json, package-lock.json</files>
  <action>
Run `npm install @mux/mux-node@12.8.1` from the project root.

Do NOT install @mux/mux-player-react or @mux/mux-uploader-react — those are Phase 67 only.

After install, verify the package appears in package.json dependencies at version 12.8.1 (or ^12.8.1).
  </action>
  <verify>Run `node -e "require('@mux/mux-node')" 2>&1 | head -5` — should not throw. Also check `grep "@mux/mux-node" package.json`.</verify>
  <done>@mux/mux-node appears in package.json dependencies and imports without error.</done>
</task>

<task type="auto">
  <name>Task 2: Create content library migration</name>
  <files>supabase/migrations/20260225000010_content_library.sql</files>
  <action>
Create file `supabase/migrations/20260225000010_content_library.sql` with all 5 tables. Follow the exact same patterns used in existing migrations (e.g., `lib/db/migrations/033_user_subscriptions.sql`, `20260212000003_create_document_repository.sql`).

Use IF NOT EXISTS on all CREATE TABLE statements so the migration is idempotent.

**Table 1: courses**
```sql
CREATE TABLE IF NOT EXISTS courses (
  id            UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title         TEXT NOT NULL,
  description   TEXT NOT NULL DEFAULT '',
  slug          TEXT NOT NULL UNIQUE,
  thumbnail_url TEXT,
  stage         TEXT,
  topic         TEXT,
  tier_required TEXT NOT NULL DEFAULT 'free'
                CHECK (tier_required IN ('free', 'pro', 'studio')),
  is_published  BOOLEAN NOT NULL DEFAULT false,
  sort_order    INTEGER NOT NULL DEFAULT 0,
  created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at    TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Table 2: modules**
```sql
CREATE TABLE IF NOT EXISTS modules (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  course_id   UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
  title       TEXT NOT NULL,
  description TEXT NOT NULL DEFAULT '',
  sort_order  INTEGER NOT NULL DEFAULT 0,
  created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at  TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Table 3: lessons**
```sql
CREATE TABLE IF NOT EXISTS lessons (
  id               UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  module_id        UUID NOT NULL REFERENCES modules(id) ON DELETE CASCADE,
  title            TEXT NOT NULL,
  description      TEXT NOT NULL DEFAULT '',
  sort_order       INTEGER NOT NULL DEFAULT 0,
  duration_seconds INTEGER,
  mux_upload_id    TEXT,
  mux_asset_id     TEXT,
  mux_playback_id  TEXT,
  mux_status       TEXT NOT NULL DEFAULT 'pending'
                   CHECK (mux_status IN ('pending', 'processing', 'ready', 'error')),
  is_preview       BOOLEAN NOT NULL DEFAULT false,
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now()
);
```

**Table 4: enrollments**
```sql
CREATE TABLE IF NOT EXISTS enrollments (
  id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id     UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  course_id   UUID NOT NULL REFERENCES courses(id) ON DELETE CASCADE,
  enrolled_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(user_id, course_id)
);
```

**Table 5: content_progress**
```sql
CREATE TABLE IF NOT EXISTS content_progress (
  id           UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id      UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  lesson_id    UUID NOT NULL REFERENCES lessons(id) ON DELETE CASCADE,
  watched_pct  INTEGER NOT NULL DEFAULT 0 CHECK (watched_pct BETWEEN 0 AND 100),
  completed    BOOLEAN NOT NULL DEFAULT false,
  last_watched TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(user_id, lesson_id)
);
```

**Indexes:**
```sql
CREATE INDEX IF NOT EXISTS idx_courses_published ON courses(is_published);
CREATE INDEX IF NOT EXISTS idx_courses_stage ON courses(stage);
CREATE INDEX IF NOT EXISTS idx_courses_topic ON courses(topic);
CREATE INDEX IF NOT EXISTS idx_modules_course_id ON modules(course_id);
CREATE INDEX IF NOT EXISTS idx_lessons_module_id ON lessons(module_id);
CREATE INDEX IF NOT EXISTS idx_lessons_mux_asset_id ON lessons(mux_asset_id);
CREATE INDEX IF NOT EXISTS idx_enrollments_user_id ON enrollments(user_id);
CREATE INDEX IF NOT EXISTS idx_content_progress_user_id ON content_progress(user_id);
```

**RLS for courses:**
```sql
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read published courses"
  ON courses FOR SELECT TO authenticated
  USING (is_published = true);

CREATE POLICY "Service role manages courses"
  ON courses FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

**RLS for modules:**
```sql
ALTER TABLE modules ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read modules"
  ON modules FOR SELECT TO authenticated
  USING (true);

CREATE POLICY "Service role manages modules"
  ON modules FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

**RLS for lessons:**
```sql
ALTER TABLE lessons ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Authenticated users can read lessons"
  ON lessons FOR SELECT TO authenticated
  USING (true);

CREATE POLICY "Service role manages lessons"
  ON lessons FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

**RLS for enrollments:**
```sql
ALTER TABLE enrollments ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users read own enrollments"
  ON enrollments FOR SELECT TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users create own enrollments"
  ON enrollments FOR INSERT TO authenticated
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Service role manages enrollments"
  ON enrollments FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

**RLS for content_progress:**
```sql
ALTER TABLE content_progress ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users read own progress"
  ON content_progress FOR SELECT TO authenticated
  USING (auth.uid() = user_id);

CREATE POLICY "Users upsert own progress"
  ON content_progress FOR ALL TO authenticated
  USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Service role manages content_progress"
  ON content_progress FOR ALL TO service_role
  USING (true) WITH CHECK (true);
```

Note: DO NOT add `CREATE POLICY IF NOT EXISTS` — use the same pattern as existing migrations which just run CREATE POLICY directly. If re-running causes issues, the executor should check existing migration patterns.

Add a comment header to the migration file:
```sql
-- Migration: Content Library
-- Creates 5 tables for the course content system:
-- courses, modules, lessons, enrollments, content_progress
-- Phase 66: Content Library — Schema & Backend
```
  </action>
  <verify>Check that the file exists and contains all 5 table definitions: `grep -c "CREATE TABLE" supabase/migrations/20260225000010_content_library.sql` should output 5. Also verify RLS: `grep -c "ENABLE ROW LEVEL SECURITY" supabase/migrations/20260225000010_content_library.sql` should output 5.</verify>
  <done>Migration file contains all 5 tables with CHECK constraints, ON DELETE CASCADE foreign keys, 8 indexes, and RLS policies for each table with authenticated + service_role policies.</done>
</task>

</tasks>

<verification>
1. `npm ls @mux/mux-node` shows version 12.8.1 installed
2. `grep -c "CREATE TABLE IF NOT EXISTS" supabase/migrations/20260225000010_content_library.sql` outputs 5
3. `grep "REFERENCES auth.users" supabase/migrations/20260225000010_content_library.sql` shows enrollments and content_progress reference auth.users
4. `grep "tier_required" supabase/migrations/20260225000010_content_library.sql` shows CHECK constraint with 'free', 'pro', 'studio'
5. `grep "mux_playback_id" supabase/migrations/20260225000010_content_library.sql` shows the lessons table has mux columns
</verification>

<success_criteria>
- @mux/mux-node installed at 12.8.1
- Migration file at supabase/migrations/20260225000010_content_library.sql with all 5 tables
- All foreign keys use ON DELETE CASCADE
- tier_required CHECK constraint uses normalized values ('free', 'pro', 'studio')
- RLS enabled on all 5 tables with authenticated read + service_role full access
- 8 performance indexes defined
- TypeScript build passes: `npm run build` (or at minimum `npx tsc --noEmit`)
</success_criteria>

<output>
After completion, create `.planning/phases/66-content-library-backend/66-01-SUMMARY.md` with:
- What was created (migration file path, table names, package installed)
- Key decisions made (schema field names, RLS policy names)
- Any deviations from the plan
</output>
