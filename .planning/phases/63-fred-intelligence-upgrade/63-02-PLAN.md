---
phase: 63-fred-intelligence-upgrade
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/ai/frameworks/positioning.ts
  - lib/ai/frameworks/investor-lens.ts
  - lib/ai/diagnostic-engine.ts
autonomous: true

must_haves:
  truths:
    - "Mode switching does not trigger on ambiguous phrases like 'my position in the market' or 'how do I value my time'"
    - "Mode transitions require 2+ signals before triggering"
    - "Mode exit requires 5+ consecutive quiet messages instead of 3"
  artifacts:
    - path: "lib/ai/frameworks/positioning.ts"
      provides: "Positioning signal detection with negative patterns and confidence scoring"
      contains: "NEGATIVE_POSITIONING_PATTERNS"
    - path: "lib/ai/frameworks/investor-lens.ts"
      provides: "Investor signal detection with negative patterns and confidence scoring"
      contains: "NEGATIVE_INVESTOR_PATTERNS"
    - path: "lib/ai/diagnostic-engine.ts"
      provides: "Confidence-based mode transitions with minimum signal count"
      contains: "MIN_SIGNALS_TO_TRANSITION"
  key_links:
    - from: "lib/ai/diagnostic-engine.ts"
      to: "lib/ai/frameworks/positioning.ts"
      via: "detectPositioningSignals + needsPositioningFramework"
      pattern: "detectPositioningSignals"
    - from: "lib/ai/diagnostic-engine.ts"
      to: "lib/ai/frameworks/investor-lens.ts"
      via: "detectInvestorSignals + needsInvestorLens"
      pattern: "detectInvestorSignals"
---

<objective>
Reduce false positive mode switches by adding negative patterns, confidence scoring, and requiring multiple signals before transitioning.

Purpose: Currently, single regex matches trigger mode transitions. "My position in the market" triggers positioning mode. "How do I value my time?" triggers investor mode. This causes jarring, incorrect framework introductions that break the conversation flow.

Output: Smoother, more accurate mode switching with fewer false positives.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/63-fred-intelligence-upgrade/63-RESEARCH.md

@lib/ai/diagnostic-engine.ts
@lib/ai/frameworks/positioning.ts
@lib/ai/frameworks/investor-lens.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add negative patterns and confidence scoring to signal detection</name>
  <files>
    lib/ai/frameworks/positioning.ts
    lib/ai/frameworks/investor-lens.ts
  </files>
  <action>
    1. In `lib/ai/frameworks/positioning.ts`:
       - Add a `NEGATIVE_POSITIONING_PATTERNS` array of regex patterns that should SUPPRESS positioning signals when matched. These are phrases where positioning-related words appear in non-positioning contexts:
         - `/\b(my|our|their) position (in|at|on)\b/i` — "my position in the company", "our position at the table"
         - `/\bcompetitive position\b/i` — this IS positioning, so do NOT include as negative
         - `/\bposition (paper|statement)\b/i` — academic, not marketing
       - Modify `detectPositioningSignals()`:
         - After computing signals, check if any negative patterns match. If a negative pattern matches, set the corresponding signal to false.
         - Specifically, fix `icpVagueOrUndefined`: The current logic `!lowerContext.includes("customer") && !lowerContext.includes("buyer")` triggers on virtually any message. Add a minimum length check: only apply this heuristic if the message is >100 chars (short messages are likely not ICP discussions).
         - Fix `everyoneAsTarget`: Add negative check — "everyone" followed by common non-target phrases like "everyone knows", "everyone does", "tell everyone", "everyone on my team".
         - Fix `genericMessaging`: "disrupt" should only match if it's part of a buzzword-heavy sentence, not standalone. Check for 2+ buzzwords together before triggering.
       - Add a new export `countPositioningSignals(signals: PositioningSignals): number` that returns the count of true signals.
       - Modify `needsPositioningFramework()` to require **2+ signals** instead of any single signal: `return countPositioningSignals(signals) >= 2`.

    2. In `lib/ai/frameworks/investor-lens.ts`:
       - Add a `NEGATIVE_INVESTOR_PATTERNS` array:
         - `/\bvalue (my|your|their|our) time\b/i` — "value my time" is not about valuation
         - `/\braise (awareness|the bar|the question|hell|concern)\b/i` — "raise awareness" is not fundraising
         - `/\bcapital (letter|city|punishment|crime)\b/i` — not financial capital
         - `/\bdeck (the halls|of cards|chair)\b/i` — not pitch deck
         - `/\bpitch (in|fork|black|dark|perfect)\b/i` — not pitch deck
         - `/\bslides? (into|down|across)\b/i` — not presentation slides
       - Modify `detectInvestorSignals()`:
         - After computing initial signals, check negative patterns. If a negative pattern matches the same keyword category, suppress that signal.
         - For `mentionsFundraising`: The pattern `lower.includes("raise")` is too broad. Change to `/\braise\b(?!\s+(awareness|the bar|the question|hell|concern))/i` regex test, or check for negative patterns after the fact.
         - For `mentionsValuation`: The pattern `lower.includes("valuation")` is fine (specific enough), but add negative check for "value my time" on the broader value-related patterns.
         - For `mentionsDeck`: `lower.includes("pitch")` matches "pitch in and help". Make more specific: require "pitch deck", "pitch to investors", or just "my pitch" — not standalone "pitch".
       - Add a new export `countInvestorSignals(signals: InvestorReadinessSignals): number`.
       - Modify `needsInvestorLens()` to require **2+ signals** (not counting uploadedDeck alone, which should still trigger by itself since it's an explicit action): `return signals.uploadedDeck || countInvestorSignals(signals) >= 2`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep -n "NEGATIVE_POSITIONING_PATTERNS\|NEGATIVE_INVESTOR_PATTERNS" lib/ai/frameworks/positioning.ts lib/ai/frameworks/investor-lens.ts` shows negative patterns defined
    - `grep -n "countPositioningSignals\|countInvestorSignals" lib/ai/frameworks/positioning.ts lib/ai/frameworks/investor-lens.ts` shows count functions exported
    - `grep -n ">= 2" lib/ai/frameworks/positioning.ts lib/ai/frameworks/investor-lens.ts` shows 2-signal threshold
  </verify>
  <done>
    Signal detection has negative patterns to suppress false positives. Both frameworks require 2+ signals to trigger (except uploadedDeck which is always explicit). Common ambiguous phrases no longer cause mode switches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update diagnostic engine with confidence scoring and higher exit threshold</name>
  <files>lib/ai/diagnostic-engine.ts</files>
  <action>
    1. Increase `MODE_EXIT_THRESHOLD` from 3 to 5. Add a comment explaining why: "5 consecutive quiet messages prevents premature exit from frameworks that naturally have question-answer gaps."

    2. Add a new constant `MIN_SIGNALS_TO_TRANSITION = 2` at the top near MODE_EXIT_THRESHOLD.

    3. In `determineModeTransition()`:
       - After computing `hasPositioningSignals` and `hasInvestorSignals` from the updated framework functions (which now require 2+ signals), no changes needed to the transition logic itself since the threshold is now enforced in the framework functions.
       - However, add a **sliding window confidence check**: look at the last 3 entries in `modeContext.signalHistory`. If fewer than 2 of the last 3 messages had signals for the target framework, do NOT enter the mode. This prevents single-message signal bursts from triggering mode entry.
       - Specifically: Before executing Case 1 (enter investor) or Case 2 (enter positioning), check:
         ```
         const recentHistory = updatedContext.signalHistory.slice(-3);
         const recentSignalCount = recentHistory.filter(h => h.framework === targetFramework).length;
         if (recentSignalCount < 1 && !hasUploadedDeck) { /* don't transition */ }
         ```
         This ensures that either the current message has strong signals (2+ from the framework function) OR there's been a recent pattern of signals.

    4. In `analyzeConversation()` (the full-conversation analysis function):
       - It currently creates fresh DiagnosticState. Update it to use the new `countPositioningSignals` and `countInvestorSignals` exports from the framework files.
       - The `shouldIntroducePositioning` and `shouldIntroduceInvestor` flags should now only be true when 2+ signals are detected (which the updated `needsPositioningFramework` and `needsInvestorLens` already enforce).

    5. Update the `ModeTransitionResult` interface to include a `signalConfidence: number` field (0-1). Calculate it as:
       - `signalConfidence = detectedSignals.length / totalPossibleSignals` where totalPossibleSignals is 4 for positioning, 5 for investor.
       - Include this in the return value for observability.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `grep -n "MODE_EXIT_THRESHOLD.*=.*5" lib/ai/diagnostic-engine.ts` shows threshold increased
    - `grep -n "MIN_SIGNALS_TO_TRANSITION\|signalConfidence" lib/ai/diagnostic-engine.ts` shows confidence scoring
    - `npm test -- --passWithNoTests` passes
  </verify>
  <done>
    Mode exit threshold increased to 5. Signal detection requires 2+ signals. Sliding window prevents single-message bursts from triggering transitions. signalConfidence field added for observability.
  </done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors: `npx tsc --noEmit`
- Existing tests pass: `npm test -- --passWithNoTests`
- "my position in the market" no longer triggers positioning mode
- "how do I value my time?" no longer triggers investor mode
- Single-keyword matches no longer cause mode transitions
- Mode exit requires 5 quiet messages instead of 3
</verification>

<success_criteria>
1. Both signal detectors have negative pattern suppression
2. Both frameworks require 2+ signals to trigger (uploadedDeck exempted)
3. MODE_EXIT_THRESHOLD is 5
4. determineModeTransition uses sliding window confidence
5. No regressions in existing mode switching for legitimate signals
</success_criteria>

<output>
After completion, create `.planning/phases/63-fred-intelligence-upgrade/63-02-SUMMARY.md`
</output>
