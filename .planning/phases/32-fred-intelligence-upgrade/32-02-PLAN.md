# Phase 32-02: Chat Export UX + Memory Retention Enforcement

**Phase:** 32 — FRED Intelligence Upgrade
**Plan:** 02 of 2
**Status:** COMPLETE
**Depends on:** 32-01

## Goal

Add a user-facing chat export button in the chat interface and implement automatic memory retention enforcement per tier limits.

## Steps

### Step 1: Add export button to chat interface
**Files:** Chat page or layout component (find where chat header/footer is rendered)
- Add an "Export Chat" button in the chat header or as a dropdown option
- Format selector: JSON, Markdown, CSV (dropdown or dialog)
- On click, call GET `/api/fred/export?format={format}`
- Trigger browser file download
- Show loading spinner during export
- Toast on success: "Chat history exported"
- Toast on error: "Export failed"

### Step 2: Add export size warning
**Files:** Same as Step 1
- Before downloading, fetch message count from `/api/fred/memory?type=episodes`
- If count > 500, show warning dialog: "Your chat history has {count} messages. Large exports may take a moment."
- Allow user to proceed or cancel

### Step 3: Implement memory retention cleanup
**Files:** `lib/db/fred-memory.ts`
Add a function `enforceRetentionLimits(userId, tier)`:
- Read tier's `retentionDays` from `MEMORY_CONFIG`
- Delete episodic memories older than retention period
- Delete excess episodic memories beyond `maxEpisodicItems` (keep newest)
- For Free tier (0 days retention), delete all episodic memories
- Return count of deleted items

### Step 4: Call retention enforcement in chat route
**Files:** `app/api/fred/chat/route.ts`
- After storing new episodic memory, call `enforceRetentionLimits(userId, tier)`
- Fire-and-forget (don't block the chat response)
- Log cleanup counts via structured logger

## Verification

- [ ] Export button visible in chat interface
- [ ] Export downloads file in selected format (JSON/Markdown/CSV)
- [ ] Large export warning shown for 500+ messages
- [ ] `enforceRetentionLimits()` deletes old memories per tier config
- [ ] Retention called after chat message storage
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- Chat interface component — added export button with format selector
- `lib/db/fred-memory.ts` — added enforceRetentionLimits function
- `app/api/fred/chat/route.ts` — added retention enforcement after memory storage
