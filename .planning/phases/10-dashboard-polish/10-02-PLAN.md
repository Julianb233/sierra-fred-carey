# Plan: 10-02 — Delete Account Server Endpoint

**Phase:** 10 - Dashboard Polish & Missing Wiring
**Audit Ref:** v1.0-final-audit-2026-02-06.md — GAP 2
**Files:** `app/api/user/delete/route.ts` (new), `app/dashboard/settings/page.tsx`

---

## Problem

The "Delete Account" button in settings only clears localStorage and signs out. It does NOT delete user data from the database. Users who "delete" their account still have all their data persisted.

---

## Tasks

### Task 1: Create DELETE /api/user/delete endpoint

**File:** `app/api/user/delete/route.ts` (NEW)

```typescript
import { NextRequest, NextResponse } from "next/server";
import { requireAuth } from "@/lib/auth";
import sql from "@/lib/db/supabase-sql";
import { createClient } from "@/lib/supabase/server";

export async function DELETE(request: NextRequest) {
  try {
    const auth = await requireAuth();
    if (!auth.user) {
      return NextResponse.json({ error: "Authentication required" }, { status: 401 });
    }

    const userId = auth.user.id;

    // Delete user data in dependency order (children before parents)
    // Use service role client for auth.users deletion
    await sql`DELETE FROM agent_tasks WHERE user_id = ${userId}`;
    await sql`DELETE FROM fred_episodic_memory WHERE user_id = ${userId}`;
    await sql`DELETE FROM fred_semantic_memory WHERE user_id = ${userId}`;
    await sql`DELETE FROM fred_procedural_memory WHERE user_id = ${userId}`;
    await sql`DELETE FROM fred_calibration_records WHERE user_id = ${userId}`;
    await sql`DELETE FROM sms_checkins WHERE user_id = ${userId}`;
    await sql`DELETE FROM sms_preferences WHERE user_id = ${userId}`;
    await sql`DELETE FROM boardy_matches WHERE user_id = ${userId}`;
    await sql`DELETE FROM documents WHERE user_id = ${userId}`;
    await sql`DELETE FROM strategy_documents WHERE user_id = ${userId}`;
    await sql`DELETE FROM user_subscriptions WHERE user_id = ${userId}`;
    await sql`DELETE FROM profiles WHERE id = ${userId}`;

    // Delete auth user via Supabase admin
    const supabase = await createClient();
    await supabase.auth.admin.deleteUser(userId);

    return NextResponse.json({ success: true });
  } catch (error) {
    console.error("[user/delete] Error:", error);
    return NextResponse.json(
      { error: "Failed to delete account" },
      { status: 500 }
    );
  }
}
```

**Notes:**
- Use `sql` tagged template for direct SQL (tables may not all exist — wrap each in try/catch or use `IF EXISTS` pattern)
- Delete in dependency order to avoid FK violations
- The supabase admin client needs `SUPABASE_SERVICE_ROLE_KEY` — use service role client
- Consider soft-delete as alternative, but for MVP hard delete is simpler

### Task 2: Wire settings page to call the endpoint

**File:** `app/dashboard/settings/page.tsx`

Replace the `handleDeleteAccount` function body (lines 167-174) with:

```typescript
const res = await fetch("/api/user/delete", { method: "DELETE" });
if (!res.ok) {
  const data = await res.json();
  throw new Error(data.error || "Failed to delete account");
}
localStorage.clear();
window.location.href = "/login";
```

Keep the existing confirmation gate (`showDeleteConfirm`) and try/catch/finally wrapper.

---

## Verification

- [ ] DELETE /api/user/delete returns 401 without auth
- [ ] DELETE /api/user/delete returns 200 with auth and deletes user data
- [ ] Settings page calls the endpoint on confirm
- [ ] User is redirected to /login after deletion
- [ ] `tsc --noEmit` passes
