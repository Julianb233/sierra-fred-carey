---
phase: 18-intake-snapshot-strategy
plan: 02
type: execute
wave: 2
depends_on:
  - 18-intake-snapshot-strategy/18-01
files_modified:
  - lib/fred/enrichment/extractor.ts
  - app/api/fred/chat/route.ts
  - app/dashboard/strategy/reframing/page.tsx
  - app/api/dashboard/strategy/reframe/route.ts
autonomous: true

must_haves:
  truths:
    - "Enrichment extractor analyzes conversation text to extract profile-relevant data (industry signals, team mentions, revenue hints)"
    - "Chat route calls enrichment extractor and persists extracted data to profiles table"
    - "Strategy reframing page at /dashboard/strategy/reframing provides Fred's 9-step framework UI"
    - "Reframe API accepts a strategy challenge and returns a structured reframing response using Fred's framework"
  artifacts:
    - path: "lib/fred/enrichment/extractor.ts"
      provides: "Conversation-based profile enrichment extractor"
      exports: ["extractProfileEnrichment"]
    - path: "app/dashboard/strategy/reframing/page.tsx"
      provides: "Strategy & Execution Reframing page with 9-step framework"
    - path: "app/api/dashboard/strategy/reframe/route.ts"
      provides: "POST endpoint for strategy reframing using Fred's framework"
  key_links:
    - from: "lib/fred/enrichment/extractor.ts"
      to: "lib/fred/types.ts"
      via: "uses profile-related types for extraction output"
      pattern: "import.*from.*types"
    - from: "app/api/fred/chat/route.ts"
      to: "lib/fred/enrichment/extractor.ts"
      via: "calls extractProfileEnrichment() on conversation content"
      pattern: "extractProfileEnrichment"
    - from: "app/dashboard/strategy/reframing/page.tsx"
      to: "app/api/dashboard/strategy/reframe/route.ts"
      via: "POSTs strategy challenge for reframing"
      pattern: "/api/dashboard/strategy/reframe"
---

<objective>
Build auto-enrichment from conversations and a dedicated strategy reframing UI applying Fred's 9-step framework.

Purpose: Founder profiles should evolve automatically as FRED learns more from conversations. Additionally, the Strategy & Execution Reframing feature needs a dedicated UI rather than relying on general chat. This plan adds an enrichment extractor that mines conversations for profile data and a reframing page that walks founders through Fred's structured approach.

Output: 1 new file (enrichment extractor), 1 new page (reframing), 1 new API route, 1 modified file (chat route). No new npm dependencies.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-intake-snapshot-strategy/18-01-PLAN.md

Key source files (READ ALL BEFORE MODIFYING):
@app/api/fred/chat/route.ts (chat endpoint -- wire enrichment extraction)
@lib/fred-brain.ts (Fred's 9-step startup process and philosophy)
@lib/fred/strategy/generator.ts (existing strategy generation for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Auto-enrichment extractor and chat wiring</name>
  <files>
    lib/fred/enrichment/extractor.ts
    app/api/fred/chat/route.ts
  </files>
  <action>
**Step 1: Create `lib/fred/enrichment/extractor.ts`**

Export `extractProfileEnrichment(messages: Array<{ role: string; content: string }>): ProfileEnrichment | null`:

Define a `ProfileEnrichment` interface:
```typescript
export interface ProfileEnrichment {
  industry?: string;
  revenueHint?: string;    // e.g., "mentions $50k MRR"
  teamSizeHint?: number;   // e.g., extracted number from "we have 5 people"
  fundingHint?: string;    // e.g., "raised a seed round"
  challenges?: string[];   // new challenges mentioned
  competitorsMentioned?: string[];
  metricsShared?: Record<string, string>; // e.g., { "MRR": "$50k", "CAC": "$120" }
}
```

Implementation:
1. Scan only user messages (role === "user") for pattern matches
2. Industry detection: keyword matching against common industry terms + context clues
3. Revenue detection: regex for dollar amounts near revenue/MRR/ARR keywords
4. Team size: regex for numbers near "team", "employees", "people", "engineers", etc.
5. Funding: keyword matching for "raised", "bootstrapped", "seed", "series", "angel", "investors"
6. Challenges: sentences containing "struggling with", "challenge", "problem", "stuck on"
7. Competitors: sentences containing "competitor", "competing with", "vs", "alternative"
8. Metrics: regex for common startup metrics (MRR, ARR, CAC, LTV, churn, etc.) with values
9. Return null if no enrichment data found (avoid unnecessary DB writes)

This is a heuristic extractor -- not AI-powered. Keep it fast and synchronous.

**Step 2: Wire into `app/api/fred/chat/route.ts`**

After the chat response is generated (post-decide), call the enrichment extractor:
1. Import `extractProfileEnrichment` from `@/lib/fred/enrichment/extractor`
2. Pass the conversation messages to `extractProfileEnrichment()`
3. If result is non-null, update the profiles table with any new data:
   - Only update fields that are currently null/empty in the profile (don't overwrite existing data)
   - Set `enriched_at` to now and `enrichment_source` to `'conversation'`
4. This is a fire-and-forget operation -- do NOT block the response stream

IMPORTANT: Enrichment is best-effort. Errors should be caught and logged, never thrown. Do NOT modify the main response flow.
  </action>
  <verify>
1. `test -f lib/fred/enrichment/extractor.ts` -- extractor exists
2. `grep 'extractProfileEnrichment' lib/fred/enrichment/extractor.ts` -- function exported
3. `grep 'extractProfileEnrichment' app/api/fred/chat/route.ts` -- wired into chat
4. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
Enrichment extractor at lib/fred/enrichment/extractor.ts mines conversation text for profile-relevant data using heuristic pattern matching. Chat route calls extractor after response and fire-and-forgets profile updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Strategy reframing UI and API</name>
  <files>
    app/dashboard/strategy/reframing/page.tsx
    app/api/dashboard/strategy/reframe/route.ts
  </files>
  <action>
**Step 1: Create `app/api/dashboard/strategy/reframe/route.ts`**

POST endpoint:
1. Authenticate user
2. Accept body: `{ challenge: string; currentApproach?: string; constraints?: string }`
3. Validate: challenge is required, min 20 characters
4. Use AI (generateText from Vercel AI SDK) with Fred's voice to produce a structured reframing:
   - System prompt imports Fred's identity from fred-brain.ts and references the 9-step startup process
   - User prompt includes the challenge, current approach, and constraints
   - Request structured output with sections: reframed_problem, root_causes, alternative_approaches (3), recommended_action, metrics_to_track, timeline
5. Return JSON response with the reframing sections
6. Return 401 if not authenticated, 400 if validation fails

**Step 2: Create `app/dashboard/strategy/reframing/page.tsx`**

"use client" page at /dashboard/strategy/reframing:
- **Input section**:
  - Textarea for "What's the strategic challenge?" (required, min 20 chars)
  - Textarea for "What's your current approach?" (optional)
  - Textarea for "What constraints do you face?" (optional)
  - Submit button ("Reframe with Fred") with loading state
- **Results section** (shown after API response):
  - Card layout with 6 sections matching the API response:
    1. "Reframed Problem" -- how Fred sees the real problem
    2. "Root Causes" -- underlying issues Fred identifies
    3. "Alternative Approaches" -- 3 different strategies to consider
    4. "Recommended Action" -- Fred's specific recommendation
    5. "Metrics to Track" -- how to measure progress
    6. "Timeline" -- realistic timeline for execution
  - Each section in a bordered card with section icon and title
  - Orange accent on the "Recommended Action" card
- **Footer**: Link to /chat ("Continue this conversation with Fred")
- Loading state: skeleton cards while API processes
- Error state: friendly error message with retry button
- Responsive layout matching dashboard card styling
  </action>
  <verify>
1. `test -f app/api/dashboard/strategy/reframe/route.ts` -- API exists
2. `test -f app/dashboard/strategy/reframing/page.tsx` -- page exists
3. `grep 'reframe' app/api/dashboard/strategy/reframe/route.ts` -- route handler present
4. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
Reframe API accepts a strategic challenge and returns a 6-section structured reframing using Fred's 9-step framework and AI. Reframing page provides input form, loading states, and structured results display with cards.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Enrichment extractor exists:**
   ```bash
   test -f lib/fred/enrichment/extractor.ts && echo "EXISTS"
   grep 'extractProfileEnrichment' lib/fred/enrichment/extractor.ts
   ```

2. **Chat route wired:**
   ```bash
   grep 'extractProfileEnrichment' app/api/fred/chat/route.ts
   ```

3. **Reframing page and API exist:**
   ```bash
   test -f app/dashboard/strategy/reframing/page.tsx && test -f app/api/dashboard/strategy/reframe/route.ts && echo "EXISTS"
   ```

4. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
- Enrichment extractor mines conversations for industry, revenue, team, funding, challenges, competitors, and metrics
- Chat route calls extractor after response and updates profile (fire-and-forget, never blocks response)
- Strategy reframing page provides 3-field input form at /dashboard/strategy/reframing
- Reframe API returns 6-section structured response using Fred's voice and 9-step framework
- Results display in card layout with proper loading and error states
- No existing chat flow or strategy generation logic modified
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-intake-snapshot-strategy/18-02-SUMMARY.md`
</output>
