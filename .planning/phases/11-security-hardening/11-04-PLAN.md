# Plan 11-04: Remove Logout GET Handler & Sanitization Fix

**Phase:** 11 - Security Hardening
**Priority:** P2 (Medium)
**Estimated Scope:** 2 files modified

---

## Objective

Fix two medium-severity security issues:
1. Remove GET handler from logout route (GET should never modify state)
2. Strengthen input sanitization beyond simple `<>` removal

---

## Tasks

### Task 1: Remove Logout GET Handler

**File:** `app/api/auth/logout/route.ts`
**Action:**
1. Remove the `GET` export entirely
2. Keep only the `POST` handler
3. Verify all logout triggers in the UI use POST (not links/redirects)

**Why:** GET requests can be triggered by `<img src="/api/auth/logout">`, browser prefetch, or link hover â€” silently logging users out without any action.

**Before:**
```typescript
export async function GET() {
  await signOut();
  return NextResponse.redirect(new URL("/", process.env.NEXT_PUBLIC_APP_URL));
}

export async function POST(request: NextRequest) {
  await signOut();
  return NextResponse.json({ success: true });
}
```

**After:**
```typescript
export async function POST(request: NextRequest) {
  await signOut();
  return NextResponse.json({ success: true });
}
```

**Check:** Search codebase for any `<a href="/api/auth/logout">` or `window.location = "/api/auth/logout"` patterns that rely on GET logout and convert them to POST via fetch.

### Task 2: Strengthen Input Sanitization

**File:** `lib/auth/middleware-utils.ts`
**Action:** Replace the basic `sanitizeInput` that only strips `<>` with a more comprehensive version.

**Before:**
```typescript
export function sanitizeInput(input: string): string {
  return input
    .replace(/[<>]/g, '')
    .trim()
    .slice(0, 1000);
}
```

**After:**
```typescript
export function sanitizeInput(input: string): string {
  return input
    .replace(/[<>'"&]/g, (char) => {
      const entities: Record<string, string> = {
        '<': '&lt;',
        '>': '&gt;',
        "'": '&#39;',
        '"': '&quot;',
        '&': '&amp;',
      };
      return entities[char] || char;
    })
    .replace(/javascript:/gi, '')
    .replace(/data:/gi, '')
    .replace(/on\w+=/gi, '')
    .trim()
    .slice(0, 1000);
}
```

**Note:** This is defense-in-depth. React's JSX already escapes output, so XSS via these paths is unlikely. But sanitizing at input boundaries is best practice.

---

## Verification

- [ ] `/api/auth/logout` returns 405 for GET requests
- [ ] POST logout still works correctly
- [ ] No UI elements use GET for logout (search for href="/api/auth/logout")
- [ ] `sanitizeInput` escapes `<script>`, `javascript:`, `onerror=`, quotes
- [ ] `npx tsc --noEmit` passes
- [ ] `npx vitest run` passes

---

## Dependencies

None - can execute independently.

---

*Plan created: 2026-02-06*
