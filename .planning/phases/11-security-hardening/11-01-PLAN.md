# Plan 11-01: Auth Endpoint Rate Limiting

**Phase:** 11 - Security Hardening
**Priority:** P0 (Critical - prevents brute-force attacks)
**Estimated Scope:** 3 files modified

---

## Objective

Add rate limiting to authentication endpoints to prevent brute-force attacks on user accounts and admin access. Currently `/api/auth/login` and `/api/admin/login` accept unlimited login attempts.

---

## Context

The existing rate limiter at `lib/api/rate-limit.ts` is already used by FRED API routes. We'll reuse the same pattern for auth endpoints. The in-memory rate limiter is sufficient for Vercel serverless (provides per-instance protection; for distributed rate limiting, Upstash/Vercel KV can be added later).

---

## Tasks

### Task 1: Rate Limit User Login

**File:** `app/api/auth/login/route.ts`
**Action:**
1. Import rate limiter from `lib/api/rate-limit.ts`
2. Add IP-based rate limiting: **5 attempts per minute**
3. Return 429 with `Retry-After` header when exceeded
4. Log rate limit hits for monitoring

**Implementation:**
```typescript
import { checkRateLimit } from '@/lib/api/rate-limit';

export async function POST(request: NextRequest) {
  const ip = request.headers.get('x-forwarded-for')?.split(',')[0]?.trim() || 'unknown';
  const { allowed, headers } = checkRateLimit(`auth-login:${ip}`, 5, 60_000);
  if (!allowed) {
    return NextResponse.json(
      { error: 'Too many login attempts. Please try again later.' },
      { status: 429, headers }
    );
  }
  // ... existing login logic
}
```

### Task 2: Rate Limit Admin Login

**File:** `app/api/admin/login/route.ts`
**Action:**
1. Add IP-based rate limiting: **3 attempts per minute** (stricter for admin)
2. Return 429 with `Retry-After` header when exceeded
3. Log rate limit hits with `[AdminLogin]` prefix

**Implementation:**
```typescript
const { allowed, headers } = checkRateLimit(`admin-login:${ip}`, 3, 60_000);
```

### Task 3: Rate Limit Signup/Onboarding

**File:** `app/api/onboard/route.ts`
**Action:**
1. Add IP-based rate limiting: **10 attempts per hour** (prevents mass account creation)
2. Return 429 when exceeded

**Implementation:**
```typescript
const { allowed, headers } = checkRateLimit(`onboard:${ip}`, 10, 3_600_000);
```

---

## Verification

- [ ] Rapid POST to `/api/auth/login` returns 429 after 5th attempt within 60s
- [ ] Rapid POST to `/api/admin/login` returns 429 after 3rd attempt within 60s
- [ ] Rapid POST to `/api/onboard` returns 429 after 10th attempt within 1 hour
- [ ] 429 response includes `Retry-After` header
- [ ] Legitimate login attempts succeed after rate limit window expires
- [ ] `npx tsc --noEmit` passes
- [ ] `npx vitest run` passes

---

## Dependencies

None - can execute independently.

---

*Plan created: 2026-02-06*
