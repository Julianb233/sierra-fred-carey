# Plan 11-05: Git History Scrub & Credential Rotation

**Phase:** 11 - Security Hardening
**Priority:** P0 (Critical - exposed credentials in git history)
**Estimated Scope:** Repository-level operation + Vercel config

---

## Objective

Remove `.env`, `.env.production`, and `.env.local` files from git history to eliminate exposure of production credentials. Then rotate all exposed credentials and update deployment environment.

**Note:** Env vars have already been rotated to `ROTATE_ME` placeholders in the working tree (done by a previous session). This plan covers the git history scrub and final credential rotation in the deployment platform.

---

## Tasks

### Task 1: Scrub Secrets from Git History

**Action:**
1. Install `git-filter-repo` (modern replacement for BFG)
2. Remove all `.env*` files from entire git history
3. Force-push cleaned history

**Commands:**
```bash
# Backup first
git clone --mirror . ../sahara-backup-$(date +%Y%m%d)

# Install git-filter-repo
pip3 install git-filter-repo

# Remove secret files from all history
git filter-repo --path .env --path .env.production --path .env.local --invert-paths --force

# Verify removal
git log --all --full-history -- .env .env.production .env.local
# Should return empty

# Force-push (requires team coordination)
git push --force --all
git push --force --tags
```

**Post-scrub:**
- All team members must re-clone the repository
- Old clones still contain secrets in reflog — they must be deleted
- CI/CD caches may contain old clones — clear them

### Task 2: Rotate All Exposed Credentials

**Credentials to rotate (from git history):**

| Credential | Where to Rotate | New Value Set In |
|-----------|----------------|------------------|
| Supabase URL + anon key + service role key | Supabase Dashboard → Settings → API | Vercel env vars |
| Neon database password | Neon Dashboard → Connection Details → Reset Password | Vercel env vars |
| LiveKit API key + secret | LiveKit Cloud Dashboard → Settings | Vercel env vars |
| Linear API key | Linear Settings → API → Regenerate | Vercel env vars |
| 1Password service account token | 1Password Settings → Developer → Regenerate | Vercel env vars |
| Stack Auth secret key | Stack Dashboard → Settings → Regenerate | Vercel env vars |
| Stripe webhook secret | Stripe Dashboard → Webhooks → Reveal secret | Vercel env vars |
| JWT_SECRET | Generate new: `openssl rand -base64 32` | Vercel env vars |
| ADMIN_SECRET_KEY | Generate new: `openssl rand -base64 32` | Vercel env vars |
| CRON_SECRET | Generate new: `openssl rand -base64 32` | Vercel env vars |

### Task 3: Update .env.example

**File:** `.env.example`
**Action:**
1. Remove any placeholder values that look like real credentials
2. Use descriptive generation instructions instead
3. Mark optional vs required vars

**Example:**
```env
# Required — generate with: openssl rand -base64 32
JWT_SECRET=
ADMIN_SECRET_KEY=
CRON_SECRET=

# Required — from Supabase Dashboard → Settings → API
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Required — from Stripe Dashboard
STRIPE_SECRET_KEY=
STRIPE_WEBHOOK_SECRET=
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
```

### Task 4: Enable GitHub Secret Scanning

**Action:**
1. Enable GitHub's built-in secret scanning on the repository
2. Enable push protection to prevent future secret commits
3. Settings → Code security and analysis → Secret scanning → Enable

---

## Verification

- [ ] `git log --all --full-history -- .env .env.production .env.local` returns empty
- [ ] All old credentials are revoked (old keys return 401/403)
- [ ] New credentials work in Vercel deployment
- [ ] `.env.example` contains no real values
- [ ] GitHub secret scanning is enabled
- [ ] Build succeeds on Vercel with new env vars

---

## Dependencies

None - can execute independently. Should be done FIRST before other Phase 11 plans.

---

## Notes

- This plan requires **manual action** for credential rotation (dashboard access required)
- The git history scrub requires **force-push** — coordinate with team
- All team members must re-clone after the scrub

---

*Plan created: 2026-02-06*
