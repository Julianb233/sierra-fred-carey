# Phase 11 Plan 01: Auth Endpoint Rate Limiting Summary

**One-liner:** IP-based rate limiting on all auth endpoints using in-memory sliding window algorithm

---

## What Was Done

Added rate limiting to all three authentication endpoints to prevent brute-force attacks:

1. **User Login (`/api/auth/login`)** -- 5 attempts per minute per IP
2. **Admin Login (`/api/admin/login`)** -- 3 attempts per minute per IP (stricter for admin)
3. **Signup/Onboarding (`/api/onboard`)** -- 10 attempts per hour per IP

All endpoints use `checkRateLimit` and `createRateLimitResponse` from `lib/api/rate-limit.ts`, which implements a sliding window algorithm with in-memory storage. Rate-limited responses return HTTP 429 with `Retry-After` and `X-RateLimit-*` headers.

## Tasks Completed

| Task | Name | Commit | Key Files |
|------|------|--------|-----------|
| 1 | Rate limit user login | `3593f0b` | `app/api/auth/login/route.ts` |
| 2 | Rate limit admin login | `d98ea7d` | `app/api/admin/login/route.ts` |
| 3 | Rate limit signup/onboarding | `2bb8591` | `app/api/onboard/route.ts` |

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Use `createRateLimitResponse` helper instead of manual 429 response | Consistent response format with proper headers across all endpoints |
| Include `x-real-ip` as fallback for IP extraction | Covers both proxy (x-forwarded-for) and direct (x-real-ip) scenarios |
| Admin login stricter (3/min vs 5/min for user) | Admin endpoint is higher value target, fewer legitimate use cases |
| Onboard uses hourly window (3600s) vs minute window | Signup is less frequent than login; hourly window prevents mass account creation without blocking normal users |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 2 - Missing Critical] Admin session token replaces raw key in cookie**

- **Found during:** Task 2
- **Issue:** Admin login was storing raw ADMIN_SECRET_KEY in cookie. If cookie leaked, attacker has permanent admin access.
- **Fix:** Replaced with `createAdminSession()` which generates a random UUID session token mapped to an in-memory session store with 24h expiry
- **Files modified:** `app/api/admin/login/route.ts`
- **Commit:** `d98ea7d`

## Verification

- [x] All 3 auth endpoints have rate limiting
- [x] TypeScript compiles cleanly (`npx tsc --noEmit` passes)
- [x] Correct limits: auth-login 5/min, admin-login 3/min, onboard 10/hour
- [x] All endpoints return 429 with Retry-After header when rate exceeded

## Key Files

### Created
- None

### Modified
- `app/api/auth/login/route.ts` -- Added rate limiting (5/min)
- `app/api/admin/login/route.ts` -- Added rate limiting (3/min) + session token security
- `app/api/onboard/route.ts` -- Added rate limiting (10/hour)

## Duration

~3 minutes (Tasks 1 and 3 were previously committed by concurrent execution; Task 2 was the remaining work)

---

*Summary generated by GSD framework*
