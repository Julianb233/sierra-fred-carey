# Plan 11-02: Security Headers

**Phase:** 11 - Security Hardening
**Priority:** P1 (High - prevents clickjacking, XSS, MIME sniffing)
**Estimated Scope:** 1 file modified

---

## Objective

Add security headers to all responses via Next.js config. Currently the application serves no Content-Security-Policy, X-Frame-Options, HSTS, or other protective headers.

---

## Tasks

### Task 1: Add Security Headers to next.config.mjs

**File:** `next.config.mjs`
**Action:** Add `headers()` async function returning security headers for all routes.

**Headers to add:**

| Header | Value | Purpose |
|--------|-------|---------|
| `X-Frame-Options` | `SAMEORIGIN` | Prevent clickjacking |
| `X-Content-Type-Options` | `nosniff` | Prevent MIME type sniffing |
| `Referrer-Policy` | `strict-origin-when-cross-origin` | Control referrer leakage |
| `X-DNS-Prefetch-Control` | `on` | Allow DNS prefetch for performance |
| `Strict-Transport-Security` | `max-age=31536000; includeSubDomains` | Force HTTPS (1 year) |
| `Permissions-Policy` | `camera=(), microphone=(), geolocation=()` | Restrict browser features |
| `Content-Security-Policy` | See below | Prevent XSS |

**CSP Policy (permissive for MVP, tighten later):**
```
default-src 'self';
script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com;
style-src 'self' 'unsafe-inline';
img-src 'self' data: blob: https:;
font-src 'self' data:;
connect-src 'self' https://*.supabase.co https://api.stripe.com wss://*.livekit.cloud https://*.anthropic.com https://*.openai.com;
frame-src 'self' https://js.stripe.com https://hooks.stripe.com;
object-src 'none';
base-uri 'self';
form-action 'self';
```

**Implementation:**
```javascript
async headers() {
  return [
    {
      source: '/:path*',
      headers: [
        { key: 'X-Frame-Options', value: 'SAMEORIGIN' },
        { key: 'X-Content-Type-Options', value: 'nosniff' },
        { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
        { key: 'X-DNS-Prefetch-Control', value: 'on' },
        { key: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains' },
        { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
        {
          key: 'Content-Security-Policy',
          value: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' https://*.supabase.co https://api.stripe.com wss://*.livekit.cloud https://*.anthropic.com https://*.openai.com; frame-src 'self' https://js.stripe.com https://hooks.stripe.com; object-src 'none'; base-uri 'self'; form-action 'self';"
        },
      ],
    },
  ];
},
```

### Task 2: Verify Headers Don't Break Functionality

**Action:**
1. Test that Stripe checkout iframe still loads (requires `frame-src https://js.stripe.com`)
2. Test that Supabase auth still works (requires `connect-src https://*.supabase.co`)
3. Test that AI API calls work (requires `connect-src https://*.anthropic.com https://*.openai.com`)
4. Test that LiveKit WebSocket connects (requires `connect-src wss://*.livekit.cloud`)
5. Test that framer-motion animations work (may need `unsafe-eval` for dynamic styles)

---

## Verification

- [ ] Response headers include all 7 security headers
- [ ] Stripe checkout iframe loads correctly
- [ ] Supabase auth operations work
- [ ] FRED chat streaming works
- [ ] No CSP violations in browser console during normal usage
- [ ] `npx tsc --noEmit` passes
- [ ] Build succeeds

---

## Dependencies

None - can execute independently.

---

*Plan created: 2026-02-06*
