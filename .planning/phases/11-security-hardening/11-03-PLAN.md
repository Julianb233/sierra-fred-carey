# Plan 11-03: Admin Session Tokens

**Phase:** 11 - Security Hardening
**Priority:** P1 (High - prevents permanent credential exposure via cookie theft)
**Estimated Scope:** 3 files modified, 1 new file

---

## Objective

Replace the current admin authentication pattern (raw `ADMIN_SECRET_KEY` stored as cookie value) with session tokens. Currently, if the admin cookie is stolen (via XSS on admin page, malware, MITM), the attacker gains the permanent admin secret — which cannot be revoked without rotating the environment variable.

---

## Current State

```
Login:  POST /api/admin/login → stores raw adminKey as cookie
Verify: isAdminRequest() → compares cookie value to ADMIN_SECRET_KEY
Risk:   Cookie theft = permanent access (no revocation possible)
```

## Target State

```
Login:  POST /api/admin/login → verify key, generate random session token, store in Map
Verify: isAdminRequest() → lookup session token in Map, check expiry
Revoke: POST /api/admin/logout → delete session from Map
```

---

## Tasks

### Task 1: Create Admin Session Store

**New File:** `lib/auth/admin-sessions.ts`
**Action:**
1. Create in-memory session store (Map) with TTL
2. Sessions auto-expire after 24 hours
3. Support: create, verify, revoke, cleanup

```typescript
interface AdminSession {
  token: string;
  createdAt: number;
  expiresAt: number;
}

const sessions = new Map<string, AdminSession>();

export function createAdminSession(): string {
  const token = crypto.randomUUID();
  const now = Date.now();
  sessions.set(token, {
    token,
    createdAt: now,
    expiresAt: now + 24 * 60 * 60 * 1000, // 24 hours
  });
  cleanupExpired();
  return token;
}

export function verifyAdminSession(token: string): boolean {
  const session = sessions.get(token);
  if (!session) return false;
  if (Date.now() > session.expiresAt) {
    sessions.delete(token);
    return false;
  }
  return true;
}

export function revokeAdminSession(token: string): void {
  sessions.delete(token);
}

function cleanupExpired(): void {
  const now = Date.now();
  for (const [key, session] of sessions) {
    if (now > session.expiresAt) sessions.delete(key);
  }
}
```

**Note:** In-memory store is acceptable because:
- Admin sessions are rare (few admins, infrequent login)
- Session loss on cold start = admin re-authenticates (low impact)
- For multi-instance deployments, migrate to Redis/Vercel KV later

### Task 2: Update Admin Login Route

**File:** `app/api/admin/login/route.ts`
**Action:**
1. Keep existing timing-safe key verification
2. On successful verification, create session token instead of storing raw key
3. Set session token as cookie value (not the admin key)

**Before:**
```typescript
cookieStore.set("adminKey", adminKey, { ... });
```

**After:**
```typescript
import { createAdminSession } from '@/lib/auth/admin-sessions';
const sessionToken = createAdminSession();
cookieStore.set("adminSession", sessionToken, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 60 * 60 * 24,
  path: '/',
});
```

### Task 3: Update isAdminRequest

**File:** `lib/auth/admin.ts` (or wherever `isAdminRequest` is defined)
**Action:**
1. Check for session token cookie first (new method)
2. Fall back to header-based auth (existing `x-admin-key` for API/CLI usage)
3. Never compare raw admin key from cookies

**Before:**
```typescript
const adminKey = cookieStore.get("adminKey")?.value;
return adminKey === process.env.ADMIN_SECRET_KEY;
```

**After:**
```typescript
import { verifyAdminSession } from '@/lib/auth/admin-sessions';

// Check session cookie first
const sessionToken = cookieStore.get("adminSession")?.value;
if (sessionToken && verifyAdminSession(sessionToken)) return true;

// Fall back to header auth (for API/CLI usage)
const headerKey = request.headers.get('x-admin-key');
if (headerKey) return timingSafeEqual(headerKey, process.env.ADMIN_SECRET_KEY);

return false;
```

### Task 4: Add Admin Logout

**File:** `app/api/admin/logout/route.ts`
**Action:**
1. Read session token from cookie
2. Revoke session in store
3. Clear cookie
4. Return success

```typescript
import { revokeAdminSession } from '@/lib/auth/admin-sessions';

export async function POST() {
  const cookieStore = await cookies();
  const sessionToken = cookieStore.get("adminSession")?.value;
  if (sessionToken) revokeAdminSession(sessionToken);
  cookieStore.delete("adminSession");
  return NextResponse.json({ success: true });
}
```

---

## Verification

- [ ] Admin login creates session token cookie (not raw admin key)
- [ ] Cookie value is a UUID, not the admin secret
- [ ] All admin API routes accept session token authentication
- [ ] Header-based `x-admin-key` auth still works for API/CLI
- [ ] Admin logout revokes session (subsequent requests fail)
- [ ] Expired sessions (>24h) are rejected
- [ ] `npx tsc --noEmit` passes
- [ ] `npx vitest run` passes

---

## Dependencies

None - can execute independently.

---

*Plan created: 2026-02-06*
