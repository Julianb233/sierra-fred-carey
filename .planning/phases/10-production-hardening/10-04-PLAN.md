# Plan 10-04: Build Pipeline & Tooling Fix

**Phase:** 10 - Production Hardening & Launch Prep
**Priority:** P2 (Pre-launch)
**Estimated Scope:** 3-5 files modified, 1 new file

---

## Objective

Fix the build pipeline so `next build` succeeds end-to-end (including SSG pages), and migrate ESLint from v8 to v9 flat config to resolve the circular structure error with eslint-config-next@16.

---

## Tasks

### Task 1: Fix framer-motion SSG Crash

**Issue:** `next build` (Turbopack) compiles successfully but SSG fails on `/features` page due to framer-motion@12 + React 19 `useContext` returning null during static generation.

**Files:** Pages using framer-motion that are statically generated (likely `app/features/page.tsx` and any landing pages)

**Action (choose one):**

**Option A (Preferred): Dynamic import with SSR disabled**
```typescript
import dynamic from 'next/dynamic';
const MotionDiv = dynamic(
  () => import('framer-motion').then(mod => ({ default: mod.motion.div })),
  { ssr: false }
);
```

**Option B: Force dynamic rendering**
```typescript
export const dynamic = 'force-dynamic';
```

**Option A preferred** because it keeps the page statically generated for SEO while only client-rendering the animated parts.

### Task 2: ESLint 9 Flat Config Migration

**Issue:** ESLint 8 + eslint-config-next@16 throws "Converting circular structure to JSON" error, making linting impossible.

**Files:**
- Delete: `.eslintrc.json` (old config)
- Create: `eslint.config.mjs` (new flat config)
- Update: `package.json` (ESLint 9 + updated plugins)

**Action:**
1. Upgrade ESLint to v9: `npm install eslint@9 --save-dev`
2. Install flat-config compatible plugins
3. Create `eslint.config.mjs`:
```javascript
import nextConfig from '@next/eslint-plugin-next';
import tseslint from 'typescript-eslint';

export default [
  ...tseslint.configs.recommended,
  {
    plugins: { '@next/next': nextConfig },
    rules: nextConfig.configs.recommended.rules,
  },
  { ignores: ['.next/', 'node_modules/'] },
];
```
4. Remove `.eslintrc.json`
5. Update `package.json` lint script if needed

### Task 3: Fix Build Script in package.json

**File:** `package.json`

**Issue:** If build script uses `--webpack` flag, it fails on Next.js 16 App Router (missing pages-manifest.json).

**Action:**
1. Ensure build script is `next build` (no `--webpack` flag)
2. Verify `next build` completes successfully after Tasks 1-2

---

## Verification

- [ ] `next build` completes with 0 errors (including SSG pages)
- [ ] `/features` page renders correctly in production build
- [ ] `npx eslint .` runs without circular structure error
- [ ] ESLint reports on actual code issues (not config errors)
- [ ] `npx tsc --noEmit` still passes
- [ ] `npx vitest run` still passes
- [ ] Vercel deployment preview succeeds

---

## Dependencies

None - independent of other 10-xx plans.

---

*Plan created: 2026-02-06*
