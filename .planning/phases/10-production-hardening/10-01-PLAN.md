# Plan 10-01: Security Hardening

**Phase:** 10 - Production Hardening & Launch Prep
**Priority:** P0 (Critical - before any production deploy)
**Estimated Scope:** 5 files modified, 2 new files

---

## Objective

Eliminate the critical security vulnerability of exposed credentials in git history, add startup environment validation to fail fast on missing secrets, and add rate limiting to unauthenticated endpoints.

---

## Tasks

### Task 1: Scrub Secrets from Git History

**Files:** Repository-level git operation
**Action:**
1. Install `git-filter-repo` (preferred over BFG for modern repos)
2. Run filter to remove `.env.production` and `.env.local` from all commits
3. Force-push cleaned history (coordinate with team)
4. Verify secrets no longer in any commit

**Commands:**
```bash
pip3 install git-filter-repo
git filter-repo --path .env.production --path .env.local --invert-paths
```

**Note:** After scrub, ALL team members must re-clone. Old clones retain secrets.

### Task 2: Credential Rotation

**Action:** Rotate all credentials exposed in commit `b75dc93`:
- [ ] Supabase URL + anon key + service role key (Supabase Dashboard → Settings → API)
- [ ] Neon database password (Neon Dashboard → Connection Details → Reset)
- [ ] Stack secret server key
- [ ] LiveKit API key + secret
- [ ] Linear API key
- [ ] 1Password service account token

**Post-rotation:** Update Vercel Environment Variables with new values.

### Task 3: Startup Environment Validation

**New File:** `lib/env.ts`
**Action:** Create a centralized env validation module using Zod that:
1. Defines all required env vars with types
2. Validates at import time (module-level)
3. Exports typed env object
4. Fails fast with clear error messages listing ALL missing vars

**Pattern:**
```typescript
import { z } from 'zod';

const envSchema = z.object({
  NEXT_PUBLIC_SUPABASE_URL: z.string().url(),
  NEXT_PUBLIC_SUPABASE_ANON_KEY: z.string().min(1),
  SUPABASE_SERVICE_ROLE_KEY: z.string().min(1),
  STRIPE_SECRET_KEY: z.string().startsWith('sk_'),
  STRIPE_WEBHOOK_SECRET: z.string().startsWith('whsec_'),
  // ... all required vars
});

export const env = envSchema.parse(process.env);
```

**Update:** Replace all `process.env.KEY!` non-null assertions with `env.KEY` imports in these files (8+ files identified in audit).

### Task 4: Rate Limiting on Public Endpoints

**File:** `app/api/onboard/invite/route.ts`
**New File:** `lib/rate-limit.ts`
**Action:**
1. Create a simple in-memory rate limiter (sliding window, IP-based)
2. Apply to `/api/onboard/invite` (unauthenticated endpoint)
3. Return 429 Too Many Requests when exceeded
4. Config: 5 requests per minute per IP

**Pattern:**
```typescript
const rateLimiter = new RateLimiter({ windowMs: 60_000, max: 5 });

export async function POST(req: NextRequest) {
  const ip = req.headers.get('x-forwarded-for') || 'unknown';
  if (!rateLimiter.check(ip)) {
    return NextResponse.json({ error: 'Too many requests' }, { status: 429 });
  }
  // ... existing logic
}
```

---

## Verification

- [ ] `git log --all --full-history -- .env.production` returns empty
- [ ] `git log --all --full-history -- .env.local` returns empty
- [ ] All rotated credentials work (Supabase queries, Stripe operations succeed)
- [ ] App fails to start with clear message when required env vars missing
- [ ] `/api/onboard/invite` returns 429 after 5 rapid requests
- [ ] `npx tsc --noEmit` passes
- [ ] `npx vitest run` passes

---

## Dependencies

None - this plan can execute independently.

---

*Plan created: 2026-02-06*
