---
phase: 03-pro-tier
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/migrations/027_strategy_documents.sql
  - lib/fred/strategy/types.ts
  - lib/fred/strategy/templates.ts
  - lib/fred/strategy/generator.ts
  - lib/fred/strategy/db.ts
  - lib/fred/strategy/index.ts
  - app/api/fred/strategy/route.ts
  - app/api/fred/strategy/[id]/route.ts
  - app/api/fred/strategy/[id]/export/route.ts
  - lib/documents/export.ts
  - app/dashboard/strategy/page.tsx
  - components/strategy/document-type-selector.tsx
  - components/strategy/document-editor.tsx
  - components/strategy/document-preview.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "5 strategy document templates exist: executive summary, market analysis, 30-60-90 plan, competitive analysis, GTM plan"
    - "Strategy generator produces section-by-section documents using FRED voice and startup context"
    - "POST /api/fred/strategy generates a new document (Pro tier gated)"
    - "GET/PUT/DELETE /api/fred/strategy/[id] support CRUD operations"
    - "GET /api/fred/strategy/[id]/export?format=pdf exports document as PDF"
    - "Strategy page shows functional document type selector, generation, list, and preview"
  artifacts:
    - path: "lib/fred/strategy/types.ts"
      provides: "DocumentType union, StrategyTemplate, GeneratedDocument interfaces"
      exports: ["StrategyDocumentType", "StrategyTemplate", "TemplateSection", "GeneratedDocument", "GeneratorInput"]
    - path: "lib/fred/strategy/templates.ts"
      provides: "5 document templates with section definitions and prompts"
      exports: ["STRATEGY_TEMPLATES", "getTemplate"]
    - path: "lib/fred/strategy/generator.ts"
      provides: "AI-powered document generation using generateText"
      exports: ["generateDocument", "generateSection"]
    - path: "lib/fred/strategy/db.ts"
      provides: "CRUD for strategy_documents table"
      exports: ["saveStrategyDocument", "getStrategyDocument", "getStrategyDocuments", "updateStrategyDocument", "deleteStrategyDocument"]
    - path: "lib/fred/strategy/index.ts"
      provides: "Barrel re-export for strategy module"
    - path: "app/api/fred/strategy/route.ts"
      provides: "POST (generate) and GET (list) endpoints"
      exports: ["POST", "GET"]
    - path: "app/api/fred/strategy/[id]/route.ts"
      provides: "GET, PUT, DELETE for individual documents"
      exports: ["GET", "PUT", "DELETE"]
    - path: "app/api/fred/strategy/[id]/export/route.ts"
      provides: "PDF export endpoint"
      exports: ["GET"]
    - path: "lib/documents/export.ts"
      provides: "Markdown to PDF conversion"
      exports: ["exportToPDF"]
    - path: "lib/db/migrations/027_strategy_documents.sql"
      provides: "Database table for generated strategy documents"
      contains: "CREATE TABLE"
    - path: "app/dashboard/strategy/page.tsx"
      provides: "Functional strategy page with real API integration"
    - path: "components/strategy/document-type-selector.tsx"
      provides: "Card grid for selecting document type to generate"
    - path: "components/strategy/document-editor.tsx"
      provides: "Markdown editor for editing generated documents"
    - path: "components/strategy/document-preview.tsx"
      provides: "Formatted preview of generated document"
  key_links:
    - from: "lib/fred/strategy/generator.ts"
      to: "lib/fred/strategy/templates.ts"
      via: "getTemplate called in generateDocument"
      pattern: "getTemplate"
    - from: "lib/fred/strategy/generator.ts"
      to: "ai"
      via: "generateText for each section"
      pattern: "generateText"
    - from: "app/api/fred/strategy/route.ts"
      to: "lib/fred/strategy/generator.ts"
      via: "POST handler calls generateDocument"
      pattern: "generateDocument"
    - from: "app/api/fred/strategy/[id]/export/route.ts"
      to: "lib/documents/export.ts"
      via: "GET handler calls exportToPDF"
      pattern: "exportToPDF"
    - from: "app/dashboard/strategy/page.tsx"
      to: "/api/fred/strategy"
      via: "fetch calls for CRUD and generation"
      pattern: "fetch.*api/fred/strategy"
---

<objective>
Build the complete Strategy Document Generation feature, closing UAT gaps from tests 8 and 9.

Purpose: Pro tier users can generate professional strategy documents (executive summaries, market analysis, 30-60-90 plans, competitive analysis, GTM plans) using FRED's voice and their startup context. Documents can be viewed, edited, and exported as PDF.

Output: Functional strategy generation engine, 5 templates, CRUD API endpoints, PDF export, and UI page that replaces the existing static mock.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-pro-tier/03-UAT.md

Existing infrastructure to build on (read these for patterns):
@lib/fred/irs/types.ts — Type definition pattern
@lib/fred/irs/engine.ts — Engine pattern (generateObject + Zod + system prompt)
@lib/fred/irs/db.ts — Database operations pattern
@lib/fred/irs/index.ts — Barrel export pattern
@lib/ai/fred-client.ts — AI client with generateStructured, generateObject
@lib/api/tier-middleware.ts — checkTierForRequest pattern
@app/api/fred/investor-readiness/route.ts — API route pattern to follow
@lib/db/documents.ts — Document CRUD pattern (Supabase client usage)
@lib/db/migrations/025_investor_readiness_scores.sql — Migration pattern
@app/dashboard/strategy/page.tsx — EXISTING STATIC MOCK (replace with functional version)
@lib/constants.ts — UserTier enum
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strategy Templates, Generator Engine, DB, Migration</name>
  <files>
    lib/db/migrations/027_strategy_documents.sql
    lib/fred/strategy/types.ts
    lib/fred/strategy/templates.ts
    lib/fred/strategy/generator.ts
    lib/fred/strategy/db.ts
    lib/fred/strategy/index.ts
  </files>
  <action>
    **Migration (027_strategy_documents.sql):**
    Follow the 025/026 migration pattern:
    - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
    - user_id UUID NOT NULL
    - type TEXT NOT NULL (one of: 'executive_summary', 'market_analysis', '30_60_90_plan', 'competitive_analysis', 'gtm_plan')
    - title TEXT NOT NULL
    - content TEXT NOT NULL (full Markdown content)
    - sections JSONB NOT NULL (array of {title, content} objects for section-level editing)
    - metadata JSONB DEFAULT '{}' (wordCount, generatedAt, context sources)
    - version INTEGER DEFAULT 1
    - created_at TIMESTAMPTZ DEFAULT NOW()
    - updated_at TIMESTAMPTZ DEFAULT NOW()
    - Indexes on user_id, type, created_at DESC

    **Types (lib/fred/strategy/types.ts):**
    Follow the IRS types.ts pattern:
    - `StrategyDocumentType` = 'executive_summary' | 'market_analysis' | '30_60_90_plan' | 'competitive_analysis' | 'gtm_plan'
    - `STRATEGY_DOCUMENT_TYPES: StrategyDocumentType[]` array constant
    - `DOCUMENT_TYPE_LABELS: Record<StrategyDocumentType, string>` (human-readable: "Executive Summary", "Market Analysis", "30-60-90 Day Plan", "Competitive Analysis", "Go-to-Market Plan")
    - `DOCUMENT_TYPE_DESCRIPTIONS: Record<StrategyDocumentType, string>` (what each type is for)
    - `DOCUMENT_TYPE_ICONS: Record<StrategyDocumentType, string>` (Lucide icon names: 'FileText', 'Target', 'Calendar', 'TrendingUp', 'Rocket')
    - `TemplateSection` interface: { title: string; prompt: string; maxWords: number }
    - `StrategyTemplate` interface: { type: StrategyDocumentType; label: string; description: string; sections: TemplateSection[]; totalWordTarget: number; tone: string }
    - `GeneratorInput` interface: { type: StrategyDocumentType; startupInfo: { name?: string; stage?: string; industry?: string; description?: string; challenge?: string }; additionalContext?: string }
    - `GeneratedSection` interface: { title: string; content: string; wordCount: number }
    - `GeneratedDocument` interface: { id?: string; userId?: string; type: StrategyDocumentType; title: string; content: string; sections: GeneratedSection[]; metadata: { wordCount: number; generatedAt: Date; context: string[] }; version: number; createdAt?: Date; updatedAt?: Date }

    **Templates (lib/fred/strategy/templates.ts):**
    Export `STRATEGY_TEMPLATES: Record<StrategyDocumentType, StrategyTemplate>` and `getTemplate(type): StrategyTemplate`.

    Define 5 templates with specific section prompts:

    1. **executive_summary** (target ~500 words, tone: "professional, concise, compelling"):
       Sections: Company Overview, Problem & Solution, Market Opportunity, Business Model, Traction & Milestones, Team, Funding & Use of Proceeds

    2. **market_analysis** (target ~1500 words, tone: "analytical, data-driven"):
       Sections: Market Definition, Market Size (TAM/SAM/SOM), Market Trends & Drivers, Customer Segments, Competitive Landscape, Market Entry Strategy

    3. **30_60_90_plan** (target ~1000 words, tone: "action-oriented, specific"):
       Sections: Current State Assessment, 30-Day Priorities (Quick Wins), 60-Day Objectives (Foundation), 90-Day Goals (Scale), Key Metrics to Track, Resource Requirements

    4. **competitive_analysis** (target ~1200 words, tone: "strategic, objective"):
       Sections: Competitor Overview, Feature Comparison Matrix, Positioning Map, Strengths & Weaknesses Analysis, Differentiation Strategy, Competitive Moat

    5. **gtm_plan** (target ~1500 words, tone: "tactical, execution-focused"):
       Sections: Target Customer Profile (ICP), Value Proposition, Channel Strategy, Pricing Strategy, Launch Plan & Timeline, Success Metrics & KPIs

    Each section's `prompt` field should be a detailed instruction for the AI, e.g.:
    ```
    "Write the Market Size section. Include TAM (Total Addressable Market), SAM (Serviceable Addressable Market), and SOM (Serviceable Obtainable Market) with specific dollar figures. Cite industry sources where possible. Show the market size calculation methodology."
    ```

    **Generator (lib/fred/strategy/generator.ts):**
    Follow the IRS engine pattern:
    - `generateDocument(input: GeneratorInput): Promise<GeneratedDocument>` — Main orchestrator:
      1. Get template via `getTemplate(input.type)`
      2. Build system prompt: "You are Fred Cary, serial entrepreneur and startup advisor with 40+ years experience. You speak directly, avoid corporate jargon, and give specific actionable advice. You are writing a {template.label} for {startupInfo.name}."
      3. For each section in template.sections: call `generateSection(section, input, systemPrompt)`
      4. Assemble all sections into full Markdown document: each section is `## {title}\n\n{content}`
      5. Build title: "{template.label}: {startupInfo.name}" (or "{template.label}" if no name)
      6. Calculate total word count
      7. Return GeneratedDocument with assembled content, sections, metadata

    - `generateSection(section: TemplateSection, input: GeneratorInput, systemPrompt: string): Promise<GeneratedSection>` — Uses `generateText` from 'ai' with `openai('gpt-4o')`:
      - Prompt includes: section.prompt + startup context (name, stage, industry, description, challenge)
      - Temperature 0.7 for creative content
      - maxOutputTokens based on section.maxWords * 2 (tokens roughly = 0.75 * words, with margin)
      - Returns { title: section.title, content: result.text, wordCount: countWords(result.text) }

    - Helper: `countWords(text: string): number` — Split on whitespace, filter empties, return length

    Use `generateText` (NOT generateObject) for section generation since we want flowing prose, not structured data. Import from 'ai' and '@ai-sdk/openai' like the IRS engine does.

    **Database (lib/fred/strategy/db.ts):**
    Follow IRS db.ts pattern:
    - Initialize Supabase client same way (createClient with env vars)
    - `saveStrategyDocument(userId: string, doc: GeneratedDocument): Promise<GeneratedDocument>` — Insert into strategy_documents, return mapped result
    - `getStrategyDocument(userId: string, docId: string): Promise<GeneratedDocument | null>` — Single document by ID, check user ownership
    - `getStrategyDocuments(userId: string, filters?: { type?: StrategyDocumentType; limit?: number }): Promise<GeneratedDocument[]>` — User's documents, newest first
    - `updateStrategyDocument(userId: string, docId: string, updates: { content?: string; sections?: GeneratedSection[]; title?: string }): Promise<GeneratedDocument>` — Update content, bump version, set updated_at
    - `deleteStrategyDocument(userId: string, docId: string): Promise<void>` — Delete with ownership check
    - Private `mapDbToDocument(row): GeneratedDocument` function

    **Index (lib/fred/strategy/index.ts):**
    Barrel export:
    - `export * from './types'`
    - `export { STRATEGY_TEMPLATES, getTemplate } from './templates'`
    - `export { generateDocument, generateSection } from './generator'`
    - `export { saveStrategyDocument, getStrategyDocument, getStrategyDocuments, updateStrategyDocument, deleteStrategyDocument } from './db'`
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no type errors. Check all files exist:
    ```
    ls lib/fred/strategy/types.ts lib/fred/strategy/templates.ts lib/fred/strategy/generator.ts lib/fred/strategy/db.ts lib/fred/strategy/index.ts lib/db/migrations/027_strategy_documents.sql
    ```
    Verify templates: `grep -c "TemplateSection" lib/fred/strategy/templates.ts` should show references to all 5 template section arrays.
  </verify>
  <done>
    All 6 files exist. TypeScript compiles without errors. 5 document templates defined with detailed section prompts. Generator produces Markdown documents using FRED's voice. DB layer handles CRUD. Module follows same structure as lib/fred/irs/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Strategy API Endpoints, PDF Export, and Functional UI</name>
  <files>
    app/api/fred/strategy/route.ts
    app/api/fred/strategy/[id]/route.ts
    app/api/fred/strategy/[id]/export/route.ts
    lib/documents/export.ts
    app/dashboard/strategy/page.tsx
    components/strategy/document-type-selector.tsx
    components/strategy/document-editor.tsx
    components/strategy/document-preview.tsx
  </files>
  <action>
    **API Route — List and Generate (app/api/fred/strategy/route.ts):**
    Follow investor-readiness/route.ts pattern:
    - POST handler (Generate new document):
      1. `checkTierForRequest(request, UserTier.PRO)` — 403 if not allowed
      2. Parse body: `{ type: StrategyDocumentType, startupInfo?: {...}, additionalContext?: string }`
      3. Validate type is one of STRATEGY_DOCUMENT_TYPES (400 if invalid)
      4. Call `generateDocument({ type, startupInfo: body.startupInfo || {}, additionalContext: body.additionalContext })`
      5. Call `saveStrategyDocument(userId, document)`
      6. Return `{ success: true, document: savedDoc }`
      7. Wrap in try/catch, return 500 on failure
    - GET handler (List documents):
      1. `checkTierForRequest(request, UserTier.PRO)` — 403 if not allowed
      2. Parse searchParams: `type` (optional filter), `limit` (default 20)
      3. Call `getStrategyDocuments(userId, { type, limit })`
      4. Return `{ success: true, documents, count: documents.length }`

    **API Route — Single Document (app/api/fred/strategy/[id]/route.ts):**
    - GET handler:
      1. Tier check (Pro)
      2. Extract `id` from params. In Next.js 16 App Router, the second argument is `{ params: Promise<{ id: string }> }`. Use `const { id } = await params;`
      3. Call `getStrategyDocument(userId, id)` — 404 if not found
      4. Return `{ success: true, document }`
    - PUT handler:
      1. Tier check (Pro)
      2. Parse body: `{ content?: string, sections?: GeneratedSection[], title?: string }`
      3. Call `updateStrategyDocument(userId, id, body)`
      4. Return `{ success: true, document: updated }`
    - DELETE handler:
      1. Tier check (Pro)
      2. Call `deleteStrategyDocument(userId, id)`
      3. Return `{ success: true }`

    **PDF Export (lib/documents/export.ts):**
    Simple Markdown-to-PDF conversion. Do NOT add heavy dependencies. Use a lightweight approach:
    - `exportToPDF(content: string, title: string): Promise<Buffer>` — Convert Markdown to a clean PDF
    - Implementation approach: Use the existing `@react-pdf/renderer` if it's in package.json. If NOT, use a simpler approach:
      1. Check `package.json` for existing PDF libraries
      2. If none suitable for server-side PDF generation: generate a print-friendly HTML document
      3. Simplest viable approach: parse markdown headings (##) and paragraphs manually with regex, wrap in a styled HTML template with print-friendly CSS (@media print styles), return as Buffer
      4. The export endpoint serves this as text/html with Content-Disposition header suggesting a .html filename. The user can then print-to-PDF from their browser. This avoids heavy dependencies.
    - AVOID installing puppeteer, wkhtmltopdf, or other heavy rendering engines.
    - Export function signature: `exportToPDF(content: string, title: string): Promise<{ buffer: Buffer; contentType: string; extension: string }>`
    - This allows the endpoint to set correct headers based on actual output format.

    **Export API Route (app/api/fred/strategy/[id]/export/route.ts):**
    - GET handler:
      1. Tier check (Pro)
      2. Extract `id` from params (await params pattern)
      3. Parse searchParams: `format` (default 'pdf')
      4. Call `getStrategyDocument(userId, id)` — 404 if not found
      5. If format === 'pdf': call `exportToPDF(document.content, document.title)`, return with appropriate Content-Type and Content-Disposition headers
      6. If format === 'markdown': return raw markdown content with Content-Type text/markdown and Content-Disposition attachment header
      7. Return 400 for unsupported formats

    **UI Components:**

    **components/strategy/document-type-selector.tsx** — 'use client' component
    Props: `{ onSelect: (type: StrategyDocumentType) => void; generating: StrategyDocumentType | null }`
    - Grid of 5 cards (2 columns on md, 1 on sm)
    - Each card: icon (from Lucide -- map DOCUMENT_TYPE_ICONS strings to actual components: FileText, Target, Calendar, TrendingUp, Rocket), type label, description, "Generate" button
    - Generating state: show Loader2 spinner on the active card, disable all other buttons
    - Orange accent color (#ff6a1a) for buttons and hover states (consistent with existing UI)
    - Import types and constants from '@/lib/fred/strategy'

    **components/strategy/document-editor.tsx** — 'use client' component
    Props: `{ document: GeneratedDocument; onSave: (updates: { content: string; sections: GeneratedSection[] }) => void; saving: boolean }`
    - Tab interface: "Edit" and "Preview" tabs (use simple state toggle, no library needed)
    - Edit tab: textarea for full markdown content (monospace font, full width, min-height 400px, border, rounded)
    - Preview tab: render content with whitespace preserved (white-space: pre-wrap in a prose container)
    - Save button at top-right (disabled when saving, shows Loader2 spinner)
    - On save: parse the edited content back into sections by splitting on "## " headers, rebuild sections array

    **components/strategy/document-preview.tsx** — 'use client' component
    Props: `{ document: GeneratedDocument; onExport: (format: string) => void; onEdit: () => void; onDelete: () => void }`
    - Document title as h2, type badge (orange pill)
    - Metadata row: word count, generated date (formatted), version number
    - Full content rendered with preserved whitespace and prose styling
    - Action buttons row: "Export PDF" (orange), "Export Markdown" (outline), "Edit" (outline), "Delete" (red outline)
    - Delete confirmation via window.confirm('Delete this document?') before calling onDelete

    **Dashboard Page (app/dashboard/strategy/page.tsx):**
    REPLACE the entire existing static mock page. Make it a 'use client' component:
    - State: `documents` (GeneratedDocument[]), `selectedDoc` (GeneratedDocument | null), `view` ('list' | 'preview' | 'edit'), `generating` (StrategyDocumentType | null), `loading`, `saving`
    - On mount: GET `/api/fred/strategy` to load existing documents
    - Three views controlled by `view` state:
      1. **list** (default): DocumentTypeSelector at top + document list below. Document list as cards (not table -- more visual). Each card: title, type badge, date, word count. Click card to select and switch to 'preview' view.
      2. **preview**: DocumentPreview showing selected document. Back button (arrow left icon) returns to list. Edit button switches to 'edit' view.
      3. **edit**: DocumentEditor for selected document. Save triggers PUT `/api/fred/strategy/{id}`. Cancel/back returns to preview.
    - Generate flow: DocumentTypeSelector onSelect triggers POST `/api/fred/strategy` with `{ type, startupInfo: {} }`. On success, add to documents list, select it, switch to preview view.
    - Delete flow: calls DELETE `/api/fred/strategy/{id}`, removes from list, returns to list view
    - Export flow: window.open(`/api/fred/strategy/${doc.id}/export?format=pdf`) for PDF, similar for markdown
    - Pro badge in header, toast notifications via sonner for success/error
    - Loading states: skeleton cards while loading, spinner overlay during generation with "FRED is writing your {type}..." message
    - Empty state: "No strategy documents yet. Choose a document type above to generate your first."
    - Import types from '@/lib/fred/strategy' for type safety
  </action>
  <verify>
    Run `npx tsc --noEmit` and confirm no type errors. Check all files exist:
    ```
    ls app/api/fred/strategy/route.ts app/api/fred/strategy/[id]/route.ts app/api/fred/strategy/[id]/export/route.ts lib/documents/export.ts app/dashboard/strategy/page.tsx components/strategy/document-type-selector.tsx components/strategy/document-editor.tsx components/strategy/document-preview.tsx
    ```
    Run `npx next build 2>&1 | head -50` to verify no build errors (timeout 120s).
    Verify tier gating: `grep -r "checkTierForRequest" app/api/fred/strategy/` should show tier checks in all 3 route files.
  </verify>
  <done>
    All API endpoints exist: POST/GET /api/fred/strategy, GET/PUT/DELETE /api/fred/strategy/[id], GET /api/fred/strategy/[id]/export. PDF/markdown export works via exportToPDF. Strategy page is fully functional with generate, list, preview, edit, and delete flows. All endpoints require Pro tier. Three UI components render document types, editor, and preview.
  </done>
</task>

</tasks>

<verification>
1. `ls lib/fred/strategy/` shows: types.ts, templates.ts, generator.ts, db.ts, index.ts
2. `ls app/api/fred/strategy/` shows: route.ts and [id]/ directory
3. `ls app/api/fred/strategy/[id]/` shows: route.ts and export/ directory
4. `ls components/strategy/` shows: document-type-selector.tsx, document-editor.tsx, document-preview.tsx
5. `ls lib/documents/export.ts` exists
6. `ls lib/db/migrations/027_strategy_documents.sql` exists
7. `npx tsc --noEmit` passes with no errors
8. `grep -r "checkTierForRequest" app/api/fred/strategy/` confirms tier gating in all 3 route files
9. `grep -r "generateDocument" app/api/fred/strategy/route.ts` confirms generator integration
10. `grep -r "generateText" lib/fred/strategy/generator.ts` confirms AI integration
11. `grep -r "STRATEGY_TEMPLATES" lib/fred/strategy/templates.ts` confirms 5 templates defined
12. `grep -c "executive_summary\|market_analysis\|30_60_90_plan\|competitive_analysis\|gtm_plan" lib/fred/strategy/templates.ts` returns at least 5
</verification>

<success_criteria>
- 5 strategy document templates defined with detailed section prompts and FRED's voice
- Generator produces multi-section Markdown documents via OpenAI
- CRUD API endpoints all Pro tier gated
- PDF/Markdown export endpoint works
- Dashboard page replaces static mock with full generate/list/preview/edit/delete workflow
- All TypeScript compiles without errors
- Module follows same structure as lib/fred/irs/ (types, engine/generator, db, index barrel)
</success_criteria>

<output>
After completion, create `.planning/phases/03-pro-tier/03-07-SUMMARY.md`
</output>
