# Plan 03-05: Pro Tier Stripe Integration

**Status:** COMPLETED
**Phase:** 03 - Pro Tier Features
**Depends On:** 02-04 (Tier gating)
**Estimated Complexity:** Medium

---

## Objective

Implement Stripe integration for Pro tier subscriptions:
1. Create Stripe product and price configurations
2. Build checkout flow for upgrades
3. Handle webhooks for subscription events
4. Sync subscription status with user tiers
5. Build upgrade/downgrade UI

---

## Current State Analysis

**Existing:**
- Tier gating infrastructure (02-04)
- User profiles in Supabase
- TierContext and useTier hooks

**Missing:**
- Stripe configuration
- Checkout session creation
- Webhook handling
- Customer portal integration
- Upgrade UI components

---

## Pricing Structure

| Tier | Price | Features |
|------|-------|----------|
| Free | $0/month | Reality Lens, Basic FRED chat, Decision history |
| Pro | $49/month | + PDF analysis, IRS, Pitch review, Strategy docs |
| Studio | $199/month | + Virtual agents, SMS check-ins, Boardy integration |

---

## Implementation Steps

### Step 1: Create Stripe Configuration

**File:** `lib/stripe/config.ts`

```typescript
export const stripeConfig = {
  products: {
    pro: {
      name: 'Sahara Pro',
      description: 'Full access to FRED AI advisor features',
      priceId: process.env.STRIPE_PRO_PRICE_ID,
    },
    studio: {
      name: 'Sahara Studio',
      description: 'Complete founder operating system with virtual team',
      priceId: process.env.STRIPE_STUDIO_PRICE_ID,
    },
  },
  webhookSecret: process.env.STRIPE_WEBHOOK_SECRET,
};
```

### Step 2: Create Stripe Client

**File:** `lib/stripe/client.ts`

```typescript
import Stripe from 'stripe';

export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {
  apiVersion: '2024-12-18.acacia',
  typescript: true,
});
```

Key functions:
- `createCheckoutSession(userId, priceId, returnUrl)`
- `createPortalSession(customerId, returnUrl)`
- `getSubscription(subscriptionId)`
- `cancelSubscription(subscriptionId)`

### Step 3: Add Subscription Fields to User Profile

**File:** `lib/db/migrations/013_subscriptions.sql`

```sql
-- Add subscription fields to profiles
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS stripe_customer_id TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS stripe_subscription_id TEXT;
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS subscription_status TEXT DEFAULT 'none';
-- 'none', 'active', 'past_due', 'canceled', 'trialing'
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS subscription_tier TEXT DEFAULT 'free';
ALTER TABLE profiles ADD COLUMN IF NOT EXISTS subscription_period_end TIMESTAMPTZ;

CREATE INDEX idx_profiles_stripe_customer ON profiles(stripe_customer_id);
```

### Step 4: Create Checkout API

**File:** `app/api/stripe/checkout/route.ts`

```typescript
// POST /api/stripe/checkout
// Body: { tier: 'pro' | 'studio' }
// - Create or retrieve Stripe customer
// - Create checkout session
// - Return checkout URL

export async function POST(request: Request) {
  // Verify authenticated user
  // Get or create Stripe customer
  // Create checkout session with success/cancel URLs
  // Return session URL
}
```

### Step 5: Create Webhook Handler

**File:** `app/api/stripe/webhook/route.ts`

```typescript
// POST /api/stripe/webhook
// Handle Stripe webhook events

const relevantEvents = [
  'checkout.session.completed',
  'customer.subscription.created',
  'customer.subscription.updated',
  'customer.subscription.deleted',
  'invoice.payment_succeeded',
  'invoice.payment_failed',
];

export async function POST(request: Request) {
  // Verify webhook signature
  // Handle each event type
  // Update user subscription status
}
```

**File:** `lib/stripe/webhooks.ts`

```typescript
// Event handlers

export async function handleCheckoutCompleted(session: Stripe.Checkout.Session) {
  // Link customer to user
  // Update subscription status
  // Send welcome email
}

export async function handleSubscriptionUpdated(subscription: Stripe.Subscription) {
  // Update tier based on subscription
  // Handle upgrade/downgrade
}

export async function handleSubscriptionDeleted(subscription: Stripe.Subscription) {
  // Downgrade to free tier
  // Send cancellation email
}

export async function handlePaymentFailed(invoice: Stripe.Invoice) {
  // Mark subscription as past_due
  // Send payment failure email
}
```

### Step 6: Create Customer Portal API

**File:** `app/api/stripe/portal/route.ts`

```typescript
// POST /api/stripe/portal
// - Get user's Stripe customer ID
// - Create portal session
// - Return portal URL

export async function POST(request: Request) {
  // Verify authenticated user
  // Get Stripe customer ID
  // Create portal session
  // Return portal URL
}
```

### Step 7: Create Upgrade Modal

**File:** `components/tier/upgrade-modal.tsx`

Features:
- Tier comparison table
- Price display
- Feature highlights
- "Upgrade Now" CTA
- FAQ accordion

### Step 8: Create Pricing Page

**File:** `app/pricing/page.tsx`

Layout:
- Three tier cards (Free, Pro, Studio)
- Feature comparison
- FAQ section
- Trust indicators

### Step 9: Create Subscription Management UI

**File:** `components/settings/subscription-settings.tsx`

Features:
- Current tier display
- Billing cycle info
- Payment method (masked)
- Upgrade/downgrade buttons
- Cancel subscription
- Link to Stripe portal

### Step 10: Update Tier Context

**File:** `lib/context/tier-context.tsx` (update)

```typescript
// Fetch tier from subscription status
// Handle subscription changes
// Provide upgrade/downgrade actions
```

---

## Webhook Event Flow

```
User clicks "Upgrade" → Checkout Session Created → User pays
    ↓
checkout.session.completed webhook
    ↓
customer.subscription.created webhook
    ↓
Update user profile (stripe_customer_id, subscription_tier, etc.)
    ↓
User redirected to success page with Pro access
```

---

## Environment Variables

```env
STRIPE_SECRET_KEY=sk_...
STRIPE_PUBLISHABLE_KEY=pk_...
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_PRO_PRICE_ID=price_...
STRIPE_STUDIO_PRICE_ID=price_...
```

---

## Testing

- [ ] Checkout session creates correctly
- [ ] Webhook signature verification works
- [ ] Subscription status syncs after payment
- [ ] Tier upgrades immediately after checkout
- [ ] Cancellation downgrades to free
- [ ] Payment failure marks as past_due
- [ ] Portal session works

---

## Verification

- [ ] Complete Pro upgrade flow (test mode)
- [ ] Verify tier updates in database
- [ ] Test webhook with Stripe CLI
- [ ] Cancel subscription via portal
- [ ] Verify downgrade to free tier

---

## Stripe CLI Testing

```bash
# Listen for webhooks locally
stripe listen --forward-to localhost:3000/api/stripe/webhook

# Trigger test events
stripe trigger checkout.session.completed
stripe trigger customer.subscription.updated
stripe trigger customer.subscription.deleted
```

---

*Plan file for GSD framework*
