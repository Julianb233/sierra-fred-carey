---
phase: 65-mobile-ux-polish
plan: 04
type: execute
wave: 2
depends_on: ["65-01"]
files_modified:
  - lib/hooks/use-push-subscription.ts
  - components/settings/NotificationSettings.tsx
autonomous: true

must_haves:
  truths:
    - "Push subscription retries with exponential backoff on transient failure"
    - "Push notification UI shows correct state when permission is denied"
    - "iOS standalone detection prompts PWA install before push subscription"
  artifacts:
    - path: "lib/hooks/use-push-subscription.ts"
      provides: "Push subscription hook with retry logic and iOS detection"
      contains: "retry"
    - path: "components/settings/NotificationSettings.tsx"
      provides: "Notification settings with denied-permission guidance"
      contains: "denied"
  key_links:
    - from: "lib/hooks/use-push-subscription.ts"
      to: "/api/push/subscribe"
      via: "fetch POST to register subscription"
      pattern: "api/push/subscribe"
    - from: "components/settings/NotificationSettings.tsx"
      to: "lib/hooks/use-push-subscription.ts"
      via: "hook import"
      pattern: "use-push-subscription"
---

<objective>
Harden push notification reliability on mobile by adding retry logic with exponential backoff, proper handling of denied permission state, and iOS standalone mode detection. This depends on Plan 01 (Serwist migration) since the push handlers are now in the new SW.

Purpose: Push notifications currently have no retry logic on subscription failure and don't handle the "denied" permission state gracefully. iOS PWA push requires standalone mode detection. These are the remaining gaps for reliable mobile push.

Output: Updated `use-push-subscription.ts` with retry logic and iOS detection, updated `NotificationSettings.tsx` with denied-permission UI.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-mobile-ux-polish/65-RESEARCH.md

Key existing files:
@lib/hooks/use-push-subscription.ts
@components/settings/NotificationSettings.tsx
@lib/push/index.ts
@app/api/push/subscribe/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add retry logic and iOS detection to push subscription hook</name>
  <files>lib/hooks/use-push-subscription.ts</files>
  <action>
Read the existing `lib/hooks/use-push-subscription.ts` first to understand its current structure.

Then update it with these additions:

1. **Retry with exponential backoff**: When `pushManager.subscribe()` or the backend registration fetch fails, retry up to 3 times with delays of 1s, 2s, 4s (exponential backoff). Use a try/catch loop:
   ```typescript
   async function subscribeWithRetry(registration: ServiceWorkerRegistration, retries = 3): Promise<PushSubscription | null> {
     for (let attempt = 0; attempt < retries; attempt++) {
       try {
         const subscription = await registration.pushManager.subscribe({
           userVisibleOnly: true,
           applicationServerKey: urlBase64ToUint8Array(vapidPublicKey),
         });
         // Register with backend
         await fetch("/api/push/subscribe", { ... });
         return subscription;
       } catch (err) {
         if (attempt === retries - 1) throw err;
         await new Promise(r => setTimeout(r, 1000 * Math.pow(2, attempt)));
       }
     }
     return null;
   }
   ```

2. **Permission state tracking**: Add a `permissionState` to the hook's return value: `'default' | 'granted' | 'denied' | 'unsupported'`. Check `Notification.permission` on mount and after any permission request. If `'denied'`, the subscribe function should be a no-op that returns early.

3. **iOS standalone detection**: Add a helper:
   ```typescript
   function isIOSStandalone(): boolean {
     return (
       typeof window !== 'undefined' &&
       'standalone' in (window.navigator as any) &&
       (window.navigator as any).standalone === true
     );
   }
   function isIOS(): boolean {
     return typeof window !== 'undefined' && /iPad|iPhone|iPod/.test(navigator.userAgent);
   }
   ```
   Add `isIOS` and `isIOSStandalone` to the hook's return value. This allows the UI to show "Add to Home Screen" guidance on iOS non-standalone.

4. **Return type**: The hook should return:
   ```typescript
   {
     subscription: PushSubscription | null;
     isSubscribed: boolean;
     isLoading: boolean;
     error: string | null;
     permissionState: 'default' | 'granted' | 'denied' | 'unsupported';
     isIOS: boolean;
     isIOSStandalone: boolean;
     subscribe: () => Promise<void>;
     unsubscribe: () => Promise<void>;
   }
   ```

Keep all existing functionality (subscribe, unsubscribe, state management) -- only add the retry logic, permission state, and iOS detection on top.
  </action>
  <verify>
- `lib/hooks/use-push-subscription.ts` contains retry logic with backoff
- Hook returns `permissionState`, `isIOS`, `isIOSStandalone`
- TypeScript: no type errors
  </verify>
  <done>Push subscription hook has retry with exponential backoff, permission state tracking, and iOS standalone detection</done>
</task>

<task type="auto">
  <name>Task 2: Update NotificationSettings with denied-permission and iOS guidance</name>
  <files>components/settings/NotificationSettings.tsx</files>
  <action>
Read the existing `components/settings/NotificationSettings.tsx` first.

Then add these UI states:

1. **Denied permission state**: When `permissionState === 'denied'`, instead of showing the subscribe button, show a helpful message:
   ```
   "Push notifications are blocked. To re-enable:
   1. Click the lock/info icon in your browser's address bar
   2. Find 'Notifications' and change to 'Allow'
   3. Reload this page"
   ```
   Style with a yellow/amber warning card (bg-amber-50, border-amber-200, text-amber-800, dark variants).

2. **iOS non-standalone state**: When `isIOS && !isIOSStandalone`, show guidance:
   ```
   "To receive push notifications on iOS:
   1. Tap the Share button in Safari
   2. Select 'Add to Home Screen'
   3. Open Sahara from your home screen
   4. Enable notifications here"
   ```
   Style with a blue info card (bg-blue-50, border-blue-200, text-blue-800, dark variants).

3. **Unsupported state**: When `permissionState === 'unsupported'`, show:
   ```
   "Push notifications are not supported in this browser."
   ```

4. Keep the existing subscribe/unsubscribe buttons for the normal `'default'` and `'granted'` states. Just add the new conditional states above them.

5. If the hook now returns `isLoading`, show a loading spinner on the subscribe button when subscription is in progress.
  </action>
  <verify>
- `components/settings/NotificationSettings.tsx` handles denied, iOS, and unsupported states
- Each state has clear user guidance
- `npm run build` succeeds
  </verify>
  <done>Notification settings show actionable guidance for denied permissions, iOS PWA install requirement, and unsupported browsers</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Push subscription hook returns permissionState, isIOS, isIOSStandalone
3. NotificationSettings handles denied/iOS/unsupported states with user guidance
4. Retry logic uses exponential backoff (1s, 2s, 4s)
</verification>

<success_criteria>
- Push subscription retries automatically on transient failure (up to 3 attempts)
- Users who denied push permission see clear re-enable instructions
- iOS users not in standalone mode see PWA install instructions
- Unsupported browsers show clear "not supported" message
- All existing push subscription functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/65-mobile-ux-polish/65-04-SUMMARY.md`
</output>
