---
phase: 65-mobile-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/sw.ts
  - next.config.mjs
  - app/providers.tsx
  - tsconfig.json
  - .gitignore
  - public/sw.js
autonomous: true

must_haves:
  truths:
    - "Service worker caches content for offline access using Serwist precache manifest"
    - "Offline fallback page renders when network unavailable"
    - "Push notification handlers work after Serwist migration"
    - "Old sahara-v2 cache is cleaned up on SW activation"
  artifacts:
    - path: "app/sw.ts"
      provides: "Serwist-managed service worker source"
      contains: "Serwist"
    - path: "next.config.mjs"
      provides: "Serwist + Sentry config wrapping"
      contains: "withSerwistInit"
    - path: "app/providers.tsx"
      provides: "Providers without manual SW registration"
  key_links:
    - from: "next.config.mjs"
      to: "app/sw.ts"
      via: "withSerwistInit swSrc config"
      pattern: "swSrc.*app/sw\\.ts"
    - from: "app/sw.ts"
      to: "/offline"
      via: "Serwist fallbacks"
      pattern: "fallbacks.*url.*offline"
---

<objective>
Migrate from the hand-rolled `public/sw.js` service worker to Serwist-managed PWA caching. This replaces the manual cache list with automatic precache manifest injection, adds proper runtime caching strategies, and preserves existing push notification handlers.

Purpose: Serwist provides automatic precache manifest generation from build output, versioned caching strategies, and navigation preload -- none of which the current custom SW supports. This is the foundation for reliable offline access.

Output: `app/sw.ts` (Serwist source), updated `next.config.mjs` with Serwist wrapping, cleaned up `providers.tsx` without manual SW registration, updated `tsconfig.json` and `.gitignore`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/65-mobile-ux-polish/65-RESEARCH.md

Key existing files:
@public/sw.js
@next.config.mjs
@app/providers.tsx
@tsconfig.json
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Serwist and create app/sw.ts</name>
  <files>app/sw.ts, package.json</files>
  <action>
1. Install dependencies:
   ```bash
   npm install @serwist/next@^9.5.4
   npm install -D serwist@^9.5.6
   ```

2. Create `app/sw.ts` with the following:
   - Import `defaultCache` from `@serwist/next/worker`
   - Import `PrecacheEntry`, `SerwistGlobalConfig` from `serwist`
   - Declare global `WorkerGlobalScope` with `__SW_MANIFEST`
   - Declare `self` as `ServiceWorkerGlobalScope & typeof globalThis`
   - Create `Serwist` instance with:
     - `precacheEntries: self.__SW_MANIFEST`
     - `skipWaiting: true`
     - `clientsClaim: true`
     - `navigationPreload: true`
     - `runtimeCaching: defaultCache`
     - `fallbacks` with entry for `/offline` matching `request.destination === "document"`
   - Add old cache cleanup in `activate` event: delete all caches starting with `sahara-` (from the old custom SW)
   - Copy push notification handlers from `public/sw.js` (the `push` and `notificationclick` event listeners) -- place them BEFORE `serwist.addEventListeners()`
   - Call `serwist.addEventListeners()` at the end

3. The push handlers should be identical to the existing ones in `public/sw.js` lines 82-165, using `self.addEventListener("push", ...)` and `self.addEventListener("notificationclick", ...)`.

See the exact code pattern in `.planning/phases/65-mobile-ux-polish/65-RESEARCH.md` Pattern 1.
  </action>
  <verify>
- `app/sw.ts` exists and contains Serwist import, push handlers, and `serwist.addEventListeners()`
- `npm ls @serwist/next` shows installed version
- `npm ls serwist` shows installed version
  </verify>
  <done>app/sw.ts created with Serwist precaching, offline fallback, old cache cleanup, and push notification handlers preserved</done>
</task>

<task type="auto">
  <name>Task 2: Update next.config.mjs, providers.tsx, tsconfig.json, .gitignore</name>
  <files>next.config.mjs, app/providers.tsx, tsconfig.json, .gitignore</files>
  <action>
1. **next.config.mjs**: Wrap with Serwist BEFORE Sentry wrapping:
   - Add `import { spawnSync } from "node:child_process";` at top
   - Add `import withSerwistInit from "@serwist/next";` after Sentry import
   - Create revision: `const revision = spawnSync("git", ["rev-parse", "HEAD"], { encoding: "utf-8" }).stdout?.trim() ?? crypto.randomUUID();`
   - Create `withSerwist = withSerwistInit({ swSrc: "app/sw.ts", swDest: "public/sw.js", additionalPrecacheEntries: [{ url: "/offline", revision }], disable: process.env.NODE_ENV === "development" })`
   - Apply: `const serwistConfig = withSerwist(nextConfig);`
   - Then Sentry wraps `serwistConfig` instead of `nextConfig`: `withSentryConfig(serwistConfig, { ... })`
   - The else branch (no Sentry DSN) should also use `serwistConfig`
   - IMPORTANT: Serwist wraps first (inner), Sentry wraps second (outer). This ensures SW compilation happens before Sentry source map upload.

2. **app/providers.tsx**: Remove the `ServiceWorkerRegistrar` component entirely (both the function and its usage in JSX). Serwist handles SW registration automatically via its Next.js plugin. Keep `InstallPrompt`, `TierProvider`, and `NextThemesProvider` unchanged. Remove the `useEffect` import if no longer used.

3. **tsconfig.json**: Add `"webworker"` to `compilerOptions.lib` array (needed for ServiceWorkerGlobalScope types). Add `"@serwist/next/typings"` to a new `compilerOptions.types` array. Add `"public/sw.js"` to the `exclude` array (Serwist generates this file).

4. **.gitignore**: Add a `# Serwist generated files` section with:
   ```
   public/sw.js
   public/sw.js.map
   public/swe-worker-*.js
   ```

5. Delete `public/sw.js` since it will now be auto-generated by Serwist at build time. Run `git rm public/sw.js` to remove it from tracking.
  </action>
  <verify>
- `npm run build` completes successfully (run with timeout of 5 minutes)
- Build output includes `public/sw.js` generated by Serwist
- `app/providers.tsx` has no ServiceWorkerRegistrar
- `tsconfig.json` includes "webworker" in lib
- `.gitignore` includes public/sw.js
  </verify>
  <done>Serwist fully integrated into build pipeline. next.config.mjs wraps Serwist then Sentry. Manual SW registration removed. TypeScript configured for service worker types. Generated SW files gitignored.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds and generates `public/sw.js` from Serwist
2. Generated `public/sw.js` contains precache manifest (`__SW_MANIFEST`)
3. Generated `public/sw.js` contains push notification handlers
4. `app/providers.tsx` has no reference to `serviceWorker` or `ServiceWorkerRegistrar`
5. TypeScript: `npx tsc --noEmit` does not error on `app/sw.ts`
</verification>

<success_criteria>
- Build generates Serwist-managed service worker at public/sw.js
- Precache manifest automatically includes build assets
- Offline fallback to /offline works for navigation requests
- Push notification handlers preserved from old SW
- Old sahara-v2 cache cleaned up on activation
- No manual SW registration in providers.tsx
</success_criteria>

<output>
After completion, create `.planning/phases/65-mobile-ux-polish/65-01-SUMMARY.md`
</output>
