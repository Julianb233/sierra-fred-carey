---
phase: "68"
plan: "01"
name: "service-marketplace-schema-and-backend"
type: "single"
autonomous: true
---

# Phase 68 Plan 01: Service Marketplace — Schema & Backend

## Objective

Deliver the complete service marketplace backend: DB migration (4 tables + RLS), typed DB helper functions, 5 API routes, and upgrade the FRED provider-finder tool from a stub to a real DB-backed recommender.

## Context

- Pattern reference: `lib/db/content.ts`, `app/api/content/route.ts`
- FRED tool pattern: `lib/fred/tools/content-recommender.ts`
- FRED registry: `lib/fred/tools/index.ts` (already has `findProviderTool` stub)
- RLS pattern: `supabase/migrations/20260225000010_content_library.sql`
- Auth pattern: `createClient()` from `@/lib/supabase/server` for user auth; `createServiceClient()` for admin/service operations

## Tasks

### Task 1: Database Migration

**type:** auto

Create `supabase/migrations/20260225000020_service_marketplace.sql` with 4 tables and RLS policies.

Tables:
- `service_providers` (id, user_id nullable, name, slug unique, tagline, description, category with check, stage_fit text[], logo_url, website, stripe_account_id, is_verified, is_active, rating, review_count, created_at, updated_at)
- `service_listings` (id, provider_id FK cascade, title, description, price_cents, price_type with check, deliverables text[], turnaround_days, is_active, created_at)
- `bookings` (id, user_id FK cascade, provider_id FK, listing_id FK nullable, status with check default pending, message, stripe_payment_intent_id, amount_cents, created_at, updated_at)
- `provider_reviews` (id, user_id FK cascade, provider_id FK cascade, booking_id FK nullable, rating check 1-5, review_text, created_at, UNIQUE(user_id, provider_id))

RLS:
- service_providers: authenticated can SELECT where is_active=true; service_role all
- service_listings: authenticated can SELECT where is_active=true; service_role all
- bookings: authenticated SELECT/INSERT/UPDATE own rows (auth.uid()=user_id); service_role all
- provider_reviews: authenticated SELECT all; authenticated INSERT own; service_role all

**Verification:** File exists, valid SQL syntax (no syntax errors visible).

**Done:** Migration file created at correct path.

---

### Task 2: DB Helper Functions (`lib/db/marketplace.ts`)

**type:** auto

Create typed helper functions following the pattern in `lib/db/content.ts`. Use `createServiceClient()` for all queries (service role bypasses RLS, consistent with content.ts pattern).

Types to define:
```typescript
ServiceProvider, ServiceListing, Booking, ProviderReview
CreateBookingInput { providerId, listingId?, message?, amountCents? }
CreateReviewInput { providerId, bookingId?, rating, reviewText? }
```

Functions:
- `getProviders(filters?)` — list active providers, filter by category/stage/search (ilike on name+tagline+description)
- `getProvider(slug)` — single provider with listings[] and reviews[]
- `createBooking(userId, data)` — insert booking
- `getUserBookings(userId)` — list user's bookings with provider name
- `createReview(userId, data)` — insert review (validates booking exists and is completed if bookingId provided)
- `updateProviderRating(providerId)` — recalculate avg from provider_reviews, update service_providers

**Verification:** File compiles as part of pnpm build.

**Done:** `lib/db/marketplace.ts` exists with all 6 exported functions.

---

### Task 3: API Routes

**type:** auto

Create 5 API routes:

1. `app/api/marketplace/route.ts` — GET with optional `?category=&stage=&search=` params, auth required, calls `getProviders()`

2. `app/api/marketplace/[slug]/route.ts` — GET provider detail, auth required, calls `getProvider(slug)`, returns 404 if null

3. `app/api/marketplace/bookings/route.ts` — GET + POST
   - GET: auth required, calls `getUserBookings(userId)`
   - POST: auth required, validate body (providerId required), call `createBooking()`

4. `app/api/marketplace/reviews/route.ts` — POST
   - POST: auth required, validate body (providerId, rating required), call `createReview()`, then call `updateProviderRating()`

All routes follow the pattern in `app/api/content/route.ts`:
- Use `createClient()` for auth check, return 401 if no user
- Use try/catch, return 500 on error with console.error

**Verification:** All route files exist.

**Done:** All 4 route files created (bookings/route.ts handles both GET and POST).

---

### Task 4: Upgrade FRED Provider-Recommender Tool

**type:** auto

Replace the stub in `lib/fred/tools/provider-finder.ts` with a real implementation that calls `getProviders()` from `lib/db/marketplace.ts`.

The tool should:
- Accept `serviceType` (string), `stage` (optional enum), `budget` (optional enum)
- Map `serviceType` to marketplace category where possible (legal→legal, finance→finance, marketing→marketing, growth→growth, tech→tech, hr→hr)
- Call `getProviders({ category, stage })`
- Return structured results with providers list or graceful "no results" / "coming soon" fallback (same pattern as content-recommender.ts)
- Keep the same tool name export `findProviderTool` so `lib/fred/tools/index.ts` needs NO changes

**Verification:** Tool file updated, index.ts still works (no import changes needed).

**Done:** `lib/fred/tools/provider-finder.ts` queries real DB.

---

### Task 5: Build Verification

**type:** auto

Run `pnpm build` and fix any TypeScript errors until it passes with zero errors.

**Verification:** `pnpm build` exits 0.

**Done:** Build passes.

## Verification

- [ ] Migration file exists at `supabase/migrations/20260225000020_service_marketplace.sql`
- [ ] `lib/db/marketplace.ts` exports all 6 functions
- [ ] All API routes exist (marketplace, marketplace/[slug], marketplace/bookings, marketplace/reviews)
- [ ] `lib/fred/tools/provider-finder.ts` queries real DB
- [ ] `pnpm build` passes with zero TypeScript errors

## Success Criteria

- All 5 tasks committed
- `pnpm build` passes
- Zero TypeScript errors
- No new lint errors introduced

## Output

- `supabase/migrations/20260225000020_service_marketplace.sql`
- `lib/db/marketplace.ts`
- `app/api/marketplace/route.ts`
- `app/api/marketplace/[slug]/route.ts`
- `app/api/marketplace/bookings/route.ts`
- `app/api/marketplace/reviews/route.ts`
- `lib/fred/tools/provider-finder.ts` (upgraded from stub)
