---
phase: 22-pwa-mobile-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app/offline/page.tsx
  - public/sw.js
  - components/pwa/useInstallPrompt.ts
  - components/pwa/InstallPrompt.tsx
  - app/install/page.tsx
  - app/providers.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Offline fallback page with Sahara branding and retry button appears when user has no network connection"
    - "Custom install prompt appears on first visit for installable browsers (Chromium) with dismiss-for-7-days behavior"
    - "iOS users see a link to install instructions instead of a native install button"
    - "Install instructions page shows platform-specific step-by-step guides for iOS Safari and Android Chrome"
    - "Install prompt does not appear when app is already running in standalone/PWA mode"
    - "Page auto-reloads when connectivity is restored on the offline page"
  artifacts:
    - path: "app/offline/page.tsx"
      provides: "Sahara-branded offline fallback page with retry and auto-reconnect"
      min_lines: 40
    - path: "public/sw.js"
      provides: "Updated service worker with offline page pre-caching and navigation fallback"
      contains: "OFFLINE_URL"
    - path: "components/pwa/useInstallPrompt.ts"
      provides: "Hook managing beforeinstallprompt event, iOS detection, standalone mode detection"
      exports: ["useInstallPrompt"]
    - path: "components/pwa/InstallPrompt.tsx"
      provides: "Floating install prompt component with dismiss-for-7-days localStorage logic"
      exports: ["InstallPrompt"]
    - path: "app/install/page.tsx"
      provides: "Install instructions page with iOS Safari and Android Chrome step-by-step guides"
      min_lines: 80
    - path: "app/providers.tsx"
      provides: "Updated providers to include InstallPrompt component"
      contains: "InstallPrompt"
  key_links:
    - from: "public/sw.js"
      to: "/offline"
      via: "caches.match(OFFLINE_URL) in navigate fetch handler"
      pattern: "caches\\.match.*OFFLINE_URL"
    - from: "components/pwa/InstallPrompt.tsx"
      to: "components/pwa/useInstallPrompt.ts"
      via: "import useInstallPrompt hook"
      pattern: "useInstallPrompt"
    - from: "components/pwa/InstallPrompt.tsx"
      to: "/install"
      via: "Link to install instructions for iOS users"
      pattern: "href.*install"
    - from: "app/providers.tsx"
      to: "components/pwa/InstallPrompt.tsx"
      via: "Renders InstallPrompt globally"
      pattern: "InstallPrompt"
---

<objective>
Build the complete PWA install experience: offline fallback page, custom install prompt, and install instructions page.

Purpose: Sahara must be installable as a PWA with guided onboarding. Users on Chromium browsers get a native-feeling install prompt; iOS users get step-by-step instructions. When offline, users see a branded fallback page instead of a browser error.

Output: Three new pages/components (offline page, install prompt, install instructions), updated service worker, updated providers.
</objective>

<execution_context>
@/opt/agency-workspace/sierra-fred-carey/.planning/phases/22-pwa-mobile-polish/22-RESEARCH.md
</execution_context>

<context>
@/opt/agency-workspace/sierra-fred-carey/.planning/PROJECT.md
@/opt/agency-workspace/sierra-fred-carey/.planning/ROADMAP.md
@/opt/agency-workspace/sierra-fred-carey/public/sw.js
@/opt/agency-workspace/sierra-fred-carey/app/manifest.ts
@/opt/agency-workspace/sierra-fred-carey/app/providers.tsx
@/opt/agency-workspace/sierra-fred-carey/app/layout.tsx
@/opt/agency-workspace/sierra-fred-carey/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Offline fallback page and service worker update</name>
  <files>
    app/offline/page.tsx
    public/sw.js
  </files>
  <action>
**1. Create `app/offline/page.tsx`** -- a "use client" page with Sahara branding:
- Full-viewport centered layout (`min-h-dvh flex flex-col items-center justify-center`)
- Sahara logo at top using `<img src="/sahara-logo.svg" alt="Sahara" className="h-10 mx-auto mb-8" />`
- Orange-tinted icon circle (wifi-off style SVG icon, use `#ff6a1a` brand color with `/10` opacity background)
- Heading: "You're Offline"
- Description: "It looks like you've lost your internet connection. We'll automatically reconnect when you're back online."
- "Try Again" `<Button>` using `bg-[#ff6a1a] hover:bg-[#ea580c] text-white` styling with `size="lg"` that calls `window.location.reload()`
- Use `useState` + `useEffect` to listen for `online`/`offline` events on `window`
- Auto-reload when `navigator.onLine` becomes true (via the `online` event listener calling `window.location.reload()`)
- Background: `bg-gray-50 dark:bg-gray-900` to match site styling
- Import Button from `@/components/ui/button`

**2. Update `public/sw.js`**:
- Bump `CACHE_NAME` from `"sahara-v1"` to `"sahara-v2"`
- Add `OFFLINE_URL = "/offline"` constant
- Add `OFFLINE_URL` to the `STATIC_ASSETS` array so it is pre-cached during the install event
- Modify the `navigate` fetch handler (line 67-70): change from `fetch(request).catch(() => caches.match(request))` to `fetch(request).catch(() => caches.match(OFFLINE_URL))` -- this ensures failed navigation requests show the offline page instead of trying to match the specific request URL from cache
- Keep all other SW logic identical (cache-first for static assets, skip API/auth routes, activate cleanup)
  </action>
  <verify>
- `cat app/offline/page.tsx` exists with "use client" directive, Button import, online/offline event listeners, and auto-reload logic
- `grep "sahara-v2" public/sw.js` confirms cache version bumped
- `grep "OFFLINE_URL" public/sw.js` confirms offline URL constant exists
- `grep 'OFFLINE_URL' public/sw.js | wc -l` shows at least 3 occurrences (declaration, STATIC_ASSETS, fetch handler)
- `npm run build` succeeds without errors
  </verify>
  <done>
- Offline page renders at /offline with Sahara logo, "You're Offline" heading, retry button, and auto-reconnect behavior
- Service worker pre-caches /offline and serves it as fallback for all failed navigation requests
- Build passes cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Install prompt hook, component, and instructions page</name>
  <files>
    components/pwa/useInstallPrompt.ts
    components/pwa/InstallPrompt.tsx
    app/install/page.tsx
    app/providers.tsx
  </files>
  <action>
**1. Create `components/pwa/useInstallPrompt.ts`** -- "use client" hook:
- Define `BeforeInstallPromptEvent` interface extending `Event` with `prompt(): Promise<{ outcome: "accepted" | "dismissed" }>`
- Track state: `deferredPrompt` (the saved event or null), `isInstalled` (boolean), `isIOS` (boolean), `isStandalone` (boolean)
- In `useEffect`:
  - Detect standalone: `window.matchMedia("(display-mode: standalone)").matches || (navigator as any).standalone === true`
  - Detect iOS: `/iPad|iPhone|iPod/.test(navigator.userAgent) && !(window as any).MSStream`
  - Listen for `beforeinstallprompt` event: `e.preventDefault()`, save event to state
  - Listen for `appinstalled` event: set `isInstalled = true`, clear `deferredPrompt`
  - Clean up both listeners on unmount
- `promptInstall` callback (via `useCallback`): calls `deferredPrompt.prompt()`, returns `result.outcome`, clears deferredPrompt
- Return: `{ canPrompt, isIOS, isStandalone, isInstalled, promptInstall }`

**2. Create `components/pwa/InstallPrompt.tsx`** -- "use client" floating prompt:
- Import `useInstallPrompt` from `./useInstallPrompt`, `Button` from `@/components/ui/button`, `Cross2Icon` from `@radix-ui/react-icons`, `Link` from `next/link`
- State: `dismissed` (starts `true` to prevent flash), `showPrompt` (starts `false`)
- On mount `useEffect`: check `localStorage.getItem("pwa-install-dismissed")` -- if exists and less than 7 days old (compare `Date.now() - parseInt(stored) < 7 * 24 * 60 * 60 * 1000`), keep dismissed. Otherwise set `dismissed(false)`
- Second `useEffect` with 5-second delay (`setTimeout`): after delay, set `showPrompt(true)`. This prevents the prompt from appearing immediately on page load.
- Render nothing if: `isStandalone || dismissed || !showPrompt || (!canPrompt && !isIOS)`
- Floating card: `fixed bottom-4 left-4 right-4 sm:left-auto sm:right-4 sm:w-80 z-50` with white/dark background, rounded-2xl, shadow-xl, border
- Close button (top-right): sets `dismissed(true)` and stores `Date.now().toString()` in `localStorage` key `"pwa-install-dismissed"`
- Content: Sahara icon (`/icon-192.png` at 48x48, rounded-xl), title "Install Sahara", subtitle "Get the full app experience with offline access"
- Action area:
  - If `canPrompt` (Chromium): orange "Install Now" button calling `promptInstall`
  - If `isIOS`: outline button `<Link href="/install">See How to Install</Link>`

**3. Create `app/install/page.tsx`** -- "use client" install instructions page:
- Auto-detect platform in `useEffect`: set state for `isIOS`, `isAndroid` (`/Android/.test(navigator.userAgent)`), `isDesktop` (neither)
- Layout: centered max-w-2xl container, `py-16 px-4`
- Header: "Install Sahara" h1, subtitle explaining PWA benefits
- Platform tabs or sections (show detected platform first, others collapsed):
  - **iOS Safari section**: 3 numbered steps with descriptive text:
    1. "Tap the Share button" (bottom toolbar share icon) -- describe location of share icon
    2. "Scroll down and tap 'Add to Home Screen'"
    3. "Tap 'Add' to confirm"
  - **Android Chrome section**: 3 numbered steps:
    1. "Tap the menu icon (three dots) in the top-right corner"
    2. "Tap 'Install app' or 'Add to Home Screen'"
    3. "Tap 'Install' to confirm"
  - **Desktop Chrome section** (optional, brief): "Click the install icon in the address bar"
- Each step in a numbered card with Sahara orange accent (`border-l-4 border-[#ff6a1a]`)
- Back link to home at bottom
- Style consistent with Sahara design: gray-50/gray-900 backgrounds, orange accents

**4. Update `app/providers.tsx`**:
- Import `InstallPrompt` from `@/components/pwa/InstallPrompt`
- Add `<InstallPrompt />` inside the Providers component, after `<ServiceWorkerRegistrar />` and before `{children}`
- This ensures the install prompt is available globally across all pages

**Important:** Do NOT add next-pwa or any new dependencies. All PWA functionality uses browser APIs only.
  </action>
  <verify>
- `cat components/pwa/useInstallPrompt.ts` contains beforeinstallprompt handler, iOS detection, standalone detection
- `cat components/pwa/InstallPrompt.tsx` contains localStorage 7-day dismiss logic, 5-second delay, canPrompt/isIOS branching
- `cat app/install/page.tsx` contains iOS Safari and Android Chrome step-by-step instructions
- `grep "InstallPrompt" app/providers.tsx` confirms component is rendered globally
- `npm run build` succeeds without errors
  </verify>
  <done>
- useInstallPrompt hook detects installability on Chromium (beforeinstallprompt), iOS (UA detection), and standalone mode
- InstallPrompt component appears after 5-second delay on first visit, dismisses for 7 days, shows platform-appropriate action
- Install instructions page at /install has step-by-step guides for iOS Safari and Android Chrome
- InstallPrompt is rendered globally via providers.tsx
- Build passes cleanly
  </done>
</task>

</tasks>

<verification>
1. `npm run build` -- zero errors, all new pages compile
2. Verify `/offline` route exists in build output
3. Verify `/install` route exists in build output
4. `grep -r "OFFLINE_URL" public/sw.js` -- confirms SW references offline page
5. `grep -r "InstallPrompt" app/providers.tsx` -- confirms global rendering
6. `grep "sahara-v2" public/sw.js` -- confirms cache version bump
</verification>

<success_criteria>
- Offline fallback page with Sahara branding renders at /offline with retry button and auto-reconnect
- Service worker pre-caches offline page and serves it for failed navigation requests
- Install prompt hook detects Chromium installability, iOS, and standalone mode
- Floating install prompt appears after 5s delay on first visit, dismisses for 7 days via localStorage
- iOS users see "See How to Install" link; Chromium users see "Install Now" button
- Install instructions page at /install provides step-by-step guides for iOS Safari and Android Chrome
- InstallPrompt renders globally via providers.tsx
- No new npm dependencies added
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/22-pwa-mobile-polish/22-01-SUMMARY.md`
</output>
