---
phase: 67-content-library-frontend
plan: 02
type: execute
wave: 2
depends_on: [67-01]
files_modified:
  - package.json
  - package-lock.json
  - app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx
autonomous: true

must_haves:
  truths:
    - "@mux/mux-player-react is installed as a project dependency"
    - "Video player page exists at app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"
    - "Signed playback token is fetched from /api/content/[courseId]/lessons/[lessonId]/playback-token"
    - "Progress is auto-saved at 25/50/75/100% marks via POST /api/content/progress"
    - "Upgrade prompt shown for tier-gated lessons returning 403 from playback-token endpoint"
    - "Lesson sidebar shows lesson list for navigation"
  artifacts:
    - path: "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"
      provides: "Mux video player with signed token, progress tracking, tier gate, lesson sidebar"
      contains: "MuxPlayer\|mux-player-react"
    - path: "package.json"
      provides: "@mux/mux-player-react dependency"
      contains: "@mux/mux-player-react"
---

<objective>
Install @mux/mux-player-react and build the video player page with signed token fetching, progress auto-save at percentage milestones, and a tier-gate upgrade prompt.

Purpose: This is the core video consumption experience. Signed tokens protect content. Progress tracking lets founders resume where they left off.
Output: Video player page that loads signed Mux token, auto-saves progress, and gracefully handles tier gates.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@lib/db/content.ts
@app/api/content/[courseId]/lessons/[lessonId]/playback-token/route.ts
@app/api/content/progress/route.ts
@app/dashboard/content/[courseId]/page.tsx
</context>

<tasks>

<task id="1" type="auto">
  <name>Install @mux/mux-player-react</name>
  <action>
Install the Mux player React package using npm (use npm install, not pnpm, per Phase 66 workspace constraints):

```bash
npm install @mux/mux-player-react
```

This installs the official Mux Player web component wrapper for React. The package provides `<MuxPlayer>` component that handles HLS video playback with the Mux infrastructure.

Verify installation succeeded by checking package.json.
  </action>
  <verify>
Run: `grep "@mux/mux-player-react" package.json`
Expected: shows the package with a version number.
  </verify>
  <done>@mux/mux-player-react appears in package.json dependencies.</done>
</task>

<task id="2" type="auto">
  <name>Create Video Player page</name>
  <action>
Create `app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx`.

This is a "use client" page.

Type definitions:
```tsx
interface PlaybackTokenResponse {
  token: string;
  playbackId: string;
}

interface LessonNav {
  id: string;
  title: string;
  sort_order: number;
  mux_status: "pending" | "processing" | "ready" | "error";
  is_preview: boolean;
  duration_seconds: number | null;
}

interface ModuleNav {
  id: string;
  title: string;
  lessons: LessonNav[];
}
```

Get route params via `useParams()`:
```tsx
const { courseId, lessonId } = useParams() as { courseId: string; lessonId: string };
```

State:
```tsx
const [tokenData, setTokenData] = useState<PlaybackTokenResponse | null>(null);
const [tokenError, setTokenError] = useState<string | null>(null);
const [upgradeRequired, setUpgradeRequired] = useState(false);
const [loading, setLoading] = useState(true);
const [course, setCourse] = useState<{ title: string; modules: ModuleNav[] } | null>(null);
const [currentLesson, setCurrentLesson] = useState<LessonNav | null>(null);
const reportedMilestones = useRef<Set<number>>(new Set());
```

On mount (useEffect, deps: [courseId, lessonId]):
1. Fetch course for sidebar: `GET /api/content/${courseId}` → set course + find currentLesson
2. Fetch playback token: `GET /api/content/${courseId}/lessons/${lessonId}/playback-token`
   - On 200: setTokenData
   - On 403: setUpgradeRequired(true)
   - On other error: setTokenError(error message)
3. setLoading(false)

Run both fetches in parallel with Promise.all.

Progress tracking callback:
```tsx
function handleTimeUpdate(event: Event) {
  const video = event.target as HTMLVideoElement;
  if (!video.duration || video.duration === 0) return;
  const pct = Math.floor((video.currentTime / video.duration) * 100);
  const milestones = [25, 50, 75, 100];
  for (const m of milestones) {
    if (pct >= m && !reportedMilestones.current.has(m)) {
      reportedMilestones.current.add(m);
      fetch("/api/content/progress", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          lessonId,
          watchedPct: m,
          completed: m === 100,
        }),
      }).catch(() => {}); // fire and forget, don't block UI
    }
  }
}
```

MuxPlayer usage:
```tsx
import MuxPlayer from "@mux/mux-player-react";

<MuxPlayer
  playbackId={tokenData.playbackId}
  tokens={{ playback: tokenData.token }}
  className="w-full rounded-lg aspect-video"
  onTimeUpdate={handleTimeUpdate}
/>
```

Page layout (two-column on desktop, single column on mobile):
```
[  Video Player (flex-1)  ] [  Lesson Sidebar (w-72)  ]
```

Left column:
- Back link: "← Course Name" linking back to /dashboard/content/[courseId]
- Current lesson title (text-xl font-semibold)
- MuxPlayer (when tokenData available)
- Upgrade prompt (when upgradeRequired):
  - Card with Lock icon, "Upgrade Required" heading
  - "This lesson requires a [Pro/Studio] subscription."
  - Button "Upgrade Now" linking to /pricing

Right sidebar:
- "Course Lessons" heading
- For each module: module title (text-sm font-medium text-muted-foreground uppercase tracking-wide), then lesson list
- Each lesson item: link to /dashboard/content/[courseId]/lessons/[lesson.id]
  - Highlight current lesson (bg-orange-500/10 border-l-2 border-orange-500)
  - Show Play icon (if ready), Clock icon (if processing), Lock icon (if not ready)
  - Lesson title (truncate)
  - Duration formatted

Loading state: Skeleton blocks for video area and sidebar.
Error state (tokenError): Alert with error message and back link.

Imports:
- useState, useEffect, useRef from react
- useParams from next/navigation
- Link from next/link
- MuxPlayer from @mux/mux-player-react (default import)
- Card, CardContent, CardHeader, CardTitle from @/components/ui/card
- Skeleton from @/components/ui/skeleton
- Button from @/components/ui/button
- Badge from @/components/ui/badge
- Play, Clock, Lock, ChevronLeft from lucide-react
- cn from @/lib/utils

IMPORTANT: MuxPlayer uses `onTimeUpdate` but the event type from the web component is `Event` not `React.SyntheticEvent`. To avoid TypeScript errors, cast: `onTimeUpdate={(e) => handleTimeUpdate(e as unknown as Event)}` and inside the handler: `const player = (e as unknown as { target: HTMLVideoElement }).target`.

Actually a cleaner approach: use a ref on the mux player element and add event listener manually:
```tsx
const playerRef = useRef<HTMLVideoElement | null>(null);
// After token loads, attach timeupdate listener to the shadow DOM video
// This is complex — simpler: use onTimeUpdate prop directly
```

For simplicity and type safety, use the onTimeUpdate prop:
```tsx
const handleTimeUpdate = useCallback((e: Event) => {
  const target = e.currentTarget as HTMLVideoElement;
  // ...
}, [lessonId]);
```

Actually the cleanest approach for TypeScript: use a wrapper div with a ref and addEventListener in useEffect. But that's complex with Mux's web component.

Simplest correct approach: define the handler separately and cast types:
```tsx
function saveProgress(watchedPct: number) {
  if (reportedMilestones.current.has(watchedPct)) return;
  reportedMilestones.current.add(watchedPct);
  fetch("/api/content/progress", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ lessonId, watchedPct, completed: watchedPct === 100 }),
  }).catch(() => {});
}

// Pass to MuxPlayer as:
<MuxPlayer
  playbackId={tokenData.playbackId}
  tokens={{ playback: tokenData.token }}
  className="w-full aspect-video rounded-lg"
  onTimeUpdate={(e: React.SyntheticEvent<HTMLVideoElement>) => {
    const video = e.currentTarget;
    if (!video.duration) return;
    const pct = Math.floor((video.currentTime / video.duration) * 100);
    [25, 50, 75, 100].forEach(m => { if (pct >= m) saveProgress(m); });
  }}
/>
```

If MuxPlayer's onTimeUpdate prop type doesn't accept React.SyntheticEvent, use:
```tsx
// eslint-disable-next-line @typescript-eslint/no-explicit-any
onTimeUpdate={(e: any) => { ... }}
```

The MuxPlayer component from @mux/mux-player-react may extend HTMLVideoElement events — check after install. If TypeScript complains about onTimeUpdate type, use `// @ts-expect-error` with a comment explaining why.
  </action>
  <verify>
Run: `ls "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"`
Expected: file exists.
Run: `grep -c "MuxPlayer\|mux-player-react" "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"`
Expected: >= 2 (import and usage).
  </verify>
  <done>Video player page exists with MuxPlayer import, signed token fetching, progress saving, upgrade prompt, and lesson sidebar.</done>
</task>

</tasks>

<verification>
1. `grep "@mux/mux-player-react" package.json` — package installed
2. `ls "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"` — file exists
3. `grep "playback-token\|/api/content/progress" "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"` — both API calls present
4. `grep "upgradeRequired\|Upgrade\|403" "app/dashboard/content/[courseId]/lessons/[lessonId]/page.tsx"` — tier gate handled
5. `npx tsc --noEmit 2>&1 | grep "lessons" | head -10` — no TypeScript errors in lesson page
</verification>

<success_criteria>
- @mux/mux-player-react installed in package.json
- Video player page at /dashboard/content/[courseId]/lessons/[lessonId]
- Signed token fetched and passed to MuxPlayer
- Progress auto-saved at 25/50/75/100% (fire-and-forget, non-blocking)
- 403 response shows upgrade prompt with link to /pricing
- Lesson sidebar shows all lessons with current highlighted
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/67-content-library-frontend/67-02-SUMMARY.md` documenting what was built, decisions made, and any deviations.
</output>
