---
phase: 09-stripe-checkout-fix
plan: 01
type: execute
wave: 1
depends_on: []
autonomous: true
gap_closure: true
files_modified:
  - app/api/stripe/checkout/route.ts

must_haves:
  truths:
    - "redirectToCheckoutByTier('pro') resolves to FUNDRAISING plan priceId"
    - "redirectToCheckoutByTier('studio') resolves to VENTURE_STUDIO plan priceId"
    - "Existing direct priceId flow still works"
  artifacts:
    - path: "app/api/stripe/checkout/route.ts"
      provides: "Checkout route with tier-name-to-plan-key mapping"
  key_links:
    - from: "app/dashboard/page.tsx"
      to: "app/api/stripe/checkout/route.ts"
      via: "redirectToCheckoutByTier('pro')"
      pattern: "TIER_TO_PLAN_KEY"
---

# Plan 09-01: Fix Stripe Checkout Tier Mapping

**Goal:** Fix the dashboard CTA "Upgrade Now" button which sends `tier: "pro"` but the checkout route only recognizes PLANS keys (FREE, FUNDRAISING, VENTURE_STUDIO).

## Tasks

### Task 1: Add tier-name-to-plan-key mapping in checkout route

**What:** The checkout route at `app/api/stripe/checkout/route.ts` lines 34-39 does `tier.toUpperCase()` and checks if the result is in `PLANS`. But `PLANS` keys are `FREE`, `FUNDRAISING`, `VENTURE_STUDIO` — not `PRO` or `STUDIO`. Add a mapping from user-facing tier names to PLANS keys.

**Changes:**
1. In `app/api/stripe/checkout/route.ts`, add a mapping constant before the tier resolution logic:
   ```typescript
   const TIER_TO_PLAN_KEY: Record<string, string> = {
     PRO: "FUNDRAISING",
     STUDIO: "VENTURE_STUDIO",
     // Direct keys also work
     FREE: "FREE",
     FUNDRAISING: "FUNDRAISING",
     VENTURE_STUDIO: "VENTURE_STUDIO",
   };
   ```
2. Replace the tier resolution block (lines 34-38) with:
   ```typescript
   if (!resolvedPriceId && tier) {
     const tierKey = TIER_TO_PLAN_KEY[tier.toUpperCase()];
     if (tierKey && tierKey in PLANS) {
       resolvedPriceId = PLANS[tierKey as keyof typeof PLANS].priceId;
     }
   }
   ```

**Verification:**
- `redirectToCheckoutByTier("pro")` → sends `{ tier: "pro" }` → route maps `"PRO"` → `"FUNDRAISING"` → gets priceId
- `redirectToCheckoutByTier("studio")` → maps `"STUDIO"` → `"VENTURE_STUDIO"` → gets priceId
- Direct `{ tier: "fundraising" }` still works (maps `"FUNDRAISING"` → `"FUNDRAISING"`)
- Direct `{ priceId: "price_xxx" }` still works (bypasses mapping entirely)

## Commit Message

```
fix: add tier-name mapping to Stripe checkout route

Dashboard CTA sends tier="pro" but PLANS keys are
FREE/FUNDRAISING/VENTURE_STUDIO. Add TIER_TO_PLAN_KEY
mapping so "pro" -> FUNDRAISING and "studio" -> VENTURE_STUDIO.

Closes: P1 Stripe checkout tier mapping bug from v1.0 audit
```
