---
phase: 20-investor-targeting
plan: 02
type: execute
wave: 2
depends_on:
  - 20-investor-targeting/20-01
files_modified:
  - lib/db/migrations/039_investor_pipeline.sql
  - app/api/investors/generate-outreach/route.ts
  - app/api/investors/pipeline/route.ts
  - app/dashboard/investor-targeting/outreach/page.tsx
  - app/dashboard/investor-targeting/pipeline/page.tsx
autonomous: true

must_haves:
  truths:
    - "Migration 039 creates investor_outreach_sequences and investor_pipeline tables"
    - "Outreach API generates personalized email sequences using AI with Fred's fundraising voice"
    - "Pipeline API supports CRUD for tracking investor conversations through stages"
    - "Outreach page displays generated email sequences with copy-to-clipboard and timing recommendations"
    - "Pipeline page provides a Kanban-style board tracking investors through contacted/meeting/passed/committed stages"
  artifacts:
    - path: "lib/db/migrations/039_investor_pipeline.sql"
      provides: "Outreach sequences and pipeline tracking tables"
    - path: "app/api/investors/generate-outreach/route.ts"
      provides: "POST endpoint generating AI-personalized outreach sequences"
    - path: "app/api/investors/pipeline/route.ts"
      provides: "GET/POST/PATCH endpoints for pipeline stage management"
    - path: "app/dashboard/investor-targeting/outreach/page.tsx"
      provides: "Outreach sequence display page with copy and timing"
    - path: "app/dashboard/investor-targeting/pipeline/page.tsx"
      provides: "Kanban pipeline board for investor tracking"
  key_links:
    - from: "app/api/investors/generate-outreach/route.ts"
      to: "lib/fred-brain.ts"
      via: "uses Fred's voice for outreach generation"
      pattern: "fred-brain"
    - from: "app/dashboard/investor-targeting/outreach/page.tsx"
      to: "app/api/investors/generate-outreach/route.ts"
      via: "requests outreach generation and displays results"
      pattern: "/api/investors/generate-outreach"
    - from: "app/dashboard/investor-targeting/pipeline/page.tsx"
      to: "app/api/investors/pipeline/route.ts"
      via: "manages pipeline stages via API"
      pattern: "/api/investors/pipeline"
---

<objective>
Build outreach sequence generation and a pipeline tracking board so founders can execute investor outreach and track conversations through stages.

Purpose: After identifying target investors (Plan 20-01), founders need tools to reach out and track progress. This plan adds AI-generated personalized outreach sequences (initial email, follow-ups, thank-you) and a CRM-lite Kanban board tracking each investor through stages from first contact to commitment. Fred's fundraising experience shapes the outreach tone and follow-up timing.

Output: 1 new migration, 2 new API routes, 2 new pages. No new npm dependencies.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-investor-targeting/20-01-PLAN.md

Key source files (READ ALL BEFORE MODIFYING):
@lib/fred-brain.ts (Fred's fundraising experience and communication style)
@lib/agents/fundraising/tools.ts (existing outreach draft tool for reference)
@lib/db/migrations/038_investor_tables.sql (investor tables from Plan 20-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database and outreach API</name>
  <files>
    lib/db/migrations/039_investor_pipeline.sql
    app/api/investors/generate-outreach/route.ts
  </files>
  <action>
**Step 1: Create migration `lib/db/migrations/039_investor_pipeline.sql`**

```sql
-- Outreach sequences
CREATE TABLE investor_outreach_sequences (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users NOT NULL,
  investor_id uuid REFERENCES investors ON DELETE CASCADE NOT NULL,
  sequence_type text NOT NULL DEFAULT 'cold', -- 'cold', 'warm_intro', 'follow_up'
  emails jsonb NOT NULL DEFAULT '[]', -- array of { subject, body, send_day, status }
  timing_notes text, -- Fred's advice on when to send
  generated_at timestamptz DEFAULT now(),
  UNIQUE(user_id, investor_id, sequence_type)
);

-- Pipeline tracking
CREATE TABLE investor_pipeline (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES auth.users NOT NULL,
  investor_id uuid REFERENCES investors ON DELETE CASCADE NOT NULL,
  match_id uuid REFERENCES investor_matches,
  stage text NOT NULL DEFAULT 'identified', -- 'identified', 'contacted', 'meeting', 'due_diligence', 'term_sheet', 'committed', 'passed'
  notes text,
  next_action text,
  next_action_date timestamptz,
  last_contact_at timestamptz,
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now(),
  UNIQUE(user_id, investor_id)
);
```

Add RLS policies for user-scoped access. Add index on investor_pipeline(user_id, stage).

**Step 2: Create `app/api/investors/generate-outreach/route.ts`**

POST endpoint:
1. Authenticate user (Studio tier)
2. Accept body: `{ investorId: string; sequenceType: 'cold' | 'warm_intro' | 'follow_up' }`
3. Load investor data and user profile from database
4. Use AI (generateText from Vercel AI SDK) with Fred's fundraising voice:
   - System prompt: Fred Cary's investor outreach philosophy (concise, confident, no desperation, demonstrate founder-market fit early)
   - User prompt: founder profile + investor details + sequence type
   - Request structured output: array of 3-4 emails with subject, body, send_day (day offset from first email), and timing notes
5. Cold sequence: initial outreach (day 0), follow-up 1 (day 3), follow-up 2 (day 7), break-up email (day 14)
6. Warm intro: intro request to connector (day 0), thank-you to connector (day 1), direct follow-up (day 3)
7. Follow-up: post-meeting thank-you (day 0), additional materials (day 2), next steps (day 5)
8. Persist generated sequence to investor_outreach_sequences
9. Return the sequence with timing notes
  </action>
  <verify>
1. `test -f lib/db/migrations/039_investor_pipeline.sql` -- migration exists
2. `grep 'investor_outreach_sequences\|investor_pipeline' lib/db/migrations/039_investor_pipeline.sql` -- both tables
3. `test -f app/api/investors/generate-outreach/route.ts` -- API exists
4. `grep 'generateText\|fred-brain' app/api/investors/generate-outreach/route.ts` -- AI generation with Fred's voice
5. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
Migration 039 creates outreach_sequences and pipeline tables. Outreach API generates 3-4 email sequences (cold/warm/follow-up) using AI with Fred's fundraising voice and timing recommendations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Pipeline API and UI pages</name>
  <files>
    app/api/investors/pipeline/route.ts
    app/dashboard/investor-targeting/outreach/page.tsx
    app/dashboard/investor-targeting/pipeline/page.tsx
  </files>
  <action>
**Step 1: Create `app/api/investors/pipeline/route.ts`**

- GET: Authenticate user. Return all pipeline entries grouped by stage. Join with investors table for investor name/firm. Accept optional `stage` query param for filtering.
- POST: Authenticate user. Accept `{ investorId, stage?, notes?, nextAction?, nextActionDate? }`. Create pipeline entry. Return 201.
- PATCH: Authenticate user. Accept `{ id, stage?, notes?, nextAction?, nextActionDate?, lastContactAt? }`. Update pipeline entry, set updated_at. Return updated entry.

**Step 2: Create `app/dashboard/investor-targeting/outreach/page.tsx`**

"use client" page at /dashboard/investor-targeting/outreach:
- Accept investorId from URL search params
- If investorId provided, show outreach for that investor
- Otherwise, show list of investors with generated outreach sequences
- **Sequence display**:
  - Card for each email in the sequence:
    - Day indicator (e.g., "Day 0", "Day 3")
    - Subject line (bold)
    - Email body (formatted text)
    - "Copy to Clipboard" button for each email
    - Send status indicator (draft/sent/skipped)
  - Timing notes card with Fred's advice on when to send
- **Generate section**:
  - Select investor from dropdown
  - Select sequence type (Cold Outreach, Warm Intro, Follow-up)
  - "Generate Sequence" button with loading state
- Studio tier gated with FeatureLock

**Step 3: Create `app/dashboard/investor-targeting/pipeline/page.tsx`**

"use client" page at /dashboard/investor-targeting/pipeline:
- Kanban-style board with columns for each stage:
  - Identified | Contacted | Meeting | Due Diligence | Term Sheet | Committed | Passed
- Each card shows:
  - Investor name and firm
  - Match score badge (from investor_matches)
  - Last contact date
  - Next action and due date
  - Notes preview
- Drag-and-drop between columns (use HTML5 drag-and-drop or simple click-to-move dropdown):
  - On stage change, PATCH /api/investors/pipeline
  - Update last_contact_at when moving to "Contacted" or later stages
- "Add Investor" button to manually add to pipeline (search from uploaded investors)
- Summary stats at top: total in pipeline, by stage counts
- Responsive: columns stack vertically on mobile with stage headers
- Loading skeleton and empty state
- Studio tier gated with FeatureLock
  </action>
  <verify>
1. `test -f app/api/investors/pipeline/route.ts` -- pipeline API exists
2. `test -f app/dashboard/investor-targeting/outreach/page.tsx` -- outreach page exists
3. `test -f app/dashboard/investor-targeting/pipeline/page.tsx` -- pipeline page exists
4. `grep 'Kanban\|stage\|pipeline' app/dashboard/investor-targeting/pipeline/page.tsx` -- Kanban elements present
5. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
Pipeline API supports GET/POST/PATCH for stage management. Outreach page displays generated email sequences with copy-to-clipboard and timing notes. Pipeline page provides Kanban board tracking investors through 7 stages.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Migration:**
   ```bash
   test -f lib/db/migrations/039_investor_pipeline.sql && echo "EXISTS"
   grep -c 'CREATE TABLE' lib/db/migrations/039_investor_pipeline.sql
   # Should be 2
   ```

2. **API routes:**
   ```bash
   test -f app/api/investors/generate-outreach/route.ts && test -f app/api/investors/pipeline/route.ts && echo "EXISTS"
   ```

3. **UI pages:**
   ```bash
   test -f app/dashboard/investor-targeting/outreach/page.tsx && test -f app/dashboard/investor-targeting/pipeline/page.tsx && echo "EXISTS"
   ```

4. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
- Migration creates outreach_sequences and pipeline tables with RLS
- Outreach API generates 3-4 email sequences per investor with AI using Fred's fundraising voice
- Three sequence types supported: cold outreach, warm intro, follow-up
- Pipeline API supports full CRUD for tracking investors through 7 stages
- Outreach page displays emails with copy-to-clipboard, timing notes, and generation controls
- Pipeline page provides Kanban board with drag/click stage transitions
- Both pages gated to Studio tier with FeatureLock
- No new npm dependencies
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/20-investor-targeting/20-02-SUMMARY.md`
</output>
