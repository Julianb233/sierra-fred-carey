---
phase: 05-auth-onboarding-fix
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - middleware.ts
  - lib/db/migrations/032_profiles_table_trigger.sql
  - app/onboarding/page.tsx
autonomous: false

must_haves:
  truths:
    - "Supabase auth.signUp() no longer returns 500 Database error"
    - "Auth sessions are refreshed on every navigation (no silent expiry)"
    - "/onboarding redirects unauthenticated users to /get-started"
  artifacts:
    - path: "middleware.ts"
      provides: "Root Next.js middleware for Supabase session refresh + route protection"
      contains: "updateSession"
    - path: "lib/db/migrations/032_profiles_table_trigger.sql"
      provides: "SQL to create profiles table and auth trigger in Supabase"
      contains: "handle_new_user"
  key_links:
    - from: "middleware.ts"
      to: "lib/supabase/middleware.ts"
      via: "import updateSession"
      pattern: "import.*updateSession.*from.*@/lib/supabase/middleware"
---

<objective>
Fix Supabase auth infrastructure: create the missing profiles table + trigger (root cause of 500 error), add root middleware for session refresh, and redirect /onboarding for unauthenticated users.

Purpose: Unblock ALL user creation. Without the profiles table/trigger fix, signUp() always 500s. Without middleware, sessions silently expire. These are prerequisites for the signup flow fix in Plan 02.

Output: SQL migration file, root middleware.ts, fixed /onboarding redirect.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-auth-onboarding-fix/05-RESEARCH.md
@lib/supabase/middleware.ts
@lib/supabase/server.ts
@lib/supabase/client.ts
@lib/supabase/auth-helpers.ts
@app/onboarding/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create root middleware.ts and profiles migration SQL</name>
  <files>middleware.ts, lib/db/migrations/032_profiles_table_trigger.sql</files>
  <action>
    1. Create `middleware.ts` at the project root (NOT inside src/, NOT inside lib/):

    ```typescript
    import { type NextRequest } from "next/server";
    import { updateSession } from "@/lib/supabase/middleware";

    export async function middleware(request: NextRequest) {
      const { response, user } = await updateSession(request);

      // Protect dashboard and chat routes - redirect to login if not authenticated
      const protectedPaths = ["/dashboard", "/chat"];
      const isProtectedPath = protectedPaths.some(path =>
        request.nextUrl.pathname.startsWith(path)
      );

      if (isProtectedPath && !user) {
        const loginUrl = new URL("/login", request.url);
        loginUrl.searchParams.set("redirect", request.nextUrl.pathname);
        return Response.redirect(loginUrl);
      }

      return response;
    }

    export const config = {
      matcher: [
        "/((?!_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)",
      ],
    };
    ```

    The existing `lib/supabase/middleware.ts` already has the correct `updateSession` function that returns `{ response, user }`. The root middleware just needs to invoke it and add route protection.

    2. Create `lib/db/migrations/032_profiles_table_trigger.sql` with the complete SQL to fix the Supabase database:

    ```sql
    -- Migration 032: Fix profiles table and auth trigger
    -- This MUST be run in the Supabase SQL Editor (Dashboard > SQL Editor)
    -- It fixes the 500 "Database error saving new user" on auth.signUp()
    --
    -- Root cause: A trigger on auth.users references public.profiles,
    -- but the table either doesn't exist or has mismatched columns.

    -- Step 1: Drop any existing broken trigger and function
    DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
    DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE;

    -- Step 2: Create the profiles table (IF NOT EXISTS is safe to run multiple times)
    CREATE TABLE IF NOT EXISTS public.profiles (
      id UUID NOT NULL REFERENCES auth.users ON DELETE CASCADE,
      email TEXT,
      name TEXT,
      stage TEXT,
      challenges JSONB DEFAULT '[]',
      teammate_emails JSONB DEFAULT '[]',
      tier INTEGER DEFAULT 0,
      onboarding_completed BOOLEAN DEFAULT false,
      created_at TIMESTAMPTZ DEFAULT NOW(),
      updated_at TIMESTAMPTZ DEFAULT NOW(),
      PRIMARY KEY (id)
    );

    -- Step 3: Enable RLS
    ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;

    -- Step 4: Drop existing policies (safe to re-run)
    DROP POLICY IF EXISTS "Users can view own profile" ON public.profiles;
    DROP POLICY IF EXISTS "Users can update own profile" ON public.profiles;
    DROP POLICY IF EXISTS "Users can insert own profile" ON public.profiles;
    DROP POLICY IF EXISTS "Service role full access" ON public.profiles;

    -- Step 5: Create RLS policies
    CREATE POLICY "Users can view own profile" ON public.profiles
      FOR SELECT USING (auth.uid() = id);

    CREATE POLICY "Users can update own profile" ON public.profiles
      FOR UPDATE USING (auth.uid() = id);

    CREATE POLICY "Users can insert own profile" ON public.profiles
      FOR INSERT WITH CHECK (auth.uid() = id);

    CREATE POLICY "Service role full access" ON public.profiles
      FOR ALL USING (auth.role() = 'service_role');

    -- Step 6: Create trigger function
    CREATE OR REPLACE FUNCTION public.handle_new_user()
    RETURNS TRIGGER
    LANGUAGE plpgsql
    SECURITY DEFINER SET search_path = ''
    AS $$
    BEGIN
      INSERT INTO public.profiles (id, email, name)
      VALUES (
        NEW.id,
        NEW.email,
        COALESCE(NEW.raw_user_meta_data ->> 'name', '')
      );
      RETURN NEW;
    END;
    $$;

    -- Step 7: Create trigger
    CREATE TRIGGER on_auth_user_created
      AFTER INSERT ON auth.users
      FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
    ```

    3. Update `app/onboarding/page.tsx` to redirect unauthenticated users to `/get-started`. Add a Supabase auth check at the top of the component. If no user is authenticated, redirect to `/get-started` instead of showing the localStorage-only wizard. Import `createClient` from `@/lib/supabase/client` and `useRouter` from `next/navigation`. In a useEffect, call `supabase.auth.getUser()` and if no user, `router.replace("/get-started")`. Only render the wizard content if user is authenticated.
  </action>
  <verify>
    - `ls middleware.ts` confirms the file exists at project root
    - `ls lib/db/migrations/032_profiles_table_trigger.sql` confirms migration exists
    - `npx next build 2>&1 | head -30` compiles without errors (middleware imports resolve)
    - The /onboarding page component includes a supabase auth check
  </verify>
  <done>
    - Root middleware.ts exists and imports updateSession from lib/supabase/middleware
    - middleware.ts protects /dashboard and /chat routes (redirects to /login if unauthenticated)
    - middleware.ts matcher excludes static assets
    - Migration SQL file exists with DROP TRIGGER, CREATE TABLE, RLS policies, and CREATE TRIGGER
    - /onboarding page redirects unauthenticated users to /get-started
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Run profiles migration SQL in Supabase Dashboard</name>
  <what-to-do>
    The 500 error on user creation is caused by a broken database trigger in Supabase. Claude has created the fix SQL at `lib/db/migrations/032_profiles_table_trigger.sql`.

    **You must run this SQL in the Supabase Dashboard:**

    1. Open your Supabase project dashboard
    2. Go to **SQL Editor** (left sidebar)
    3. Click **New query**
    4. Copy the ENTIRE contents of `lib/db/migrations/032_profiles_table_trigger.sql` and paste it
    5. Click **Run** (or Cmd+Enter)
    6. Verify it says "Success" with no errors

    **Also check email confirmation setting:**

    7. Go to **Authentication** > **Providers** > **Email**
    8. If "Confirm email" is enabled, **disable it** for now (MVP -- re-enable when email infra is ready)
    9. This ensures `signUp()` returns a session immediately instead of requiring email confirmation

    **Verify the fix worked:**

    10. Go to **Table Editor** > verify `profiles` table exists with columns: id, email, name, stage, challenges, teammate_emails, tier, onboarding_completed, created_at, updated_at
    11. Go to **Database** > **Triggers** > filter by `auth` schema > verify `on_auth_user_created` trigger exists
  </what-to-do>
  <resume-signal>Type "done" when the SQL has been run successfully and email confirmation is disabled, or describe any errors you encountered.</resume-signal>
</task>

</tasks>

<verification>
After both tasks complete:
1. The root middleware.ts exists and compiles (verified via `npx next build`)
2. The Supabase profiles table exists with correct schema
3. The on_auth_user_created trigger is active
4. Email confirmation is disabled (signUp returns session immediately)
5. /onboarding redirects unauthenticated users to /get-started
</verification>

<success_criteria>
- middleware.ts at project root calls updateSession() on every non-static request
- Protected routes (/dashboard, /chat) redirect to /login when unauthenticated
- Supabase profiles table exists with RLS policies
- Auth trigger creates profile row on user signup
- Email confirmation disabled for MVP
- /onboarding requires auth
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-onboarding-fix/05-01-SUMMARY.md`
</output>
