---
phase: 05-auth-onboarding-fix
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - app/get-started/page.tsx
  - app/api/onboard/route.ts
  - app/dashboard/layout.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can sign up with a real password they choose"
    - "User can log back in with the password they chose during signup"
    - "Dashboard sidebar shows the actual authenticated user's name, email, and tier"
    - "Signup form validates password (min 6 chars) before submission"
  artifacts:
    - path: "app/get-started/page.tsx"
      provides: "Signup flow with password collection"
      contains: "password"
    - path: "app/api/onboard/route.ts"
      provides: "Onboard API requiring password for new users"
      contains: "Password must be at least 6 characters"
    - path: "app/dashboard/layout.tsx"
      provides: "Dashboard layout using real auth user data"
      contains: "supabase.auth.getUser"
  key_links:
    - from: "app/get-started/page.tsx"
      to: "/api/onboard"
      via: "fetch POST with password field"
      pattern: "password.*:.*password"
    - from: "app/api/onboard/route.ts"
      to: "supabase.auth.signUp"
      via: "password parameter (no more crypto.randomUUID fallback)"
      pattern: "const userPassword = password"
    - from: "app/dashboard/layout.tsx"
      to: "supabase.auth.getUser"
      via: "useEffect fetching real user data"
      pattern: "supabase\\.auth\\.getUser"
---

<objective>
Fix the signup flow to collect a real password and wire the dashboard layout to real auth data. This closes the ONBOARD-AUTH gap (random password nobody knows) and the broken E2E flow (signup -> dashboard shows real user).

Purpose: After Plan 01 fixes the database and middleware, this plan makes the user-facing flows work end-to-end. Users sign up with a password they choose, land on the dashboard, and can log back in later.

Output: Working signup-to-dashboard flow with persistent auth.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-auth-onboarding-fix/05-RESEARCH.md
@app/get-started/page.tsx
@app/api/onboard/route.ts
@app/dashboard/layout.tsx
@lib/supabase/auth-helpers.ts
@lib/supabase/client.ts
@app/login/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add password field to /get-started and require password in /api/onboard</name>
  <files>app/get-started/page.tsx, app/api/onboard/route.ts</files>
  <action>
    **Fix 1: app/get-started/page.tsx**

    Add a password input field to Step 3 (the email step). Changes needed:

    1. Add `Lock` to the lucide-react import (it is already imported in the login page, so this icon exists): `import { ..., Lock } from "lucide-react";`

    2. Add password state next to the existing email state:
       ```typescript
       const [password, setPassword] = useState("");
       ```

    3. In Step 3's form section (around line 443, inside the `<div className="space-y-4">`), add a password input AFTER the email input and BEFORE the error display. Structure it identically to the email input but with type="password":
       ```tsx
       <div className="relative">
         <Lock className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
         <input
           type="password"
           placeholder="Create a password (6+ chars)"
           value={password}
           onChange={(e) => setPassword(e.target.value)}
           onKeyDown={(e) => e.key === "Enter" && handleSubmit()}
           className="w-full pl-11 pr-4 py-3.5 rounded-xl border border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-gray-900 dark:text-white placeholder:text-gray-400 focus:border-[#ff6a1a] focus:ring-2 focus:ring-[#ff6a1a]/20 focus:bg-white dark:focus:bg-gray-900 outline-none transition-all text-lg"
         />
       </div>
       ```

    4. Update the `handleSubmit` function to validate and include password:
       - Add password validation AFTER the email validation:
         ```typescript
         if (!password || password.length < 6) {
           setError("Password must be at least 6 characters");
           return;
         }
         ```
       - Add `password` to the fetch body:
         ```typescript
         body: JSON.stringify({
           email: email.trim().toLowerCase(),
           password: password,
           stage: selectedStage,
           challenges: selectedChallenge ? [selectedChallenge] : [],
           isQuickOnboard: true,
         }),
         ```

    5. Move the `autoFocus` from the email input to keep it there (email is still the first field users fill in Step 3).

    6. Update the heading text from "Enter your email to create your account" to "Create your account" (since we now collect email + password).

    **Fix 2: app/api/onboard/route.ts**

    1. Replace the random password fallback on line 77. Change:
       ```typescript
       const userPassword = password || crypto.randomUUID();
       ```
       To:
       ```typescript
       if (!password || password.length < 6) {
         return NextResponse.json(
           { error: "Password must be at least 6 characters" },
           { status: 400 }
         );
       }
       const userPassword = password;
       ```

    2. The rest of the route stays the same -- it already accepts `password` from the request body (line 6), it already passes `userPassword` to `signUp()` (line 81), and it already handles the success/error cases correctly.

    DO NOT change the existing user branch (lines 47-73) -- that still handles returning users correctly. The password requirement only applies to NEW user creation.
  </action>
  <verify>
    - `grep -n "crypto.randomUUID" app/api/onboard/route.ts` returns NO matches (random password removed)
    - `grep -n "password" app/get-started/page.tsx` returns matches showing password state, input, and validation
    - `grep -n "Password must be at least 6" app/api/onboard/route.ts` returns a match
    - `npx next build 2>&1 | tail -5` compiles without TypeScript errors
  </verify>
  <done>
    - /get-started Step 3 has both email AND password inputs
    - Password is validated client-side (min 6 chars) before submission
    - /api/onboard requires password for new users (returns 400 if missing/short)
    - No more crypto.randomUUID() password generation anywhere in the onboard route
    - Password is included in the fetch body sent to /api/onboard
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire dashboard layout to real authenticated user data</name>
  <files>app/dashboard/layout.tsx</files>
  <action>
    Replace the hardcoded mock user (lines 139-144) with real Supabase auth data. The layout is a "use client" component, so use the browser client.

    1. Add imports at the top:
       ```typescript
       import { useEffect } from "react";  // already imported via useState destructure
       import { createClient } from "@/lib/supabase/client";
       ```
       Note: `useState` is already imported. Add `useEffect` to its destructure.

    2. Replace the hardcoded user constant (lines 139-144) with state:
       ```typescript
       const [user, setUser] = useState({
         name: "",
         email: "",
         tier: 0,
       });
       ```

    3. Add a useEffect to fetch real user data:
       ```typescript
       useEffect(() => {
         async function loadUser() {
           try {
             const supabase = createClient();
             const { data: { user: authUser } } = await supabase.auth.getUser();

             if (!authUser) return; // Middleware handles redirect

             // Fetch profile for name and tier
             const { data: profile } = await supabase
               .from("profiles")
               .select("name, tier")
               .eq("id", authUser.id)
               .single();

             setUser({
               name: profile?.name || authUser.email?.split("@")[0] || "Founder",
               email: authUser.email || "",
               tier: profile?.tier || 0,
             });
           } catch (e) {
             console.error("[dashboard-layout] Error loading user:", e);
           }
         }
         loadUser();
       }, []);
       ```

    4. The rest of the component stays identical -- it already uses `user.name`, `user.email`, and `user.tier` throughout. The SidebarContent, nav items, tier display, and UpgradeBanner all work as-is with the real data shape.

    5. Handle the loading state: While the user is loading (name is empty string), show the avatar with a placeholder. The current code uses `user.name.split(" ").map(n => n[0]).join("")` for initials -- this would error on empty string. Add a guard:
       ```typescript
       {(user.name || "?").split(" ").map(n => n[0]).join("")}
       ```
       OR set a default name like "..." in initial state so the avatar doesn't break during loading.

    DO NOT touch the nav items, SidebarContent structure, mobile/desktop sidebar, or main content area. Only the user data source and avatar initials guard change.
  </action>
  <verify>
    - `grep -n "Fred Cary" app/dashboard/layout.tsx` returns NO matches (hardcoded mock removed)
    - `grep -n "founder@startup.com" app/dashboard/layout.tsx` returns NO matches
    - `grep -n "supabase.auth.getUser" app/dashboard/layout.tsx` returns a match (real auth)
    - `grep -n "createClient" app/dashboard/layout.tsx` returns a match (Supabase client import)
    - `npx next build 2>&1 | tail -5` compiles without TypeScript errors
  </verify>
  <done>
    - Dashboard layout fetches real user data from Supabase auth + profiles table
    - Sidebar shows authenticated user's actual name, email, and tier
    - No hardcoded "Fred Cary" or "founder@startup.com" anywhere in the layout
    - Avatar initials derived from real user name
    - Tier badge reflects actual user tier from profiles table
    - Component still works during loading (no crashes on empty user)
  </done>
</task>

</tasks>

<verification>
Full E2E verification after both tasks:

1. `/get-started` Step 3 shows email + password fields
2. Submitting without password shows "Password must be at least 6 characters"
3. Submitting with valid email + password creates a Supabase user (no 500 error)
4. After signup, user lands on /dashboard with real name/email in sidebar
5. User can navigate away and return to /dashboard (middleware refreshes session)
6. User can log out and log back in at /login with the password they chose
7. Dashboard sidebar shows correct tier (Free by default)
8. /onboarding redirects to /get-started for unauthenticated users

Build verification:
- `npx next build` succeeds with no TypeScript errors
- No references to `crypto.randomUUID` in onboard route
- No hardcoded user data in dashboard layout
</verification>

<success_criteria>
- New users choose their own password during signup (no random UUIDs)
- /api/onboard rejects signups without a password (400 response)
- Dashboard layout displays real authenticated user data
- The full flow works: /get-started (email+password) -> celebration -> /dashboard (real user shown)
- Users can log out and log back in via /login with their chosen password
</success_criteria>

<output>
After completion, create `.planning/phases/05-auth-onboarding-fix/05-02-SUMMARY.md`
</output>
