---
phase: 31-email-engagement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/email/client.ts
  - lib/email/send.ts
  - lib/email/constants.ts
  - lib/email/types.ts
  - lib/email/preferences.ts
  - lib/email/templates/layout.tsx
  - lib/email/templates/weekly-digest.tsx
  - lib/email/digest/data.ts
  - lib/db/migrations/045_email_engagement.sql
  - app/api/cron/weekly-digest/route.ts
  - vercel.json
autonomous: true
user_setup:
  - service: resend
    why: "Email sending via Resend API"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys"
      - name: RESEND_FROM_EMAIL
        source: "Verified sending domain in Resend Dashboard"

must_haves:
  truths:
    - "Weekly digest cron sends a summary email to opted-in users every Monday"
    - "Users who opted out of weekly digest in settings do NOT receive digest emails"
    - "Users with zero activity in the period do NOT receive an empty digest"
    - "Duplicate digest emails are prevented via email_sends idempotency table"
    - "Cron endpoint returns 401 without valid CRON_SECRET and 503 without RESEND_API_KEY"
  artifacts:
    - path: "lib/email/client.ts"
      provides: "Resend SDK singleton client"
      exports: ["getResendClient"]
    - path: "lib/email/send.ts"
      provides: "Unified email send function with logging and tracking"
      exports: ["sendEmail"]
    - path: "lib/email/preferences.ts"
      provides: "Email preference checking against profiles.metadata.notification_prefs"
      exports: ["shouldSendEmail"]
    - path: "lib/email/templates/layout.tsx"
      provides: "Shared Sahara-branded email layout component"
      exports: ["EmailLayout"]
    - path: "lib/email/templates/weekly-digest.tsx"
      provides: "Weekly digest React Email template"
      exports: ["WeeklyDigest"]
    - path: "lib/email/digest/data.ts"
      provides: "Digest data aggregation from existing DB tables"
      exports: ["getDigestData"]
    - path: "lib/db/migrations/045_email_engagement.sql"
      provides: "email_sends table for idempotent tracking"
      contains: "CREATE TABLE IF NOT EXISTS email_sends"
    - path: "app/api/cron/weekly-digest/route.ts"
      provides: "Cron endpoint for weekly digest dispatch"
      exports: ["GET"]
  key_links:
    - from: "app/api/cron/weekly-digest/route.ts"
      to: "lib/email/digest/data.ts"
      via: "getDigestData() call per user"
      pattern: "getDigestData"
    - from: "app/api/cron/weekly-digest/route.ts"
      to: "lib/email/preferences.ts"
      via: "shouldSendEmail() check before sending"
      pattern: "shouldSendEmail"
    - from: "app/api/cron/weekly-digest/route.ts"
      to: "lib/email/send.ts"
      via: "sendEmail() with React template"
      pattern: "sendEmail"
    - from: "lib/email/send.ts"
      to: "lib/email/client.ts"
      via: "getResendClient() for SDK instance"
      pattern: "getResendClient"
    - from: "vercel.json"
      to: "app/api/cron/weekly-digest/route.ts"
      via: "cron schedule entry"
      pattern: "weekly-digest"
---

<objective>
Build the email engagement foundation and weekly digest system for Sahara.

Purpose: Install the Resend SDK, create shared email infrastructure (client, send function, preferences, React Email templates), create the email_sends tracking table, and implement the weekly digest cron that aggregates founder activity from existing DB tables into a branded email summary.

Output: Working weekly digest cron endpoint, shared email layout, Resend SDK client, idempotent email tracking, and preference-gated sending.
</objective>

<execution_context>
@/opt/agency-workspace/sierra-fred-carey/.planning/phases/31-email-engagement/31-RESEARCH.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@lib/sms/scheduler.ts
@app/api/cron/weekly-checkin/route.ts
@lib/notifications/email.ts
@lib/push/preferences.ts
@lib/db/migrations/009_journey_tables.sql
@vercel.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Email infrastructure and database migration</name>
  <files>
    lib/email/client.ts
    lib/email/send.ts
    lib/email/constants.ts
    lib/email/types.ts
    lib/email/preferences.ts
    lib/email/templates/layout.tsx
    lib/db/migrations/045_email_engagement.sql
    package.json
  </files>
  <action>
    1. Install the Resend SDK: `npm install resend --legacy-peer-deps`

    2. Create `lib/email/client.ts` -- Resend SDK singleton following the project's lazy-init pattern (see `lib/push/preferences.ts` for style). Export `getResendClient()` that returns `Resend | null` (null when RESEND_API_KEY is missing). Cache the instance in a module-level variable.

    3. Create `lib/email/types.ts` with:
       - `EmailCategory` type: `'weekly_digest' | 'milestone' | 're_engagement'`
       - `EmailSendResult` interface: `{ success: boolean; resendId?: string; error?: string }`
       - `DigestData` interface with fields: `founderName: string`, `weekOf: string`, `stats: DigestStats`, `highlights: DigestHighlight[]`, `activeRedFlags: number`, `appUrl: string`, `unsubscribeUrl: string`
       - `DigestStats` interface: `{ conversationCount: number; completedMilestones: number; completedTasks: number; newJourneyEvents: number }`
       - `DigestHighlight` interface: `{ title: string; description: string; type: 'milestone' | 'task' | 'event' }`

    4. Create `lib/email/constants.ts` with:
       - `EMAIL_CATEGORIES` object mapping category to preference key: `{ weekly_digest: 'weekly', milestone: 'email', re_engagement: 'marketing' }`
       - `DIGEST_SKIP_THRESHOLD = 0` (minimum total activity items to send digest)
       - `RE_ENGAGEMENT_DAYS = [7, 14, 30]` (graduated nudge cadence)
       - `BATCH_SIZE = 100` (Resend batch limit)

    5. Create `lib/email/preferences.ts` -- Export `shouldSendEmail(userId: string, category: EmailCategory): Promise<boolean>`. This reads `profiles.metadata.notification_prefs` via service client. Map category to preference key using EMAIL_CATEGORIES constant. Return false if the master `email` toggle is false OR if the specific category toggle is false. Default to true if prefs are not set (matching existing settings page behavior). Use structured logging via `lib/logger`.

    6. Create `lib/email/send.ts` -- Export `sendEmail(options)` function that:
       - Gets Resend client via `getResendClient()`, returns error result if null
       - Sends email using `resend.emails.send()` with `from`, `to`, `subject`, `react` (React component), and `tags` parameters
       - Uses `RESEND_FROM_EMAIL` and `RESEND_FROM_NAME` env vars (with fallback defaults)
       - Logs send via `lib/logger` with `[Email]` prefix
       - Records send in `email_sends` table via service client (user_id, email_type, email_subtype, week_number, year, resend_id, status)
       - Returns `EmailSendResult`

    7. Create `lib/email/templates/layout.tsx` -- Shared React Email layout component using `@react-email/components` (Html, Head, Body, Container, Section, Text, Link, Hr, Preview, Img). Include:
       - Sahara logo/brand header (text-based "Sahara" in brand color, not image -- keeps it simple)
       - `previewText` prop rendered via `<Preview>`
       - `children` slot for content
       - Footer with "Manage email preferences" link pointing to `${appUrl}/dashboard/settings`
       - Inline styles (required for email -- no Tailwind)
       - Font: `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif`
       - Background: `#f9fafb`, content card: `#ffffff` with `border-radius: 8px`

    8. Create `lib/db/migrations/045_email_engagement.sql`:
       ```sql
       CREATE TABLE IF NOT EXISTS email_sends (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         user_id TEXT NOT NULL,
         email_type TEXT NOT NULL,
         email_subtype TEXT,
         week_number INTEGER,
         year INTEGER,
         resend_id TEXT,
         status TEXT NOT NULL DEFAULT 'sent' CHECK (status IN ('sent', 'failed', 'skipped')),
         metadata JSONB DEFAULT '{}',
         created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
       );
       CREATE INDEX idx_email_sends_user_type ON email_sends(user_id, email_type);
       CREATE INDEX idx_email_sends_week ON email_sends(user_id, email_type, week_number, year);
       CREATE INDEX idx_email_sends_created ON email_sends(created_at);
       CREATE UNIQUE INDEX idx_email_sends_digest_unique
         ON email_sends(user_id, email_type, week_number, year)
         WHERE email_type = 'weekly_digest';
       ALTER TABLE email_sends ENABLE ROW LEVEL SECURITY;
       CREATE POLICY email_sends_select_own ON email_sends FOR SELECT
         USING (user_id = auth.uid()::TEXT);
       CREATE POLICY email_sends_service_role ON email_sends FOR ALL
         USING (auth.role() = 'service_role')
         WITH CHECK (auth.role() = 'service_role');
       ```
       Follow the exact RLS pattern from `044_push_notification_logs.sql`.
  </action>
  <verify>
    - `npx tsc --noEmit` passes with no errors in the new files
    - `npm run lint` passes
    - `lib/email/client.ts`, `lib/email/send.ts`, `lib/email/preferences.ts`, `lib/email/types.ts`, `lib/email/constants.ts`, `lib/email/templates/layout.tsx` all exist
    - `lib/db/migrations/045_email_engagement.sql` exists with CREATE TABLE, indexes, and RLS policies
    - `resend` appears in package.json dependencies
  </verify>
  <done>
    Resend SDK installed. Email client singleton, send function, preference checker, types, constants, shared layout template, and email_sends migration all exist and compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Weekly digest template, data aggregation, and cron route</name>
  <files>
    lib/email/templates/weekly-digest.tsx
    lib/email/digest/data.ts
    app/api/cron/weekly-digest/route.ts
    vercel.json
  </files>
  <action>
    1. Create `lib/email/digest/data.ts` -- Export `getDigestData(userId: string, since: Date): Promise<DigestData | null>`. This function:
       - Uses `createServiceClient()` from `lib/supabase/server`
       - Runs parallel queries via `Promise.all` against existing tables:
         a. `milestones` -- completed or in_progress since `since`, for the user
         b. `journey_events` -- events since `since`, ordered by created_at DESC, limit 10
         c. `fred_red_flags` -- active flags for the user, limit 5
         d. `agent_tasks` -- completed since `since`
         e. `fred_episodic_memory` -- count of conversations since `since` (count only, head: true)
       - Fetches user profile (name, email) from `profiles` table
       - Calculates total activity = milestones.length + journeyEvents.length + completedTasks.length + conversationCount
       - Returns null if total activity is 0 (skip empty digests)
       - Builds highlights array from top milestones and completed tasks (max 5 items)
       - Returns `DigestData` with stats, highlights, founderName, weekOf (formatted via date-fns `format`), appUrl, unsubscribeUrl

    2. Create `lib/email/templates/weekly-digest.tsx` -- React Email component using `@react-email/components`. Props: `DigestData`. Structure:
       - Uses `EmailLayout` from `./layout` as wrapper
       - Preview text: `Your Sahara weekly digest - Week of {weekOf}`
       - Greeting: `Hey {founderName},`
       - Intro: `Here is your weekly progress summary from Sahara:`
       - Stats section: 4-cell grid showing conversation count, completed milestones, completed tasks, and active red flags (use colored stat boxes with inline styles)
       - Highlights section: bulleted list of top highlights (milestone completions, task completions) if any exist
       - CTA button: `View Your Dashboard` linking to `{appUrl}/dashboard`
       - If red flags > 0, add a subtle warning section: `You have {n} active red flags to review`
       - All styles must be inline (email compatibility). Use table-based layout for the stats grid.

    3. Create `app/api/cron/weekly-digest/route.ts` -- Follow the EXACT pattern from `app/api/cron/weekly-checkin/route.ts`:
       - `export const dynamic = 'force-dynamic'`
       - `export const maxDuration = 60` (60 second timeout for batch processing)
       - GET handler with CRON_SECRET bearer token auth (same pattern as weekly-checkin)
       - Check RESEND_API_KEY is present, return 503 if not
       - Query all profiles where `onboarding_completed = true` and email is not null
       - For each user (process sequentially to stay within timeout):
         a. Check `shouldSendEmail(userId, 'weekly_digest')` -- skip if false
         b. Check idempotency: query `email_sends` for existing `weekly_digest` record with current week_number + year (use `getISOWeek`/`getISOWeekYear` from date-fns). Skip if exists.
         c. Call `getDigestData(userId, since)` where `since` is 7 days ago. Skip if null (no activity).
         d. Call `sendEmail()` with `WeeklyDigest` React component, subject `Your Weekly Sahara Digest`, and tags `[{name: 'category', value: 'weekly_digest'}, {name: 'user_id', value: userId}]`
       - Track sent/skipped/failed counts
       - Log via `lib/logger` with `[Cron: Weekly Digest]` prefix
       - Return JSON summary: `{ success, sent, skipped, failed, duration }`

    4. Update `vercel.json` -- Add weekly digest cron entry to the existing `crons` array:
       ```json
       { "path": "/api/cron/weekly-digest", "schedule": "0 10 * * 1" }
       ```
       This runs Monday 10:00 UTC (separate from SMS weekly-checkin at 14:00 UTC Monday).
       Keep all existing crons and headers intact. Only add the new entry.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npm run lint` passes
    - `app/api/cron/weekly-digest/route.ts` exists and exports GET
    - `lib/email/templates/weekly-digest.tsx` exists and exports WeeklyDigest
    - `lib/email/digest/data.ts` exists and exports getDigestData
    - `vercel.json` contains `/api/cron/weekly-digest` in crons array
    - `npm run build` completes without errors
  </verify>
  <done>
    Weekly digest system is complete: data aggregation queries pull from 5 existing tables, React Email template renders a branded summary, cron route processes users with idempotency and preference checks, and Vercel cron is configured for Monday 10:00 UTC.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes with all new files
2. Lint: `npm run lint` passes
3. Build: `npm run build` succeeds
4. Email infrastructure files exist: client.ts, send.ts, preferences.ts, types.ts, constants.ts, layout.tsx
5. Weekly digest files exist: weekly-digest.tsx, data.ts, cron route.ts
6. Migration 045 exists with email_sends table, indexes, and RLS
7. vercel.json has weekly-digest cron entry
8. Resend SDK is in package.json dependencies
</verification>

<success_criteria>
- Resend SDK installed and client singleton created
- Shared email layout component renders Sahara-branded emails
- Email preference checker reads from profiles.metadata.notification_prefs
- email_sends table migration exists with idempotency constraint
- Weekly digest data aggregation queries 5 existing tables in parallel
- Weekly digest React Email template shows stats grid, highlights, and CTA
- Cron route authenticates via CRON_SECRET, checks preferences, prevents duplicates, aggregates data, sends emails
- vercel.json configured for Monday 10:00 UTC cron
- All files compile and build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/31-email-engagement/31-01-SUMMARY.md`
</output>
