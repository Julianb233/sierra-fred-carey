# Phase 30-01: Wire PostHog Into Product Flows + Funnel Events

**Phase:** 30 — Product Analytics & Growth
**Plan:** 01 of 2
**Status:** PENDING
**Depends on:** None (PostHog scaffolding already exists)

## Goal

PostHog client/server libraries are installed and scaffolded but only wired into the onboarding page. This plan instruments all critical user flows with analytics events so we can measure feature adoption, conversion funnels, and engagement. After this plan, every key user action is tracked and visible in PostHog dashboards.

## Steps

### Step 1: Wire analytics into auth flows
**Files:** `app/login/page.tsx`, `app/get-started/page.tsx`
- Track `AUTH.LOGIN` on successful login
- Track `AUTH.SIGNUP` on successful registration
- Track `AUTH.LOGOUT` on logout
- Include properties: `{ method: 'email', tier: userTier }`

### Step 2: Wire analytics into chat
**Files:** `app/api/fred/chat/route.ts` or `lib/hooks/use-fred-chat.ts`
- Track `CHAT.MESSAGE_SENT` on each user message (server-side preferred)
- Track `CHAT.SESSION_STARTED` on first message of a session
- Include properties: `{ tier, messageCount, topic }`
- Use `serverTrack()` for server-side events

### Step 3: Wire analytics into feature usage
**Files:** Various feature pages
- `app/dashboard/reality-lens/page.tsx` → track `FEATURES.REALITY_LENS_USED` on analysis submit
- `app/dashboard/pitch-review/page.tsx` or upload handler → track `FEATURES.PITCH_DECK_UPLOADED`
- `app/dashboard/strategy/page.tsx` → track `FEATURES.STRATEGY_CREATED`
- `app/dashboard/agents/page.tsx` → track `FEATURES.AGENT_DISPATCHED`
- `app/dashboard/investor-targeting/page.tsx` → track `FEATURES.INVESTOR_READINESS_USED`

### Step 4: Wire analytics into subscription events
**Files:** `app/api/stripe/webhook/route.ts` or checkout handler
- Track `SUBSCRIPTION.CHECKOUT_STARTED` when checkout session created
- Track `SUBSCRIPTION.CHECKOUT_COMPLETED` on successful webhook
- Track `SUBSCRIPTION.TIER_CHANGED` on subscription update
- Include properties: `{ fromTier, toTier, price }`

### Step 5: Wire analytics into engagement events
**Files:** `app/dashboard/page.tsx`, `app/dashboard/settings/page.tsx`
- Track `ENGAGEMENT.DASHBOARD_VIEWED` on dashboard page load
- Track `ENGAGEMENT.SETTINGS_UPDATED` on settings save
- Track `ENGAGEMENT.DOCUMENT_EXPORTED` on any export action

### Step 6: Add PostHog provider to app layout
**Files:** `app/layout.tsx` or `app/providers.tsx`
- Initialize PostHog on app load via `initAnalytics()`
- Identify user on auth state change via `identifyUser()`
- Reset on logout via `resetUser()`
- Ensure PostHog no-ops gracefully when key is not set

## Verification

- [ ] Login/signup/logout events tracked
- [ ] Chat message events tracked (server-side)
- [ ] All 5 feature usage events tracked
- [ ] Subscription events tracked in webhook
- [ ] Dashboard and settings engagement tracked
- [ ] PostHog initialized in app layout
- [ ] All events no-op gracefully when NEXT_PUBLIC_POSTHOG_KEY is not set
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- `app/login/page.tsx` — added login analytics tracking
- `app/get-started/page.tsx` — added signup analytics tracking
- `app/api/fred/chat/route.ts` — added server-side chat event tracking
- Various dashboard pages — added feature usage tracking
- `app/api/stripe/webhook/route.ts` — added subscription event tracking
- `app/layout.tsx` or `app/providers.tsx` — PostHog initialization and user identification
