# Phase 41-01: Community Database Schema + API Routes

**Phase:** 41 — Founder Communities
**Plan:** 01 of 2 (Backend Foundation)
**Wave:** 5 (parallel with Phase 40)
**Depends on:** Phase 34 (basic mentor infrastructure)
**Status:** PENDING
**autonomous:** true

## Goal

Build the complete backend for Founder Communities: database tables with RLS policies and RESTful API routes. Founders can create, browse, join, and interact within self-started communities. This plan delivers the data layer and API surface; Plan 02 delivers the UI.

## Requirements Addressed

- **COMM-01**: Founders can create communities around topics, industries, or stages (self-started, not admin-curated)
- **COMM-02**: Founders can browse and join communities from the dashboard
- **COMM-03**: Community feeds show posts, questions, and updates from members
- **COMM-04**: Communities are self-moderated by users with basic moderation tools

---

## Database Schema (Migration 051)

### Step 1: Create migration file `lib/db/migrations/051_communities.sql`

Five tables with RLS. All use `uuid` primary keys via `gen_random_uuid()`.

#### Table: `communities`
```sql
CREATE TABLE communities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  slug TEXT NOT NULL UNIQUE,
  description TEXT NOT NULL DEFAULT '',
  category TEXT NOT NULL DEFAULT 'general',
    -- enum: 'industry', 'stage', 'topic', 'general'
  cover_image_url TEXT,
  creator_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  member_count INTEGER NOT NULL DEFAULT 1,
  is_private BOOLEAN NOT NULL DEFAULT false,
  is_archived BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_communities_slug ON communities(slug);
CREATE INDEX idx_communities_category ON communities(category);
CREATE INDEX idx_communities_creator ON communities(creator_id);
CREATE INDEX idx_communities_created ON communities(created_at DESC);
```

#### Table: `community_members`
```sql
CREATE TABLE community_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'member',
    -- enum: 'owner', 'moderator', 'member'
  joined_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(community_id, user_id)
);

CREATE INDEX idx_community_members_community ON community_members(community_id);
CREATE INDEX idx_community_members_user ON community_members(user_id);
```

#### Table: `community_posts`
```sql
CREATE TABLE community_posts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  community_id UUID NOT NULL REFERENCES communities(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL DEFAULT '',
  content TEXT NOT NULL,
  post_type TEXT NOT NULL DEFAULT 'post',
    -- enum: 'post', 'question', 'update', 'milestone'
  is_pinned BOOLEAN NOT NULL DEFAULT false,
  reaction_count INTEGER NOT NULL DEFAULT 0,
  reply_count INTEGER NOT NULL DEFAULT 0,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_community_posts_community ON community_posts(community_id, created_at DESC);
CREATE INDEX idx_community_posts_author ON community_posts(author_id);
CREATE INDEX idx_community_posts_pinned ON community_posts(community_id, is_pinned DESC, created_at DESC);
```

#### Table: `community_post_reactions`
```sql
CREATE TABLE community_post_reactions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES community_posts(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  reaction_type TEXT NOT NULL DEFAULT 'like',
    -- enum: 'like', 'insightful', 'support'
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(post_id, user_id, reaction_type)
);

CREATE INDEX idx_reactions_post ON community_post_reactions(post_id);
CREATE INDEX idx_reactions_user ON community_post_reactions(user_id);
```

#### Table: `community_post_replies`
```sql
CREATE TABLE community_post_replies (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  post_id UUID NOT NULL REFERENCES community_posts(id) ON DELETE CASCADE,
  author_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content TEXT NOT NULL,
  parent_reply_id UUID REFERENCES community_post_replies(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_replies_post ON community_post_replies(post_id, created_at ASC);
CREATE INDEX idx_replies_parent ON community_post_replies(parent_reply_id);
CREATE INDEX idx_replies_author ON community_post_replies(author_id);
```

### Step 2: RLS Policies

Enable RLS on all 5 tables. Policies:

**communities:**
- SELECT: anyone authenticated can read non-archived communities (`auth.uid() IS NOT NULL AND is_archived = false`), or private communities they are a member of
- INSERT: any authenticated user can create (`auth.uid() = creator_id`)
- UPDATE: only owner can update (`auth.uid() = creator_id`)
- DELETE: only owner can archive (soft delete via `is_archived`)

**community_members:**
- SELECT: anyone authenticated can see members of communities they belong to
- INSERT: any authenticated user can join public communities; owner can add to private
- DELETE: user can leave (`auth.uid() = user_id`), or owner/moderator can remove

**community_posts:**
- SELECT: any authenticated member of the community can read posts
- INSERT: any member can create posts
- UPDATE: author can edit own posts, moderator/owner can edit any
- DELETE: author can delete own posts, moderator/owner can delete any

**community_post_reactions:**
- SELECT: any authenticated user can read
- INSERT: any member can react (`auth.uid() = user_id`)
- DELETE: user can remove own reaction (`auth.uid() = user_id`)

**community_post_replies:**
- SELECT: any authenticated member of the community can read
- INSERT: any member can reply
- UPDATE: author can edit own reply
- DELETE: author can delete own, moderator/owner can delete any

### Step 3: Trigger for member_count sync

Create a trigger function that increments/decrements `communities.member_count` on INSERT/DELETE in `community_members`.

### Step 4: Trigger for reaction_count and reply_count sync

Create trigger functions to keep `community_posts.reaction_count` and `community_posts.reply_count` in sync.

---

## Database Access Layer

### Step 5: Create `lib/db/communities.ts`

Follow the pattern from `lib/db/red-flags.ts` — use `createServiceClient()` for server-side operations.

**Type interfaces:**
```typescript
interface CommunityRow { ... }
interface CommunityMemberRow { ... }
interface CommunityPostRow { ... }
interface CommunityPostReactionRow { ... }
interface CommunityPostReplyRow { ... }
```

**Functions to implement:**
```typescript
// Communities
export async function createCommunity(params: { userId: string; name: string; description: string; category: string; isPrivate?: boolean }): Promise<Community>
export async function getCommunity(slug: string): Promise<Community | null>
export async function listCommunities(opts?: { category?: string; search?: string; limit?: number; offset?: number }): Promise<Community[]>
export async function updateCommunity(id: string, userId: string, updates: Partial<Pick<Community, 'name' | 'description' | 'category' | 'coverImageUrl' | 'isArchived'>>): Promise<Community>

// Members
export async function joinCommunity(communityId: string, userId: string): Promise<CommunityMember>
export async function leaveCommunity(communityId: string, userId: string): Promise<void>
export async function getCommunityMembers(communityId: string, opts?: { limit?: number; offset?: number }): Promise<CommunityMember[]>
export async function getUserCommunities(userId: string): Promise<Community[]>
export async function getMemberRole(communityId: string, userId: string): Promise<string | null>
export async function updateMemberRole(communityId: string, targetUserId: string, role: string): Promise<void>
export async function removeMember(communityId: string, targetUserId: string): Promise<void>

// Posts
export async function createPost(params: { communityId: string; authorId: string; title: string; content: string; postType: string }): Promise<CommunityPost>
export async function getPost(postId: string): Promise<CommunityPost | null>
export async function listPosts(communityId: string, opts?: { limit?: number; offset?: number; pinFirst?: boolean }): Promise<CommunityPost[]>
export async function updatePost(postId: string, userId: string, updates: Partial<Pick<CommunityPost, 'title' | 'content' | 'isPinned'>>): Promise<CommunityPost>
export async function deletePost(postId: string, userId: string): Promise<void>

// Reactions
export async function toggleReaction(postId: string, userId: string, reactionType: string): Promise<{ added: boolean }>
export async function getPostReactions(postId: string): Promise<CommunityPostReaction[]>

// Replies
export async function createReply(params: { postId: string; authorId: string; content: string; parentReplyId?: string }): Promise<CommunityPostReply>
export async function listReplies(postId: string): Promise<CommunityPostReply[]>
export async function updateReply(replyId: string, userId: string, content: string): Promise<CommunityPostReply>
export async function deleteReply(replyId: string, userId: string): Promise<void>
```

Each function uses `createServiceClient()` and follows the row-to-model mapping pattern from `red-flags.ts` (snake_case DB -> camelCase TypeScript).

---

## API Routes

### Step 6: Create `app/api/communities/route.ts`

Follow the pattern from `app/api/red-flags/route.ts` — use `requireAuth()`, return `{ success, data }` shape.

**GET** `/api/communities` — List/browse communities
- Query params: `?category=industry&search=saas&limit=20&offset=0`
- Returns array of communities with `isMember` flag for current user

**POST** `/api/communities` — Create a community
- Body: `{ name, description, category, isPrivate? }`
- Validates: name (2-100 chars), description (max 500), category (valid enum)
- Auto-generates slug from name (lowercase, hyphenated, deduped)
- Auto-adds creator as owner in `community_members`
- Returns created community

### Step 7: Create `app/api/communities/[slug]/route.ts`

**GET** `/api/communities/[slug]` — Get community detail
- Returns community + membership info for current user + recent posts preview

**PATCH** `/api/communities/[slug]` — Update community
- Only owner can update
- Body: `{ name?, description?, category?, isArchived? }`

### Step 8: Create `app/api/communities/[slug]/members/route.ts`

**GET** `/api/communities/[slug]/members` — List members
- Query params: `?limit=20&offset=0`
- Returns members with name, role, joinedAt

**POST** `/api/communities/[slug]/members` — Join community
- No body needed — adds current user as member
- Returns membership

**DELETE** `/api/communities/[slug]/members` — Leave community
- Query param: `?userId=xxx` (for moderator removing someone, or self-leave)
- Owner cannot leave (must transfer or archive)

### Step 9: Create `app/api/communities/[slug]/posts/route.ts`

**GET** `/api/communities/[slug]/posts` — List posts
- Query params: `?limit=20&offset=0`
- Must be a member to view
- Returns posts with author info, reaction counts

**POST** `/api/communities/[slug]/posts` — Create post
- Body: `{ title, content, postType }`
- Must be a member
- Validates content (1-5000 chars), postType (valid enum)

### Step 10: Create `app/api/communities/[slug]/posts/[postId]/route.ts`

**GET** — Get single post with replies
**PATCH** — Update post (author or moderator/owner)
**DELETE** — Delete post (author or moderator/owner)

### Step 11: Create `app/api/communities/[slug]/posts/[postId]/reactions/route.ts`

**POST** — Toggle reaction `{ reactionType }` (adds if not exists, removes if exists)
**GET** — Get reactions for a post

### Step 12: Create `app/api/communities/[slug]/posts/[postId]/replies/route.ts`

**GET** — List replies for a post (threaded)
**POST** — Create reply `{ content, parentReplyId? }`

### Step 13: Create `app/api/communities/[slug]/posts/[postId]/replies/[replyId]/route.ts`

**PATCH** — Update reply (author only)
**DELETE** — Delete reply (author or moderator/owner)

---

## Verification

- [ ] Migration 051 applies cleanly with `psql` or Supabase migration runner
- [ ] All 5 tables created with correct columns, types, and constraints
- [ ] RLS policies enforce: public communities readable by all authenticated, private communities only by members
- [ ] RLS policies enforce: only members can create posts, reactions, replies
- [ ] RLS policies enforce: only owner/moderator can moderate (pin, delete others' posts)
- [ ] `member_count`, `reaction_count`, `reply_count` triggers work correctly
- [ ] All API routes return `{ success: true, data }` on success, `{ success: false, error }` on failure
- [ ] All API routes use `requireAuth()` and validate inputs
- [ ] `npx tsc --noEmit` passes
- [ ] Slug generation handles duplicates (appends `-2`, `-3`, etc.)

## must_haves

- All 5 tables with correct foreign keys and indexes
- RLS enabled on all tables with member-scoped read/write policies
- Trigger-based counter sync for member_count, reaction_count, reply_count
- CRUD API routes matching RESTful URL structure
- Input validation on all POST/PATCH endpoints
- Slug auto-generation from community name
- Auth required on all endpoints via `requireAuth()`

## Files Modified/Created

### New Files
- `lib/db/migrations/051_communities.sql` — migration with 5 tables, indexes, RLS, triggers
- `lib/db/communities.ts` — database access layer (CRUD functions)
- `app/api/communities/route.ts` — list + create communities
- `app/api/communities/[slug]/route.ts` — get + update community
- `app/api/communities/[slug]/members/route.ts` — join + leave + list members
- `app/api/communities/[slug]/posts/route.ts` — list + create posts
- `app/api/communities/[slug]/posts/[postId]/route.ts` — get + update + delete post
- `app/api/communities/[slug]/posts/[postId]/reactions/route.ts` — toggle + list reactions
- `app/api/communities/[slug]/posts/[postId]/replies/route.ts` — list + create replies
- `app/api/communities/[slug]/posts/[postId]/replies/[replyId]/route.ts` — update + delete reply

### Modified Files
- None (this plan is additive only)
