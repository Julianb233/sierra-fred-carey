---
phase: 08-final-polish
plan: 08-01
title: "Chat FRED wiring, dashboard fixes, cleanup"
autonomous: true
wave: 1
estimated_tasks: 7
---

# Plan 08-01: Chat FRED Wiring, Dashboard Fixes, Cleanup

**Goal:** Close all remaining v1.0 tech debt — wire chat to FRED engine, fix dead buttons, replace stubs, clean up orphaned code.

## Tasks

### Task 1: Wire chat-interface.tsx to FRED engine via useFredChat hook

**What:** Replace the raw `fetch("/api/chat")` in `components/chat/chat-interface.tsx` with the `useFredChat` hook from `lib/hooks/use-fred-chat.ts`. This hook already calls `/api/fred/chat` with full SSE streaming, XState state tracking, session management, and memory persistence.

**Changes:**
1. In `components/chat/chat-interface.tsx`:
   - Import `useFredChat` and `FredMessage` from `@/lib/hooks/use-fred-chat`
   - Import `CognitiveStateIndicator` from `./cognitive-state-indicator`
   - Replace the component's internal state management (`useState` for messages, isLoading) with the hook
   - The hook provides: `messages`, `sendMessage`, `state`, `isProcessing`, `error`, `clearError`, `reset`
   - Map `FredMessage` to the existing `Message` type used by `ChatMessage` component (both have `id`, `content`, `role`, `timestamp`)
   - Add initial greeting message via `useState` for the FRED welcome message (the hook starts with empty messages)
   - Replace the `handleSendMessage` function body with a call to `sendMessage(content)` from the hook
   - Replace `isLoading` with `isProcessing` from the hook
   - Add `CognitiveStateIndicator` or `CognitiveStepIndicator` above the input area to show FRED's thinking state
   - Remove the manual fetch/error handling — the hook handles all of this

2. In `app/chat/page.tsx`: No changes needed — it just renders `<ChatInterface />`

**Key detail:** The `useFredChat` hook's `FredMessage` has additional fields (`confidence`, `action`, `requiresApproval`, `reasoning`) compared to the basic `Message` type. The `ChatMessage` component can use the base fields initially. The `CognitiveStateIndicator` shows the XState processing stages (analyzing → thinking → synthesizing → responding).

**Verification:**
- `grep -r "/api/chat" components/chat/` returns zero matches
- `components/chat/chat-interface.tsx` imports `useFredChat`
- `CognitiveStateIndicator` or `CognitiveStepIndicator` rendered in the component

### Task 2: Delete legacy /api/chat route

**What:** Delete `app/api/chat/route.ts`. All consumers should now use `/api/fred/chat`.

**Changes:**
1. Delete `app/api/chat/route.ts`
2. Verify no remaining references: `grep -r "api/chat" --include='*.ts' --include='*.tsx'` should return zero matches (excluding `api/fred/chat`)

**Verification:**
- `app/api/chat/route.ts` does not exist
- No imports or fetch calls reference `/api/chat` (only `/api/fred/chat`)

### Task 3: Fix dashboard CTA "Upgrade Now" dead button

**What:** The "Upgrade Now" button at `app/dashboard/page.tsx` lines 351-356 has no onClick handler.

**Changes:**
1. In `app/dashboard/page.tsx`:
   - Import `redirectToCheckoutByTier` from `@/lib/stripe/client`
   - Add `onClick` handler to the CTA Button: `onClick={() => redirectToCheckoutByTier("pro")}`
   - The button is inside a `{user.tier === 0 && (...)}` conditional, so it only shows for free users — "pro" is the correct upgrade target

**Verification:**
- Button has an `onClick` handler
- `redirectToCheckoutByTier` imported and called

### Task 4: Fix Reality Lens getUserTier() stub

**What:** Replace the hardcoded `getUserTier` stub in `app/api/fred/reality-lens/route.ts` with a real subscription lookup.

**Changes:**
1. In `app/api/fred/reality-lens/route.ts`:
   - Import `getUserSubscription` from `@/lib/db/subscriptions`
   - Import `getPlanByPriceId` from `@/lib/stripe/config`
   - Import `getTierFromString` from `@/lib/constants`
   - Replace the stub `getUserTier` function with the real implementation that matches `lib/api/tier-middleware.ts`:
     ```
     async function getUserTier(userId: string): Promise<RealityLensTier> {
       try {
         const subscription = await getUserSubscription(userId);
         if (!subscription || !["active", "trialing"].includes(subscription.status)) {
           return "free";
         }
         const plan = getPlanByPriceId(subscription.stripePriceId);
         if (!plan) return "free";
         const tierString = getTierFromString(plan.id);
         // Map UserTier enum (0,1,2) to RealityLensTier string
         const tierMap: Record<number, RealityLensTier> = { 0: "free", 1: "pro", 2: "studio" };
         return tierMap[tierString] || "free";
       } catch (error) {
         console.error("[RealityLens] Error fetching user tier:", error);
         return "free";
       }
     }
     ```
   - Remove the `TODO` comment

**Verification:**
- No `TODO` in the getUserTier function
- `getUserSubscription`, `getPlanByPriceId`, `getTierFromString` imported
- Function body contains actual subscription lookup logic

### Task 5: Fix SMS nav link and delete check-ins mockup

**What:** Dashboard nav "Weekly Check-ins" points to `/dashboard/check-ins` (static mockup) instead of `/dashboard/sms` (functional page).

**Changes:**
1. In `app/dashboard/layout.tsx` line 114:
   - Change `href: "/dashboard/check-ins"` to `href: "/dashboard/sms"`
2. Delete `app/dashboard/check-ins/page.tsx` (static mockup, no other consumers)

**Verification:**
- `grep "check-ins" app/dashboard/layout.tsx` returns zero matches
- `app/dashboard/check-ins/` directory does not exist
- Nav item href is `/dashboard/sms`

### Task 6: Delete legacy orphaned routes

**What:** Delete orphaned `/dashboard/investor-score` page and `/api/investor-score` route. These were replaced by `/dashboard/investor-readiness` and `/api/fred/investor-readiness`.

**Changes:**
1. Delete `app/dashboard/investor-score/page.tsx`
2. Delete `app/api/investor-score/route.ts`
3. Verify no remaining references to either path

**Verification:**
- Neither file exists
- `grep -r "investor-score" --include='*.ts' --include='*.tsx'` returns zero matches

### Task 7: Standardize auth imports

**What:** FRED routes (7 files) import `requireAuth` from `@/lib/supabase/auth-helpers`. All other routes (46 files) import from `@/lib/auth`. Standardize FRED routes to use `@/lib/auth` since it's the public API barrel.

**Changes:**
1. In these 6 files (excluding the test file), replace:
   `import { requireAuth } from "@/lib/supabase/auth-helpers"` → `import { requireAuth } from "@/lib/auth"`
   - `app/api/fred/reality-lens/route.ts`
   - `app/api/fred/chat/route.ts`
   - `app/api/fred/decide/route.ts`
   - `app/api/fred/history/route.ts`
   - `app/api/fred/memory/route.ts`
   - `app/api/fred/analyze/route.ts`
2. In the test file, update similarly:
   - `app/api/fred/__tests__/fred-api.test.ts`

**Verification:**
- `grep -r "supabase/auth-helpers" --include='*.ts' --include='*.tsx'` returns only `lib/supabase/auth-helpers.ts` itself (the source module) and `lib/auth.ts` (the barrel)
- All FRED route files import from `@/lib/auth`

## Commit Message

```
fix: wire chat to FRED engine, fix dead buttons, clean up tech debt

- Replace legacy /api/chat with useFredChat hook (XState, memory, SSE)
- Add cognitive state indicator to chat interface
- Fix dashboard CTA "Upgrade Now" button (was dead, now calls Stripe)
- Fix Reality Lens getUserTier() stub (now reads real subscription)
- Fix SMS nav link (check-ins mockup → functional /dashboard/sms)
- Delete orphaned legacy routes (investor-score, check-ins, /api/chat)
- Standardize auth imports to @/lib/auth barrel

Closes: P0 chat wiring, P1 dead button + tier stub + nav link
Closes: P2 orphaned routes + dual auth pattern
```
