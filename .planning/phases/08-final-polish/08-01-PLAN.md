---
phase: 08-final-polish
plan: 01
type: execute
wave: 1
depends_on: []
autonomous: true
gap_closure: true
files_modified:
  - components/chat/chat-interface.tsx
  - app/api/chat/route.ts
  - app/dashboard/page.tsx
  - app/api/fred/reality-lens/route.ts
  - app/dashboard/layout.tsx
  - app/dashboard/check-ins/page.tsx
  - app/dashboard/investor-score/page.tsx
  - app/api/investor-score/route.ts
  - app/api/fred/reality-lens/route.ts
  - app/api/fred/chat/route.ts
  - app/api/fred/decide/route.ts
  - app/api/fred/history/route.ts
  - app/api/fred/memory/route.ts
  - app/api/fred/analyze/route.ts
  - app/api/fred/__tests__/fred-api.test.ts

must_haves:
  truths:
    - "Chat interface calls /api/fred/chat via useFredChat hook (not legacy /api/chat)"
    - "Legacy /api/chat route is deleted"
    - "Dashboard CTA Upgrade Now button has working onClick with error handling"
    - "Reality Lens getUserTier() reads real user tier from subscription (not hardcoded free)"
    - "SMS nav links to /dashboard/sms (not /dashboard/check-ins)"
    - "Legacy /dashboard/investor-score and /api/investor-score are deleted"
    - "All FRED routes import requireAuth from @/lib/auth (not @/lib/supabase/auth-helpers)"
    - "Dashboard stats fetched from real API counts (not hardcoded mocks)"
  artifacts:
    - path: "components/chat/chat-interface.tsx"
      provides: "Chat interface wired to FRED engine"
      contains: "useFredChat"
    - path: "app/dashboard/page.tsx"
      provides: "Dashboard with working CTA and real stats"
  key_links:
    - from: "components/chat/chat-interface.tsx"
      to: "/api/fred/chat"
      via: "useFredChat hook"
      pattern: "useFredChat"
---

# Plan 08-01: Chat FRED Wiring, Dashboard Fixes, Cleanup

**Goal:** Close all remaining v1.0 tech debt — wire chat to FRED engine, fix dead buttons, replace stubs, clean up orphaned code.

## Tasks

### Task 1: Wire chat-interface.tsx to FRED engine via useFredChat hook

**What:** Replace the raw `fetch("/api/chat")` in `components/chat/chat-interface.tsx` with the `useFredChat` hook from `lib/hooks/use-fred-chat.ts`. This hook already calls `/api/fred/chat` with full SSE streaming, XState state tracking, session management, and memory persistence.

**Changes:**
1. In `components/chat/chat-interface.tsx`:
   - Import `useFredChat` and `FredMessage` from `@/lib/hooks/use-fred-chat`
   - Import `CognitiveStateIndicator` from `./cognitive-state-indicator`
   - Replace the component's internal state management (`useState` for messages, isLoading) with the hook
   - The hook provides: `messages`, `sendMessage`, `state`, `isProcessing`, `error`, `clearError`, `reset`
   - Map `FredMessage` to the existing `Message` type used by `ChatMessage` component (both have `id`, `content`, `role`, `timestamp`)
   - Add initial greeting message via `useState` for the FRED welcome message (the hook starts with empty messages)
   - Replace the `handleSendMessage` function body with a call to `sendMessage(content)` from the hook
   - Replace `isLoading` with `isProcessing` from the hook
   - Add `CognitiveStateIndicator` or `CognitiveStepIndicator` above the input area to show FRED's thinking state
   - Remove the manual fetch/error handling — the hook handles all of this

2. In `app/chat/page.tsx`: No changes needed — it just renders `<ChatInterface />`

**Key detail:** The `useFredChat` hook's `FredMessage` has additional fields (`confidence`, `action`, `requiresApproval`, `reasoning`) compared to the basic `Message` type. The `ChatMessage` component can use the base fields initially. The `CognitiveStateIndicator` shows the XState processing stages (analyzing → thinking → synthesizing → responding).

**Verification:**
- `grep -r "/api/chat" components/chat/` returns zero matches
- `components/chat/chat-interface.tsx` imports `useFredChat`
- `CognitiveStateIndicator` or `CognitiveStepIndicator` rendered in the component

### Task 2: Delete legacy /api/chat route

**What:** Delete `app/api/chat/route.ts`. All consumers should now use `/api/fred/chat`.

**Changes:**
1. Delete `app/api/chat/route.ts`
2. Verify no remaining references: `grep -r "api/chat" --include='*.ts' --include='*.tsx'` should return zero matches (excluding `api/fred/chat`)

**Verification:**
- `app/api/chat/route.ts` does not exist
- No imports or fetch calls reference `/api/chat` (only `/api/fred/chat`)

### Task 3: Fix dashboard CTA "Upgrade Now" dead button

**What:** The "Upgrade Now" button at `app/dashboard/page.tsx` lines 351-356 has no onClick handler.

**Changes:**
1. In `app/dashboard/page.tsx`:
   - Import `redirectToCheckoutByTier` from `@/lib/stripe/client`
   - Import `toast` from `sonner` (if not already imported)
   - Add `onClick` handler with error handling:
     ```
     onClick={async () => {
       try {
         await redirectToCheckoutByTier("pro");
       } catch (e: any) {
         toast.error(e.message || "Failed to start upgrade");
       }
     }}
     ```
   - The button is inside a `{user.tier === 0 && (...)}` conditional, so it only shows for free users — "pro" is the correct upgrade target

**Verification:**
- Button has an `onClick` handler with try/catch and toast.error
- `redirectToCheckoutByTier` imported and called

### Task 4: Fix Reality Lens getUserTier() stub

**What:** Replace the hardcoded `getUserTier` stub in `app/api/fred/reality-lens/route.ts` with a real subscription lookup.

**Changes:**
1. In `app/api/fred/reality-lens/route.ts`:
   - Import `getTierForRequest` from `@/lib/api/tier-middleware` (this function already does the full subscription lookup chain: getUserSubscription -> getPlanByPriceId -> getTierFromString)
   - Import `UserTier` from `@/lib/constants`
   - Replace the stub `getUserTier` function with a thin wrapper that uses the existing tier middleware and maps `UserTier` enum to `RealityLensTier` string:
     ```
     async function getUserTier(userId: string, request: Request): Promise<RealityLensTier> {
       try {
         const tier = await getTierForRequest(request);
         const tierMap: Record<number, RealityLensTier> = { 0: "free", 1: "pro", 2: "studio" };
         return tierMap[tier] || "free";
       } catch {
         return "free";
       }
     }
     ```
   - Update the call site to pass `request` to `getUserTier(userId, request)` (the POST handler already has the `request` parameter)
   - Remove the `TODO` comment
   - Note: This avoids duplicating the subscription lookup logic from tier-middleware.ts. If `getTierForRequest` doesn't fit (it may extract userId from auth internally), fall back to importing `getUserSubscription` + `getPlanByPriceId` + `getTierFromString` directly and compose the chain, but still map the UserTier enum to RealityLensTier string.

**Verification:**
- No `TODO` in the getUserTier function
- Function uses tier-middleware imports (not duplicated subscription logic)
- Function body maps UserTier enum to RealityLensTier string

### Task 5: Fix SMS nav link and delete check-ins mockup

**What:** Dashboard nav "Weekly Check-ins" points to `/dashboard/check-ins` (static mockup) instead of `/dashboard/sms` (functional page).

**Changes:**
1. In `app/dashboard/layout.tsx` line 114:
   - Change `href: "/dashboard/check-ins"` to `href: "/dashboard/sms"`
2. Delete `app/dashboard/check-ins/page.tsx` (static mockup, no other consumers)
   - **Important:** Do NOT delete `/app/check-ins/*` routes (e.g., `app/check-ins/page.tsx`, `app/check-ins/[checkInId]/page.tsx`, `app/check-ins/configure/page.tsx`, `app/api/check-ins/route.ts`). These are separate functional pages, not mockups. Only the dashboard mockup at `app/dashboard/check-ins/page.tsx` should be deleted.

**Verification:**
- `grep "check-ins" app/dashboard/layout.tsx` returns zero matches
- `app/dashboard/check-ins/` directory does not exist
- Nav item href is `/dashboard/sms`

### Task 6: Delete legacy orphaned routes

**What:** Delete orphaned `/dashboard/investor-score` page and `/api/investor-score` route. These were replaced by `/dashboard/investor-readiness` and `/api/fred/investor-readiness`.

**Changes:**
1. Delete `app/dashboard/investor-score/page.tsx`
2. Delete `app/api/investor-score/route.ts`
3. Verify no remaining references to either path

**Verification:**
- Neither file exists
- `grep -r "investor-score" --include='*.ts' --include='*.tsx'` returns zero matches

### Task 7: Standardize auth imports

**What:** FRED routes (7 files) import `requireAuth` from `@/lib/supabase/auth-helpers`. All other routes (46 files) import from `@/lib/auth`. Standardize FRED routes to use `@/lib/auth` since it's the public API barrel.

**Changes:**
1. In these 6 files (excluding the test file), replace:
   `import { requireAuth } from "@/lib/supabase/auth-helpers"` → `import { requireAuth } from "@/lib/auth"`
   - `app/api/fred/reality-lens/route.ts`
   - `app/api/fred/chat/route.ts`
   - `app/api/fred/decide/route.ts`
   - `app/api/fred/history/route.ts`
   - `app/api/fred/memory/route.ts`
   - `app/api/fred/analyze/route.ts`
2. In the test file, update similarly:
   - `app/api/fred/__tests__/fred-api.test.ts`

**Verification:**
- `grep -r "supabase/auth-helpers" --include='*.ts' --include='*.tsx'` returns only `lib/supabase/auth-helpers.ts` itself (the source module) and `lib/auth.ts` (the barrel)
- All FRED route files import from `@/lib/auth`

### Task 8: Replace dashboard hardcoded stats with real API data

**What:** The dashboard page at `app/dashboard/page.tsx` has hardcoded mock stats (lines ~117-146) and fake recent activity (lines ~183-202). Replace with real data fetched from existing APIs.

**Changes:**
1. In `app/dashboard/page.tsx`:
   - Add a `useEffect` that fetches real counts on mount from existing endpoints:
     - Ideas analyzed: `GET /api/fred/reality-lens` count or query `fred_analyses` table
     - Pitch decks reviewed: `GET /api/fred/pitch-review` count
     - Check-ins completed: `GET /api/sms/preferences?include=history` checkin count
     - Active agents: `GET /api/agents/tasks?status=running` count
   - Create a new API endpoint `GET /api/dashboard/stats` that aggregates these counts server-side (preferred — single fetch), OR fetch from individual endpoints (simpler but more requests)
   - The simplest approach: create `app/api/dashboard/stats/route.ts` that runs 4 count queries against Supabase and returns `{ ideasAnalyzed, pitchDecksReviewed, checkInsCompleted, activeAgents }`
   - Replace the hardcoded `stats` array with fetched values, using "0" as default while loading
   - For `recentActivity`: fetch the 5 most recent items across relevant tables (fred_analyses, pitch_reviews, strategy_documents) ordered by created_at, or simply remove the hardcoded data and show "No recent activity" until real data exists
   - Add loading state for stats (show skeleton or "—" while loading)

2. Create `app/api/dashboard/stats/route.ts`:
   - GET handler with `requireAuth()`
   - Query counts from: fred_analyses (or reality lens assessments), pitch_reviews, sms_checkins, agent_tasks (status = 'running' or 'pending')
   - Return `{ ideasAnalyzed, pitchDecksReviewed, checkInsCompleted, activeAgents, recentActivity: [...] }`
   - Graceful fallback: return 0 for any failed count query

**Verification:**
- `grep "Mock stats" app/dashboard/page.tsx` returns zero matches
- `app/api/dashboard/stats/route.ts` exists
- Dashboard page fetches from `/api/dashboard/stats`
- No hardcoded stat values remain in the stats array

## Commit Message

```
fix: wire chat to FRED engine, fix dead buttons, clean up tech debt

- Replace legacy /api/chat with useFredChat hook (XState, memory, SSE)
- Add cognitive state indicator to chat interface
- Fix dashboard CTA "Upgrade Now" button (was dead, now calls Stripe)
- Fix Reality Lens getUserTier() stub (now reads real subscription)
- Fix SMS nav link (check-ins mockup → functional /dashboard/sms)
- Delete orphaned legacy routes (investor-score, check-ins, /api/chat)
- Standardize auth imports to @/lib/auth barrel
- Replace hardcoded dashboard stats with real API data

Closes: P0 chat wiring, P1 dead button + tier stub + nav link
Closes: P2 orphaned routes + dual auth pattern + mock stats
```
