---
phase: 39-missing-frameworks-gated-reviews
plan: 01
type: execute
wave: 4
depends_on: ["37-01", "38-01"]
files_modified:
  - lib/fred/irs/engine.ts
  - lib/fred/actors/execute.ts
  - lib/ai/prompts.ts
  - app/api/fred/chat/route.ts
  - lib/db/conversation-state.ts
  - app/api/fred/pitch-review/route.ts
  - lib/fred/pitch/types.ts
  - lib/fred/pitch/analyzers/index.ts
autonomous: true
status: complete
completed: 2026-02-11
commit: d782112
---

# Phase 39 Plan 01: IRS Scoring, Deck Protocol, and Gated Pitch Review

**Status:** COMPLETE (Retroactive Documentation)
**Commit:** d782112c0f5723d42b782f046fbe0341bd834837
**Date:** 2026-02-11

<objective>
Wire IRS scoring, Deck Request Protocol, and gated Pitch Deck Review into the FRED conversation pipeline so investor readiness is assessed automatically, decks are requested only after a verdict, and deck reviews are gated behind Reality Lens validation.

**Success criteria (from ROADMAP.md Phase 39):**
1. IRS framework fully implemented — AI scoring across 6 categories with stage benchmarks
2. Deck Request Protocol formalized — provisional verdict first, then deck request decision
3. Pitch Deck Review gated behind Reality Lens — 403 if upstream not validated
4. Per-slide investor objections generated as part of gated review
</objective>

<context>
Phase 39 builds on the gating logic from Phase 37 and framework integration patterns from Phase 38. It activates three investor-readiness capabilities that were partially built but not wired into the conversation flow:

1. **IRS Engine** (existing code in `lib/fred/irs/`) — Had full scoring logic but no adapter to convert conversation state into IRSInput
2. **Investor Lens Framework** (from Phase 03) — Had `shouldRequestDeck()` logic but no integration with conversation state or verdict tracking
3. **Pitch Review API** (existing) — Had 11-dimension review but no Reality Lens gate

Phase 39 connects these pieces into the active FRED conversation pipeline.
</context>

<tasks>

<task id="1">
  <name>IRS Conversation Adapter and Auto-Trigger</name>
  <files>
    - lib/fred/irs/engine.ts
    - lib/fred/actors/execute.ts
  </files>
  <description>
Build an adapter that maps conversation data (founderSnapshot + diagnosticTags) to structured IRSInput, and wire auto-scoring into the execute actor with appropriate triggers.

**What was built:**

1. **calculateIRSFromConversation()** in `lib/fred/irs/engine.ts`:
   - Adapter function that maps founderSnapshot and diagnosticTags to IRSInput structure
   - Uses helper functions: `parseNumericHint()` to handle "$50k", "10000", "5" with k/K expansion
   - Uses `mapProductStatus()` to normalize status strings (idea/concept/proto/mvp/beta/launched/live/market/scaling)
   - Reuses existing `normalizeStage()` for stage mapping
   - Slices conversationExcerpt to 2000 chars for product description

2. **triggerIRSScoring()** in `lib/fred/actors/execute.ts`:
   - Fire-and-forget IRS trigger with three conditions:
     - `activeMode === "investor-readiness"`
     - 3+ investor signals detected
     - 24h cooldown since last IRS calculation
   - Uses `getLatestIRS()` for cooldown check
   - Calls `calculateIRSFromConversation()` and persists via `saveIRSResult()`
   - .catch() to prevent blocking the response

3. **extractAndPersistVerdict()** in `lib/fred/actors/execute.ts`:
   - Detects FRED's provisional investor verdict from response text
   - Regex patterns: "my verdict is", "IC verdict:", "verdict --" with markdown bold handling
   - Normalizes to "yes" | "no" | "not-yet" (handles "Not Yet" -> "not-yet")
   - Persists to `formalAssessments.verdictIssued` and `verdictValue` via `updateFormalAssessments()`

**Integration point:** Called from `updateConversationState()` in execute.ts (fire-and-forget)
  </description>
  <verification>
IRS adapter correctly maps conversation state to IRSInput structure. Auto-trigger fires when conditions met (3+ investor signals, investor-readiness mode, 24h cooldown). Verdict extraction detects and persists provisional verdicts from FRED responses.
  </verification>
</task>

<task id="2">
  <name>Prompt Blocks for IRS, Deck Protocol, and Review Readiness</name>
  <files>
    - lib/ai/prompts.ts
    - lib/db/conversation-state.ts
    - lib/fred/pitch/types.ts
  </files>
  <description>
Build prompt injection blocks that give FRED context about the founder's investor readiness, enforce deck request protocol, and signal when 11-dimension review is available.

**What was built:**

1. **buildIRSPromptBlock()** in `lib/ai/prompts.ts`:
   - Handles three states:
     - No IRS yet: Instructions to assess without mentioning the score system
     - Stale IRS (>7 days): Shows scores but notes they're outdated
     - Fresh IRS (<7 days): Full breakdown with category scores + stage benchmark comparison
   - For each category: shows score with +/- arrow comparing to stage benchmark
   - Includes stage benchmarks table (idea/pre-seed/seed/series-a)
   - Enforces Operating Bible rule: "Do NOT mention the score system to the founder unless they ask"

2. **buildDeckProtocolBlock()** in `lib/ai/prompts.ts`:
   - Enforces verdict-before-deck decision tree:
     - If no verdict issued: Instruct FRED to issue provisional verdict first
     - If verdict issued but deck not requested: Use `shouldRequestDeck()` from investor-lens to decide
     - If deck already uploaded: Skip request, proceed to review readiness
   - Integrates `shouldRequestDeck()` from `lib/ai/frameworks/investor-lens.ts`
   - Hardcodes `mentionsFundraising: true` (always true in investor-readiness mode)
   - Tracks `deckRequested` state in formalAssessments

3. **buildDeckReviewReadyBlock()** in `lib/ai/prompts.ts`:
   - Returns block only when:
     - Reality Lens gate is open for pitch_deck (all upstream dimensions validated)
     - Provisional verdict has been issued
   - Signals FRED that 11-dimension pitch deck review is available
   - Returns empty string when conditions not met (safe for concatenation)

4. **Extended ModeContext.formalAssessments** in `lib/db/conversation-state.ts`:
   - Added fields:
     - `verdictIssued: boolean` — tracks if provisional verdict was given
     - `verdictValue: "yes" | "no" | "not-yet" | null` — stores the verdict
     - `deckRequested: boolean` — tracks if FRED asked for deck upload
   - Backward-compatible with existing `offered` and `accepted` fields

5. **Added SlideObjection interface** in `lib/fred/pitch/types.ts`:
   - `question: string` — skeptical investor question
   - `knockoutAnswer: string` — suggested response that addresses objection
   - `severity: "high" | "medium" | "low"` — deal-breaker vs. manageable vs. minor

**Integration point:** Blocks assembled in chat route when `activeMode === "investor-readiness"`
  </description>
  <verification>
Prompt blocks correctly inject IRS context, enforce deck request protocol, and signal review readiness. ModeContext stores verdict and deck request state. SlideObjection type supports investor objections.
  </verification>
</task>

<task id="3">
  <name>Chat Pipeline Integration and Pitch Review Gate</name>
  <files>
    - app/api/fred/chat/route.ts
    - app/api/fred/pitch-review/route.ts
    - lib/fred/pitch/analyzers/index.ts
  </files>
  <description>
Wire Phase 39 blocks into the chat route's context assembly, gate the pitch review API behind Reality Lens validation, and enhance slide analysis with investor objections.

**What was built:**

1. **Chat route Phase 39 block loading** in `app/api/fred/chat/route.ts`:
   - Conditional loading: only when `activeMode === "investor-readiness"`
   - Loads latest IRS via `getLatestIRS()`
   - Builds IRS block via `buildIRSPromptBlock(latestIRS, founderStage)`
   - Loads `formalAssessments` from mode context via `getActiveMode(userId)`
   - Builds deck protocol block via `buildDeckProtocolBlock(formalAssessments, hasUploadedDeck, founderStage)`
   - Checks RL gate status and builds deck review ready block via `buildDeckReviewReadyBlock()`
   - Non-blocking try/catch (established pattern from Phases 36-38)
   - Assembles blocks into `fullContext` alongside existing founderContext, stepGuidance, RL, and framework blocks

2. **Pitch review Reality Lens gate** in `app/api/fred/pitch-review/route.ts`:
   - Loads RL gate via `getRealityLensGate(userId)`
   - Checks gate status via `checkGateStatus(rlGate, "pitch_deck")`
   - Returns 403 with `RL_GATE_BLOCKED` code if gate closed
   - Response includes:
     - `blockingDimensions`: array of weak/unassessed dimensions
     - `guidance`: user-friendly text ("Chat with FRED to work through your {dims} assumptions")
   - Wrapped in try/catch with graceful degradation (if gate check fails, review proceeds)

3. **Per-slide investor objections** in `lib/fred/pitch/analyzers/index.ts`:
   - Extended Zod schema with `SlideObjectionSchema`
   - Prompt updated to generate "2-3 skeptical investor questions a VC partner would ask"
   - Each objection includes:
     - Question (the investor's concern)
     - Knockout answer (how to address it)
     - Severity (high = deal-breaker, medium = manageable, low = minor flag)
   - Result capped at 3 objections via `.slice(0, 3)`
   - Default empty array fallback: `result.objections || []`

**Integration point:** Chat route assembles all blocks into fullContext for AI. Pitch review API enforces gate before execution.
  </description>
  <verification>
Chat route conditionally loads Phase 39 blocks in investor-readiness mode. Pitch review API returns 403 RL_GATE_BLOCKED when upstream dimensions are unvalidated. Slide analyzer generates investor objections with knockout answers.
  </verification>
</task>

</tasks>

<verification>
- [x] IRS adapter maps conversation state to structured IRSInput
- [x] Auto-trigger fires IRS scoring when 3+ investor signals detected (24h cooldown)
- [x] Verdict extraction detects and persists FRED's provisional verdicts
- [x] IRS prompt block injects score summary with stage benchmarks
- [x] Deck protocol block enforces verdict-before-deck rule
- [x] Deck review ready block signals when 11-dimension review is available
- [x] ModeContext.formalAssessments tracks verdictIssued, verdictValue, deckRequested
- [x] Chat route conditionally loads Phase 39 blocks when activeMode === "investor-readiness"
- [x] Pitch review API gated behind Reality Lens (403 RL_GATE_BLOCKED)
- [x] Per-slide investor objections generated with knockout answers
</verification>

<success_criteria>
All 4 requirements from ROADMAP.md Phase 39 are met:

1. **IRS framework fully implemented** — `calculateIRSFromConversation()` adapter maps conversation data to IRSInput, auto-trigger fires with 3+ investor signals and 24h cooldown, prompt block injects scores with stage benchmarks
2. **Deck Request Protocol formalized** — `buildDeckProtocolBlock()` enforces verdict-first rule, integrates `shouldRequestDeck()` logic, tracks verdict and deck request state in formalAssessments
3. **Pitch Deck Review gated behind Reality Lens** — `pitch-review/route.ts` checks RL gate and returns 403 RL_GATE_BLOCKED with blockingDimensions and guidance when upstream not validated
4. **Per-slide investor objections generated** — `analyzers/index.ts` generates 2-3 skeptical questions per slide with knockout answers and severity levels

Phase 39 is production-ready and active in the conversation pipeline.
</success_criteria>

<output>
**Commit:** d782112c0f5723d42b782f046fbe0341bd834837
**Files modified:** 8 (+466/-12 lines)
**Tests:** Covered by existing IRS engine tests and pitch review tests
**Documentation:** This retroactive PLAN.md + accompanying CODE-REVIEW.md
</output>
