---
phase: 19-inbox-ops-agent
plan: 01
type: execute
wave: 2
depends_on: []
files_modified:
  - lib/inbox/types.ts
  - lib/inbox/aggregator.ts
  - app/api/inbox/route.ts
  - app/dashboard/inbox/page.tsx
  - components/inbox/inbox-message.tsx
  - components/inbox/inbox-filter.tsx
autonomous: true

must_haves:
  truths:
    - "InboxMessage and MessagePriority types are exported from lib/inbox/types.ts"
    - "Aggregator queries completed agent tasks, recommendations, and action items from existing tables"
    - "Messages are prioritized: urgent items first, then by recency"
    - "Inbox API returns paginated, filterable messages for the authenticated user"
    - "Inbox page at /dashboard/inbox renders the message hub with filter/sort controls"
    - "Inbox message cards show source agent, priority indicator, timestamp, and action summary"
  artifacts:
    - path: "lib/inbox/types.ts"
      provides: "InboxMessage, MessagePriority, MessageSource type definitions"
      exports: ["InboxMessage", "MessagePriority", "MessageSource"]
    - path: "lib/inbox/aggregator.ts"
      provides: "Aggregator that queries agent_tasks and related tables to produce InboxMessages"
      exports: ["aggregateInboxMessages"]
    - path: "app/api/inbox/route.ts"
      provides: "GET endpoint returning paginated inbox messages"
    - path: "app/dashboard/inbox/page.tsx"
      provides: "Message hub page with list and filters"
    - path: "components/inbox/inbox-message.tsx"
      provides: "Message card component with priority indicator and actions"
      exports: ["InboxMessage"]
    - path: "components/inbox/inbox-filter.tsx"
      provides: "Filter and sort controls for inbox"
      exports: ["InboxFilter"]
  key_links:
    - from: "lib/inbox/aggregator.ts"
      to: "lib/inbox/types.ts"
      via: "imports InboxMessage, MessagePriority types"
      pattern: "import.*InboxMessage.*from.*types"
    - from: "app/api/inbox/route.ts"
      to: "lib/inbox/aggregator.ts"
      via: "calls aggregateInboxMessages() to build message list"
      pattern: "aggregateInboxMessages"
    - from: "app/dashboard/inbox/page.tsx"
      to: "components/inbox/inbox-message.tsx"
      via: "renders InboxMessage cards for each message"
      pattern: "InboxMessage"
    - from: "app/dashboard/inbox/page.tsx"
      to: "components/inbox/inbox-filter.tsx"
      via: "renders InboxFilter for filtering/sorting"
      pattern: "InboxFilter"
---

<objective>
Build an in-app message hub that aggregates and prioritizes output from all virtual agents, giving Studio founders a centralized inbox for agent recommendations, completed tasks, and action items.

Purpose: Currently, agent task outputs (emails drafted, meetings scheduled, fundraising recommendations, growth experiments) are only visible within the individual agent chat interfaces. Studio founders need a unified view of all agent activity so nothing falls through the cracks. This plan builds an inbox page that queries existing agent_tasks data, prioritizes by urgency and recency, and presents it in a filterable message hub.

Output: 2 new files (types, aggregator), 1 new API route, 1 new page, 2 new components. No new npm dependencies. No new database tables (reads from existing agent_tasks table).
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

Key source files (READ ALL BEFORE MODIFYING):
@lib/db/migrations/028_agent_tasks.sql (agent_tasks table schema)
@lib/agents/base-agent.ts (agent execution and task persistence)
@app/dashboard/page.tsx (dashboard layout for reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Types, aggregator, and API</name>
  <files>
    lib/inbox/types.ts
    lib/inbox/aggregator.ts
    app/api/inbox/route.ts
  </files>
  <action>
**Step 1: Create `lib/inbox/types.ts`**

Define the inbox type system:

```typescript
export type MessagePriority = "urgent" | "high" | "normal" | "low";
export type MessageSource = "founder-ops" | "fundraising" | "growth" | "system";
export type MessageStatus = "unread" | "read" | "actioned" | "dismissed";

export interface InboxMessage {
  id: string;
  userId: string;
  source: MessageSource;
  priority: MessagePriority;
  status: MessageStatus;
  title: string;
  summary: string;
  detail?: string;
  actionUrl?: string; // link to relevant page
  agentTaskId?: string; // reference to source agent_task
  createdAt: string;
  readAt?: string;
}

export interface InboxFilters {
  source?: MessageSource;
  priority?: MessagePriority;
  status?: MessageStatus;
  limit?: number;
  offset?: number;
}
```

**Step 2: Create `lib/inbox/aggregator.ts`**

Export `aggregateInboxMessages(userId: string, filters?: InboxFilters): Promise<InboxMessage[]>`:

1. Import createServerClient from `@/lib/supabase/server`
2. Query the `agent_tasks` table for the given user, ordered by created_at desc
3. Filter by status (completed tasks become inbox messages), agent type (maps to MessageSource)
4. Map each agent_task row to an InboxMessage:
   - `source`: derive from agent_tasks.agent_type ("founder_ops" -> "founder-ops", etc.)
   - `priority`: determine from task type and result:
     - Tasks with "urgent" or "critical" in result -> "urgent"
     - Fundraising tasks -> "high" (time-sensitive)
     - Recent tasks (< 24h) -> "high"
     - Default -> "normal"
   - `title`: derive from agent_tasks.tool_name and task context
   - `summary`: extract first 200 chars of task result
   - `detail`: full task result
   - `actionUrl`: map to relevant dashboard page (e.g., fundraising tasks -> /dashboard/investor-targeting)
5. Apply filters (source, priority, status) if provided
6. Apply pagination (limit default 20, offset default 0)
7. Sort: urgent first, then high, then by createdAt desc

Also export `getInboxCount(userId: string): Promise<{ total: number; unread: number; urgent: number }>` for badge counts.

**Step 3: Create `app/api/inbox/route.ts`**

GET endpoint:
1. Authenticate user
2. Parse query params: source, priority, status, limit, offset
3. Call aggregateInboxMessages(userId, filters)
4. Also call getInboxCount(userId) for metadata
5. Return JSON: `{ messages: InboxMessage[], meta: { total, unread, urgent } }`
6. Return 401 if not authenticated
  </action>
  <verify>
1. `test -f lib/inbox/types.ts` -- types exist
2. `grep 'InboxMessage\|MessagePriority\|MessageSource' lib/inbox/types.ts` -- types exported
3. `test -f lib/inbox/aggregator.ts` -- aggregator exists
4. `grep 'aggregateInboxMessages\|getInboxCount' lib/inbox/aggregator.ts` -- functions exported
5. `test -f app/api/inbox/route.ts` -- API exists
6. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
Inbox types defined with InboxMessage, MessagePriority, MessageSource. Aggregator queries agent_tasks table and maps to prioritized inbox messages. API returns paginated, filterable messages with counts.
  </done>
</task>

<task type="auto">
  <name>Task 2: UI page and components</name>
  <files>
    components/inbox/inbox-message.tsx
    components/inbox/inbox-filter.tsx
    app/dashboard/inbox/page.tsx
  </files>
  <action>
**Step 1: Create `components/inbox/inbox-message.tsx`**

"use client" component rendering a single inbox message card:
- Props: `InboxMessage` object + `onAction?: (id: string, action: string) => void`
- Card with left border color coded by priority: urgent = red, high = orange, normal = gray, low = blue
- Layout: flex row with priority dot, source badge, content, timestamp
- Source badge: colored pill showing agent name (e.g., "Founder Ops", "Fundraising", "Growth")
- Content: title (bold), summary (muted text, truncated to 2 lines)
- Timestamp: relative time (e.g., "2h ago") using a simple date formatter
- Action buttons: "View" (links to actionUrl), "Dismiss" (calls onAction)
- Unread indicator: subtle dot or bold title for unread messages

**Step 2: Create `components/inbox/inbox-filter.tsx`**

"use client" component with filter and sort controls:
- Props: `{ filters: InboxFilters; onChange: (filters: InboxFilters) => void }`
- Row of filter controls:
  - Source dropdown: "All Sources", "Founder Ops", "Fundraising", "Growth"
  - Priority dropdown: "All Priorities", "Urgent", "High", "Normal", "Low"
  - Status dropdown: "All", "Unread", "Read", "Actioned"
- "Clear Filters" button when any filter is active
- Compact horizontal layout that wraps on mobile

**Step 3: Create `app/dashboard/inbox/page.tsx`**

"use client" page at /dashboard/inbox:
- Page header: "Inbox" with unread/urgent count badges
- InboxFilter component at top
- Scrollable list of InboxMessage cards
- Fetch from GET /api/inbox on mount and when filters change
- Infinite scroll or "Load More" button for pagination
- Empty state: "All caught up! No pending messages." with a checkmark icon
- Loading state: 3-4 skeleton message cards
- Error state: retry button
- Responsive layout: full-width on mobile, max-width on desktop
  </action>
  <verify>
1. `test -f components/inbox/inbox-message.tsx` -- message component exists
2. `test -f components/inbox/inbox-filter.tsx` -- filter component exists
3. `test -f app/dashboard/inbox/page.tsx` -- page exists
4. `grep 'InboxMessage' app/dashboard/inbox/page.tsx` -- message component used
5. `grep 'InboxFilter' app/dashboard/inbox/page.tsx` -- filter component used
6. `npx tsc --noEmit` passes with no errors
  </verify>
  <done>
InboxMessage card renders priority-coded messages with source badge, content, and actions. InboxFilter provides source/priority/status filtering. Inbox page at /dashboard/inbox aggregates agent output into a filterable, paginated message hub.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Types and aggregator:**
   ```bash
   test -f lib/inbox/types.ts && test -f lib/inbox/aggregator.ts && echo "EXISTS"
   ```

2. **API route:**
   ```bash
   test -f app/api/inbox/route.ts && echo "EXISTS"
   ```

3. **UI components:**
   ```bash
   test -f components/inbox/inbox-message.tsx && test -f components/inbox/inbox-filter.tsx && echo "EXISTS"
   ```

4. **Page exists:**
   ```bash
   test -f app/dashboard/inbox/page.tsx && echo "EXISTS"
   ```

5. **TypeScript compiles:**
   ```bash
   npx tsc --noEmit
   ```
</verification>

<success_criteria>
- InboxMessage type includes source, priority, status, title, summary, and action URL
- Aggregator queries agent_tasks table and maps results to prioritized InboxMessages
- Inbox API returns paginated messages with filter support and count metadata
- Message cards show priority color, source badge, content summary, and action buttons
- Filter controls allow filtering by source, priority, and status
- Inbox page renders filterable message list with loading, empty, and error states
- No new database tables needed (reads from existing agent_tasks)
- No new npm dependencies
- TypeScript compiles with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-inbox-ops-agent/19-01-SUMMARY.md`
</output>
