# Phase 28-01: Push Notification Preferences + Deep Linking

**Phase:** 28 — Web Push Notifications
**Plan:** 01 of 2
**Status:** PENDING
**Depends on:** None (core push infrastructure already complete)

## Goal

The core push notification system is fully built (service worker, subscription management, triggers, settings UI). This plan adds per-notification-type preference toggles so users can control which push notifications they receive, and enhances notification payloads with deep links for direct navigation to relevant content.

## Steps

### Step 1: Add notification preference categories to push subscription
**Files:** `lib/push/preferences.ts`
Create a preferences module that defines notification categories and manages user preferences:
- Categories: `red_flags`, `wellbeing_alerts`, `agent_completions`, `inbox_messages`, `weekly_digest`
- Each category has: `enabled` (boolean), `label` (display name), `description` (help text)
- `getPreferences(userId)` — read from `notification_configs` table or return defaults
- `updatePreferences(userId, category, enabled)` — update specific category
- Default all categories to `true` (opt-out model)
- Store preferences as JSON in `notification_configs` table (extend existing schema if needed)

### Step 2: Gate push triggers by user preferences
**Files:** `lib/push/triggers.ts`
Update the 4 existing trigger functions to check preferences before sending:
- `notifyRedFlag()` — check `red_flags` preference
- `notifyWellbeingAlert()` — check `wellbeing_alerts` preference
- `notifyAgentComplete()` — check `agent_completions` preference
- `notifyInboxMessage()` — check `inbox_messages` preference
- Import `getPreferences()` from preferences module
- If preference is disabled, skip the push silently (no error)

### Step 3: Add preference UI to NotificationSettings
**Files:** `components/settings/NotificationSettings.tsx`
Extend the existing notification settings UI to include per-category toggles:
- Add a "Push Notification Categories" section below the existing push toggle
- Show only when push is subscribed and enabled
- Toggle switches for each category with label and description
- Save changes via API call to `/api/push/preferences`

### Step 4: Create preferences API endpoint
**Files:** `app/api/push/preferences/route.ts`
- GET: Return user's notification preferences (all categories with enabled state)
- PATCH: Update specific category preference `{ category: string, enabled: boolean }`
- Require authentication

### Step 5: Enhance notification payloads with deep links
**Files:** `lib/push/triggers.ts`
Update each trigger to include a contextual URL in the notification payload:
- `notifyRedFlag()` → url: `/dashboard` (red flags widget)
- `notifyWellbeingAlert()` → url: `/dashboard/wellbeing`
- `notifyAgentComplete()` → url: `/dashboard/agents`
- `notifyInboxMessage()` → url: `/dashboard/inbox`
- The service worker already handles click-to-url navigation

## Verification

- [ ] `lib/push/preferences.ts` exists with getPreferences/updatePreferences
- [ ] All 4 triggers check preferences before sending
- [ ] NotificationSettings shows per-category toggles when push is active
- [ ] `/api/push/preferences` route handles GET and PATCH
- [ ] Each trigger includes a contextual deep link URL
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- `lib/push/preferences.ts` — new notification preference management module
- `lib/push/triggers.ts` — added preference checks and deep link URLs
- `components/settings/NotificationSettings.tsx` — added per-category toggle UI
- `app/api/push/preferences/route.ts` — new preferences API endpoint
