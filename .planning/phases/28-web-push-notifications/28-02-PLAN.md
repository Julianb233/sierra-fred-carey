# Phase 28-02: Push Notification History + Delivery Analytics

**Phase:** 28 — Web Push Notifications
**Plan:** 02 of 2
**Status:** COMPLETE
**Depends on:** 28-01

## Goal

Add notification delivery tracking and a user-facing notification history page so users can see past notifications and admins can monitor delivery metrics.

## Steps

### Step 1: Create push notification log table
**Files:** `lib/db/migrations/044_push_notification_logs.sql`
Create a migration for tracking sent notifications:
- Table: `push_notification_logs`
- Columns: id (UUID), user_id (text), category (text), title (text), body (text), url (text), status (text: sent/failed/clicked), error_message (text nullable), sent_at (timestamptz), clicked_at (timestamptz nullable)
- RLS policies for user-scoped access + service role
- Index on (user_id, sent_at DESC)

### Step 2: Log sends in push triggers
**Files:** `lib/push/triggers.ts`
After each `sendPushToUser()` call, insert a log entry with the notification details and delivery status.

### Step 3: Create notification history page
**Files:** `app/dashboard/notifications/page.tsx`
User-facing notification history page:
- List past notifications with title, body, timestamp, category badge
- Click to navigate to the deep link URL
- Paginated (20 per page)
- Filter by category
- "Mark all as read" functionality (visual only, no separate read tracking needed)

### Step 4: Add notification count to dashboard nav
**Files:** `components/dashboard/nav.tsx` or equivalent
Add an unread notification count badge to the notifications nav item:
- Count notifications sent in last 24h that haven't been clicked
- Show as a small badge number on the nav icon

## Verification

- [ ] Migration file exists at `lib/db/migrations/044_push_notification_logs.sql`
- [ ] Push triggers log delivery status
- [ ] Notification history page loads at `/dashboard/notifications`
- [ ] Page shows paginated notification list with category badges
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- `lib/db/migrations/044_push_notification_logs.sql` — new push notification log table
- `lib/push/triggers.ts` — added delivery logging after sends
- `app/dashboard/notifications/page.tsx` — new notification history page
- Nav component — added unread notification count badge
