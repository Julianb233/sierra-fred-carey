# Phase 35-01: Onboarding-to-FRED Handoff

```yaml
wave: 1
depends_on: [34]
files_modified:
  - lib/fred/context-builder.ts
  - lib/ai/guards/prompt-guard.ts (Phase 34 fix, supports this)
  - lib/db/migrations/050_founder_snapshot_columns.sql (db-specialist)
  - lib/db/conversation-state.ts (syncSnapshotFromProfile already existed)
autonomous: true
```

## Objective

Ensure a seamless handoff from onboarding into FRED's first conversation. FRED already knows what onboarding captured and picks up where it left off -- no repeated questions, seamless continuity.

## Tasks

### Task 1: First-Conversation Detection

Add `checkIsFirstConversation(userId)` to context-builder.ts that queries `fred_conversation_state` for the user. If no row exists, this is the user's first chat with FRED.

**Verification:** Function returns `true` for new users, `false` for returning users.

### Task 2: Onboarding Completion Flag

Enhance `loadFounderProfile` to include `onboarding_completed` in the SELECT and return it as part of `FounderProfile`. This flag tells FRED whether onboarding was completed or skipped.

**Verification:** FounderProfile.onboardingCompleted is `true` when profiles.onboarding_completed is true.

### Task 3: Handoff Instructions in Context Block

Update `buildContextBlock` to emit handoff-specific instructions based on three paths:

**Path A: Completed onboarding + first conversation**
- FRED references known data naturally ("You mentioned you're at [stage] working in [industry]...")
- FRED never re-asks stage, industry, challenge, team size, revenue, or funding
- FRED goes deeper: asks about product status, traction, runway, 90-day goal, buyer identity

**Path B: Skipped onboarding + first conversation (no data)**
- FRED runs Universal Entry Flow: "What are you building?", "Who is it for?", "What are you trying to accomplish?"
- FRED gathers Founder Snapshot fields naturally through conversation
- FRED never mentions onboarding or that data is missing

**Path C: Returning user**
- Original behavior: use snapshot, skip known fields

**Verification:** Context block includes appropriate handoff section based on state.

### Task 4: Seed Founder Snapshot on First Chat

On first conversation after onboarding completes, fire-and-forget call to `syncSnapshotFromProfile(userId)` seeds the `fred_conversation_state.founder_snapshot` JSONB from the profiles table data.

**Verification:** After first chat, conversation state founder_snapshot contains stage, industry, etc. from profiles.

### Task 5: Parallel Loading (No Added Latency)

`buildFounderContext` runs `checkIsFirstConversation` in parallel with `loadFounderProfile` and `loadSemanticFacts` using `Promise.all`. Zero added latency to the chat request.

**Verification:** All three queries run in parallel.

## must_haves

- [ ] Onboarding captures full founder snapshot (stage, industry, challenge, revenue, team, funding)
- [ ] FRED's first message after onboarding references what was shared and asks deeper follow-ups
- [ ] If onboarding was skipped, FRED detects missing data and runs Founder Intake Protocol
- [ ] Combined data populates Founder Snapshot in conversation state (dashboard-ready)
- [ ] Zero new TypeScript errors
- [ ] No added latency to chat request critical path

## Implementation Notes

- All changes in `lib/fred/context-builder.ts` (86 insertions, 7 deletions)
- Commit: `5c9ae9f`
- `syncSnapshotFromProfile` uses dynamic import to avoid circular dependencies
- `seedFounderSnapshot` is fire-and-forget (non-blocking) to avoid slowing down the first response
- The handoff instructions are part of the FOUNDER SNAPSHOT context block injected via `{{FOUNDER_CONTEXT}}` placeholder
