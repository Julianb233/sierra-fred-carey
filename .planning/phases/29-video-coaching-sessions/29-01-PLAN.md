# Phase 29-01: Video Session Lifecycle Tracking + Participant Management

**Phase:** 29 — Video Coaching Sessions
**Plan:** 01 of 2
**Status:** PENDING
**Depends on:** None (core LiveKit + coaching UI already complete)

## Goal

The video coaching system is 85-90% built (LiveKit integration, coaching layout, FRED sidebar, session history). This plan completes the session lifecycle by auto-tracking started_at/ended_at/duration, populating the video_participants table, and adding room cleanup.

## Steps

### Step 1: Add session state tracking to coaching layout
**Files:** `components/coaching/coaching-layout.tsx`
Wire the LiveKit connection state changes to update the coaching session record:
- On connection → PATCH session with `status: "in_progress"` and `started_at: new Date()`
- On disconnection → PATCH session with `status: "completed"`, `ended_at: new Date()`, calculate `duration_seconds`
- Use LiveKit's `useConnectionState()` hook or `onConnected`/`onDisconnected` callbacks
- Handle browser close/tab close via `beforeunload` event to attempt session completion

### Step 2: Create participant tracking API
**Files:** `app/api/coaching/participants/route.ts`
Create an API endpoint to record participants joining/leaving:
- POST: Record join event `{ sessionId, userId, name }` → insert into `video_participants`
- PATCH: Record leave event `{ participantId }` → update `left_at` timestamp
- GET: List participants for a session (for session detail view)

### Step 3: Wire participant tracking into VideoRoom
**Files:** `components/video/VideoRoom.tsx`
- On join → POST to `/api/coaching/participants`
- On disconnect → PATCH to update leave time
- Store participantId in component state for cleanup

### Step 4: Add session duration display to history page
**Files:** `app/dashboard/coaching/history/page.tsx`
Enhance the session history display:
- Show formatted duration (e.g., "23m 45s") instead of raw seconds
- Show participant count per session
- Add "In Progress" badge for active sessions
- Auto-refresh active sessions every 30 seconds

### Step 5: Add room cleanup utility
**Files:** `lib/livekit/cleanup.ts`
Create a utility to clean up stale rooms:
- `cleanupStaleSessions()` — find sessions with status "in_progress" older than 2 hours and mark them as "completed"
- Can be called from an admin API or cron job
- Log cleanup actions via structured logger

## Verification

- [ ] Session status auto-updates on connect/disconnect
- [ ] Duration auto-calculated from started_at/ended_at
- [ ] Participant join/leave tracked in video_participants table
- [ ] History page shows formatted duration and participant count
- [ ] Stale session cleanup utility works
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- `components/coaching/coaching-layout.tsx` — added session lifecycle tracking
- `app/api/coaching/participants/route.ts` — new participant tracking API
- `components/video/VideoRoom.tsx` — wired participant join/leave tracking
- `app/dashboard/coaching/history/page.tsx` — enhanced with duration/participant display
- `lib/livekit/cleanup.ts` — new stale session cleanup utility
