# Phase 29-02: Session Recording Config + In-Call Chat Persistence

**Phase:** 29 — Video Coaching Sessions
**Plan:** 02 of 2
**Status:** COMPLETE
**Depends on:** 29-01

## Goal

Enable optional session recording configuration (for when LiveKit credentials are available) and persist in-call FRED sidebar chat messages to the coaching session notes for later review.

## Steps

### Step 1: Add recording toggle to coaching layout
**Files:** `components/coaching/coaching-layout.tsx`
- Add optional recording toggle in the lobby (before connecting)
- Pass recording preference to token generation API
- Display recording indicator when active
- Only show for Studio tier users

### Step 2: Extend token API for recording permission
**Files:** `app/api/livekit/token/route.ts`
- Accept optional `enableRecording` parameter
- If true, add `canPublishData` and recording permissions to token
- Log recording requests

### Step 3: Persist FRED sidebar chat to session notes
**Files:** `components/coaching/coaching-sidebar.tsx`
- On session end (disconnect), compile the FRED chat messages into session notes
- Auto-save to the session via PATCH `/api/coaching/sessions`
- Format: timestamp + role + message for each chat exchange
- Append to any existing manual notes (don't overwrite)

### Step 4: Add FRED chat history to session detail view
**Files:** `components/coaching/session-detail.tsx`
- Display the FRED chat log within the session detail
- Collapsible section "FRED Coaching Notes"
- Show timestamped messages in a readable format
- Distinguish user messages from FRED responses

## Verification

- [ ] Recording toggle visible in lobby for Studio users
- [ ] Token API accepts recording parameter
- [ ] FRED sidebar chat persisted to session notes on disconnect
- [ ] Session detail shows FRED chat history
- [ ] `npx tsc --noEmit` passes
- [ ] `npm run test` passes

## Files Changed

- `components/coaching/coaching-layout.tsx` — recording toggle in lobby
- `app/api/livekit/token/route.ts` — recording permission support
- `components/coaching/coaching-sidebar.tsx` — auto-persist chat to session
- `components/coaching/session-detail.tsx` — display FRED chat history
