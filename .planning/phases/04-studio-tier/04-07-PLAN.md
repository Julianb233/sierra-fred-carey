---
phase: 04-studio-tier
plan: 07
type: execute
wave: 4
depends_on: ["04-01"]
files_modified:
  - lib/stripe/config.ts
  - lib/constants.ts
  - app/api/stripe/webhook/route.ts
  - app/api/stripe/checkout/route.ts
  - components/tier/upgrade-card.tsx
  - components/sms/checkin-settings.tsx
  - app/dashboard/sms/page.tsx
autonomous: true
user_setup:
  - service: stripe
    why: "Studio tier pricing product in Stripe"
    env_vars:
      - name: NEXT_PUBLIC_STRIPE_VENTURE_STUDIO_PRICE_ID
        source: "Stripe Dashboard -> Products -> Create 'Venture Studio' product ($249/mo) -> Copy Price ID (price_xxx)"

must_haves:
  truths:
    - "Users can upgrade from Pro to Studio tier via Stripe checkout"
    - "Studio tier is correctly recognized after subscription webhook"
    - "Stripe webhook handles Studio price ID for tier assignment"
    - "Upgrade card shows Studio tier features and pricing"
    - "SMS check-in settings page allows users to configure phone and preferences"
  artifacts:
    - path: "lib/stripe/config.ts"
      provides: "Updated PLANS with Studio tier features reflecting Phase 04 capabilities"
      contains: "Virtual Team"
    - path: "lib/constants.ts"
      provides: "Updated TIER_FEATURES with Studio tier features"
      contains: "Virtual Team"
    - path: "components/tier/upgrade-card.tsx"
      provides: "Studio tier upgrade card component"
    - path: "components/sms/checkin-settings.tsx"
      provides: "SMS check-in preferences component"
    - path: "app/dashboard/sms/page.tsx"
      provides: "SMS check-in history and settings page"
  key_links:
    - from: "app/api/stripe/webhook/route.ts"
      to: "lib/stripe/config.ts"
      via: "maps Studio price ID to tier"
      pattern: "getPlanByPriceId|venture_studio"
    - from: "components/tier/upgrade-card.tsx"
      to: "app/api/stripe/checkout/route.ts"
      via: "creates checkout session for Studio tier"
      pattern: "fetch.*api/stripe/checkout"
    - from: "app/dashboard/sms/page.tsx"
      to: "lib/db/sms.ts"
      via: "reads/writes SMS preferences"
      pattern: "sms.*preferences|checkin"
---

<objective>
Complete the Studio tier Stripe integration and build the SMS settings/history UI. Update the Stripe config to include Studio tier features, ensure the webhook correctly assigns Studio tier, create upgrade UI, and build the SMS check-in management page.

Purpose: This plan monetizes the Studio tier and gives users control over their SMS check-in preferences. Without this, users can't purchase Studio tier or manage their check-in settings.

Output: Updated Stripe config, upgrade card, SMS settings page with phone number configuration and check-in history.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-studio-tier/04-RESEARCH.md
@.planning/phases/04-studio-tier/04-01-SUMMARY.md
@lib/stripe/config.ts (existing PLANS to update)
@lib/constants.ts (existing TIER_FEATURES to update)
@app/api/stripe/webhook/route.ts (existing webhook to verify Studio handling)
@app/api/stripe/checkout/route.ts (existing checkout flow)
@lib/context/tier-context.tsx (tier detection already handles Studio)
@lib/db/sms.ts (from Plan 05 - SMS database operations)
@lib/sms/types.ts (from Plan 05)
@components/tier/feature-lock.tsx (existing tier UI pattern)
@components/tier/tier-badge.tsx (existing tier badge pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Stripe config update and tier feature alignment</name>
  <files>
    lib/stripe/config.ts
    lib/constants.ts
  </files>
  <action>
**lib/stripe/config.ts:**
Update the existing PLANS object. The VENTURE_STUDIO plan already exists but its features list is generic. Update the features to reflect the actual Phase 04 capabilities:

```typescript
VENTURE_STUDIO: {
  id: "venture_studio",
  name: "Venture Studio",
  price: 249,
  priceId: process.env.NEXT_PUBLIC_STRIPE_VENTURE_STUDIO_PRICE_ID,
  features: [
    "Everything in Fundraising & Strategy",
    "Virtual Team: Founder Ops Agent",
    "Virtual Team: Fundraising Agent",
    "Virtual Team: Growth Agent",
    "Weekly SMS Accountability Check-ins",
    "Boardy Investor/Advisor Matching",
    "Priority AI compute & deeper memory",
  ],
},
```

Do NOT change the FREE or FUNDRAISING plan configs. Only update VENTURE_STUDIO features.

**lib/constants.ts:**
Update the TIER_FEATURES[UserTier.STUDIO] array to match the actual implemented features:

```typescript
[UserTier.STUDIO]: [
  "Everything in Pro tier",
  "Virtual Team: Founder Ops Agent",
  "Virtual Team: Fundraising Agent",
  "Virtual Team: Growth Agent",
  "Weekly SMS Accountability Check-ins",
  "Boardy Investor/Advisor Matching",
  "Priority compute & deeper memory",
],
```

Also verify DASHBOARD_NAV includes the agent and boardy routes (it already has agents at UserTier.PRO and boardy at UserTier.STUDIO -- update agents to UserTier.STUDIO since agents are a Studio feature):

Change the agents nav item from `tier: UserTier.PRO` to `tier: UserTier.STUDIO`.

Add an SMS check-ins nav item:
```typescript
{ id: "sms-checkins", label: "SMS Check-ins", icon: "MessageSquare", href: "/dashboard/sms", tier: UserTier.STUDIO },
```

Verify the existing Stripe webhook handler (app/api/stripe/webhook/route.ts) already handles Studio tier correctly. It uses `getUserTierFromSubscription()` which calls `getPlanByPriceId()` then `getTierFromString()`. Since `getTierFromString` already maps 'venture_studio' to UserTier.STUDIO, and `getPlanByPriceId` will match the VENTURE_STUDIO priceId, the webhook should work correctly without modification. If it does NOT work correctly, fix the mapping.

Similarly verify the checkout route (app/api/stripe/checkout/route.ts) supports tier-based lookup with `tier: 'VENTURE_STUDIO'`. The existing code checks `tierKey in PLANS` which will match. No changes needed if this works.
  </action>
  <verify>Stripe config has updated Studio features. Constants reflect actual capabilities. Dashboard nav includes SMS and corrects agent tier. `npm run build` succeeds.</verify>
  <done>Stripe and constants config aligned with Phase 04 features. Studio tier priceId mapping verified end-to-end through webhook pipeline.</done>
</task>

<task type="auto">
  <name>Task 2: Upgrade card and SMS settings UI</name>
  <files>
    components/tier/upgrade-card.tsx
    components/sms/checkin-settings.tsx
    app/dashboard/sms/page.tsx
  </files>
  <action>
**components/tier/upgrade-card.tsx:**
Create `UpgradeCard` component for promoting Studio tier:
- Props: `{ currentTier: UserTier, targetTier?: UserTier }`
- If currentTier is already STUDIO, show "You're on the Studio plan" with a manage button -> /api/stripe/portal
- If currentTier is PRO, show Studio upgrade card with:
  - Title: "Upgrade to Venture Studio"
  - Price: "$249/month"
  - Feature list from PLANS.VENTURE_STUDIO.features (with checkmark icons)
  - "Upgrade Now" button that POSTs to /api/stripe/checkout with `{ tier: 'VENTURE_STUDIO' }` and redirects to session.url
- If currentTier is FREE, show Pro upgrade first (don't skip tiers)
- Use the orange gradient styling from TIER_BADGES[UserTier.STUDIO]
- Loading state while creating checkout session

**components/sms/checkin-settings.tsx:**
Create `CheckinSettings` component for managing SMS preferences:
- Props: `{ preferences?: UserSMSPreferences, onSave: (prefs: Partial<UserSMSPreferences>) => void }`
- Phone number input with E.164 format hint (e.g., +15551234567)
- Toggle for checkin_enabled (on/off)
- Day-of-week selector (dropdown: Monday-Sunday, default Monday)
- Hour selector (dropdown: 6am-10pm in user's timezone)
- Timezone selector (common US timezones + UTC: America/New_York, America/Chicago, America/Denver, America/Los_Angeles, America/Anchorage, America/Honolulu, UTC)
- "Save Preferences" button that calls onSave
- If no phone number set, show prominent prompt to add one
- Note about A2P compliance: "By enabling SMS check-ins, you consent to receiving weekly messages from Sahara. Reply STOP at any time to opt out."

**app/dashboard/sms/page.tsx:**
"use client" page:
1. Fetch SMS preferences from a new API endpoint or directly (create inline API call to get/update preferences)
2. Actually: create two simple fetch calls inline:
   - GET /api/sms/preferences (you'll need to create this -- OR use a simpler approach: fetch preferences client-side via a dedicated hook or inline fetch to an API that reads user_sms_preferences)
   - POST /api/sms/preferences to save

   For the API: Create a simple inline implementation:
   - Add `app/api/sms/preferences/route.ts` with GET (returns preferences for authenticated user) and POST (updates preferences). Import from lib/db/sms.ts.

3. Show CheckinSettings component with current preferences
4. Below settings, show check-in history: fetch from a GET call that reads sms_checkins for this user
5. Display history as a timeline: outbound messages with linked inbound responses
6. Tier gating: Studio only, show FeatureLock if not Studio
7. Page title: "SMS Check-ins" with subtitle "Weekly accountability to keep you on track"

Add the file `app/api/sms/preferences/route.ts` to files_modified list (it's a small supporting file).
  </action>
  <verify>Upgrade card renders for Pro users with correct pricing. SMS settings page shows preferences form and check-in history. Tier gating works. `npm run build` succeeds.</verify>
  <done>Studio upgrade flow works via Stripe checkout. SMS settings allow phone configuration, schedule customization, and opt-in consent. Check-in history shows timeline of messages.</done>
</task>

</tasks>

<verification>
- lib/stripe/config.ts VENTURE_STUDIO features match Phase 04 capabilities
- lib/constants.ts TIER_FEATURES[STUDIO] updated
- DASHBOARD_NAV includes sms-checkins and corrects agent tier
- UpgradeCard creates Stripe checkout for Studio
- CheckinSettings manages phone, schedule, timezone, opt-in
- /dashboard/sms page renders with settings and history
- `npm run build` succeeds
</verification>

<success_criteria>
- Pro users see Studio upgrade card with $249/mo pricing
- Stripe checkout creates session for Studio tier
- Webhook correctly assigns Studio tier on subscription creation
- SMS settings page allows full preference management
- Check-in history displays outbound/inbound message timeline
- All Studio features properly gated in nav and UI
</success_criteria>

<output>
After completion, create `.planning/phases/04-studio-tier/04-07-SUMMARY.md`
</output>
