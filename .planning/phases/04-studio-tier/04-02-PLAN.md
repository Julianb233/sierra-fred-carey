---
phase: 04-studio-tier
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - lib/agents/founder-ops/agent.ts
  - lib/agents/founder-ops/tools.ts
  - lib/agents/founder-ops/prompts.ts
  - app/api/agents/route.ts
  - app/api/agents/[agentId]/route.ts
autonomous: true

must_haves:
  truths:
    - "User can dispatch a task to the Founder Ops Agent via API"
    - "Founder Ops Agent can draft emails, create tasks, and suggest meeting agendas"
    - "Agent task status is tracked in the database from pending through completion"
    - "API enforces Studio tier gating"
  artifacts:
    - path: "lib/agents/founder-ops/agent.ts"
      provides: "Founder Ops agent runner function"
      exports: ["runFounderOpsAgent"]
    - path: "lib/agents/founder-ops/tools.ts"
      provides: "Domain tools: draftEmail, createTask, scheduleMeeting, weeklyPriorities"
      exports: ["founderOpsTools"]
    - path: "lib/agents/founder-ops/prompts.ts"
      provides: "System prompt for Founder Ops agent"
      exports: ["FOUNDER_OPS_SYSTEM_PROMPT"]
    - path: "app/api/agents/route.ts"
      provides: "POST /api/agents to dispatch agent tasks, GET to list tasks"
      exports: ["POST", "GET"]
    - path: "app/api/agents/[agentId]/route.ts"
      provides: "GET /api/agents/:agentId for agent task status"
      exports: ["GET"]
  key_links:
    - from: "lib/agents/founder-ops/agent.ts"
      to: "lib/agents/base-agent.ts"
      via: "uses runAgent base function"
      pattern: "import.*runAgent.*from.*base-agent"
    - from: "app/api/agents/route.ts"
      to: "lib/agents/machine.ts"
      via: "creates orchestrator instance and dispatches task"
      pattern: "agentOrchestratorMachine|createActor"
    - from: "app/api/agents/route.ts"
      to: "lib/db/agent-tasks.ts"
      via: "persists task to database"
      pattern: "createAgentTask|getAgentTasks"
---

<objective>
Implement the Founder Ops Agent -- the first specialist agent in the virtual team. This agent helps founders with operational tasks: email drafting, task/todo management, meeting prep, and weekly priority setting. Also create the shared API routes for dispatching and querying agent tasks.

Purpose: The Founder Ops Agent is the core operational assistant. Building it first (alongside shared API routes) validates the full agent pipeline: API -> orchestrator -> agent -> tools -> result.

Output: Founder Ops agent with 4 domain tools, system prompt, and API routes for agent dispatch/status.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-studio-tier/04-RESEARCH.md
@.planning/phases/04-studio-tier/04-01-SUMMARY.md
@lib/agents/types.ts (from Plan 01)
@lib/agents/base-agent.ts (from Plan 01)
@lib/agents/machine.ts (from Plan 01)
@lib/db/agent-tasks.ts (from Plan 01)
@lib/ai/fred-client.ts (generateStructuredReliable pattern)
@lib/ai/providers.ts (getModel)
@lib/auth.ts (requireAuth pattern)
@lib/middleware/tier-gate.ts (tier gating pattern)
@lib/constants.ts (UserTier enum)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Founder Ops Agent implementation</name>
  <files>
    lib/agents/founder-ops/agent.ts
    lib/agents/founder-ops/tools.ts
    lib/agents/founder-ops/prompts.ts
  </files>
  <action>
**lib/agents/founder-ops/prompts.ts:**
Export `FOUNDER_OPS_SYSTEM_PROMPT` as a string constant:
```
You are the Founder Ops Agent for Sahara, channeling Fred Cary's decades of experience helping founders execute effectively.

Your domain: operational excellence for startup founders.
- Email drafting: Professional, concise emails tailored to recipient and context
- Task management: Prioritized tasks with deadlines and clear ownership
- Meeting preparation: Agendas, key questions, expected outcomes
- Weekly priorities: Top 3-5 priorities based on founder's current stage and goals

Principles:
- Be actionable and specific. No vague advice.
- Every output should be immediately usable.
- Prioritize ruthlessly -- founders have limited bandwidth.
- Frame operational work in terms of business outcomes.
- Keep outputs concise. Founders don't read essays.

When using tools, prefer structured outputs. Always explain WHY you're recommending something, not just WHAT.
```

**lib/agents/founder-ops/tools.ts:**
Export `founderOpsTools` object containing 4 tools using Vercel AI SDK `tool()`:

1. `draftEmail` - parameters: { recipient: string, subject: string, context: string, tone: 'formal'|'casual'|'urgent' }. Execute: use `generateStructuredReliable()` from fred-client to generate { subject: string, body: string, suggestedFollowUp?: string }. Return the structured object.

2. `createTask` - parameters: { title: string, priority: 'low'|'medium'|'high'|'critical', dueDate?: string, category: string, rationale: string }. Execute: return { taskId: crypto.randomUUID(), title, priority, dueDate, category, rationale, status: 'created' }. (No DB write in the tool itself -- the orchestrator handles persistence via agent output.)

3. `scheduleMeeting` - parameters: { attendees: string[], topic: string, duration: number (minutes), keyQuestions: string[] }. Execute: use generateStructuredReliable to create { agenda: string[], preparationItems: string[], expectedOutcomes: string[] }. Return the structured result.

4. `weeklyPriorities` - parameters: { currentGoals: string[], blockers: string[], recentWins: string[] }. Execute: use generateStructuredReliable to create { priorities: Array<{ title: string, why: string, metric: string }>, dropCandidates: string[], quickWins: string[] }. Return the structured result.

Import `tool` from 'ai', `z` from 'zod', `generateStructuredReliable` from '@/lib/ai/fred-client'.

**lib/agents/founder-ops/agent.ts:**
Export `async function runFounderOpsAgent(task: AgentTask): Promise<AgentResult>`:
- Import `runAgent` from '../base-agent', `founderOpsTools` from './tools', `FOUNDER_OPS_SYSTEM_PROMPT` from './prompts'
- Call `runAgent({ agentType: 'founder_ops', systemPrompt: FOUNDER_OPS_SYSTEM_PROMPT, tools: founderOpsTools, maxSteps: 8 }, task)`
- Return the result
  </action>
  <verify>TypeScript compilation passes. All tool schemas validate. Agent function is callable with an AgentTask.</verify>
  <done>Founder Ops Agent has 4 domain tools (email, tasks, meetings, priorities), a Fred-Cary-aligned system prompt, and uses the base agent runner.</done>
</task>

<task type="auto">
  <name>Task 2: Agent API routes (shared by all agents)</name>
  <files>
    app/api/agents/route.ts
    app/api/agents/[agentId]/route.ts
  </files>
  <action>
**app/api/agents/route.ts:**

POST handler - Dispatch a task to an agent:
1. `requireAuth()` to get userId
2. Validate request body with Zod: `{ agentType: z.enum(['founder_ops', 'fundraising', 'growth']), taskType: z.string(), description: z.string().min(1).max(5000), input: z.record(z.unknown()).optional() }`
3. Check tier gating: user must be Studio tier (UserTier.STUDIO). Use the pattern from existing tier-gated routes -- fetch user subscription and check tier. Return 403 with upgrade message if not Studio.
4. Check rate limit: query `getActiveAgentTasks(userId)` and reject if count >= 5 (prevent runaway agent usage)
5. Create task in DB via `createAgentTask({ userId, agentType, taskType, description, input })`
6. Start agent execution asynchronously: import `createActor` from 'xstate', create actor from `agentOrchestratorMachine`, send DISPATCH event. Use `waitFor` or fire-and-forget pattern -- the agent updates the DB task status as it runs. Do NOT await full completion (agents may take 30+ seconds).
7. Return 201 with `{ taskId, status: 'pending', agentType }`

GET handler - List agent tasks for the user:
1. `requireAuth()` to get userId
2. Parse query params: agentType (optional), status (optional), limit (default 20), offset (default 0)
3. Call `getAgentTasks(userId, { agentType, status, limit, offset })`
4. Return 200 with tasks array

**app/api/agents/[agentId]/route.ts:**

GET handler - Get a specific agent task:
1. `requireAuth()` to get userId
2. Extract taskId from params (the `agentId` segment is actually the task ID)
3. Call `getAgentTask(taskId)`
4. Verify task.userId === userId (security check)
5. Return 200 with task or 404 if not found/not owned

Follow the existing API route patterns in the codebase (see app/api/stripe/checkout/route.ts for auth + validation pattern). Use NextRequest/NextResponse from 'next/server'.
  </action>
  <verify>`curl -X POST /api/agents` with valid body returns 201. `curl -X GET /api/agents` returns task list. TypeScript compiles cleanly.</verify>
  <done>Agent API routes handle task dispatch (with tier gating and rate limiting), task listing, and individual task status queries. Fire-and-forget execution prevents request timeouts.</done>
</task>

</tasks>

<verification>
- lib/agents/founder-ops/ directory has agent.ts, tools.ts, prompts.ts
- POST /api/agents creates a task and returns 201 with taskId
- GET /api/agents returns task list for authenticated user
- GET /api/agents/:taskId returns individual task
- Tier gating rejects non-Studio users with 403
- `npm run build` succeeds
</verification>

<success_criteria>
- Founder Ops Agent has 4 working tools that produce structured output
- API routes enforce auth, Studio tier gate, and rate limiting
- Agent execution is async (fire-and-forget from API perspective)
- Task lifecycle tracked in database (pending -> running -> complete/failed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-studio-tier/04-02-SUMMARY.md`
</output>
