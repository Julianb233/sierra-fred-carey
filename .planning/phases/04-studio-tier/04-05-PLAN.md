---
phase: 04-studio-tier
plan: 05
type: execute
wave: 3
depends_on: ["04-01", "04-02", "04-03", "04-04"]
files_modified:
  - lib/sms/client.ts
  - lib/sms/scheduler.ts
  - lib/sms/templates.ts
  - lib/sms/webhook-handler.ts
  - lib/sms/types.ts
  - lib/db/sms.ts
  - app/api/sms/webhook/route.ts
  - app/api/cron/weekly-checkin/route.ts
  - vercel.json
autonomous: true
user_setup:
  - service: twilio
    why: "SMS sending and receiving for weekly check-ins"
    env_vars:
      - name: TWILIO_ACCOUNT_SID
        source: "Twilio Console -> Account Info -> Account SID"
      - name: TWILIO_AUTH_TOKEN
        source: "Twilio Console -> Account Info -> Auth Token"
      - name: TWILIO_MESSAGING_SERVICE_SID
        source: "Twilio Console -> Messaging -> Services -> Create/select service -> SID"
    dashboard_config:
      - task: "Create Messaging Service"
        location: "Twilio Console -> Messaging -> Services"
      - task: "Configure inbound webhook URL"
        location: "Twilio Console -> Phone Numbers -> Active Numbers -> select number -> Messaging Configuration -> Webhook URL: https://YOUR_DOMAIN/api/sms/webhook"
      - task: "Start A2P 10DLC brand registration"
        location: "Twilio Console -> Messaging -> Compliance -> A2P Brand Registration"
  - service: vercel
    why: "Cron job for weekly check-in scheduling"
    env_vars:
      - name: CRON_SECRET
        source: "Generate a random secret: openssl rand -hex 32. Add to Vercel -> Settings -> Environment Variables"

must_haves:
  truths:
    - "Weekly check-in SMS is sent to opted-in Studio users every Monday"
    - "Inbound SMS responses are received and stored via Twilio webhook"
    - "Check-in messages are personalized based on user's recent agent activity"
    - "STOP keyword handling removes user from check-in list"
    - "Webhook signature validation prevents spoofing"
  artifacts:
    - path: "lib/sms/client.ts"
      provides: "Twilio client wrapper with lazy initialization"
      exports: ["sendSMS", "validateWebhook"]
    - path: "lib/sms/scheduler.ts"
      provides: "Weekly check-in dispatch logic"
      exports: ["sendWeeklyCheckins"]
    - path: "lib/sms/templates.ts"
      provides: "SMS message templates"
      exports: ["getCheckinTemplate", "getWelcomeTemplate"]
    - path: "lib/sms/webhook-handler.ts"
      provides: "Inbound SMS processing"
      exports: ["processInboundSMS"]
    - path: "lib/db/sms.ts"
      provides: "CRUD for sms_checkins and user_sms_preferences"
      exports: ["createCheckin", "getCheckinHistory", "getUserSMSPreferences", "updateSMSPreferences"]
    - path: "app/api/sms/webhook/route.ts"
      provides: "Twilio inbound webhook endpoint"
      exports: ["POST"]
    - path: "app/api/cron/weekly-checkin/route.ts"
      provides: "Vercel cron endpoint for weekly dispatch"
      exports: ["GET"]
    - path: "vercel.json"
      provides: "Cron schedule configuration"
      contains: "weekly-checkin"
  key_links:
    - from: "app/api/cron/weekly-checkin/route.ts"
      to: "lib/sms/scheduler.ts"
      via: "calls sendWeeklyCheckins"
      pattern: "sendWeeklyCheckins"
    - from: "lib/sms/scheduler.ts"
      to: "lib/sms/client.ts"
      via: "sends SMS via Twilio"
      pattern: "sendSMS"
    - from: "app/api/sms/webhook/route.ts"
      to: "lib/sms/webhook-handler.ts"
      via: "processes inbound messages"
      pattern: "processInboundSMS"
    - from: "lib/sms/webhook-handler.ts"
      to: "lib/db/sms.ts"
      via: "stores inbound messages"
      pattern: "createCheckin"
---

<objective>
Implement the Twilio SMS weekly check-in system: Twilio client wrapper, SMS templates, weekly scheduling via Vercel Cron, inbound webhook for responses, and database operations for check-in tracking.

Purpose: Weekly SMS check-ins create accountability for founders and drive engagement with the platform. This is a key differentiator for Studio tier. The scheduler references agent task history for personalized highlights, so all three agents must be complete first.

Output: Complete SMS pipeline from cron-triggered outbound messages to webhook-received inbound responses, with full database tracking.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/04-studio-tier/04-RESEARCH.md
@.planning/phases/04-studio-tier/04-01-SUMMARY.md
@lib/db/migrations/029_sms_checkins.sql (from Plan 01)
@lib/db/migrations/031_user_sms_preferences.sql (from Plan 01)
@lib/db/agent-tasks.ts (from Plan 01 - used by scheduler for agent activity highlights)
@lib/stripe/server.ts (lazy client initialization pattern)
@app/api/stripe/webhook/route.ts (webhook validation pattern)
@vercel.json (existing config to extend)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Twilio client, templates, and database operations</name>
  <files>
    lib/sms/types.ts
    lib/sms/client.ts
    lib/sms/templates.ts
    lib/db/sms.ts
  </files>
  <action>
**lib/sms/types.ts:**
Export types:
- `SMSDirection` = 'outbound' | 'inbound'
- `SMSStatus` = 'queued' | 'sent' | 'delivered' | 'failed' | 'received'
- `CheckinRecord` interface: { id, userId, phoneNumber, messageSid?, direction, body, status, weekNumber, year, parentCheckinId?, accountabilityScore?, sentAt?, receivedAt?, createdAt }
- `UserSMSPreferences` interface: { userId, phoneNumber?, phoneVerified, checkinEnabled, checkinDay, checkinHour, timezone, createdAt, updatedAt }
- `WeeklyCheckinResult` interface: { sent: number, failed: number, skipped: number, errors: Array<{ userId: string, error: string }> }

**lib/sms/client.ts:**
Follow the lazy-init pattern from lib/stripe/server.ts:
- `let twilioClient: any = null` (use `any` for Twilio type to avoid import issues, or properly type if Twilio types are available)
- `function getTwilio()`: lazy-initialize with TWILIO_ACCOUNT_SID and TWILIO_AUTH_TOKEN from env. Throw descriptive error if missing.
- `export async function sendSMS(to: string, body: string): Promise<string>`: create message via `client.messages.create({ to, body, messagingServiceSid: process.env.TWILIO_MESSAGING_SERVICE_SID })`. Return message.sid.
- `export function validateWebhook(signature: string, url: string, params: Record<string, string>): boolean`: use `Twilio.validateRequest(authToken, signature, url, params)`.
- Import Twilio with `import Twilio from 'twilio'` (this requires `pnpm add twilio` to have been run).

**lib/sms/templates.ts:**
Export template functions:
- `getCheckinTemplate(founderName: string, highlights?: string[]): string` - returns a personalized weekly check-in message. Example: "Hey {name}! It's your weekly check-in from Sahara. {highlights ? 'This week your agents worked on: ' + highlights.join(', ') + '. ' : ''}What are your top 3 priorities this week? Reply with your goals."
- `getWelcomeTemplate(founderName: string): string` - welcome message for new SMS subscribers
- `getStopConfirmation(): string` - "You've been unsubscribed from Sahara check-ins. Text START to re-enable."
- Keep messages under 160 chars where possible (single SMS segment). If highlights push it over, truncate highlights.

**lib/db/sms.ts:**
CRUD operations using the project's database pattern:
- `createCheckin(params: Omit<CheckinRecord, 'id' | 'createdAt'>): Promise<CheckinRecord>` - INSERT into sms_checkins
- `getCheckinHistory(userId: string, opts?: { limit?: number, weekNumber?: number, year?: number }): Promise<CheckinRecord[]>` - SELECT with filters
- `getCheckinByMessageSid(messageSid: string): Promise<CheckinRecord | null>` - for linking inbound to outbound
- `findUserByPhoneNumber(phoneNumber: string): Promise<{ userId: string } | null>` - lookup user from inbound SMS
- `getUserSMSPreferences(userId: string): Promise<UserSMSPreferences | null>` - SELECT from user_sms_preferences
- `updateSMSPreferences(userId: string, updates: Partial<UserSMSPreferences>): Promise<UserSMSPreferences>` - UPSERT
- `getOptedInUsers(): Promise<Array<UserSMSPreferences & { name?: string }>>` - SELECT WHERE checkin_enabled = true AND phone_number IS NOT NULL AND phone_verified = true. Join with users table to get name.
- `updateCheckinStatus(checkinId: string, status: SMSStatus, messageSid?: string): Promise<void>` - UPDATE status
  </action>
  <verify>TypeScript compilation passes. Client module imports Twilio correctly. DB functions match table schema.</verify>
  <done>Twilio client wrapper, SMS templates, and database CRUD operations are complete. Templates stay under 160 chars.</done>
</task>

<task type="auto">
  <name>Task 2: Webhook handler, cron endpoint, and scheduler</name>
  <files>
    lib/sms/webhook-handler.ts
    lib/sms/scheduler.ts
    app/api/sms/webhook/route.ts
    app/api/cron/weekly-checkin/route.ts
    vercel.json
  </files>
  <action>
**lib/sms/webhook-handler.ts:**
Export `async function processInboundSMS(from: string, body: string): Promise<void>`:
1. Normalize phone number (ensure E.164 format)
2. Look up user by phone via `findUserByPhoneNumber(from)`
3. If no user found, log and return (ignore messages from unknown numbers)
4. Check for STOP keyword: if body.trim().toUpperCase() === 'STOP', call `updateSMSPreferences(user.userId, { checkinEnabled: false })` and return
5. Check for START keyword: if body.trim().toUpperCase() === 'START', call `updateSMSPreferences(user.userId, { checkinEnabled: true })` and return
6. Get current ISO week number and year using date-fns: `getISOWeek(new Date())`, `getISOWeekYear(new Date())`
7. Find the most recent outbound checkin for this user this week (to link as parent)
8. Create inbound checkin record via `createCheckin({ userId: user.userId, phoneNumber: from, direction: 'inbound', body, status: 'received', weekNumber, year, parentCheckinId: outboundCheckin?.id, receivedAt: new Date() })`

**lib/sms/scheduler.ts:**
Export `async function sendWeeklyCheckins(): Promise<WeeklyCheckinResult>`:
1. Get all opted-in users via `getOptedInUsers()`
2. Get current ISO week number and year
3. For each user:
   a. Check if checkin already sent this week (idempotency) via getCheckinHistory with weekNumber filter
   b. If already sent, skip (increment skipped counter)
   c. Query recent agent tasks for this user via `getAgentTasks(userId, { limit: 5, status: 'complete' })` from lib/db/agent-tasks.ts to generate highlights (task descriptions of recently completed agent work)
   d. Generate message via `getCheckinTemplate(user.name, highlights)`
   e. Create outbound checkin record with status 'queued'
   f. Try `sendSMS(user.phoneNumber, message)` -- on success, update status to 'sent' with messageSid. On error, update status to 'failed' and log error.
4. Return { sent, failed, skipped, errors }

Use `getISOWeek` and `getISOWeekYear` from 'date-fns' for week calculations.

**app/api/sms/webhook/route.ts:**
POST handler for Twilio inbound SMS:
1. Parse form data from request (Twilio sends application/x-www-form-urlencoded)
2. Extract all params into a Record<string, string>
3. Validate Twilio signature using `validateWebhook(signature, url, params)` where signature is from `x-twilio-signature` header and url is `${process.env.NEXT_PUBLIC_APP_URL}/api/sms/webhook`
4. If invalid signature, return 403
5. Extract `From` and `Body` from params
6. Call `processInboundSMS(from, body)`
7. Return empty TwiML response: `<?xml version="1.0" encoding="UTF-8"?><Response></Response>` with Content-Type: text/xml

IMPORTANT: Export `const dynamic = 'force-dynamic'` to prevent caching. Do NOT use edge runtime for this route (Twilio SDK may need Node.js APIs).

**app/api/cron/weekly-checkin/route.ts:**
GET handler triggered by Vercel Cron:
1. Verify authorization: `request.headers.get('authorization')` must equal `Bearer ${process.env.CRON_SECRET}`. Return 401 if not.
2. Call `sendWeeklyCheckins()`
3. Return 200 with result `{ sent, failed, skipped }`
4. On error, return 500 with error message
5. Log extensively -- this runs unattended.

Export `const dynamic = 'force-dynamic'`

**vercel.json:**
Read the existing vercel.json and add a `crons` array (keeping all existing config):
```json
{
  "crons": [
    {
      "path": "/api/cron/weekly-checkin",
      "schedule": "0 14 * * 1"
    }
  ]
}
```
This runs every Monday at 2 PM UTC. Merge with existing vercel.json content (headers, etc.).
  </action>
  <verify>
- `npx tsc --noEmit` passes
- vercel.json is valid JSON with both existing headers and new crons array
- Webhook route validates signatures and returns TwiML
- Cron route checks CRON_SECRET auth
- `npm run build` succeeds
  </verify>
  <done>Complete SMS pipeline: cron triggers weekly dispatch, outbound SMS sent via Twilio, inbound responses received via webhook, STOP/START handling, all persisted to database with idempotency checks.</done>
</task>

</tasks>

<verification>
- `pnpm add twilio` has been run (package in node_modules)
- lib/sms/ directory has client.ts, scheduler.ts, templates.ts, webhook-handler.ts, types.ts
- lib/db/sms.ts has all CRUD operations
- app/api/sms/webhook/route.ts validates Twilio signatures
- app/api/cron/weekly-checkin/route.ts verifies CRON_SECRET
- vercel.json has crons array with weekly-checkin schedule
- `npm run build` succeeds
</verification>

<success_criteria>
- Twilio client sends SMS via Messaging Services
- Weekly check-ins dispatched via Vercel Cron with idempotency
- Inbound responses received, linked to outbound check-ins
- STOP/START keyword handling for compliance
- Webhook signature validation prevents spoofing
- All data persisted to sms_checkins table
</success_criteria>

<output>
After completion, create `.planning/phases/04-studio-tier/04-05-SUMMARY.md`
</output>
