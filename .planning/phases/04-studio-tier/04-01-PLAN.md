---
phase: 04-studio-tier
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - lib/db/migrations/026_agent_tasks.sql
  - lib/db/migrations/027_sms_checkins.sql
  - lib/db/migrations/028_boardy_matches.sql
  - lib/db/migrations/029_user_sms_preferences.sql
  - lib/agents/types.ts
  - lib/agents/machine.ts
  - lib/agents/base-agent.ts
  - lib/db/agent-tasks.ts
autonomous: true

must_haves:
  truths:
    - "Agent tasks can be created, updated, and queried by user and status"
    - "Orchestrator state machine routes tasks to the correct agent type"
    - "Base agent class wraps Vercel AI SDK generateText with tools and maxSteps"
    - "Database schema supports agent tasks, SMS check-ins, Boardy matches, and SMS preferences"
  artifacts:
    - path: "lib/db/migrations/026_agent_tasks.sql"
      provides: "Agent task table with status tracking, JSONB input/output"
      contains: "CREATE TABLE agent_tasks"
    - path: "lib/db/migrations/027_sms_checkins.sql"
      provides: "SMS check-in tracking with parent-child relationships"
      contains: "CREATE TABLE sms_checkins"
    - path: "lib/db/migrations/028_boardy_matches.sql"
      provides: "Boardy match storage with status workflow"
      contains: "CREATE TABLE boardy_matches"
    - path: "lib/db/migrations/029_user_sms_preferences.sql"
      provides: "User SMS preferences (phone, timezone, schedule)"
      contains: "CREATE TABLE user_sms_preferences"
    - path: "lib/agents/types.ts"
      provides: "Shared agent types: AgentTask, AgentResult, AgentType"
      exports: ["AgentTask", "AgentResult", "AgentType", "AgentStatus"]
    - path: "lib/agents/machine.ts"
      provides: "XState v5 orchestrator state machine"
      contains: "agentOrchestratorMachine"
    - path: "lib/agents/base-agent.ts"
      provides: "Base agent class wrapping AI SDK with tools"
      exports: ["runAgent", "BaseAgentConfig"]
    - path: "lib/db/agent-tasks.ts"
      provides: "CRUD operations for agent_tasks table"
      exports: ["createAgentTask", "updateAgentTask", "getAgentTasks", "getAgentTask"]
  key_links:
    - from: "lib/agents/machine.ts"
      to: "lib/agents/types.ts"
      via: "imports AgentTask, AgentResult, AgentType"
      pattern: "import.*AgentTask.*from.*types"
    - from: "lib/agents/base-agent.ts"
      to: "lib/ai/fred-client.ts"
      via: "uses generateText from AI SDK via existing providers"
      pattern: "import.*getModel.*from.*providers"
    - from: "lib/db/agent-tasks.ts"
      to: "lib/db/migrations/026_agent_tasks.sql"
      via: "queries agent_tasks table"
      pattern: "agent_tasks"
---

<objective>
Create the foundational architecture for the Studio tier virtual agent system: database schema for all Phase 04 tables, shared TypeScript types, the XState v5 orchestrator state machine, a base agent wrapper, and database CRUD operations for agent tasks.

Purpose: This is the foundation that all three specialist agents (Plans 02-04), SMS check-ins (Plan 05), Boardy integration (Plan 06), and Stripe upgrade (Plan 07) build upon. Without these types, schema, and orchestrator, no downstream plan can execute.

Output: 4 SQL migration files, agent type system, orchestrator state machine, base agent class, and agent task database operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-studio-tier/04-RESEARCH.md
@lib/fred/machine.ts (XState v5 pattern to follow)
@lib/fred/types.ts (type system pattern to follow)
@lib/ai/fred-client.ts (AI SDK integration pattern)
@lib/ai/providers.ts (getModel, provider configuration)
@lib/db/documents.ts (database CRUD pattern to follow)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Database migrations for Phase 04 tables</name>
  <files>
    lib/db/migrations/026_agent_tasks.sql
    lib/db/migrations/027_sms_checkins.sql
    lib/db/migrations/028_boardy_matches.sql
    lib/db/migrations/029_user_sms_preferences.sql
  </files>
  <action>
Create 4 SQL migration files following the exact schema from 04-RESEARCH.md:

**026_agent_tasks.sql:**
- Table `agent_tasks` with columns: id (UUID PK), user_id (UUID FK auth.users), agent_type (TEXT CHECK 'founder_ops'|'fundraising'|'growth'), task_type (TEXT NOT NULL), description (TEXT NOT NULL), status (TEXT CHECK 'pending'|'running'|'complete'|'failed'|'cancelled' DEFAULT 'pending'), input (JSONB DEFAULT '{}'), output (JSONB), error (TEXT), started_at (TIMESTAMPTZ), completed_at (TIMESTAMPTZ), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())
- Indexes on user_id, status, agent_type

**027_sms_checkins.sql:**
- Table `sms_checkins` with columns: id (UUID PK), user_id (UUID FK auth.users), phone_number (TEXT NOT NULL), message_sid (TEXT), direction (TEXT CHECK 'outbound'|'inbound'), body (TEXT NOT NULL), status (TEXT CHECK 'queued'|'sent'|'delivered'|'failed'|'received' DEFAULT 'queued'), week_number (INTEGER NOT NULL), year (INTEGER NOT NULL), parent_checkin_id (UUID FK self-referencing sms_checkins), accountability_score (JSONB), sent_at (TIMESTAMPTZ), received_at (TIMESTAMPTZ), created_at (TIMESTAMPTZ DEFAULT now())
- Indexes on user_id, (year, week_number), phone_number

**028_boardy_matches.sql:**
- Table `boardy_matches` with columns: id (UUID PK), user_id (UUID FK auth.users), match_type (TEXT CHECK 'investor'|'advisor'|'mentor'|'partner'), match_name (TEXT), match_description (TEXT), match_score (REAL), status (TEXT CHECK 'suggested'|'connected'|'intro_sent'|'meeting_scheduled'|'declined' DEFAULT 'suggested'), boardy_reference_id (TEXT), metadata (JSONB DEFAULT '{}'), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())
- Indexes on user_id, status

**029_user_sms_preferences.sql:**
- Table `user_sms_preferences` with columns: user_id (UUID PK FK auth.users), phone_number (TEXT), phone_verified (BOOLEAN DEFAULT false), checkin_enabled (BOOLEAN DEFAULT true), checkin_day (INTEGER DEFAULT 1), checkin_hour (INTEGER DEFAULT 9), timezone (TEXT DEFAULT 'America/New_York'), created_at (TIMESTAMPTZ DEFAULT now()), updated_at (TIMESTAMPTZ DEFAULT now())

Follow the pattern from existing migrations (e.g., 024_uploaded_documents.sql, 025_investor_readiness_scores.sql).
  </action>
  <verify>All 4 SQL files exist and contain valid SQL with proper CREATE TABLE, CHECK constraints, indexes, and FK references.</verify>
  <done>4 migration files created matching the schema from research. Tables cover agent tasks, SMS check-ins, Boardy matches, and user SMS preferences.</done>
</task>

<task type="auto">
  <name>Task 2: Agent type system and base agent class</name>
  <files>
    lib/agents/types.ts
    lib/agents/base-agent.ts
    lib/db/agent-tasks.ts
  </files>
  <action>
**lib/agents/types.ts:**
Create shared types for the agent system:
- `AgentType` = 'founder_ops' | 'fundraising' | 'growth'
- `AgentStatus` = 'pending' | 'running' | 'complete' | 'failed' | 'cancelled'
- `AgentTask` interface: { id: string, userId: string, agentType: AgentType, taskType: string, description: string, status: AgentStatus, input: Record<string, unknown>, output?: Record<string, unknown>, error?: string, startedAt?: Date, completedAt?: Date, createdAt: Date, updatedAt: Date }
- `AgentResult` interface: { agentId: AgentType, taskId: string, output: string, toolCalls: Array<{ toolName: string, args: Record<string, unknown>, result: unknown }>, status: 'complete' | 'failed', error?: string, tokenUsage?: { prompt: number, completion: number, total: number } }
- `AgentToolDefinition` type for tool definitions (re-export from 'ai' tool type)
- `BaseAgentConfig` interface: { agentType: AgentType, systemPrompt: string, tools: Record<string, any>, maxSteps: number, model?: string }

**lib/agents/base-agent.ts:**
Create a base agent runner that wraps Vercel AI SDK generateText with tools:
- Import `generateText, tool` from 'ai', `getModel` from '@/lib/ai/providers', and types
- Export `async function runAgent(config: BaseAgentConfig, task: AgentTask): Promise<AgentResult>`
- Inside: call `generateText({ model: getModel(config.model || 'primary'), system: config.systemPrompt, prompt: task.description, tools: config.tools, maxSteps: config.maxSteps })`
- Map the result to AgentResult format, extracting tool calls from `result.steps.flatMap(s => s.toolCalls)`
- Track token usage from `result.usage`
- Wrap in try/catch, return failed status on error
- DO NOT use the circuit breaker or fallback chain here -- the orchestrator handles retries. Keep the base agent simple.

**lib/db/agent-tasks.ts:**
Create CRUD operations for the agent_tasks table following the pattern in lib/db/documents.ts:
- Import `sql` from the existing database module (check lib/db/ for the connection pattern)
- `createAgentTask(params: { userId, agentType, taskType, description, input }): Promise<AgentTask>` - INSERT and return
- `updateAgentTask(taskId: string, updates: Partial<{ status, output, error, startedAt, completedAt }>): Promise<AgentTask>` - UPDATE by id
- `getAgentTask(taskId: string): Promise<AgentTask | null>` - SELECT by id
- `getAgentTasks(userId: string, opts?: { agentType?, status?, limit?, offset? }): Promise<AgentTask[]>` - SELECT with filters
- `getActiveAgentTasks(userId: string): Promise<AgentTask[]>` - SELECT WHERE status IN ('pending', 'running')

Use parameterized queries to prevent SQL injection. Follow the pattern from existing lib/db/*.ts files.
  </action>
  <verify>TypeScript compilation check: `npx tsc --noEmit lib/agents/types.ts lib/agents/base-agent.ts lib/db/agent-tasks.ts` (or the project-level tsc). All imports resolve correctly.</verify>
  <done>Agent type system exports AgentTask, AgentResult, AgentType, AgentStatus. Base agent wraps AI SDK generateText with tools/maxSteps. Database CRUD operations support full agent task lifecycle.</done>
</task>

<task type="auto">
  <name>Task 3: XState v5 orchestrator state machine</name>
  <files>lib/agents/machine.ts</files>
  <action>
Create the agent orchestrator XState v5 state machine following the exact pattern from lib/fred/machine.ts:

Import `setup, assign, fromPromise` from 'xstate' and types from './types'.

Define `agentOrchestratorMachine` using `setup({...}).createMachine({...})`:

**Context type:**
```
{ userId: string, currentTask: AgentTask | null, results: AgentResult[], activeAgents: string[], error: Error | null }
```

**Events:**
- `DISPATCH` with `task: AgentTask` - start processing a task
- `AGENT_COMPLETE` with `agentId: string, result: AgentResult`
- `AGENT_ERROR` with `agentId: string, error: Error`
- `CANCEL` - cancel current task

**Actors (fromPromise):**
- `founderOpsAgent`: dynamic import `./founder-ops/agent` and call `runFounderOpsAgent(input)`
- `fundraisingAgent`: dynamic import `./fundraising/agent` and call `runFundraisingAgent(input)`
- `growthAgent`: dynamic import `./growth/agent` and call `runGrowthAgent(input)`

**Guards:**
- `isFounderOpsTask`: check `context.currentTask?.agentType === 'founder_ops'`
- `isFundraisingTask`: check `context.currentTask?.agentType === 'fundraising'`
- `isGrowthTask`: check `context.currentTask?.agentType === 'growth'`

**States:**
1. `idle` - on DISPATCH, store task and transition to `routing`
2. `routing` - always transitions: check guards and route to `executing_founder_ops`, `executing_fundraising`, or `executing_growth`. If no guard matches, go to `error`.
3. `executing_founder_ops` - invoke founderOpsAgent actor with current task. onDone -> store result, go to `complete`. onError -> go to `error`.
4. `executing_fundraising` - same pattern with fundraisingAgent
5. `executing_growth` - same pattern with growthAgent
6. `complete` - final state, entry action stores result in results array
7. `error` - on CANCEL -> go to `failed`. Store error.
8. `failed` - final state

Use `assign()` for all context mutations. Add `logTransition` action like fred/machine.ts does.

Export the machine and its type.
  </action>
  <verify>TypeScript compilation check passes. Machine has all states, guards, actors defined. Pattern matches lib/fred/machine.ts structure.</verify>
  <done>XState v5 orchestrator state machine routes tasks to specialist agents via guards, with proper error handling and state transitions matching the existing FRED machine pattern.</done>
</task>

</tasks>

<verification>
- All 4 SQL migration files exist in lib/db/migrations/
- lib/agents/types.ts exports AgentTask, AgentResult, AgentType, AgentStatus, BaseAgentConfig
- lib/agents/base-agent.ts exports runAgent function
- lib/agents/machine.ts exports agentOrchestratorMachine
- lib/db/agent-tasks.ts exports createAgentTask, updateAgentTask, getAgentTask, getAgentTasks
- `npm run build` succeeds (or at minimum `npx tsc --noEmit` passes)
</verification>

<success_criteria>
- Database schema matches research spec exactly
- Type system is shared and importable by all downstream plans
- Orchestrator correctly routes to 3 agent types via guards
- Base agent wraps AI SDK generateText with maxSteps tool loop
- Agent task CRUD supports full lifecycle (create -> running -> complete/failed)
</success_criteria>

<output>
After completion, create `.planning/phases/04-studio-tier/04-01-SUMMARY.md`
</output>
