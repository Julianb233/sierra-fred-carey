{
  "project": "Sahara",
  "branchName": "ralph/phase-47-community-data-layer-consent",
  "description": "Create the community data layer foundation (14 tables, RLS policies, materialized views, triggers) and consent management system (CRUD module, API routes, Settings UI) for Phases 47-53",
  "userStories": [
    {
      "id": "US-001",
      "title": "Create migration 053 with 14 new tables and ALTER columns",
      "description": "As a developer, I need to create migration 053_community_data_layer.sql containing all 14 new tables (community_profiles, consent_preferences, consent_audit_log, subcommunity_sponsors, cohorts, cohort_members, social_feed_posts, social_feed_reactions, social_feed_comments, founder_messages, founder_connections, expert_listings, reputation_events, engagement_streaks), 3 new columns on the existing communities table (parent_community_id, is_sponsored, tier_required), with correct columns, types, constraints, and foreign keys.",
      "acceptanceCriteria": [
        "File exists at lib/db/migrations/053_community_data_layer.sql",
        "grep -c 'CREATE TABLE' returns 14",
        "ALTER TABLE communities adds parent_community_id, is_sponsored, tier_required",
        "Every table has id UUID PRIMARY KEY DEFAULT gen_random_uuid()",
        "FK references match existing table column types exactly (e.g. milestones.id type)",
        "Appropriate indexes on user_id columns, FK columns, and created_at DESC",
        "updated_at trigger using existing update_updated_at_column() function where applicable",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql (054 instead of 053 since 053 was taken). Follow exact pattern from migration 051_founder_communities.sql (DO $$ BEGIN...EXCEPTION WHEN duplicate_object THEN NULL; END $$)."
    },
    {
      "id": "US-002",
      "title": "Enable RLS and create policies for all 14 new tables",
      "description": "As a developer, I need to enable Row Level Security on all 14 new tables and create comprehensive RLS policies: user-scoped for personal data (consent_preferences, consent_audit_log, engagement_streaks, reputation_events), owner CRUD for user content (community_profiles, social_feed_posts, comments, reactions, expert_listings), party-based for messaging (founder_messages, founder_connections), cohort-member-scoped for cohorts, and service_role ALL policies on every table.",
      "acceptanceCriteria": [
        "grep -c 'ENABLE ROW LEVEL SECURITY' returns 14",
        "grep -c 'CREATE POLICY' returns at least 40",
        "Every table has a service_role ALL policy",
        "consent_preferences SELECT policy uses auth.uid() = user_id",
        "founder_messages SELECT allows both sender_id and recipient_id",
        "All policies wrapped in idempotent DO $$ BEGIN...EXCEPTION blocks",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql. RLS policies are Section 7 of the migration. Already implemented as part of US-001 — 14 ENABLE RLS + 50 CREATE POLICY (14 service_role ALL)."
    },
    {
      "id": "US-003",
      "title": "Create counter-sync triggers for social feed posts",
      "description": "As a developer, I need to create triggers on social_feed_reactions and social_feed_comments that automatically sync reaction_count and comment_count on social_feed_posts, following the exact pattern from migration 051 (sync_post_reaction_count, sync_post_reply_count).",
      "acceptanceCriteria": [
        "Trigger function sync_post_reaction_count exists and updates social_feed_posts.reaction_count",
        "Trigger function sync_post_comment_count exists and updates social_feed_posts.comment_count",
        "Triggers fire AFTER INSERT OR DELETE on social_feed_reactions and social_feed_comments",
        "Pattern matches migration 051 exactly",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql (Section 3 of migration). Already implemented as part of US-001."
    },
    {
      "id": "US-004",
      "title": "Create consent audit trigger on consent_preferences",
      "description": "As a developer, I need to create a trigger on consent_preferences that fires AFTER INSERT OR UPDATE and inserts a row into consent_audit_log with old and new values. For INSERT, previous_value should be false (the default).",
      "acceptanceCriteria": [
        "Trigger function log_consent_change exists",
        "Trigger fires AFTER INSERT OR UPDATE on consent_preferences",
        "INSERT operations log previous_value as false",
        "UPDATE operations log actual OLD.enabled value",
        "consent_audit_log rows created automatically on consent_preferences changes",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql (Section 4 of migration). Already implemented as part of US-001."
    },
    {
      "id": "US-005",
      "title": "Create consent-gated materialized views with k-anonymity",
      "description": "As a developer, I need to create two materialized views (benchmark_stage_aggregates and benchmark_industry_aggregates) that INNER JOIN on consent_preferences to only include opted-in users, with HAVING COUNT(*) >= 5 for k-anonymity. Include unique indexes for REFRESH CONCURRENTLY and a refresh function.",
      "acceptanceCriteria": [
        "benchmark_stage_aggregates materialized view exists with consent JOIN",
        "benchmark_industry_aggregates materialized view exists with consent JOIN",
        "Both views have HAVING COUNT(*) >= 5 for k-anonymity",
        "Unique indexes exist on stage and industry columns for CONCURRENTLY refresh",
        "refresh_benchmark_aggregates() function exists and refreshes both views",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql (Section 5 of migration). Already implemented as part of US-001."
    },
    {
      "id": "US-006",
      "title": "Set REPLICA IDENTITY FULL and add table comments",
      "description": "As a developer, I need to set REPLICA IDENTITY FULL on social_feed_posts and founder_messages for future Supabase Realtime support, and add COMMENT ON TABLE for every new table explaining its purpose and which phase uses it.",
      "acceptanceCriteria": [
        "ALTER TABLE social_feed_posts REPLICA IDENTITY FULL is present",
        "ALTER TABLE founder_messages REPLICA IDENTITY FULL is present",
        "All 14 new tables have COMMENT ON TABLE statements",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Files: lib/db/migrations/054_community_data_layer.sql (Sections 6 and 8 of migration). Already implemented as part of US-001."
    },
    {
      "id": "US-007",
      "title": "Create consent CRUD module with merge-with-defaults pattern",
      "description": "As a developer, I need to create lib/db/consent.ts exporting getConsentPreferences, updateConsentPreference, isConsentEnabled, CONSENT_DEFAULTS (all false/opt-in), and CONSENT_CATEGORIES. Follow the exact structural pattern from lib/push/preferences.ts with merge-with-defaults logic using createServiceClient().",
      "acceptanceCriteria": [
        "lib/db/consent.ts exists and exports getConsentPreferences, updateConsentPreference, isConsentEnabled",
        "CONSENT_DEFAULTS has 4 categories (benchmarks, social_feed, directory, messaging) all defaulting to false",
        "CONSENT_CATEGORIES exported as ConsentCategory[]",
        "getConsentPreferences merges stored rows with CONSENT_DEFAULTS",
        "updateConsentPreference uses UPSERT (not separate insert/update)",
        "createServiceClient pattern matches push/preferences.ts",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Files: lib/db/consent.ts. Already implemented following push/preferences.ts pattern."
    },
    {
      "id": "US-008",
      "title": "Create consent API route with GET and PUT handlers",
      "description": "As a developer, I need to create app/api/community/consent/route.ts with authenticated GET (returns all consent preferences) and PUT (toggles a specific category) endpoints following the existing API response pattern { success: true/false, data/error }.",
      "acceptanceCriteria": [
        "app/api/community/consent/route.ts exists with GET and PUT exports",
        "GET handler calls requireAuth() and returns preferences via getConsentPreferences",
        "PUT handler validates category against CONSENT_CATEGORIES",
        "PUT handler calls updateConsentPreference with UPSERT",
        "Both handlers follow { success: true, data } / { success: false, error } pattern",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Files: app/api/community/consent/route.ts. Already implemented with GET+PUT, requireAuth via @/lib/auth."
    },
    {
      "id": "US-009",
      "title": "Create ConsentSettings component with instant-save toggles",
      "description": "As a developer, I need to create components/settings/ConsentSettings.tsx as a 'use client' component with 4 toggle switches (Benchmark Data, Social Feed, Founder Directory, Direct Messaging) that save immediately on toggle via fetch to /api/community/consent, with loading skeleton and toast feedback via sonner.",
      "acceptanceCriteria": [
        "components/settings/ConsentSettings.tsx exists as 'use client' component",
        "Card with title 'Community Data Sharing' and description about opt-in",
        "4 Switch components for each consent category",
        "Each toggle calls PUT /api/community/consent immediately (no Save button)",
        "Loading skeleton shown while fetching initial state",
        "Toast notifications on success/error via sonner",
        "No server-only imports (labels/descriptions duplicated as client-safe constants)",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Files: components/settings/ConsentSettings.tsx. Already implemented with client-safe duplicated constants."
    },
    {
      "id": "US-010",
      "title": "Add ConsentSettings to the Settings page",
      "description": "As a developer, I need to import and render the ConsentSettings component in app/dashboard/settings/page.tsx after the General Notifications card and before the Voice & TTS section. No tier gating needed.",
      "acceptanceCriteria": [
        "ConsentSettings imported in app/dashboard/settings/page.tsx",
        "ConsentSettings rendered after notifications and before Voice & TTS",
        "No tier gating on consent settings (all tiers can set preferences)",
        "Page renders without errors",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Files: app/dashboard/settings/page.tsx. Already implemented — ConsentSettings imported and rendered after General Notifications."
    }
  ]
}
